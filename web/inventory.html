<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tick Tock Inc. â€” ERP</title>
<style>
/* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg0:     #0d0f14;
  --bg1:     #131720;
  --bg2:     #1a1f2e;
  --bg3:     #222840;
  --bg4:     #2a3250;
  --border:  #2e3650;
  --text0:   #eef1f8;
  --text1:   #a8b3cc;
  --text2:   #6b7a99;
  --accent:  #4f8ef7;
  --accent2: #7c5cf5;
  --green:   #22c575;
  --yellow:  #f5c842;
  --red:     #f5524a;
  --orange:  #f58c42;
  --radius:  8px;
  --sidebar: 220px;
}
html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg0); color: var(--text0); font-size: 13px; line-height: 1.5; }
a { color: var(--accent); text-decoration: none; }
button { cursor: pointer; font-family: inherit; }
input, select, textarea { font-family: inherit; font-size: 13px; }

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app { display: flex; height: 100vh; overflow: hidden; }

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: var(--sidebar); min-width: var(--sidebar);
  background: var(--bg1); border-right: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden;
}
.logo {
  padding: 20px 16px 16px;
  border-bottom: 1px solid var(--border);
}
.logo-mark {
  display: flex; align-items: center; gap: 10px;
}
.logo-icon {
  width: 32px; height: 32px; border-radius: 8px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; flex-shrink: 0;
}
.logo-text { font-size: 14px; font-weight: 700; color: var(--text0); line-height: 1.2; }
.logo-sub  { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.08em; }

nav { padding: 12px 8px; flex: 1; overflow-y: auto; }
.nav-label {
  font-size: 10px; font-weight: 600; color: var(--text2);
  text-transform: uppercase; letter-spacing: 0.1em;
  padding: 8px 8px 4px;
}
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 10px; border-radius: var(--radius);
  color: var(--text1); font-size: 13px; font-weight: 500;
  cursor: pointer; transition: all .15s; margin-bottom: 2px;
  border: none; background: none; width: 100%; text-align: left;
}
.nav-item:hover { background: var(--bg3); color: var(--text0); }
.nav-item.active { background: var(--bg4); color: var(--accent); }
.nav-item .icon { font-size: 15px; width: 18px; text-align: center; flex-shrink: 0; }
.nav-badge {
  margin-left: auto; background: var(--red); color: #fff;
  font-size: 10px; font-weight: 700; border-radius: 10px;
  padding: 1px 6px; min-width: 18px; text-align: center;
}

.sidebar-footer {
  padding: 12px 16px; border-top: 1px solid var(--border);
  font-size: 11px; color: var(--text2);
}
.conn-dot {
  display: inline-block; width: 7px; height: 7px; border-radius: 50%;
  background: var(--green); margin-right: 5px; vertical-align: middle;
}
.conn-dot.offline { background: var(--red); }

/* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main {
  flex: 1; display: flex; flex-direction: column; overflow: hidden;
  background: var(--bg0);
}

/* â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#topbar {
  padding: 0 24px;
  height: 56px; min-height: 56px;
  border-bottom: 1px solid var(--border);
  background: var(--bg1);
  display: flex; align-items: center; justify-content: space-between;
}
.topbar-title { font-size: 16px; font-weight: 600; }
.topbar-actions { display: flex; gap: 8px; }

/* â”€â”€ Stats Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#stats-bar {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 1px; background: var(--border);
  border-bottom: 1px solid var(--border);
}
.stat-card {
  background: var(--bg1); padding: 16px 20px;
}
.stat-label { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px; }
.stat-value { font-size: 22px; font-weight: 700; color: var(--text0); }
.stat-sub   { font-size: 11px; color: var(--text2); margin-top: 2px; }

/* â”€â”€ Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#content {
  flex: 1; overflow-y: auto; padding: 20px 24px;
}

/* â”€â”€ Section Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section { display: none; }
.section.active { display: block; }

/* â”€â”€ Reorder Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.reorder-panel {
  background: var(--bg2); border: 1px solid var(--border);
  border-left: 3px solid var(--red); border-radius: var(--radius);
  margin-bottom: 16px; overflow: hidden;
}
.reorder-header {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 16px; cursor: pointer;
  border-bottom: 1px solid transparent;
  transition: border-color .15s;
}
.reorder-header.open { border-bottom-color: var(--border); }
.reorder-title { font-size: 13px; font-weight: 600; flex: 1; }
.reorder-count {
  background: var(--red); color: #fff;
  font-size: 11px; font-weight: 700;
  border-radius: 10px; padding: 2px 8px;
}
.chevron { font-size: 11px; color: var(--text2); transition: transform .2s; }
.chevron.open { transform: rotate(180deg); }
.reorder-body { display: none; }
.reorder-body.open { display: block; }
.reorder-table { width: 100%; border-collapse: collapse; }
.reorder-table th {
  background: var(--bg3); padding: 8px 14px;
  font-size: 10px; font-weight: 600; color: var(--text2);
  text-transform: uppercase; letter-spacing: 0.06em; text-align: left;
}
.reorder-table td { padding: 9px 14px; border-bottom: 1px solid var(--border); }
.reorder-table tr:last-child td { border-bottom: none; }
.reorder-table tr:hover td { background: var(--bg3); }

/* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar {
  display: flex; align-items: center; gap: 10px; margin-bottom: 14px; flex-wrap: wrap;
}
.search-box {
  position: relative; flex: 1; min-width: 160px; max-width: 300px;
}
.search-box input {
  width: 100%; padding: 7px 10px 7px 32px;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); color: var(--text0);
  outline: none; transition: border-color .15s;
}
.search-box input:focus { border-color: var(--accent); }
.search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text2); font-size: 13px; }
select.filter {
  padding: 7px 10px; background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); color: var(--text0); outline: none; cursor: pointer;
}
select.filter:focus { border-color: var(--accent); }
.tab-group { display: flex; gap: 2px; background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); padding: 3px; }
.tab-btn {
  padding: 4px 12px; border: none; background: none;
  border-radius: 5px; color: var(--text1); font-size: 12px; font-weight: 500;
  transition: all .15s;
}
.tab-btn.active { background: var(--bg4); color: var(--text0); }

/* â”€â”€ Stock Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap {
  background: var(--bg1); border: 1px solid var(--border);
  border-radius: var(--radius); overflow: hidden;
}
.data-table { width: 100%; border-collapse: collapse; }
.data-table th {
  background: var(--bg2); padding: 10px 14px;
  font-size: 10px; font-weight: 600; color: var(--text2);
  text-transform: uppercase; letter-spacing: 0.06em;
  text-align: left; white-space: nowrap;
  border-bottom: 1px solid var(--border);
}
.data-table td {
  padding: 11px 14px; border-bottom: 1px solid var(--border);
  white-space: nowrap; font-size: 12px;
}
.data-table tr:last-child td { border-bottom: none; }
.data-table tbody tr { transition: background .1s; cursor: pointer; }
.data-table tbody tr:hover td { background: var(--bg2); }

.code-tag {
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 11px; color: var(--text1);
  background: var(--bg3); padding: 2px 6px; border-radius: 4px;
}
.item-name { font-weight: 500; color: var(--text0); }
.cat-badge {
  font-size: 10px; padding: 2px 7px; border-radius: 10px;
  font-weight: 600; background: var(--bg3); color: var(--text1);
}
.qty-cell { font-weight: 600; font-variant-numeric: tabular-nums; }
.qty-out  { color: var(--red); }
.qty-warn { color: var(--yellow); }
.qty-ok   { color: var(--green); }
.status-badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 10px;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.badge-ok      { background: rgba(34,197,117,.15); color: var(--green); }
.badge-low     { background: rgba(245,200,66,.15);  color: var(--yellow); }
.badge-out     { background: rgba(245,82,74,.15);   color: var(--red); }
.badge-draft   { background: rgba(107,122,153,.15); color: var(--text1); }
.badge-posted  { background: rgba(34,197,117,.15);  color: var(--green); }
.badge-cancelled { background: rgba(245,82,74,.15); color: var(--red); }

.empty-state {
  text-align: center; padding: 48px 20px; color: var(--text2);
}
.empty-icon { font-size: 32px; margin-bottom: 10px; }
.empty-msg  { font-size: 13px; }

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 7px 14px; border: none; border-radius: var(--radius);
  font-size: 12px; font-weight: 600; transition: all .15s;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #3a7ae0; }
.btn-secondary { background: var(--bg3); color: var(--text0); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--bg4); }
.btn-danger { background: var(--red); color: #fff; }
.btn-danger:hover { background: #d94040; }
.btn-success { background: var(--green); color: #0d0f14; }
.btn-success:hover { background: #1aad64; }
.btn-sm { padding: 4px 10px; font-size: 11px; }

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.65); z-index: 1000;
  align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg1); border: 1px solid var(--border);
  border-radius: 12px; width: 90%; max-width: 680px;
  max-height: 90vh; overflow: hidden;
  display: flex; flex-direction: column;
  box-shadow: 0 24px 80px rgba(0,0,0,.6);
}
.modal-header {
  display: flex; align-items: center; padding: 16px 20px;
  border-bottom: 1px solid var(--border); gap: 10px;
}
.modal-title { font-size: 15px; font-weight: 700; flex: 1; }
.modal-close {
  width: 28px; height: 28px; border: none; background: var(--bg3);
  border-radius: 6px; color: var(--text1); font-size: 16px;
  display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.modal-close:hover { background: var(--bg4); color: var(--text0); }
.modal-body { flex: 1; overflow-y: auto; padding: 20px; }
.modal-footer {
  padding: 14px 20px; border-top: 1px solid var(--border);
  display: flex; justify-content: flex-end; gap: 8px;
}

/* Detail modal */
.detail-hero {
  display: flex; gap: 20px; margin-bottom: 20px;
  padding-bottom: 20px; border-bottom: 1px solid var(--border);
}
.detail-info { flex: 1; }
.detail-code { font-family: monospace; font-size: 12px; color: var(--text2); margin-bottom: 4px; }
.detail-name { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
.detail-desc { font-size: 12px; color: var(--text1); line-height: 1.5; }
.detail-meta { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
.detail-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;
}
.detail-stat {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 12px;
}
.detail-stat-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px; }
.detail-stat-value { font-size: 20px; font-weight: 700; }
.detail-stat-sub   { font-size: 11px; color: var(--text2); }

/* Stock bar */
.stock-bar-wrap { margin-bottom: 20px; }
.stock-bar-label { font-size: 11px; color: var(--text2); margin-bottom: 6px; display: flex; justify-content: space-between; }
.stock-bar-track { height: 8px; background: var(--bg3); border-radius: 4px; overflow: hidden; position: relative; }
.stock-bar-committed { position: absolute; height: 100%; background: var(--orange); left: 0; border-radius: 4px; transition: width .4s; }
.stock-bar-available { position: absolute; height: 100%; background: var(--green); border-radius: 4px; transition: width .4s; }

/* Movement history */
.history-title { font-size: 12px; font-weight: 600; color: var(--text1); text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 10px; }
.history-row {
  display: flex; align-items: center; gap: 12px;
  padding: 8px 0; border-bottom: 1px solid var(--border);
  font-size: 12px;
}
.history-row:last-child { border-bottom: none; }
.hist-date { color: var(--text2); width: 80px; flex-shrink: 0; }
.hist-type { background: var(--bg3); padding: 2px 7px; border-radius: 4px; font-size: 10px; white-space: nowrap; flex-shrink: 0; }
.hist-qty  { font-weight: 700; width: 70px; text-align: right; font-variant-numeric: tabular-nums; flex-shrink: 0; }
.hist-wh   { color: var(--text2); font-size: 11px; flex-shrink: 0; }
.hist-notes { color: var(--text1); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* Forms */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-group.full { grid-column: 1 / -1; }
.form-label { font-size: 11px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.06em; }
.form-input {
  padding: 8px 10px; background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); color: var(--text0); outline: none;
  transition: border-color .15s; width: 100%;
}
.form-input:focus { border-color: var(--accent); }
textarea.form-input { resize: vertical; min-height: 70px; }

/* Adjustments */
.adj-lines-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
.adj-lines-table th { background: var(--bg3); padding: 7px 10px; font-size: 10px; font-weight: 600; color: var(--text2); text-transform: uppercase; text-align: left; }
.adj-lines-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
.adj-lines-table td input { width: 90px; }
.adj-lines-table tr:last-child td { border-bottom: none; }

/* â”€â”€ Sales Module â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sales-stats {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px;
}
.sales-stat {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 14px 16px;
}
.sales-stat-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: .06em; margin-bottom: 3px; }
.sales-stat-value { font-size: 20px; font-weight: 700; }
.sales-stat-sub   { font-size: 11px; color: var(--text2); }
.so-lines-table { width: 100%; border-collapse: collapse; }
.so-lines-table th { background: var(--bg3); padding: 7px 12px; font-size: 10px; font-weight: 600; color: var(--text2); text-transform: uppercase; text-align: left; }
.so-lines-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 12px; }
.so-lines-table tr:last-child td { border-bottom: none; }
.so-lines-table tfoot td { background: var(--bg3); font-weight: 600; }
.so-detail-section { margin-bottom: 20px; }
.so-detail-section-title { font-size: 11px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: .07em; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
.so-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.so-info-item { font-size: 12px; }
.so-info-label { color: var(--text2); font-size: 10px; text-transform: uppercase; letter-spacing: .06em; margin-bottom: 2px; }
.so-info-value { color: var(--text0); font-weight: 500; }
.so-total-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px; }
.so-total-row.grand { font-size: 15px; font-weight: 700; border-top: 1px solid var(--border); margin-top: 6px; padding-top: 10px; }
.action-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
.cust-card { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; margin-bottom: 10px; display: flex; gap: 16px; align-items: flex-start; cursor: pointer; transition: background .15s; }
.cust-card:hover { background: var(--bg3); }
.cust-avatar { width: 38px; height: 38px; border-radius: 8px; background: linear-gradient(135deg,var(--accent),var(--accent2)); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
.cust-info { flex: 1; }
.cust-name { font-weight: 600; font-size: 13px; margin-bottom: 2px; }
.cust-meta { font-size: 11px; color: var(--text2); }
.cust-tags { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
.pill { font-size: 10px; padding: 2px 8px; border-radius: 10px; background: var(--bg4); color: var(--text1); }

/* â”€â”€ Loading spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spinner {
  display: inline-block; width: 16px; height: 16px;
  border: 2px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin .6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast-container {
  position: fixed; bottom: 20px; right: 20px;
  display: flex; flex-direction: column; gap: 8px; z-index: 9999;
}
.toast {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 10px 16px;
  font-size: 12px; color: var(--text0); box-shadow: 0 4px 20px rgba(0,0,0,.4);
  animation: slideIn .2s ease;
  display: flex; align-items: center; gap: 8px;
}
.toast.success { border-left: 3px solid var(--green); }
.toast.error   { border-left: 3px solid var(--red); }
.toast.info    { border-left: 3px solid var(--accent); }
@keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

/* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg4); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border); }
</style>
</head>
<body>

<div id="app">

  <!-- â”€â”€ Sidebar â”€â”€ -->
  <aside id="sidebar">
    <div class="logo">
      <div class="logo-mark">
        <div class="logo-icon">âŒš</div>
        <div>
          <div class="logo-text">Tick Tock Inc.</div>
          <div class="logo-sub">ERP Â· Inventory</div>
        </div>
      </div>
    </div>

    <nav>
      <div class="nav-label">Inventory</div>
      <button class="nav-item active" data-section="overview" onclick="navigate('overview')">
        <span class="icon">ğŸ“Š</span> Stock Overview
      </button>
      <button class="nav-item" data-section="catalog" onclick="navigate('catalog')">
        <span class="icon">ğŸ“¦</span> Item Catalog
      </button>
      <button class="nav-item" data-section="alerts" onclick="navigate('alerts')">
        <span class="icon">ğŸ””</span> Reorder Alerts
        <span class="nav-badge" id="alert-badge">0</span>
      </button>
      <button class="nav-item" data-section="adjustments" onclick="navigate('adjustments')">
        <span class="icon">ğŸ“‹</span> Adjustments
      </button>
      <div class="nav-label" style="margin-top:12px">Modules</div>
      <button class="nav-item" onclick="window.location.href='/sales'">
        <span class="icon">ğŸ§¾</span> Sales Orders
      </button>
    </nav>

    <div class="sidebar-footer">
      <span class="conn-dot" id="conn-dot"></span>
      <span id="conn-status">Connectingâ€¦</span>
    </div>
  </aside>

  <!-- â”€â”€ Main â”€â”€ -->
  <div id="main">

    <!-- Top Bar -->
    <div id="topbar">
      <div class="topbar-title" id="page-title">Stock Overview</div>
      <div class="topbar-actions">
        <button class="btn btn-secondary btn-sm" onclick="refreshAll()">â†» Refresh</button>
        <button class="btn btn-primary btn-sm" id="action-btn" onclick="openNewItemModal()">+ New Item</button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div id="stats-bar">
      <div class="stat-card">
        <div class="stat-label">Total Items</div>
        <div class="stat-value" id="stat-items">â€”</div>
        <div class="stat-sub">active SKUs</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Inventory Value</div>
        <div class="stat-value" id="stat-value">â€”</div>
        <div class="stat-sub">at cost</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Reorder Alerts</div>
        <div class="stat-value" id="stat-alerts" style="color:var(--red)">â€”</div>
        <div class="stat-sub">items below reorder point</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Warehouses</div>
        <div class="stat-value" id="stat-wh">â€”</div>
        <div class="stat-sub">active locations</div>
      </div>
    </div>

    <!-- Content -->
    <div id="content">

      <!-- â”€â”€ Stock Overview â”€â”€ -->
      <div class="section active" id="section-overview">
        <div class="reorder-panel" id="reorder-panel" style="display:none">
          <div class="reorder-header" onclick="toggleReorderPanel()">
            <span style="font-size:15px">âš ï¸</span>
            <span class="reorder-title">Items Below Reorder Point</span>
            <span class="reorder-count" id="rp-count">0</span>
            <span class="chevron" id="rp-chevron">â–¼</span>
          </div>
          <div class="reorder-body" id="rp-body">
            <table class="reorder-table">
              <thead>
                <tr>
                  <th>SKU</th><th>Item</th><th>Category</th>
                  <th>Warehouse</th><th>On Hand</th><th>Available</th>
                  <th>Reorder Pt</th><th>Reorder Qty</th>
                </tr>
              </thead>
              <tbody id="rp-rows"></tbody>
            </table>
          </div>
        </div>

        <div class="toolbar">
          <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="ov-search" placeholder="Search SKU or nameâ€¦" oninput="filterOverview()">
          </div>
          <select class="filter" id="ov-cat" onchange="filterOverview()">
            <option value="">All Categories</option>
          </select>
          <select class="filter" id="ov-wh" onchange="filterOverview()">
            <option value="">All Warehouses</option>
          </select>
          <div class="tab-group">
            <button class="tab-btn active" data-tab="all"      onclick="setOvTab('all',this)">All</button>
            <button class="tab-btn"        data-tab="low"      onclick="setOvTab('low',this)">Low Stock</button>
            <button class="tab-btn"        data-tab="out"      onclick="setOvTab('out',this)">Out of Stock</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th>SKU</th><th>Item</th><th>Category</th><th>Warehouse</th>
                <th>On Hand</th><th>Committed</th><th>Available</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="overview-rows">
              <tr><td colspan="8" class="empty-state"><div class="spinner"></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ Item Catalog â”€â”€ -->
      <div class="section" id="section-catalog">
        <div class="toolbar">
          <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="cat-search" placeholder="Search SKU or nameâ€¦" oninput="filterCatalog()">
          </div>
          <select class="filter" id="cat-cat" onchange="filterCatalog()">
            <option value="">All Categories</option>
          </select>
        </div>
        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th>SKU</th><th>Item</th><th>Category</th><th>UOM</th>
                <th>Cost</th><th>Sale Price</th><th>Reorder Pt</th><th>Lead Time</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="catalog-rows">
              <tr><td colspan="9" class="empty-state"><div class="spinner"></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ Reorder Alerts â”€â”€ -->
      <div class="section" id="section-alerts">
        <div style="margin-bottom:16px">
          <p style="color:var(--text1);font-size:12px">Items where available quantity is at or below the reorder point.</p>
        </div>
        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th>SKU</th><th>Item</th><th>Category</th><th>Warehouse</th>
                <th>On Hand</th><th>Committed</th><th>Available</th>
                <th>Reorder Pt</th><th>Reorder Qty</th><th>Lead Time</th>
              </tr>
            </thead>
            <tbody id="alert-rows">
              <tr><td colspan="10" class="empty-state"><div class="spinner"></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ Adjustments â”€â”€ -->
      <div class="section" id="section-adjustments">
        <div class="toolbar" style="justify-content:flex-end">
          <button class="btn btn-primary btn-sm" onclick="openNewAdjModal()">+ New Adjustment</button>
        </div>
        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th>Number</th><th>Warehouse</th><th>Date</th>
                <th>Reason</th><th>Lines</th><th>Status</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="adj-rows">
              <tr><td colspan="7" class="empty-state"><div class="spinner"></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- â”€â”€ Item Detail Modal â”€â”€ -->
<div class="modal-overlay" id="detail-modal">
  <div class="modal" style="max-width:740px">
    <div class="modal-header">
      <div class="modal-title" id="detail-modal-title">Item Detail</div>
      <button class="modal-close" onclick="closeModal('detail-modal')">âœ•</button>
    </div>
    <div class="modal-body" id="detail-modal-body">
      <div class="empty-state"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<!-- â”€â”€ New Item Modal â”€â”€ -->
<div class="modal-overlay" id="new-item-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">New Item</div>
      <button class="modal-close" onclick="closeModal('new-item-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <form id="new-item-form" class="form-grid">
        <div class="form-group">
          <label class="form-label">SKU Code *</label>
          <input class="form-input" name="code" placeholder="WCH-005" required>
        </div>
        <div class="form-group">
          <label class="form-label">Name *</label>
          <input class="form-input" name="name" placeholder="Item name" required>
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <input class="form-input" name="category" placeholder="Watches">
        </div>
        <div class="form-group">
          <label class="form-label">Unit of Measure</label>
          <select class="form-input" name="unit_of_measure">
            <option value="EA">EA (Each)</option>
            <option value="PK">PK (Pack)</option>
            <option value="BX">BX (Box)</option>
            <option value="SET">SET</option>
          </select>
        </div>
        <div class="form-group full">
          <label class="form-label">Description</label>
          <textarea class="form-input" name="description" placeholder="Optional descriptionâ€¦"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Cost Method</label>
          <select class="form-input" name="cost_method">
            <option value="avg">Average Cost</option>
            <option value="fifo">FIFO</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Standard Cost ($)</label>
          <input class="form-input" name="standard_cost" type="number" step="0.01" min="0" placeholder="0.00">
        </div>
        <div class="form-group">
          <label class="form-label">Sale Price ($)</label>
          <input class="form-input" name="sale_price" type="number" step="0.01" min="0" placeholder="0.00">
        </div>
        <div class="form-group">
          <label class="form-label">Reorder Point</label>
          <input class="form-input" name="reorder_point" type="number" step="1" min="0" placeholder="0">
        </div>
        <div class="form-group">
          <label class="form-label">Reorder Qty</label>
          <input class="form-input" name="reorder_qty" type="number" step="1" min="0" placeholder="0">
        </div>
        <div class="form-group">
          <label class="form-label">Lead Time (days)</label>
          <input class="form-input" name="lead_time_days" type="number" step="1" min="0" placeholder="0">
        </div>
        <div class="form-group">
          <label class="form-label">UPC / Barcode</label>
          <div style="display:flex;gap:6px;align-items:center">
            <input class="form-input" name="upc_code" id="upc-input" placeholder="012345678901" style="flex:1">
            <button type="button" class="btn btn-secondary btn-sm" onclick="openBarcodeScanner()" title="Scan barcode with camera">ğŸ“· Scan</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Weight (lbs)</label>
          <input class="form-input" name="weight_lb" type="number" step="0.01" min="0" placeholder="0.00">
        </div>
        <div class="form-group">
          <label class="form-label">Country of Origin</label>
          <input class="form-input" name="country_of_origin" placeholder="China">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('new-item-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitNewItem()">Create Item</button>
    </div>
  </div>
</div>

<!-- â”€â”€ New Adjustment Modal â”€â”€ -->
<div class="modal-overlay" id="new-adj-modal">
  <div class="modal" style="max-width:780px">
    <div class="modal-header">
      <div class="modal-title">New Stock Adjustment</div>
      <button class="modal-close" onclick="closeModal('new-adj-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid" style="margin-bottom:16px">
        <div class="form-group">
          <label class="form-label">Warehouse *</label>
          <select class="form-input" id="adj-warehouse">
            <option value="">Select warehouseâ€¦</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Adjustment Date</label>
          <input class="form-input" type="date" id="adj-date">
        </div>
        <div class="form-group">
          <label class="form-label">Reason</label>
          <input class="form-input" id="adj-reason" placeholder="Cycle count, damage, etc.">
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <input class="form-input" id="adj-notes" placeholder="Optional notes">
        </div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-size:12px;font-weight:600;color:var(--text1);text-transform:uppercase;letter-spacing:.07em">Lines</div>
        <button class="btn btn-secondary btn-sm" onclick="addAdjLine()">+ Add Line</button>
      </div>
      <div class="table-wrap">
        <table class="adj-lines-table">
          <thead>
            <tr>
              <th>Item</th><th>System Qty</th><th>Actual Qty</th><th>Unit Cost</th><th></th>
            </tr>
          </thead>
          <tbody id="adj-lines-body">
            <tr><td colspan="5" style="padding:16px;text-align:center;color:var(--text2)">Click "+ Add Line" to add items</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('new-adj-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitAdj()">Save as Draft</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Barcode Scanner Modal â”€â”€ -->
<div class="modal-overlay" id="barcode-modal" style="z-index:2000">
  <div class="modal modal-sm">
    <div class="modal-header">
      <div class="modal-title">Scan Barcode</div>
      <button class="modal-close" onclick="closeBarcodeScanner()">âœ•</button>
    </div>
    <div class="modal-body" style="text-align:center">
      <div id="barcode-status" style="margin-bottom:10px;font-size:13px;color:var(--text2)">Starting cameraâ€¦</div>
      <video id="barcode-video" style="width:100%;max-width:400px;border-radius:6px;background:#000" autoplay muted playsinline></video>
      <canvas id="barcode-canvas" style="display:none"></canvas>
      <div style="margin-top:12px;font-size:12px;color:var(--text2)">
        Point the camera at a UPC barcode.<br>
        <span style="font-size:11px;color:var(--text3)">BarcodeDetector API required (Chrome/Edge).</span>
      </div>
      <div style="margin-top:10px">
        <label class="form-label" style="margin-bottom:4px">Or enter manually:</label>
        <div style="display:flex;gap:6px">
          <input class="form-input" id="barcode-manual-input" placeholder="Enter barcodeâ€¦" style="flex:1">
          <button class="btn btn-primary btn-sm" onclick="applyBarcode($('barcode-manual-input').value)">Apply</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeBarcodeScanner()">Cancel</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Toast Container â”€â”€ -->
<div id="toast-container"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = 'http://localhost:3001';
let apiOnline = false;
let currentSection = 'overview';
let ovTab = 'all';

// Data caches
let allStock = [];
let allItems = [];
let allWarehouses = [];
let allAlerts = [];
let allAdjs = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOCK DATA (fallback when API is offline)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MOCK_STOCK = [
  { item_id:'1', item_code:'WCH-001', item_name:'Classic Silver Watch',       category:'Watches',     warehouse_code:'MAIN', qty_on_hand:45, qty_committed:5,  qty_available:40, sale_price:149.99, reorder_point:10 },
  { item_id:'2', item_code:'WCH-002', item_name:'Sport Chronograph Watch',    category:'Watches',     warehouse_code:'MAIN', qty_on_hand:30, qty_committed:8,  qty_available:22, sale_price:219.99, reorder_point:8  },
  { item_id:'3', item_code:'WCH-003', item_name:'Gold Dress Watch',           category:'Watches',     warehouse_code:'MAIN', qty_on_hand:12, qty_committed:0,  qty_available:12, sale_price:399.99, reorder_point:5  },
  { item_id:'4', item_code:'WCH-004', item_name:'Digital Smart Watch',        category:'Watches',     warehouse_code:'MAIN', qty_on_hand:55, qty_committed:10, qty_available:45, sale_price:179.99, reorder_point:12 },
  { item_id:'5', item_code:'STR-001', item_name:'Leather Watch Strap 20mm',   category:'Straps',      warehouse_code:'MAIN', qty_on_hand:200,qty_committed:0,  qty_available:200,sale_price:24.99,  reorder_point:50 },
  { item_id:'6', item_code:'STR-002', item_name:'NATO Nylon Strap 22mm',      category:'Straps',      warehouse_code:'MAIN', qty_on_hand:8,  qty_committed:0,  qty_available:8,  sale_price:14.99,  reorder_point:75 },
  { item_id:'7', item_code:'BOX-001', item_name:'Luxury Watch Box',           category:'Packaging',   warehouse_code:'MAIN', qty_on_hand:25, qty_committed:0,  qty_available:25, sale_price:34.99,  reorder_point:30 },
  { item_id:'8', item_code:'ACC-001', item_name:'Watch Cleaning Kit',         category:'Accessories', warehouse_code:'MAIN', qty_on_hand:5,  qty_committed:0,  qty_available:5,  sale_price:19.99,  reorder_point:40 },
];
const MOCK_ITEMS = MOCK_STOCK.map(s => ({
  id: s.item_id, code: s.item_code, name: s.item_name, category: s.category,
  unit_of_measure:'EA', cost_method:'avg', standard_cost: s.sale_price * 0.55,
  sale_price: s.sale_price, reorder_point: s.reorder_point, reorder_qty: 20,
  lead_time_days: 14, is_active: true
}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiFetch(path, opts = {}) {
  const res = await fetch(`${API}${path}`, {
    ...opts,
    headers: { 'Content-Type': 'application/json', ...(opts.headers||{}) }
  });
  if (!res.ok) {
    const body = await res.json().catch(() => ({}));
    throw new Error(body.error || `HTTP ${res.status}`);
  }
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONNECTION CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkConnection() {
  try {
    await apiFetch('/health');
    apiOnline = true;
    document.getElementById('conn-dot').classList.remove('offline');
    document.getElementById('conn-status').textContent = 'API Connected';
  } catch {
    apiOnline = false;
    document.getElementById('conn-dot').classList.add('offline');
    document.getElementById('conn-status').textContent = 'Offline (mock data)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
  try {
    if (apiOnline) {
      const d = await apiFetch('/api/stock/dashboard');
      document.getElementById('stat-items').textContent  = d.total_items;
      document.getElementById('stat-value').textContent  = '$' + fmt(d.total_value);
      document.getElementById('stat-alerts').textContent = d.reorder_alert_count;
      document.getElementById('stat-wh').textContent     = d.warehouse_count;
      document.getElementById('alert-badge').textContent = d.reorder_alert_count;
    } else {
      document.getElementById('stat-items').textContent  = MOCK_STOCK.length;
      document.getElementById('stat-value').textContent  = '$' + fmt(MOCK_STOCK.reduce((s,r)=>s+r.qty_on_hand*r.sale_price*0.55,0));
      const alertCount = MOCK_STOCK.filter(r=>r.qty_available<=r.reorder_point).length;
      document.getElementById('stat-alerts').textContent = alertCount;
      document.getElementById('stat-wh').textContent     = 2;
      document.getElementById('alert-badge').textContent = alertCount;
    }
  } catch(e) { console.error(e); }
}

async function loadStock() {
  try {
    allStock = apiOnline ? await apiFetch('/api/stock') : MOCK_STOCK;
    renderOverview();
    loadReorderPanel();
  } catch(e) { console.error(e); }
}

async function loadItems() {
  try {
    allItems = apiOnline ? await apiFetch('/api/items') : MOCK_ITEMS;
    // Populate category filters
    const cats = [...new Set(allItems.map(i=>i.category).filter(Boolean))].sort();
    populateCategoryFilters(cats);
    renderCatalog();
  } catch(e) { console.error(e); }
}

async function loadWarehouses() {
  try {
    allWarehouses = apiOnline ? await apiFetch('/api/warehouses')
      : [{id:'1',code:'MAIN',name:'Main Warehouse'},{id:'2',code:'OVERFLOW',name:'Overflow Warehouse'}];
    // Populate warehouse filter
    const sel = document.getElementById('ov-wh');
    sel.innerHTML = '<option value="">All Warehouses</option>';
    allWarehouses.forEach(w => {
      const o = document.createElement('option'); o.value = w.code; o.textContent = w.name;
      sel.appendChild(o);
    });
    // Adj warehouse select
    const adjSel = document.getElementById('adj-warehouse');
    adjSel.innerHTML = '<option value="">Select warehouseâ€¦</option>';
    allWarehouses.forEach(w => {
      const o = document.createElement('option'); o.value = w.id; o.textContent = `${w.code} â€” ${w.name}`;
      adjSel.appendChild(o);
    });
  } catch(e) { console.error(e); }
}

async function loadAlerts() {
  try {
    allAlerts = apiOnline ? await apiFetch('/api/stock/reorder-alerts') : MOCK_STOCK.filter(r=>r.qty_available<=r.reorder_point);
    renderAlerts();
  } catch(e) { console.error(e); }
}

async function loadAdjs() {
  try {
    allAdjs = apiOnline ? await apiFetch('/api/adjustments') : [];
    renderAdjs();
  } catch(e) { console.error(e); }
}

async function loadReorderPanel() {
  const alerts = apiOnline ? await apiFetch('/api/stock/reorder-alerts').catch(()=>[]) : MOCK_STOCK.filter(r=>r.qty_available<=r.reorder_point);
  const panel = document.getElementById('reorder-panel');
  document.getElementById('rp-count').textContent = alerts.length;
  if (alerts.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = '';
  document.getElementById('rp-rows').innerHTML = alerts.map(r => `
    <tr onclick="openDetailModal('${r.item_id}')">
      <td><span class="code-tag">${r.item_code}</span></td>
      <td>${r.item_name}</td>
      <td><span class="cat-badge">${r.category||'â€”'}</span></td>
      <td>${r.warehouse_code}</td>
      <td class="qty-cell">${r.qty_on_hand}</td>
      <td class="qty-cell ${qtyClass(r)}">${r.qty_available}</td>
      <td>${r.reorder_point}</td>
      <td style="color:var(--accent)">${r.reorder_qty}</td>
    </tr>
  `).join('');
}

async function refreshAll() {
  await checkConnection();
  await Promise.all([loadDashboard(), loadStock(), loadItems(), loadAlerts(), loadAdjs()]);
  toast('Data refreshed', 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function qtyClass(r) {
  const av = parseFloat(r.qty_available);
  if (av <= 0) return 'qty-out';
  if (av <= parseFloat(r.reorder_point)) return 'qty-warn';
  return 'qty-ok';
}
function statusBadge(r) {
  const av = parseFloat(r.qty_available);
  if (av <= 0) return '<span class="status-badge badge-out">â¬¤ Out of Stock</span>';
  if (av <= parseFloat(r.reorder_point)) return '<span class="status-badge badge-low">â¬¤ Low Stock</span>';
  return '<span class="status-badge badge-ok">â¬¤ In Stock</span>';
}
function fmt(n) {
  const v = parseFloat(n)||0;
  return v >= 1000 ? v.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}) : v.toFixed(2);
}

function renderOverview() {
  const q     = (document.getElementById('ov-search').value||'').toLowerCase();
  const cat   = document.getElementById('ov-cat').value;
  const wh    = document.getElementById('ov-wh').value;

  let rows = allStock.filter(r => {
    if (q && !r.item_code.toLowerCase().includes(q) && !r.item_name.toLowerCase().includes(q)) return false;
    if (cat && r.category !== cat) return false;
    if (wh  && r.warehouse_code !== wh) return false;
    if (ovTab === 'low') return parseFloat(r.qty_available) > 0 && parseFloat(r.qty_available) <= parseFloat(r.reorder_point);
    if (ovTab === 'out') return parseFloat(r.qty_available) <= 0;
    return true;
  });

  const tbody = document.getElementById('overview-rows');
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">ğŸ“¦</div><div class="empty-msg">No items match your filters</div></div></td></tr>`;
    return;
  }
  tbody.innerHTML = rows.map(r => `
    <tr onclick="openDetailModal('${r.item_id}')">
      <td><span class="code-tag">${r.item_code}</span></td>
      <td><span class="item-name">${r.item_name}</span></td>
      <td><span class="cat-badge">${r.category||'â€”'}</span></td>
      <td>${r.warehouse_code}</td>
      <td class="qty-cell">${r.qty_on_hand}</td>
      <td class="qty-cell" style="color:var(--orange)">${r.qty_committed}</td>
      <td class="qty-cell ${qtyClass(r)}">${r.qty_available}</td>
      <td>${statusBadge(r)}</td>
    </tr>
  `).join('');
}

function renderCatalog() {
  const q   = (document.getElementById('cat-search').value||'').toLowerCase();
  const cat = document.getElementById('cat-cat').value;
  let rows  = allItems.filter(r => {
    if (q && !r.code.toLowerCase().includes(q) && !r.name.toLowerCase().includes(q)) return false;
    if (cat && r.category !== cat) return false;
    return true;
  });
  const tbody = document.getElementById('catalog-rows');
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">ğŸ“¦</div><div class="empty-msg">No items found</div></div></td></tr>`;
    return;
  }
  tbody.innerHTML = rows.map(r => `
    <tr onclick="openDetailModal('${r.id}')">
      <td><span class="code-tag">${r.code}</span></td>
      <td><span class="item-name">${r.name}</span></td>
      <td><span class="cat-badge">${r.category||'â€”'}</span></td>
      <td>${r.unit_of_measure}</td>
      <td>$${parseFloat(r.standard_cost).toFixed(2)}</td>
      <td>$${parseFloat(r.sale_price).toFixed(2)}</td>
      <td>${r.reorder_point}</td>
      <td>${r.lead_time_days}d</td>
      <td>${r.is_active ? '<span class="status-badge badge-ok">Active</span>' : '<span class="status-badge badge-out">Inactive</span>'}</td>
    </tr>
  `).join('');
}

function renderAlerts() {
  const tbody = document.getElementById('alert-rows');
  if (!allAlerts.length) {
    tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-msg">No reorder alerts â€” all stock levels are healthy!</div></div></td></tr>`;
    return;
  }
  tbody.innerHTML = allAlerts.map(r => `
    <tr onclick="openDetailModal('${r.item_id}')">
      <td><span class="code-tag">${r.item_code}</span></td>
      <td><span class="item-name">${r.item_name}</span></td>
      <td><span class="cat-badge">${r.category||'â€”'}</span></td>
      <td>${r.warehouse_code}</td>
      <td class="qty-cell">${r.qty_on_hand}</td>
      <td class="qty-cell" style="color:var(--orange)">${r.qty_committed}</td>
      <td class="qty-cell ${qtyClass(r)}">${r.qty_available}</td>
      <td>${r.reorder_point}</td>
      <td style="color:var(--accent);font-weight:600">${r.reorder_qty}</td>
      <td style="color:var(--text1)">${r.lead_time_days}d</td>
    </tr>
  `).join('');
}

function renderAdjs() {
  const tbody = document.getElementById('adj-rows');
  if (!allAdjs.length) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-msg">No adjustments yet. Click "+ New Adjustment" to create one.</div></div></td></tr>`;
    return;
  }
  tbody.innerHTML = allAdjs.map(a => `
    <tr>
      <td><span class="code-tag">${a.number}</span></td>
      <td>${a.warehouse_code}</td>
      <td>${a.adjustment_date ? a.adjustment_date.slice(0,10) : 'â€”'}</td>
      <td>${a.reason || 'â€”'}</td>
      <td>${a.line_count}</td>
      <td>${adjStatusBadge(a.status)}</td>
      <td>
        ${a.status === 'draft'
          ? `<button class="btn btn-success btn-sm" onclick="postAdj('${a.id}', event)">Post</button>`
          : 'â€”'}
      </td>
    </tr>
  `).join('');
}

function adjStatusBadge(s) {
  const map = { draft:'badge-draft', posted:'badge-posted', cancelled:'badge-cancelled' };
  return `<span class="status-badge ${map[s]||'badge-draft'}">${s}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateCategoryFilters(cats) {
  ['ov-cat','cat-cat'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="">All Categories</option>';
    cats.forEach(c => {
      const o = document.createElement('option'); o.value = c; o.textContent = c;
      sel.appendChild(o);
    });
  });
}
function filterOverview() { renderOverview(); }
function filterCatalog()  { renderCatalog();  }
function setOvTab(tab, btn) {
  ovTab = tab;
  document.querySelectorAll('[data-tab]').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderOverview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const sectionTitles = {
  overview: 'Stock Overview', catalog: 'Item Catalog',
  alerts: 'Reorder Alerts', adjustments: 'Stock Adjustments'
};
function navigate(section) {
  currentSection = section;
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(`section-${section}`).classList.add('active');
  document.querySelector(`[data-section="${section}"]`).classList.add('active');
  document.getElementById('page-title').textContent = sectionTitles[section];

  // Load on demand
  if (section === 'alerts')      loadAlerts();
  if (section === 'adjustments') loadAdjs();
  if (section === 'catalog')     renderCatalog();

  // Toggle top action button
  const btn = document.getElementById('action-btn');
  if (section === 'adjustments') {
    btn.textContent = '+ New Adjustment'; btn.onclick = openNewAdjModal;
  } else {
    btn.textContent = '+ New Item'; btn.onclick = openNewItemModal;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openDetailModal(itemId) {
  openModal('detail-modal');
  document.getElementById('detail-modal-title').textContent = 'Loadingâ€¦';
  document.getElementById('detail-modal-body').innerHTML = '<div class="empty-state"><div class="spinner"></div></div>';

  try {
    let item, avail, history;
    if (apiOnline) {
      [item, avail, history] = await Promise.all([
        apiFetch(`/api/items/${itemId}`),
        apiFetch(`/api/stock/${itemId}/availability`),
        apiFetch(`/api/stock/${itemId}/history`)
      ]);
    } else {
      item    = MOCK_ITEMS.find(i=>i.id===itemId) || MOCK_ITEMS[0];
      avail   = [MOCK_STOCK.find(s=>s.item_id===itemId)||MOCK_STOCK[0]];
      history = [
        { posting_date:'2024-01-01', transaction_type:'opening_balance', qty:45, warehouse_code:'MAIN', notes:'Opening balance', created_by_name:'Admin' }
      ];
    }

    document.getElementById('detail-modal-title').textContent = `${item.code} â€” ${item.name}`;

    const totalOnHand   = avail.reduce((s,r)=>s+parseFloat(r.qty_on_hand||0),0);
    const totalCommitted= avail.reduce((s,r)=>s+parseFloat(r.qty_committed||0),0);
    const totalAvailable= avail.reduce((s,r)=>s+parseFloat(r.qty_available||0),0);
    const pctCommitted  = totalOnHand>0 ? (totalCommitted/totalOnHand*100).toFixed(0) : 0;
    const pctAvailable  = totalOnHand>0 ? (totalAvailable/totalOnHand*100).toFixed(0) : 0;

    document.getElementById('detail-modal-body').innerHTML = `
      <div class="detail-hero">
        <div class="detail-info">
          <div class="detail-code">${item.code} Â· ${item.unit_of_measure} Â· ${item.cost_method.toUpperCase()}</div>
          <div class="detail-name">${item.name}</div>
          ${item.description ? `<div class="detail-desc">${item.description}</div>` : ''}
          <div class="detail-meta">
            ${item.category ? `<span class="cat-badge">${item.category}</span>` : ''}
            ${item.is_active ? '<span class="status-badge badge-ok" style="font-size:10px">Active</span>' : '<span class="status-badge badge-out" style="font-size:10px">Inactive</span>'}
          </div>
        </div>
      </div>

      <div class="detail-grid">
        <div class="detail-stat">
          <div class="detail-stat-label">On Hand</div>
          <div class="detail-stat-value">${totalOnHand}</div>
          <div class="detail-stat-sub">units total</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-label">Committed</div>
          <div class="detail-stat-value" style="color:var(--orange)">${totalCommitted}</div>
          <div class="detail-stat-sub">reserved</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-label">Available</div>
          <div class="detail-stat-value" style="color:var(--green)">${totalAvailable}</div>
          <div class="detail-stat-sub">to sell/ship</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-label">Cost</div>
          <div class="detail-stat-value">$${parseFloat(item.standard_cost).toFixed(2)}</div>
          <div class="detail-stat-sub">per unit</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-label">Sale Price</div>
          <div class="detail-stat-value">$${parseFloat(item.sale_price).toFixed(2)}</div>
          <div class="detail-stat-sub">per unit</div>
        </div>
        <div class="detail-stat">
          <div class="detail-stat-label">Reorder Point</div>
          <div class="detail-stat-value">${item.reorder_point}</div>
          <div class="detail-stat-sub">${item.lead_time_days}d lead time</div>
        </div>
      </div>

      <div class="stock-bar-wrap">
        <div class="stock-bar-label">
          <span>Stock Breakdown</span>
          <span style="color:var(--text2)">${pctCommitted}% committed Â· ${pctAvailable}% available</span>
        </div>
        <div class="stock-bar-track">
          <div class="stock-bar-committed" style="width:${pctCommitted}%"></div>
          <div class="stock-bar-available" style="left:${pctCommitted}%;width:${Math.min(100-pctCommitted,pctAvailable)}%"></div>
        </div>
      </div>

      ${avail.length > 1 ? `
      <div style="margin-bottom:16px">
        <div class="history-title">By Warehouse</div>
        ${avail.map(a=>`
          <div class="history-row">
            <div style="font-weight:600;width:100px">${a.warehouse_code}</div>
            <div>On Hand: <b>${a.qty_on_hand}</b></div>
            <div style="color:var(--orange)">Committed: <b>${a.qty_committed}</b></div>
            <div style="color:var(--green)">Available: <b>${a.qty_available}</b></div>
          </div>
        `).join('')}
      </div>` : ''}

      <div class="history-title">Movement History</div>
      ${history.length ? history.slice(0,30).map(h=>`
        <div class="history-row">
          <div class="hist-date">${h.posting_date?.slice?.(0,10)||'â€”'}</div>
          <div class="hist-type">${h.transaction_type?.replace(/_/g,' ')}</div>
          <div class="hist-qty ${parseFloat(h.qty)>=0?'qty-ok':'qty-out'}">${parseFloat(h.qty)>=0?'+':''}${h.qty}</div>
          <div class="hist-wh">${h.warehouse_code||''}</div>
          <div class="hist-notes">${h.notes||'â€”'}</div>
        </div>
      `).join('') : '<div style="color:var(--text2);font-size:12px;padding:8px 0">No movement history</div>'}
    `;
  } catch(e) {
    document.getElementById('detail-modal-body').innerHTML = `<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-msg">${e.message}</div></div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW ITEM MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNewItemModal() { openModal('new-item-modal'); }

async function submitNewItem() {
  const form = document.getElementById('new-item-form');
  const data = Object.fromEntries(new FormData(form));
  if (!data.code || !data.name) { toast('Code and Name are required', 'error'); return; }
  ['standard_cost','sale_price','reorder_point','reorder_qty','lead_time_days']
    .forEach(k => { if (data[k] !== undefined) data[k] = parseFloat(data[k])||0; });
  if (data.weight_lb !== undefined && data.weight_lb !== '') data.weight_lb = parseFloat(data.weight_lb) || null;
  else delete data.weight_lb;
  if (!data.upc_code) delete data.upc_code;
  if (!data.country_of_origin) delete data.country_of_origin;

  if (!apiOnline) {
    toast('API offline â€” cannot save items in mock mode', 'error'); return;
  }
  try {
    await apiFetch('/api/items', { method:'POST', body: JSON.stringify(data) });
    toast(`Item ${data.code} created!`, 'success');
    closeModal('new-item-modal');
    form.reset();
    await loadItems();
    await loadStock();
  } catch(e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADJUSTMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNewAdjModal() {
  document.getElementById('adj-date').value = new Date().toISOString().slice(0,10);
  document.getElementById('adj-lines-body').innerHTML = `<tr><td colspan="5" style="padding:16px;text-align:center;color:var(--text2)">Click "+ Add Line" to add items</td></tr>`;
  openModal('new-adj-modal');
}

function addAdjLine() {
  const tbody = document.getElementById('adj-lines-body');
  const emptyRow = tbody.querySelector('td[colspan]');
  if (emptyRow) tbody.innerHTML = '';
  const tr = document.createElement('tr');
  const itemOpts = allItems.map(i=>`<option value="${i.id}" data-cost="${i.standard_cost}">${i.code} â€” ${i.name}</option>`).join('');
  tr.innerHTML = `
    <td>
      <select class="form-input adj-item-sel" style="width:100%;font-size:12px" onchange="onAdjItemChange(this)">
        <option value="">Select itemâ€¦</option>${itemOpts}
      </select>
    </td>
    <td><input class="form-input adj-sys-qty" style="width:80px;font-size:12px" readonly placeholder="auto"></td>
    <td><input class="form-input adj-act-qty" type="number" style="width:80px;font-size:12px" placeholder="0" step="0.01"></td>
    <td><input class="form-input adj-cpu" type="number" style="width:80px;font-size:12px" placeholder="0.00" step="0.01"></td>
    <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">âœ•</button></td>
  `;
  tbody.appendChild(tr);
}

async function onAdjItemChange(sel) {
  const itemId = sel.value;
  const row    = sel.closest('tr');
  const sysQtyInput = row.querySelector('.adj-sys-qty');
  const cpuInput    = row.querySelector('.adj-cpu');

  // Set cost from item
  const opt = sel.options[sel.selectedIndex];
  const cost = opt?.dataset?.cost;
  if (cost) cpuInput.value = parseFloat(cost).toFixed(2);

  if (!itemId || !apiOnline) { sysQtyInput.value = ''; return; }

  const warehouseId = document.getElementById('adj-warehouse').value;
  if (!warehouseId) { sysQtyInput.value = '?'; return; }

  try {
    const avail = await apiFetch(`/api/stock/${itemId}/availability`);
    const row2  = avail.find(a=>a.warehouse_id===warehouseId);
    sysQtyInput.value = row2 ? row2.qty_on_hand : '0';
  } catch { sysQtyInput.value = '?'; }
}

async function submitAdj() {
  const warehouseId = document.getElementById('adj-warehouse').value;
  if (!warehouseId) { toast('Please select a warehouse', 'error'); return; }

  const lines = [];
  document.querySelectorAll('#adj-lines-body tr').forEach(tr => {
    const itemSel = tr.querySelector('.adj-item-sel');
    const actQty  = tr.querySelector('.adj-act-qty');
    const cpu     = tr.querySelector('.adj-cpu');
    if (!itemSel || !itemSel.value) return;
    lines.push({
      item_id:      itemSel.value,
      qty_actual:   parseFloat(actQty?.value)||0,
      cost_per_unit:parseFloat(cpu?.value)||0
    });
  });

  if (!lines.length) { toast('Add at least one line', 'error'); return; }

  if (!apiOnline) { toast('API offline â€” cannot save adjustments in mock mode', 'error'); return; }

  try {
    const payload = {
      warehouse_id:    warehouseId,
      adjustment_date: document.getElementById('adj-date').value,
      reason:          document.getElementById('adj-reason').value,
      notes:           document.getElementById('adj-notes').value,
      lines
    };
    const adj = await apiFetch('/api/adjustments', { method:'POST', body: JSON.stringify(payload) });
    toast(`Adjustment ${adj.number} created as Draft`, 'success');
    closeModal('new-adj-modal');
    await loadAdjs();
  } catch(e) { toast(e.message, 'error'); }
}

async function postAdj(adjId, e) {
  e.stopPropagation();
  if (!apiOnline) { toast('API offline', 'error'); return; }
  if (!confirm('Post this adjustment to the stock ledger?')) return;
  try {
    const res = await apiFetch(`/api/adjustments/${adjId}/post`, { method:'POST', body:'{}' });
    toast(`Adjustment ${res.number} posted successfully!`, 'success');
    await Promise.all([loadAdjs(), loadStock(), loadDashboard()]);
  } catch(e) { toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REORDER PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleReorderPanel() {
  const body    = document.getElementById('rp-body');
  const header  = document.querySelector('.reorder-header');
  const chevron = document.getElementById('rp-chevron');
  const open    = body.classList.toggle('open');
  header.classList.toggle('open', open);
  chevron.classList.toggle('open', open);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// Close on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type='info') {
  const icons = { success:'âœ…', error:'âŒ', info:'â„¹ï¸' };
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span>${icons[type]||''}</span><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BARCODE SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let barcodeStream = null;
let barcodeDetector = null;
let barcodeScanInterval = null;

function $b(id) { return document.getElementById(id); }

async function openBarcodeScanner() {
  openModal('barcode-modal');
  $b('barcode-status').textContent = 'Starting cameraâ€¦';
  $b('barcode-manual-input').value = '';

  // Check BarcodeDetector support
  if (!('BarcodeDetector' in window)) {
    $b('barcode-status').textContent = 'Camera scan not supported in this browser. Use manual entry below.';
    return;
  }

  try {
    barcodeDetector = new BarcodeDetector({ formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39'] });
    barcodeStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    const video = $b('barcode-video');
    video.srcObject = barcodeStream;
    await video.play();
    $b('barcode-status').textContent = 'Camera ready â€” point at barcode';

    // Scan every 500ms
    barcodeScanInterval = setInterval(async () => {
      try {
        const canvas  = $b('barcode-canvas');
        const ctx     = canvas.getContext('2d');
        canvas.width  = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const codes = await barcodeDetector.detect(canvas);
        if (codes.length > 0) {
          applyBarcode(codes[0].rawValue);
        }
      } catch { /* ignore decode errors */ }
    }, 500);
  } catch (err) {
    $b('barcode-status').textContent = `Camera error: ${err.message}. Use manual entry below.`;
  }
}

function closeBarcodeScanner() {
  clearInterval(barcodeScanInterval);
  if (barcodeStream) { barcodeStream.getTracks().forEach(t => t.stop()); barcodeStream = null; }
  const video = $b('barcode-video');
  if (video) video.srcObject = null;
  closeModal('barcode-modal');
}

function applyBarcode(code) {
  if (!code) return;
  closeBarcodeScanner();
  const upcInput = document.getElementById('upc-input');
  if (upcInput) {
    upcInput.value = code.trim();
    toast(`Barcode scanned: ${code}`, 'success');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init() {
  await checkConnection();
  await loadWarehouses();
  await Promise.all([loadDashboard(), loadStock(), loadItems()]);
})();
</script>
</body>
</html>
