<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TICK TOCK INC. | Inventory Management</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* â”€â”€ Reset & Root â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --navy:    #1e2a3a;
  --navy2:   #243347;
  --navy3:   #162130;
  --sidebar-w: 240px;
  --header-h:  60px;
  --blue:    #2563eb;
  --blue-h:  #1d4ed8;
  --blue-l:  #3b82f6;
  --blue-bg: rgba(37,99,235,.08);
  --green:   #10b981;
  --yellow:  #f59e0b;
  --red:     #ef4444;
  --orange:  #f97316;
  --purple:  #8b5cf6;
  --bg:      #f0f4f8;
  --bg2:     #e8eef5;
  --card:    #ffffff;
  --border:  #dde5ef;
  --border2: #c8d5e5;
  --text0:   #0f1923;
  --text1:   #374151;
  --text2:   #64748b;
  --text3:   #94a3b8;
  --radius:  10px;
  --radius-sm: 6px;
  --shadow:  0 1px 3px rgba(15,25,40,.08),0 4px 16px rgba(15,25,40,.06);
  --shadow-lg: 0 4px 24px rgba(15,25,40,.12),0 1px 4px rgba(15,25,40,.08);
}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text0);font-size:13px;line-height:1.5}
button{cursor:pointer;font-family:inherit;font-size:13px}
input,select,textarea{font-family:inherit;font-size:13px}
a{color:var(--blue);text-decoration:none}

/* â”€â”€ Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:flex;height:100vh;overflow:hidden}

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar{
  width:var(--sidebar-w);min-width:var(--sidebar-w);
  background:var(--navy);display:flex;flex-direction:column;
  overflow:hidden;z-index:100;
}
.sidebar-logo{
  padding:18px 20px 16px;border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;align-items:center;gap:12px;flex-shrink:0;
}
.sidebar-logo-icon{
  width:36px;height:36px;border-radius:9px;
  background:linear-gradient(135deg,var(--blue),var(--blue-l));
  display:flex;align-items:center;justify-content:center;
  font-size:18px;flex-shrink:0;box-shadow:0 4px 12px rgba(37,99,235,.4);
}
.sidebar-logo-text .co{font-size:13px;font-weight:800;color:#fff;letter-spacing:.03em}
.sidebar-logo-text .sub{font-size:9.5px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.1em}

.sidebar-nav{padding:12px 10px;flex:1;overflow-y:auto}
.nav-section{margin-bottom:4px}
.nav-label{
  font-size:9.5px;font-weight:700;color:rgba(255,255,255,.3);
  text-transform:uppercase;letter-spacing:.12em;
  padding:10px 10px 4px;
}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:8px 10px;border-radius:var(--radius-sm);
  color:rgba(255,255,255,.55);font-size:13px;font-weight:500;
  cursor:pointer;transition:all .12s;margin-bottom:1px;
  border:none;background:none;width:100%;text-align:left;
}
.nav-item:hover{background:rgba(255,255,255,.07);color:rgba(255,255,255,.85)}
.nav-item.active{background:rgba(37,99,235,.25);color:#fff}
.nav-item .ni{font-size:15px;width:18px;text-align:center;flex-shrink:0}
.nav-badge{
  margin-left:auto;background:var(--red);color:#fff;
  font-size:10px;font-weight:700;border-radius:10px;
  padding:1px 6px;min-width:18px;text-align:center;
}
.nav-badge-yellow{background:var(--yellow);color:#000}

.sidebar-footer{
  padding:12px 16px;border-top:1px solid rgba(255,255,255,.08);
  font-size:11px;color:rgba(255,255,255,.3);
  display:flex;align-items:center;justify-content:space-between;
}

/* â”€â”€ Main Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#header{
  height:var(--header-h);min-height:var(--header-h);
  background:var(--card);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 24px;gap:16px;
  z-index:50;flex-shrink:0;
}
.header-page-title{font-size:16px;font-weight:700;color:var(--text0);flex:1}
.header-actions{display:flex;align-items:center;gap:12px}

.notif-btn{
  width:36px;height:36px;border-radius:var(--radius-sm);
  background:none;border:1.5px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:16px;color:var(--text2);transition:all .12s;position:relative;
}
.notif-btn:hover{background:var(--bg);border-color:var(--border2)}
.notif-dot{
  position:absolute;top:5px;right:5px;width:7px;height:7px;
  border-radius:50%;background:var(--red);border:1.5px solid var(--card);
}

.user-chip{
  display:flex;align-items:center;gap:9px;padding:5px 12px 5px 5px;
  background:var(--bg);border:1.5px solid var(--border);border-radius:30px;
  cursor:pointer;transition:all .12s;
}
.user-chip:hover{background:var(--bg2);border-color:var(--border2)}
.user-avatar{
  width:28px;height:28px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;color:#fff;flex-shrink:0;
}
.user-info{line-height:1.3}
.user-name{font-size:12px;font-weight:600;color:var(--text0)}
.user-role{font-size:10px;color:var(--text2)}
.role-badge{
  font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;
  padding:2px 7px;border-radius:4px;
}
.role-admin    {background:rgba(245,158,11,.12);color:#b45309}
.role-warehouse{background:rgba(16,185,129,.12);color:#047857}
.role-sales    {background:rgba(37,99,235,.12);color:#1d4ed8}

.signout-btn{
  padding:7px 14px;border:none;border-radius:var(--radius-sm);
  background:none;color:var(--text2);font-size:12px;font-weight:500;
  border:1.5px solid var(--border);transition:all .12s;
}
.signout-btn:hover{background:var(--red);color:#fff;border-color:var(--red)}

/* â”€â”€ Content Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#content{flex:1;overflow-y:auto;padding:24px}

/* â”€â”€ Page sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page{display:none}
.page.active{display:block}

/* â”€â”€ KPI Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.kpi-card{
  background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  padding:20px;box-shadow:var(--shadow);transition:box-shadow .12s;
}
.kpi-card:hover{box-shadow:var(--shadow-lg)}
.kpi-label{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.kpi-label .ki{font-size:14px}
.kpi-value{font-size:28px;font-weight:800;color:var(--text0);line-height:1}
.kpi-value.blue{color:var(--blue)}
.kpi-value.green{color:var(--green)}
.kpi-value.red{color:var(--red)}
.kpi-value.yellow{color:var(--yellow)}
.kpi-sub{font-size:11px;color:var(--text3);margin-top:6px}

/* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.card-header{
  padding:16px 20px;display:flex;align-items:center;gap:12px;
  border-bottom:1px solid var(--border);
}
.card-title{font-size:14px;font-weight:700;color:var(--text0);flex:1}
.card-body{padding:0}

/* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.search-wrap{position:relative;flex:1;min-width:200px;max-width:340px}
.search-wrap input{
  width:100%;padding:8px 12px 8px 36px;
  border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--card);color:var(--text0);outline:none;
  transition:border-color .12s,box-shadow .12s;
}
.search-wrap input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:14px;pointer-events:none}
.filter-select{
  padding:8px 12px;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--card);color:var(--text1);outline:none;cursor:pointer;
  transition:border-color .12s;
}
.filter-select:focus{border-color:var(--blue)}

/* â”€â”€ Tab Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tab-bar{display:flex;gap:4px;background:var(--bg2);padding:4px;border-radius:var(--radius-sm);margin-bottom:16px}
.tab{
  padding:7px 14px;border-radius:6px;border:none;background:none;
  color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;
  transition:all .12s;white-space:nowrap;
}
.tab.active{background:var(--card);color:var(--blue);box-shadow:0 1px 3px rgba(0,0,0,.1)}
.tab:hover:not(.active){color:var(--text0)}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 14px;border-radius:var(--radius-sm);border:none;
  font-size:12px;font-weight:600;cursor:pointer;transition:all .12s;
  white-space:nowrap;
}
.btn-primary{background:var(--blue);color:#fff}
.btn-primary:hover{background:var(--blue-h)}
.btn-ghost{background:none;border:1.5px solid var(--border);color:var(--text1)}
.btn-ghost:hover{background:var(--bg);border-color:var(--border2)}
.btn-danger{background:none;border:1.5px solid transparent;color:var(--red)}
.btn-danger:hover{background:rgba(239,68,68,.08);border-color:var(--red)}
.btn-success{background:var(--green);color:#fff}
.btn-success:hover{background:#059669}
.btn-warning{background:var(--yellow);color:#000}
.btn-warning:hover{background:#d97706}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-icon{width:30px;height:30px;padding:0;justify-content:center;font-size:14px}

/* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{
  padding:10px 14px;text-align:left;font-size:11px;font-weight:700;
  color:var(--text2);text-transform:uppercase;letter-spacing:.06em;
  background:var(--bg);border-bottom:1px solid var(--border);
  white-space:nowrap;
}
thead th.sort-asc::after{content:' â†‘'}
thead th.sort-desc::after{content:' â†“'}
thead th[data-sort]{cursor:pointer;user-select:none}
thead th[data-sort]:hover{color:var(--text0)}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:var(--bg)}
tbody tr:nth-child(even){background:rgba(240,244,248,.6)}
tbody tr:nth-child(even):hover{background:var(--bg)}
td{padding:10px 14px;color:var(--text1);vertical-align:middle}
td .cell-main{font-weight:600;color:var(--text0)}
td .cell-sub{font-size:11px;color:var(--text2);margin-top:1px}

/* â”€â”€ Status Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 8px;border-radius:20px;font-size:10px;font-weight:700;
  text-transform:uppercase;letter-spacing:.06em;white-space:nowrap;
}
.badge::before{content:'â—';font-size:7px}
.badge-green {background:rgba(16,185,129,.12);color:#047857}
.badge-yellow{background:rgba(245,158,11,.12);color:#b45309}
.badge-red   {background:rgba(239,68,68,.12);color:#b91c1c}
.badge-blue  {background:rgba(37,99,235,.12);color:#1d4ed8}
.badge-gray  {background:rgba(100,116,139,.1);color:#475569}
.badge-purple{background:rgba(139,92,246,.12);color:#7c3aed}
.badge-orange{background:rgba(249,115,22,.12);color:#c2410c}

/* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state{
  padding:60px 20px;text-align:center;
}
.empty-icon{font-size:40px;margin-bottom:12px;opacity:.5}
.empty-title{font-size:15px;font-weight:700;color:var(--text1);margin-bottom:6px}
.empty-sub{font-size:13px;color:var(--text2);max-width:300px;margin:0 auto}

/* â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pagination{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px;border-top:1px solid var(--border);
  font-size:12px;color:var(--text2);
}
.page-btns{display:flex;gap:4px}
.page-btn{
  width:30px;height:30px;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:none;cursor:pointer;color:var(--text1);font-size:12px;
  display:flex;align-items:center;justify-content:center;transition:all .12s;
}
.page-btn:hover:not(:disabled){background:var(--bg);border-color:var(--border2)}
.page-btn.active{background:var(--blue);border-color:var(--blue);color:#fff}
.page-btn:disabled{opacity:.4;cursor:not-allowed}

/* â”€â”€ Skeleton loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.skeleton{
  background:linear-gradient(90deg,var(--bg) 25%,var(--bg2) 50%,var(--bg) 75%);
  background-size:200% 100%;animation:shimmer 1.5s infinite;
  border-radius:4px;display:inline-block;
}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skel-row td{padding:12px 14px}
.skel-cell{height:14px;border-radius:3px}

/* â”€â”€ Toast Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast-container{
  position:fixed;bottom:24px;right:24px;z-index:9999;
  display:flex;flex-direction:column;gap:10px;pointer-events:none;
}
.toast{
  display:flex;align-items:flex-start;gap:12px;
  padding:13px 16px;border-radius:var(--radius);
  background:var(--text0);color:#fff;
  box-shadow:0 8px 32px rgba(0,0,0,.2);
  font-size:13px;pointer-events:all;
  animation:slideIn .25s ease;max-width:340px;
  border-left:3px solid transparent;
}
.toast.success{background:#0f1923;border-left-color:var(--green)}
.toast.error  {background:#0f1923;border-left-color:var(--red)}
.toast.warning{background:#0f1923;border-left-color:var(--yellow)}
.toast.info   {background:#0f1923;border-left-color:var(--blue)}
.toast-icon{font-size:16px;flex-shrink:0;margin-top:1px}
.toast-body{flex:1;line-height:1.4}
.toast-title{font-weight:700;font-size:13px;color:#fff}
.toast-msg{font-size:12px;color:rgba(255,255,255,.6);margin-top:2px}
.toast-close{background:none;border:none;color:rgba(255,255,255,.4);font-size:16px;cursor:pointer;padding:0;flex-shrink:0}
.toast-close:hover{color:#fff}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(15,25,40,.6);
  z-index:1000;display:flex;align-items:center;justify-content:center;
  padding:24px;opacity:0;pointer-events:none;transition:opacity .2s;
}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{
  background:var(--card);border-radius:14px;box-shadow:var(--shadow-lg);
  width:100%;max-width:560px;max-height:90vh;overflow-y:auto;
  transform:scale(.95);transition:transform .2s;
}
.modal-overlay.open .modal{transform:scale(1)}
.modal-header{
  padding:20px 24px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;
}
.modal-title{font-size:16px;font-weight:700;color:var(--text0);flex:1}
.modal-close{
  width:32px;height:32px;border:none;background:var(--bg);
  border-radius:var(--radius-sm);cursor:pointer;color:var(--text2);
  font-size:16px;display:flex;align-items:center;justify-content:center;
  transition:all .12s;
}
.modal-close:hover{background:var(--bg2);color:var(--text0)}
.modal-body{padding:24px}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}

/* â”€â”€ Form Fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{
  width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--bg);color:var(--text0);outline:none;
  transition:border-color .12s,box-shadow .12s;
}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{
  border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1);background:var(--card);
}
.form-group input.error,.form-group select.error{border-color:var(--red)}
.form-group .field-error{font-size:11px;color:var(--red);margin-top:4px}
.form-group textarea{resize:vertical;min-height:70px}

/* â”€â”€ Alerts / Alert Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert-bar{
  padding:12px 16px;border-radius:var(--radius-sm);
  display:flex;align-items:flex-start;gap:10px;margin-bottom:16px;font-size:13px;
}
.alert-info{background:rgba(37,99,235,.06);border:1px solid rgba(37,99,235,.2);color:#1d4ed8}
.alert-warning{background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);color:#b45309}
.alert-error{background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);color:#b91c1c}

/* â”€â”€ Reorder Alert Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#reorderBanner{
  display:none;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);
  border-radius:var(--radius);padding:12px 16px;margin-bottom:16px;
  display:flex;align-items:center;gap:12px;cursor:pointer;
  transition:background .12s;
}
#reorderBanner:hover{background:rgba(245,158,11,.12)}
#reorderBanner.hidden{display:none!important}
.banner-icon{font-size:20px}
.banner-text{flex:1}
.banner-title{font-weight:700;color:#92400e;font-size:13px}
.banner-sub{font-size:12px;color:#b45309}

/* â”€â”€ Movement History Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.history-row{padding:10px 0;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:12px}
.history-row:last-child{border-bottom:none}
.history-badge{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0}
.history-info{flex:1}
.history-qty{font-size:13px;font-weight:700}
.history-qty.pos{color:var(--green)}
.history-qty.neg{color:var(--red)}

/* â”€â”€ Barcode Scanner Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scan-empty{text-align:center;padding:60px 20px}
.scan-empty-icon{font-size:48px;margin-bottom:12px}
.scan-empty-title{font-size:16px;font-weight:600;color:var(--text1);margin-bottom:6px}
.scan-empty-sub{font-size:13px;color:var(--text3)}
.item-result-card{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow)}
.item-result-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.item-result-icon{width:48px;height:48px;border-radius:var(--radius);background:var(--blue-bg);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
.item-result-meta{flex:1;min-width:0}
.item-result-name{font-size:17px;font-weight:700;color:var(--text0)}
.item-result-sku{font-size:12px;color:var(--text2);margin-top:3px}
.item-result-actions{display:flex;gap:8px;flex-shrink:0}
.scan-history-row{display:flex;align-items:center;gap:12px;padding:10px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s}
.scan-history-row:hover{background:var(--bg)}
.scan-history-row:last-child{border-bottom:none}
.scan-input-wrap{display:flex;align-items:center;gap:12px;flex:1}
.scan-big-input{flex:1;max-width:480px;height:42px;border:2px solid var(--border);border-radius:var(--radius-sm);padding:0 14px;font-size:15px;font-weight:600;transition:border-color .15s;outline:none}
.scan-big-input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1)}

/* â”€â”€ Print button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media print{
  #sidebar,#header,#toast-container,.toolbar,.tab-bar,.btn,.no-print{display:none!important}
  #content{padding:0}
  .card{box-shadow:none;border:none}
}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:900px){
  #sidebar{display:none}
  .kpi-grid{grid-template-columns:1fr 1fr}
}
@media(max-width:600px){
  .kpi-grid{grid-template-columns:1fr}
  .form-row{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="app">

<!-- â”€â”€ Sidebar â”€â”€ -->
<aside id="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon">â±</div>
    <div class="sidebar-logo-text">
      <div class="co">TICK TOCK INC.</div>
      <div class="sub">ERP v1.0.0</div>
    </div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section">
      <div class="nav-label">Inventory</div>
      <button class="nav-item active" onclick="showPage('dashboard')">
        <span class="ni">ğŸ“Š</span> Dashboard
      </button>
      <button class="nav-item" onclick="showPage('catalog')">
        <span class="ni">ğŸ“¦</span> Item Catalog
      </button>
      <button class="nav-item" onclick="showPage('stock')">
        <span class="ni">ğŸ­</span> Stock Overview
      </button>
      <button class="nav-item" id="navReorder" onclick="showPage('reorder')">
        <span class="ni">âš ï¸</span> Reorder Alerts
        <span class="nav-badge nav-badge-yellow" id="reorderNavBadge" style="display:none">0</span>
      </button>
      <button class="nav-item" onclick="showPage('adjustments')">
        <span class="ni">ğŸ“</span> Adjustments
      </button>
      <button class="nav-item" onclick="showPage('barcode')">
        <span class="ni">ğŸ“·</span> Barcode Lookup
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-label">Master Data</div>
      <button class="nav-item" onclick="showPage('customers')">
        <span class="ni">ğŸ¢</span> Customers
      </button>
      <button class="nav-item" onclick="showPage('vendors')">
        <span class="ni">ğŸ­</span> Vendors
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-label">Operations</div>
      <a class="nav-item" href="/sales">
        <span class="ni">ğŸ›’</span> Sales Orders
      </a>
      <a class="nav-item" href="/purchasing">
        <span class="ni">ğŸ“‹</span> Purchasing
      </a>
      <a class="nav-item" href="/financials">
        <span class="ni">ğŸ’°</span> Financials
      </a>
      <button class="nav-item" onclick="showPage('backorders')">
        <span class="ni">ğŸ”„</span> Backorders
        <span class="nav-badge" id="backorderNavBadge" style="display:none">0</span>
      </button>
      <button class="nav-item" onclick="showPage('transfers')">
        <span class="ni">â†”ï¸</span> Transfers
      </button>
      <button class="nav-item" onclick="showPage('picklists')">
        <span class="ni">âœ…</span> Pick Lists
      </button>
      <button class="nav-item" onclick="showPage('shipping')">
        <span class="ni">ğŸšš</span> Shipping
      </button>
      <button class="nav-item" onclick="showPage('demand')">
        <span class="ni">ğŸ”®</span> Demand Planning
      </button>
      <button class="nav-item" onclick="showPage('crm')">
        <span class="ni">ğŸ¤</span> CRM
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-label">Reports</div>
      <button class="nav-item" onclick="showPage('analytics')">
        <span class="ni">ğŸ“Š</span> Analytics
      </button>
      <button class="nav-item" onclick="showPage('reports')">
        <span class="ni">ğŸ“ˆ</span> Reports
      </button>
    </div>
    <div class="nav-section" id="navAdminSection">
      <div class="nav-label">System</div>
      <button class="nav-item" onclick="showPage('admin')">
        <span class="ni">âš™ï¸</span> Admin
      </button>
    </div>
  </nav>
  <div class="sidebar-footer">
    <span id="versionFooter">v1.0.0</span>
    <span id="uptimeDisplay"></span>
  </div>
</aside>

<!-- â”€â”€ Main â”€â”€ -->
<div id="main">
  <!-- Header -->
  <header id="header">
    <div class="header-page-title" id="headerTitle">Dashboard</div>
    <div class="header-actions">
      <button class="notif-btn" id="notifBtn" title="Alerts" onclick="showPage('reorder')">
        ğŸ””<span class="notif-dot" id="notifDot" style="display:none"></span>
      </button>
      <div class="user-chip" id="userChip">
        <div class="user-avatar" id="userAvatar" style="background:#2563eb">?</div>
        <div class="user-info">
          <div class="user-name" id="userName">Loadingâ€¦</div>
          <div class="user-role"><span class="role-badge" id="userRoleBadge">â€¦</span></div>
        </div>
      </div>
      <button class="signout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </header>

  <!-- Content -->
  <div id="content">

    <!-- â•â• PAGE: Dashboard â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-dashboard" class="page active">
      <div class="kpi-grid" id="kpiGrid">
        <!-- skeleton -->
        <div class="kpi-card"><div class="kpi-label"><span class="ki">ğŸ“¦</span> Total SKUs</div><div class="kpi-value blue skeleton" style="width:80px;height:32px">&nbsp;</div></div>
        <div class="kpi-card"><div class="kpi-label"><span class="ki">ğŸ’µ</span> Inventory Value</div><div class="kpi-value green skeleton" style="width:120px;height:32px">&nbsp;</div></div>
        <div class="kpi-card"><div class="kpi-label"><span class="ki">âš ï¸</span> Reorder Alerts</div><div class="kpi-value yellow skeleton" style="width:60px;height:32px">&nbsp;</div></div>
        <div class="kpi-card"><div class="kpi-label"><span class="ki">ğŸ­</span> Warehouses</div><div class="kpi-value skeleton" style="width:50px;height:32px">&nbsp;</div></div>
      </div>

      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“‰ Stock Status Overview</div>
            <button class="btn btn-ghost btn-sm" onclick="showPage('stock')">View All â†’</button>
          </div>
          <div class="card-body" id="dashStockPreview">
            <div class="empty-state"><div class="empty-icon">â³</div><div class="empty-title">Loadingâ€¦</div></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">âš ï¸ Top Reorder Alerts</div></div>
          <div class="card-body" id="dashReorderPreview">
            <div class="empty-state"><div class="empty-icon">â³</div><div class="empty-title">Loadingâ€¦</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Item Catalog â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-catalog" class="page">
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="catalogSearch" placeholder="Search by name, SKU, or UPCâ€¦" oninput="filterCatalog()"/>
        </div>
        <select class="filter-select" id="catalogCategoryFilter" onchange="filterCatalog()">
          <option value="">All Categories</option>
        </select>
        <select class="filter-select" id="catalogStatusFilter" onchange="filterCatalog()">
          <option value="">All Status</option>
          <option value="active">Active Only</option>
          <option value="inactive">Inactive</option>
        </select>
        <button class="btn btn-primary" onclick="openItemModal()">+ New Item</button>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Item Catalog</div>
          <span id="catalogCount" style="font-size:12px;color:var(--text2)"></span>
        </div>
        <div class="card-body">
          <div class="tbl-wrap">
            <table id="catalogTable">
              <thead>
                <tr>
                  <th data-sort="code" onclick="sortCatalog('code')">SKU</th>
                  <th data-sort="name" onclick="sortCatalog('name')">Name</th>
                  <th data-sort="category" onclick="sortCatalog('category')">Category</th>
                  <th>UOM</th>
                  <th data-sort="standard_cost" onclick="sortCatalog('standard_cost')" style="text-align:right">Cost</th>
                  <th data-sort="sale_price" onclick="sortCatalog('sale_price')" style="text-align:right">Sale Price</th>
                  <th>Reorder Pt.</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="catalogBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="catalogPagination"></div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Stock Overview â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-stock" class="page">
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="stockSearch" placeholder="Search itemsâ€¦" oninput="filterStock()"/>
        </div>
        <select class="filter-select" id="stockWarehouseFilter" onchange="filterStock()">
          <option value="">All Warehouses</option>
        </select>
        <select class="filter-select" id="stockStatusFilter" onchange="filterStock()">
          <option value="">All Stock Status</option>
          <option value="in_stock">In Stock</option>
          <option value="low_stock">Low Stock</option>
          <option value="out_of_stock">Out of Stock</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="printStockReport()">ğŸ–¨ Print Report</button>
      </div>

      <div class="card" id="stockCard">
        <div class="card-header">
          <div class="card-title">Stock Overview</div>
          <span id="stockCount" style="font-size:12px;color:var(--text2)"></span>
        </div>
        <div class="card-body">
          <div class="tbl-wrap">
            <table id="stockTable">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Item Name</th>
                  <th>Warehouse</th>
                  <th style="text-align:right">On Hand</th>
                  <th style="text-align:right">Reserved</th>
                  <th style="text-align:right">Available</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="stockBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="stockPagination"></div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Reorder Alerts â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-reorder" class="page">
      <div class="alert-bar alert-warning" style="margin-bottom:16px">
        âš ï¸ <span>Items below their reorder point need attention. Create a Purchase Order to replenish stock.</span>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Reorder Alerts</div>
          <span id="reorderCount" style="font-size:12px;color:var(--text2)"></span>
        </div>
        <div class="card-body">
          <div class="tbl-wrap">
            <table id="reorderTable">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Item Name</th>
                  <th>Warehouses</th>
                  <th style="text-align:right">Total Stock</th>
                  <th style="text-align:right">Reorder Point</th>
                  <th style="text-align:right">Shortfall</th>
                  <th style="text-align:right">Suggested Order</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="reorderBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Adjustments â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-adjustments" class="page">
      <div class="toolbar">
        <button class="btn btn-primary" onclick="openAdjModal()">+ New Adjustment</button>
        <select class="filter-select" id="adjStatusFilter" onchange="loadAdjustments()">
          <option value="">All Status</option>
          <option value="draft">Draft</option>
          <option value="posted">Posted</option>
        </select>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Stock Adjustments</div>
          <span id="adjCount" style="font-size:12px;color:var(--text2)"></span>
        </div>
        <div class="card-body">
          <div class="tbl-wrap">
            <table id="adjTable">
              <thead>
                <tr>
                  <th>Number</th>
                  <th>Date</th>
                  <th>Reason</th>
                  <th>Warehouse</th>
                  <th>Lines</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="adjBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Barcode Lookup â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-barcode" class="page">
      <div class="toolbar">
        <div class="scan-input-wrap">
          <input type="text" class="scan-big-input" id="barcodeInput"
            placeholder="ğŸ”  Scan or type UPC / SKU and press Enterâ€¦"
            onkeydown="onBarcodeKey(event)" autocomplete="off" spellcheck="false"/>
          <button class="btn btn-primary" onclick="doBarcodeLookup()">Look Up</button>
          <button class="btn btn-ghost btn-sm" onclick="clearBarcode()">âœ• Clear</button>
        </div>
      </div>

      <div id="barcodeResult">
        <div class="scan-empty">
          <div class="scan-empty-icon">ğŸ“·</div>
          <div class="scan-empty-title">Ready to Scan</div>
          <div class="scan-empty-sub">Connect a USB barcode scanner or type a UPC / SKU above and press Enter</div>
        </div>
      </div>

      <div class="card" id="barcodeHistoryCard" style="display:none">
        <div class="card-header">
          <div class="card-title">Recent Scans</div>
          <button class="btn btn-ghost btn-sm" onclick="clearScanHistory()">Clear</button>
        </div>
        <div class="card-body" id="barcodeHistory" style="padding:0"></div>
      </div>
    </div>

    <!-- â•â• PAGE: Customers â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-customers" class="page">
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="custSearch" placeholder="Search customersâ€¦" oninput="filterCustomers()"/>
        </div>
        <button class="btn btn-primary" onclick="alert('Customer creation: use the Sales module.')">+ New Customer</button>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Customers</div>
          <span id="custCount" style="font-size:12px;color:var(--text2)"></span>
        </div>
        <div class="card-body">
          <div class="tbl-wrap">
            <table id="custTable">
              <thead><tr><th>Code</th><th>Name</th><th>Contact</th><th>Email</th><th>Phone</th><th>Terms</th><th>AR Balance</th><th>Status</th></tr></thead>
              <tbody id="custBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="custPagination"></div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Vendors â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-vendors" class="page">
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="vendSearch" placeholder="Search vendorsâ€¦" oninput="filterVendors()"/>
        </div>
        <button class="btn btn-primary" onclick="alert('Vendor creation: use the Purchasing module.')">+ New Vendor</button>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Vendors</div>
          <span id="vendCount" style="font-size:12px;color:var(--text2)"></span>
        </div>
        <div class="card-body">
          <div class="tbl-wrap">
            <table id="vendTable">
              <thead><tr><th>Code</th><th>Name</th><th>Contact</th><th>Email</th><th>Lead Time</th><th>Terms</th><th>AP Balance</th><th>Status</th></tr></thead>
              <tbody id="vendBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="vendPagination"></div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Backorders â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-backorders" class="page">
      <div class="toolbar">
        <select class="filter-select" id="backorderStatusFilter" onchange="loadBackorders()">
          <option value="">All Open</option>
          <option value="open">Open</option>
          <option value="partial">Partial</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="loadBackorders()">âŸ³ Refresh</button>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ”„ Open Backorders</div>
          <span id="backorderCount" style="font-size:12px;color:var(--text2)"></span>
        </div>
        <div class="card-body">
          <div class="tbl-wrap">
            <table id="backorderTable">
              <thead><tr><th>Order #</th><th>Customer</th><th>Item</th><th>Warehouse</th><th style="text-align:right">Backordered</th><th style="text-align:right">Remaining</th><th>Status</th><th>Created</th></tr></thead>
              <tbody id="backorderBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="backorderPagination"></div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Transfers â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-transfers" class="page">
      <div class="toolbar">
        <select class="filter-select" id="transferStatusFilter" onchange="loadTransfers()">
          <option value="">All Statuses</option>
          <option value="draft">Draft</option>
          <option value="posted">Posted</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <button class="btn btn-primary" onclick="openTransferModal()">+ New Transfer</button>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">â†”ï¸ Stock Transfers</div>
          <span id="transferCount" style="font-size:12px;color:var(--text2)"></span>
        </div>
        <div class="card-body">
          <div class="tbl-wrap">
            <table id="transferTable">
              <thead><tr><th>Number</th><th>Date</th><th>From</th><th>To</th><th>Lines</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="transferBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="transferPagination"></div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Pick Lists â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-picklists" class="page">
      <div class="toolbar">
        <select class="filter-select" id="plStatusFilter" onchange="loadPickLists()">
          <option value="">All Statuses</option>
          <option value="open">Open</option>
          <option value="in_progress">In Progress</option>
          <option value="completed">Completed</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="loadPickLists()">âŸ³ Refresh</button>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">âœ… Pick Lists</div>
          <span id="plCount" style="font-size:12px;color:var(--text2)"></span>
        </div>
        <div class="card-body">
          <div class="tbl-wrap">
            <table id="plTable">
              <thead><tr><th>Number</th><th>Order #</th><th>Customer</th><th>Warehouse</th><th>Lines</th><th>Picked</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="plBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="plPagination"></div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Shipping â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-shipping" class="page">
      <div class="toolbar">
        <select class="filter-select" id="shpCarrierFilter" onchange="loadShipping()">
          <option value="">All Carriers</option>
          <option value="UPS">UPS</option>
          <option value="FEDEX">FedEx</option>
          <option value="USPS">USPS</option>
          <option value="DHL">DHL</option>
          <option value="CUSTOM">Custom</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="loadShipping()">âŸ³ Refresh</button>
        <button class="btn btn-primary btn-sm" onclick="openRateQuoteModal()">ğŸ“¦ Rate Quote</button>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸšš Shipments â€” Carrier & Tracking</div>
          <span id="shpCount" style="font-size:12px;color:var(--text2)"></span>
        </div>
        <div class="card-body">
          <div class="tbl-wrap">
            <table id="shpTable">
              <thead><tr><th>Shipment #</th><th>Order #</th><th>Customer</th><th>Carrier</th><th>Service</th><th>Tracking #</th><th>Weight</th><th>Freight</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="shpBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="shpPagination"></div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Demand Planning â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-demand" class="page">
      <!-- KPI row -->
      <div class="kpi-grid" id="demandKpiGrid" style="margin-bottom:20px"></div>

      <!-- Velocity Tab Bar -->
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
        <select class="filter-select" id="demandUrgency" onchange="loadVelocity()">
          <option value="">All Items</option>
          <option value="critical">ğŸ”´ Critical</option>
          <option value="high">ğŸŸ¡ High</option>
          <option value="normal">ğŸ”µ Normal</option>
          <option value="ok">ğŸŸ¢ OK</option>
        </select>
        <select class="filter-select" id="demandSort" onchange="loadVelocity()">
          <option value="days_of_stock">Sort: Days of Stock</option>
          <option value="velocity_30d">Sort: 30d Velocity</option>
          <option value="sold_90d">Sort: 90d Sold</option>
          <option value="qty_available">Sort: Stock on Hand</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="loadVelocity()">âŸ³ Refresh</button>
        <button class="btn btn-primary btn-sm" onclick="refreshSuggestions()">âš¡ Refresh Suggestions</button>
      </div>

      <div style="display:grid;grid-template-columns:1fr;gap:16px">
        <!-- Velocity Table -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“Š Sales Velocity &amp; Days of Stock</div>
            <span id="velCount" style="font-size:12px;color:var(--text2)"></span>
          </div>
          <div class="card-body">
            <div class="tbl-wrap">
              <table id="velTable">
                <thead><tr>
                  <th>SKU</th><th>Item</th>
                  <th style="text-align:right">Stock</th>
                  <th style="text-align:right">30d Sales</th>
                  <th style="text-align:right">Velocity/Day</th>
                  <th style="text-align:right">Days Left</th>
                  <th>Lead Time</th>
                  <th>Urgency</th>
                  <th>Vendor</th>
                </tr></thead>
                <tbody id="velBody"></tbody>
              </table>
            </div>
            <div class="pagination" id="velPagination"></div>
          </div>
        </div>

        <!-- Replenishment Suggestions -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ’¡ Replenishment Suggestions</div>
            <div style="display:flex;gap:8px">
              <select class="filter-select" id="suggUrgency" onchange="loadSuggestions()" style="padding:4px 8px;font-size:12px">
                <option value="pending">Pending</option>
                <option value="converted">Converted</option>
                <option value="dismissed">Dismissed</option>
              </select>
              <span id="suggCount" style="font-size:12px;color:var(--text2);align-self:center"></span>
            </div>
          </div>
          <div class="card-body">
            <div class="tbl-wrap">
              <table id="suggTable">
                <thead><tr>
                  <th>SKU</th><th>Item</th><th>Vendor</th>
                  <th style="text-align:right">Suggest Qty</th>
                  <th style="text-align:right">Est. Value</th>
                  <th style="text-align:right">Days Left</th>
                  <th>Urgency</th><th>Notes</th><th>Actions</th>
                </tr></thead>
                <tbody id="suggBody"></tbody>
              </table>
            </div>
            <div class="pagination" id="suggPagination"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: CRM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-crm" class="page">
      <!-- Tab bar -->
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
        <div style="display:flex;gap:4px;background:var(--bg2);border-radius:var(--radius-sm);padding:3px">
          <button id="crmTabInteractions" class="btn btn-sm btn-primary" onclick="crmTab('interactions')">ğŸ’¬ Interactions</button>
          <button id="crmTabPipeline"     class="btn btn-sm btn-ghost"   onclick="crmTab('pipeline')">ğŸ† Pipeline</button>
          <button id="crmTabHealth"       class="btn btn-sm btn-ghost"   onclick="crmTab('health')">â¤ï¸ Health</button>
        </div>
        <div id="crmActionsBar" style="margin-left:auto;display:flex;gap:8px"></div>
      </div>

      <!-- â”€â”€ Interactions panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="crmPanelInteractions">
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
          <select class="filter-select" id="crmIntType" onchange="loadInteractions()">
            <option value="">All Types</option>
            <option value="call">ğŸ“ Call</option>
            <option value="email">âœ‰ï¸ Email</option>
            <option value="meeting">ğŸ¤ Meeting</option>
            <option value="note">ğŸ“ Note</option>
            <option value="demo">ğŸ–¥ï¸ Demo</option>
            <option value="follow_up">ğŸ”” Follow-up</option>
          </select>
          <input type="date" id="crmIntFrom" class="filter-select" style="padding:5px 8px" onchange="loadInteractions()">
          <input type="date" id="crmIntTo"   class="filter-select" style="padding:5px 8px" onchange="loadInteractions()">
          <button class="btn btn-ghost btn-sm" onclick="loadInteractions()">âŸ³ Refresh</button>
          <button class="btn btn-primary btn-sm" onclick="openInteractionModal()">+ Log Interaction</button>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ’¬ Customer Interactions</div>
            <span id="intCount" style="font-size:12px;color:var(--text2)"></span>
          </div>
          <div class="card-body">
            <div class="tbl-wrap">
              <table id="intTable">
                <thead><tr>
                  <th>Date</th><th>Customer</th><th>Type</th><th>Dir.</th>
                  <th>Subject</th><th>Outcome</th><th>Agent</th><th>Follow-up</th>
                </tr></thead>
                <tbody id="intBody"></tbody>
              </table>
            </div>
            <div class="pagination" id="intPagination"></div>
          </div>
        </div>

        <!-- Follow-ups card -->
        <div class="card" style="margin-top:16px">
          <div class="card-header">
            <div class="card-title">ğŸ”” Upcoming Follow-ups (14 days)</div>
            <button class="btn btn-ghost btn-sm" onclick="loadFollowups()">âŸ³</button>
          </div>
          <div class="card-body">
            <div class="tbl-wrap">
              <table id="fuTable">
                <thead><tr><th>Date</th><th>Customer</th><th>Type</th><th>Subject</th></tr></thead>
                <tbody id="fuBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Pipeline panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="crmPanelPipeline" style="display:none">
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
          <select class="filter-select" id="crmOppStage" onchange="loadOpportunities()">
            <option value="">All Stages</option>
            <option value="lead">Lead</option>
            <option value="qualified">Qualified</option>
            <option value="proposal">Proposal</option>
            <option value="negotiation">Negotiation</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
          </select>
          <button class="btn btn-ghost btn-sm" onclick="loadOpportunities()">âŸ³ Refresh</button>
          <button class="btn btn-primary btn-sm" onclick="openOpportunityModal()">+ New Opportunity</button>
        </div>

        <!-- Pipeline KPI strip -->
        <div id="pipelineKpi" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:16px"></div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ† Opportunities</div>
            <span id="oppCount" style="font-size:12px;color:var(--text2)"></span>
          </div>
          <div class="card-body">
            <div class="tbl-wrap">
              <table id="oppTable">
                <thead><tr>
                  <th>Number</th><th>Customer</th><th>Title</th>
                  <th style="text-align:right">Est. Value</th>
                  <th>Stage</th><th style="text-align:right">Prob%</th>
                  <th>Close Date</th><th>Assigned</th><th>Actions</th>
                </tr></thead>
                <tbody id="oppBody"></tbody>
              </table>
            </div>
            <div class="pagination" id="oppPagination"></div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Health panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="crmPanelHealth" style="display:none">
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
          <select class="filter-select" id="crmHealthLabel" onchange="loadCustomerHealth()">
            <option value="">All Customers</option>
            <option value="Excellent">ğŸŒŸ Excellent</option>
            <option value="Good">âœ… Good</option>
            <option value="Fair">ğŸŸ¡ Fair</option>
            <option value="Poor">ğŸ”´ Poor</option>
            <option value="At Risk">âš ï¸ At Risk</option>
          </select>
          <button class="btn btn-ghost btn-sm" onclick="loadCustomerHealth()">âŸ³ Refresh</button>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">â¤ï¸ Customer Health Scores</div>
            <span id="healthCount" style="font-size:12px;color:var(--text2)"></span>
          </div>
          <div class="card-body">
            <div class="tbl-wrap">
              <table id="healthTable">
                <thead><tr>
                  <th>Code</th><th>Customer</th>
                  <th style="text-align:right">Score</th><th>Label</th>
                  <th style="text-align:right">Rev 12m</th>
                  <th style="text-align:right">Orders 90d</th>
                  <th style="text-align:right">Overdue</th>
                  <th style="text-align:right">Avg Pay Days</th>
                  <th>Last Order</th>
                  <th style="text-align:right">Interact 30d</th>
                </tr></thead>
                <tbody id="healthBody"></tbody>
              </table>
            </div>
            <div class="pagination" id="healthPagination"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Reports â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-reports" class="page">
      <div class="kpi-grid" id="reportKpiGrid" style="margin-bottom:24px"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px" id="reportCards">

        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“¦ Inventory Valuation</div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-ghost btn-sm" onclick="loadInventoryValuation()">âŸ³ Refresh</button>
              <a id="invValCSV" class="btn btn-ghost btn-sm" href="/api/reports/inventory-valuation?format=csv" download>â¬‡ CSV</a>
            </div>
          </div>
          <div class="card-body" id="invValBody">
            <div class="empty-state"><div class="empty-icon">â³</div><div class="empty-title">Click Refresh to load</div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“Š Stock Summary by Warehouse</div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-ghost btn-sm" onclick="loadStockSummary()">âŸ³ Refresh</button>
              <a class="btn btn-ghost btn-sm" href="/api/reports/stock-summary?format=csv" download>â¬‡ CSV</a>
            </div>
          </div>
          <div class="card-body" id="stockSummaryBody">
            <div class="empty-state"><div class="empty-icon">â³</div><div class="empty-title">Click Refresh to load</div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ”„ Stock Movement</div>
            <div style="display:flex;gap:8px">
              <input type="date" id="movFromDate" style="padding:4px 8px;border:1px solid var(--border);border-radius:4px;font-size:12px">
              <input type="date" id="movToDate" style="padding:4px 8px;border:1px solid var(--border);border-radius:4px;font-size:12px">
              <button class="btn btn-ghost btn-sm" onclick="loadStockMovement()">âŸ³ Load</button>
              <a id="movCSV" class="btn btn-ghost btn-sm" href="/api/reports/stock-movement?format=csv" download>â¬‡ CSV</a>
            </div>
          </div>
          <div class="card-body" id="stockMovBody">
            <div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">Select date range and click Load</div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">âš ï¸ Reorder Recommendations</div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-ghost btn-sm" onclick="loadReorderReport()">âŸ³ Refresh</button>
              <a class="btn btn-ghost btn-sm" href="/api/reports/reorder-recommendations?format=csv" download>â¬‡ CSV</a>
            </div>
          </div>
          <div class="card-body" id="reorderReportBody">
            <div class="empty-state"><div class="empty-icon">â³</div><div class="empty-title">Click Refresh to load</div></div>
          </div>
        </div>

      </div>
    </div>

    <!-- â•â• PAGE: Analytics â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-analytics" class="page">
      <!-- KPI strip -->
      <div class="kpi-grid" id="analyticsKpi" style="margin-bottom:20px"></div>

      <!-- Row 1: Revenue Trend + Category Mix -->
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“ˆ Revenue Trend â€” Last 12 Months</div>
            <button class="btn btn-ghost btn-sm" onclick="loadRevenueTrend()">âŸ³</button>
          </div>
          <div class="card-body" style="height:260px;position:relative">
            <canvas id="chartRevenue"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ© Category Mix</div>
            <button class="btn btn-ghost btn-sm" onclick="loadCategoryMix()">âŸ³</button>
          </div>
          <div class="card-body" style="height:260px;position:relative">
            <canvas id="chartCategory"></canvas>
          </div>
        </div>
      </div>

      <!-- Row 2: Top Customers + Top Items -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ† Top 10 Customers â€” 12m Revenue</div>
            <button class="btn btn-ghost btn-sm" onclick="loadTopCustomers()">âŸ³</button>
          </div>
          <div class="card-body" style="height:280px;position:relative">
            <canvas id="chartCustomers"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“¦ Top 10 Items â€” 12m Revenue</div>
            <button class="btn btn-ghost btn-sm" onclick="loadTopItems()">âŸ³</button>
          </div>
          <div class="card-body" style="height:280px;position:relative">
            <canvas id="chartItems"></canvas>
          </div>
        </div>
      </div>

      <!-- Row 3: Cash Flow + Inventory Health + CRM Pipeline -->
      <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:16px">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ’µ Cash Flow â€” Last 6 Months</div>
            <button class="btn btn-ghost btn-sm" onclick="loadCashFlow()">âŸ³</button>
          </div>
          <div class="card-body" style="height:220px;position:relative">
            <canvas id="chartCashFlow"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ¥ Inventory Health</div>
            <button class="btn btn-ghost btn-sm" onclick="loadInventoryHealth()">âŸ³</button>
          </div>
          <div class="card-body" style="height:220px;position:relative">
            <canvas id="chartHealth"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ”® CRM Pipeline</div>
            <button class="btn btn-ghost btn-sm" onclick="loadPipelineChart()">âŸ³</button>
          </div>
          <div class="card-body" style="position:relative">
            <div id="pipelineChartBody"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• PAGE: Admin â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-admin" class="page">
      <!-- Tab bar -->
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
        <div style="display:flex;gap:4px;background:var(--bg2);border-radius:var(--radius-sm);padding:3px">
          <button id="adminTabUsers"      class="btn btn-sm btn-primary" onclick="adminTab('users')">ğŸ‘¤ Users</button>
          <button id="adminTabWarehouses" class="btn btn-sm btn-ghost"   onclick="adminTab('warehouses')">ğŸ­ Warehouses</button>
          <button id="adminTabSettings"  class="btn btn-sm btn-ghost"   onclick="adminTab('settings')">âš™ï¸ Settings</button>
          <button id="adminTabAudit"     class="btn btn-sm btn-ghost"   onclick="adminTab('audit')">ğŸ“‹ Audit Log</button>
        </div>
      </div>

      <!-- â”€â”€ Users panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="adminPanelUsers">
        <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
          <button class="btn btn-ghost btn-sm" onclick="loadAdminUsers()">âŸ³ Refresh</button>
          <button class="btn btn-primary btn-sm" onclick="openUserModal()">+ New User</button>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ‘¤ System Users</div>
            <span id="usersCount" style="font-size:12px;color:var(--text2)"></span>
          </div>
          <div class="card-body">
            <div class="tbl-wrap">
              <table id="usersTable">
                <thead><tr>
                  <th>Name</th><th>Email</th><th>Role</th><th>Status</th>
                  <th>Created</th><th>Actions</th>
                </tr></thead>
                <tbody id="usersBody"></tbody>
              </table>
            </div>
            <div class="pagination" id="usersPagination"></div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Warehouses panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="adminPanelWarehouses" style="display:none">
        <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
          <button class="btn btn-ghost btn-sm" onclick="loadAdminWarehouses()">âŸ³ Refresh</button>
          <button class="btn btn-primary btn-sm" onclick="openWarehouseModal()">+ New Warehouse</button>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ­ Warehouses</div>
            <span id="whCount" style="font-size:12px;color:var(--text2)"></span>
          </div>
          <div class="card-body">
            <div class="tbl-wrap">
              <table id="whTable">
                <thead><tr>
                  <th>Code</th><th>Name</th><th>Address</th>
                  <th style="text-align:right">Ledger Entries</th>
                  <th>Status</th><th>Actions</th>
                </tr></thead>
                <tbody id="whBody"></tbody>
              </table>
            </div>
            <div class="pagination" id="whPagination"></div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Settings panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="adminPanelSettings" style="display:none">
        <div class="card">
          <div class="card-header">
            <div class="card-title">âš™ï¸ Company Settings</div>
            <button class="btn btn-primary btn-sm" onclick="saveSettings()">ğŸ’¾ Save Changes</button>
          </div>
          <div class="card-body" id="settingsBody">
            <div class="empty-state"><div class="empty-icon">â³</div><div class="empty-title">Loadingâ€¦</div></div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Audit Log panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="adminPanelAudit" style="display:none">
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
          <select class="filter-select" id="auditTableFilter" onchange="loadAuditLog()">
            <option value="">All Tables</option>
            <option value="users">users</option>
            <option value="warehouses">warehouses</option>
            <option value="company_settings">company_settings</option>
            <option value="items">items</option>
          </select>
          <input class="filter-select" style="padding:5px 8px" id="auditActionFilter" placeholder="Filter by actionâ€¦" oninput="loadAuditLog()">
          <button class="btn btn-ghost btn-sm" onclick="loadAuditLog()">âŸ³ Refresh</button>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“‹ Audit Log</div>
            <span id="auditCount" style="font-size:12px;color:var(--text2)"></span>
          </div>
          <div class="card-body">
            <div class="tbl-wrap">
              <table id="auditTable">
                <thead><tr>
                  <th>When</th><th>User</th><th>Action</th>
                  <th>Table</th><th>Entity</th><th>Details</th>
                </tr></thead>
                <tbody id="auditBody"></tbody>
              </table>
            </div>
            <div class="pagination" id="auditPagination"></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /app -->

<!-- â”€â”€ Toast Container â”€â”€ -->
<div id="toast-container"></div>

<!-- â”€â”€ Item Modal â”€â”€ -->
<div class="modal-overlay" id="itemModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="itemModalTitle">New Item</div>
      <button class="modal-close" onclick="closeModal('itemModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="itemId"/>
      <div class="form-row">
        <div class="form-group">
          <label>SKU Code *</label>
          <input type="text" id="itemCode" placeholder="e.g. WATCH-001"/>
          <div class="field-error" id="errItemCode"></div>
        </div>
        <div class="form-group">
          <label>Item Name *</label>
          <input type="text" id="itemName" placeholder="e.g. Seiko NH35 Movement"/>
          <div class="field-error" id="errItemName"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Category</label>
          <input type="text" id="itemCategory" placeholder="e.g. Movements"/>
        </div>
        <div class="form-group">
          <label>Unit of Measure</label>
          <select id="itemUOM">
            <option value="EA">EA â€” Each</option>
            <option value="PR">PR â€” Pair</option>
            <option value="DZ">DZ â€” Dozen</option>
            <option value="BOX">BOX â€” Box</option>
            <option value="SET">SET â€” Set</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Standard Cost ($)</label>
          <input type="number" id="itemCost" placeholder="0.00" step="0.01" min="0"/>
        </div>
        <div class="form-group">
          <label>Sale Price ($)</label>
          <input type="number" id="itemSalePrice" placeholder="0.00" step="0.01" min="0"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Reorder Point</label>
          <input type="number" id="itemReorderPoint" placeholder="0" min="0"/>
        </div>
        <div class="form-group">
          <label>Reorder Qty</label>
          <input type="number" id="itemReorderQty" placeholder="0" min="0"/>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>UPC / Barcode</label>
          <input type="text" id="itemUPC" placeholder="Optional barcode"/>
        </div>
        <div class="form-group">
          <label>Lead Time (Days)</label>
          <input type="number" id="itemLeadTime" placeholder="0" min="0"/>
        </div>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="itemDescription" placeholder="Optional item descriptionâ€¦"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('itemModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveItem()" id="itemSaveBtn">Save Item</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Adjustment Modal â”€â”€ -->
<div class="modal-overlay" id="adjModal">
  <div class="modal" style="max-width:680px">
    <div class="modal-header">
      <div class="modal-title">New Stock Adjustment</div>
      <button class="modal-close" onclick="closeModal('adjModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Reason *</label>
          <select id="adjReason">
            <option value="">Select reasonâ€¦</option>
            <option value="Cycle Count">Cycle Count</option>
            <option value="Damaged Goods">Damaged Goods</option>
            <option value="Receiving Variance">Receiving Variance</option>
            <option value="Theft/Shrinkage">Theft / Shrinkage</option>
            <option value="Return to Vendor">Return to Vendor</option>
            <option value="Opening Balance">Opening Balance</option>
          </select>
          <div class="field-error" id="errAdjReason"></div>
        </div>
        <div class="form-group">
          <label>Warehouse *</label>
          <select id="adjWarehouse">
            <option value="">Select warehouseâ€¦</option>
          </select>
          <div class="field-error" id="errAdjWarehouse"></div>
        </div>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <input type="text" id="adjNotes" placeholder="Optional notesâ€¦"/>
      </div>

      <div style="margin-top:4px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between">
        <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.06em">Line Items</div>
        <button class="btn btn-ghost btn-sm" onclick="addAdjLine()">+ Add Line</button>
      </div>
      <div id="adjLines"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('adjModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveAdjustment()" id="adjSaveBtn">Save Draft</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Quick Create PO Modal â”€â”€ -->
<div class="modal-overlay" id="quickPOModal">
  <div class="modal" style="max-width:520px">
    <div class="modal-header">
      <div class="modal-title">Create Purchase Order</div>
      <button class="modal-close" onclick="closeModal('quickPOModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="alert-bar alert-info" style="margin-bottom:16px">
        â„¹ï¸ <span>This creates a draft PO. Go to <a href="/purchasing" style="color:var(--blue);font-weight:600">Purchasing</a> to send it to your vendor and track receiving.</span>
      </div>
      <div id="quickPOItemSummary" style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:16px;font-size:13px"></div>
      <div class="form-row">
        <div class="form-group">
          <label>Vendor *</label>
          <select id="quickPOVendor">
            <option value="">Select vendorâ€¦</option>
          </select>
          <div class="field-error" id="errQuickPOVendor"></div>
        </div>
        <div class="form-group">
          <label>Warehouse *</label>
          <select id="quickPOWarehouse">
            <option value="">Select warehouseâ€¦</option>
          </select>
          <div class="field-error" id="errQuickPOWarehouse"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Order Qty</label>
          <input type="number" id="quickPOQty" min="1" step="1"/>
        </div>
        <div class="form-group">
          <label>Expected Delivery</label>
          <input type="date" id="quickPODate"/>
        </div>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <input type="text" id="quickPONotes" placeholder="Optional notes to vendorâ€¦"/>
      </div>
      <input type="hidden" id="quickPOItemId"/>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('quickPOModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitQuickPO()" id="quickPOBtn">Create Draft PO</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Movement History Modal â”€â”€ -->
<div class="modal-overlay" id="historyModal">
  <div class="modal" style="max-width:600px">
    <div class="modal-header">
      <div class="modal-title" id="historyModalTitle">Movement History</div>
      <button class="modal-close" onclick="closeModal('historyModal')">âœ•</button>
    </div>
    <div class="modal-body" id="historyBody">
      <div class="empty-state"><div class="empty-icon">â³</div><div class="empty-title">Loadingâ€¦</div></div>
    </div>
  </div>
</div>

<!-- â”€â”€ Add Tracking Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="trackingModal">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title">Add Tracking Info</div>
      <button class="modal-close" onclick="closeModal('trackingModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="trackingShipmentId">
      <div class="form-group">
        <label class="form-label">Carrier *</label>
        <select class="form-control" id="trackingCarrier">
          <option value="">Select carrierâ€¦</option>
          <option value="UPS">UPS</option>
          <option value="FEDEX">FedEx</option>
          <option value="USPS">USPS</option>
          <option value="DHL">DHL</option>
          <option value="CUSTOM">Custom / Local Carrier</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Service Level</label>
        <input class="form-control" id="trackingService" placeholder="e.g. UPS Ground, FedEx 2Dayâ€¦">
      </div>
      <div class="form-group">
        <label class="form-label">Tracking Number *</label>
        <input class="form-control" id="trackingNumber" placeholder="Enter tracking number">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Weight (lb)</label>
          <input class="form-control" type="number" step="0.001" id="trackingWeight" placeholder="0.000">
        </div>
        <div class="form-group">
          <label class="form-label">Freight Cost ($)</label>
          <input class="form-control" type="number" step="0.01" id="trackingFreight" placeholder="0.00">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('trackingModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTracking()">Save Tracking</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Rate Quote Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="rateQuoteModal">
  <div class="modal" style="max-width:560px">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¦ Get Rate Quote</div>
      <button class="modal-close" onclick="closeModal('rateQuoteModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">
        <div class="form-group">
          <label class="form-label">From ZIP *</label>
          <input class="form-control" id="rqFromZip" placeholder="10001">
        </div>
        <div class="form-group">
          <label class="form-label">To ZIP *</label>
          <input class="form-control" id="rqToZip" placeholder="90210">
        </div>
        <div class="form-group">
          <label class="form-label">Weight (lb) *</label>
          <input class="form-control" type="number" step="0.001" id="rqWeight" placeholder="1.000">
        </div>
      </div>
      <button class="btn btn-primary" style="width:100%;margin-bottom:16px" onclick="getRates()">Get Rates</button>
      <div id="rateResults"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ CRM: New Interaction Modal â”€â”€ -->
<div class="modal-overlay" id="interactionModal">
  <div class="modal" style="max-width:560px">
    <div class="modal-header">
      <div class="modal-title">ğŸ’¬ Log Interaction</div>
      <button class="modal-close" onclick="closeModal('interactionModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Customer *</label>
          <select class="form-control" id="intCustId"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Type *</label>
          <select class="form-control" id="intType">
            <option value="call">Call</option>
            <option value="email">Email</option>
            <option value="meeting">Meeting</option>
            <option value="note">Note</option>
            <option value="demo">Demo</option>
            <option value="follow_up">Follow-up</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Direction</label>
          <select class="form-control" id="intDirection">
            <option value="outbound">Outbound</option>
            <option value="inbound">Inbound</option>
            <option value="internal">Internal</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Date</label>
          <input class="form-control" type="datetime-local" id="intDate">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Subject *</label>
        <input class="form-control" id="intSubject" placeholder="What was this about?">
      </div>
      <div class="form-group">
        <label class="form-label">Notes / Body</label>
        <textarea class="form-control" id="intBody" rows="3" placeholder="Detailsâ€¦"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Outcome</label>
          <input class="form-control" id="intOutcome" placeholder="Result or next step">
        </div>
        <div class="form-group">
          <label class="form-label">Follow-up Date</label>
          <input class="form-control" type="date" id="intFollowUp">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('interactionModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveInteraction()">Save Interaction</button>
    </div>
  </div>
</div>

<!-- â”€â”€ CRM: New Opportunity Modal â”€â”€ -->
<div class="modal-overlay" id="opportunityModal">
  <div class="modal" style="max-width:560px">
    <div class="modal-header">
      <div class="modal-title" id="oppModalTitle">ğŸ† New Opportunity</div>
      <button class="modal-close" onclick="closeModal('opportunityModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="oppEditId">
      <div class="form-group">
        <label class="form-label">Customer *</label>
        <select class="form-control" id="oppCustId"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Title *</label>
        <input class="form-control" id="oppTitle" placeholder="e.g. Q3 Rolex Collection Order">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Stage</label>
          <select class="form-control" id="oppStage" onchange="oppStageChanged()">
            <option value="lead">Lead</option>
            <option value="qualified">Qualified</option>
            <option value="proposal">Proposal</option>
            <option value="negotiation">Negotiation</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Probability %</label>
          <input class="form-control" type="number" id="oppProb" min="0" max="100" value="10">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Estimated Value ($)</label>
          <input class="form-control" type="number" step="0.01" id="oppValue" value="0">
        </div>
        <div class="form-group">
          <label class="form-label">Expected Close Date</label>
          <input class="form-control" type="date" id="oppCloseDate">
        </div>
      </div>
      <div class="form-group" id="oppLostReasonRow" style="display:none">
        <label class="form-label">Lost Reason</label>
        <input class="form-control" id="oppLostReason" placeholder="Why was this lost?">
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-control" id="oppNotes" rows="2" placeholder="Additional contextâ€¦"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('opportunityModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveOpportunity()">Save Opportunity</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Admin: New/Edit User Modal â”€â”€ -->
<div class="modal-overlay" id="userModal">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title" id="userModalTitle">New User</div>
      <button class="modal-close" onclick="closeModal('userModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="userEditId">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Full Name *</label>
          <input class="form-control" id="userName" placeholder="Jane Smith">
        </div>
        <div class="form-group">
          <label class="form-label">Role *</label>
          <select class="form-control" id="userRole">
            <option value="sales">Sales</option>
            <option value="warehouse">Warehouse</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Email *</label>
        <input class="form-control" type="email" id="userEmail" placeholder="jane@ticktockinc.com">
      </div>
      <div id="userPasswordRow" class="form-group">
        <label class="form-label" id="userPasswordLabel">Password *</label>
        <input class="form-control" type="password" id="userPassword" placeholder="Min 6 characters">
      </div>
      <div id="userStatusRow" class="form-group" style="display:none">
        <label class="form-label">Status</label>
        <select class="form-control" id="userIsActive">
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('userModal')">Cancel</button>
      <button class="btn btn-primary" id="userSaveBtn" onclick="saveUser()">Create User</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Admin: New/Edit Warehouse Modal â”€â”€ -->
<div class="modal-overlay" id="warehouseModal">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title" id="whModalTitle">New Warehouse</div>
      <button class="modal-close" onclick="closeModal('warehouseModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="whEditId">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Code *</label>
          <input class="form-control" id="whCode" placeholder="NYC" style="text-transform:uppercase">
        </div>
        <div class="form-group" id="whStatusRow" style="display:none">
          <label class="form-label">Status</label>
          <select class="form-control" id="whIsActive">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Name *</label>
        <input class="form-control" id="whName" placeholder="New York City Warehouse">
      </div>
      <div class="form-group">
        <label class="form-label">Address</label>
        <textarea class="form-control" id="whAddress" rows="2" placeholder="123 Commerce St, New York, NY 10001"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('warehouseModal')">Cancel</button>
      <button class="btn btn-primary" id="whSaveBtn" onclick="saveWarehouse()">Create Warehouse</button>
    </div>
  </div>
</div>

<script>
'use strict';

// â”€â”€ Auth Guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TOKEN_KEY = 'tt_token';
const USER_KEY  = 'tt_user';
const API       = '';

function getToken() { return localStorage.getItem(TOKEN_KEY); }
function getUser()  {
  try { return JSON.parse(localStorage.getItem(USER_KEY) || '{}'); }
  catch { return {}; }
}
function signOut() {
  localStorage.removeItem(TOKEN_KEY);
  localStorage.removeItem(USER_KEY);
  window.location.href = '/login.html';
}
function isTokenValid(token) {
  if (!token) return false;
  try {
    const p = JSON.parse(atob(token.split('.')[1]));
    return p.exp * 1000 > Date.now();
  } catch { return false; }
}
(function authGuard() {
  const token = getToken();
  if (!isTokenValid(token)) {
    localStorage.removeItem(TOKEN_KEY);
    localStorage.removeItem(USER_KEY);
    window.location.href = '/login.html';
  }
})();

// â”€â”€ Fetch with Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(url, options = {}) {
  const token = getToken();
  const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(API + url, { ...options, headers });
  if (res.status === 401) { signOut(); return; }
  return res;
}

// â”€â”€ Toast System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(type, title, msg, duration = 4000) {
  const icons = { success:'âœ…', error:'âŒ', warning:'âš ï¸', info:'â„¹ï¸' };
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `
    <span class="toast-icon">${icons[type] || 'â„¹ï¸'}</span>
    <div class="toast-body">
      <div class="toast-title">${title}</div>
      ${msg ? `<div class="toast-msg">${msg}</div>` : ''}
    </div>
    <button class="toast-close" onclick="this.closest('.toast').remove()">âœ•</button>
  `;
  c.appendChild(t);
  setTimeout(() => {
    t.style.animation = 'slideOut .25s ease forwards';
    setTimeout(() => t.remove(), 250);
  }, duration);
}

// â”€â”€ Modal Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.addEventListener('click', e => {
  if (e.target.classList.contains('modal-overlay')) {
    e.target.classList.remove('open');
  }
});

// â”€â”€ Format Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(d)   { if (!d) return 'â€”'; const dt = new Date(d); return `${dt.getMonth()+1}/${dt.getDate()}/${dt.getFullYear()}`; }
function fmtMoney(n)  { return '$' + parseFloat(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtNum(n)    { return parseFloat(n||0).toLocaleString('en-US',{maximumFractionDigits:2}); }
function fmtInitials(name) {
  return (name || '?').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
}
function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function avatarColor(role) {
  return { admin:'#b45309', warehouse:'#047857', sales:'#1d4ed8' }[role] || '#374151';
}

// â”€â”€ Stock Status Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stockBadge(available, reorderPoint) {
  if (available <= 0)            return '<span class="badge badge-red">Out of Stock</span>';
  if (available <= reorderPoint) return '<span class="badge badge-yellow">Low Stock</span>';
  return '<span class="badge badge-green">In Stock</span>';
}

// â”€â”€ Page Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PAGE_TITLES = {
  dashboard:   'Dashboard',
  catalog:     'Item Catalog',
  stock:       'Stock Overview',
  reorder:     'Reorder Alerts',
  adjustments: 'Adjustments',
  barcode:     'Barcode Lookup',
  customers:   'Customers',
  vendors:     'Vendors',
  backorders:  'Backorders',
  transfers:   'Stock Transfers',
  picklists:   'Pick Lists',
  shipping:    'Shipping',
  demand:      'Demand Planning',
  crm:         'CRM',
  analytics:   'Analytics',
  reports:     'Reports',
  admin:       'Admin',
};
const PAGE_LOADERS = {
  dashboard:   loadDashboard,
  catalog:     loadCatalog,
  stock:       loadStock,
  reorder:     loadReorderAlerts,
  adjustments: loadAdjustments,
  customers:   loadCustomers,
  vendors:     loadVendors,
  backorders:  loadBackorders,
  transfers:   loadTransfers,
  picklists:   loadPickLists,
  shipping:    loadShipping,
  demand:      loadDemand,
  crm:         loadCRM,
  analytics:   loadAnalytics,
  reports:     loadReports,
  admin:       loadAdmin,
};
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const pg = document.getElementById(`page-${id}`);
  if (pg) pg.classList.add('active');
  const btns = document.querySelectorAll(`.nav-item`);
  btns.forEach(b => { if (b.textContent.toLowerCase().includes(PAGE_TITLES[id]?.split(' ')[0]?.toLowerCase())) b.classList.add('active'); });
  document.getElementById('headerTitle').textContent = PAGE_TITLES[id] || '';
  if (PAGE_LOADERS[id]) PAGE_LOADERS[id]();
  if (id === 'barcode') setTimeout(() => { const inp = document.getElementById('barcodeInput'); if (inp) inp.focus(); }, 60);
}

// â”€â”€ Skeleton Rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skeletonRows(cols, n = 5) {
  return Array.from({length:n}, () => `
    <tr class="skel-row">${Array.from({length:cols}, () => `<td><div class="skeleton skel-cell" style="width:${60+Math.random()*80}%">&nbsp;</div></td>`).join('')}</tr>
  `).join('');
}

// â”€â”€ Pagination Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPagination(containerId, current, total, perPage, onPage) {
  const pages = Math.ceil(total / perPage);
  const el = document.getElementById(containerId);
  if (!el) return;
  const from = Math.min((current-1)*perPage+1, total);
  const to   = Math.min(current*perPage, total);
  el.innerHTML = `
    <span>Showing ${from}â€“${to} of ${total} records</span>
    <div class="page-btns">
      <button class="page-btn" ${current<=1?'disabled':''} onclick="(${onPage})(${current-1})">â€¹</button>
      ${Array.from({length:Math.min(pages,7)}, (_,i) => {
        const p = i+1;
        return `<button class="page-btn ${p===current?'active':''}" onclick="(${onPage})(${p})">${p}</button>`;
      }).join('')}
      <button class="page-btn" ${current>=pages?'disabled':''} onclick="(${onPage})(${current+1})">â€º</button>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  initUserHeader();
  loadHealthInfo();
  loadDashboard();
  loadReorderBadge();
  loadWarehouseFilters();
  prefetchItems();   // always load items so the adjustment dropdown is ready
});

// Prefetch items silently so dropdowns are always ready
async function prefetchItems() {
  if (allItems.length > 0) return;
  try {
    const res = await apiFetch('/api/items');
    if (!res) return;
    const data = await res.json();
    allItems = Array.isArray(data) ? data : (data.data || []);
  } catch {}
}

function initUserHeader() {
  const user = getUser();
  document.getElementById('userName').textContent   = user.name || 'User';
  document.getElementById('userAvatar').textContent = fmtInitials(user.name);
  document.getElementById('userAvatar').style.background = avatarColor(user.role);
  const badge = document.getElementById('userRoleBadge');
  badge.textContent  = user.role || '';
  badge.className    = `role-badge role-${user.role}`;
}

async function loadHealthInfo() {
  try {
    const res = await apiFetch('/api/health');
    if (!res) return;
    const { data } = await res.json();
    document.getElementById('versionFooter').textContent = `v${data.version}`;
    document.getElementById('uptimeDisplay').textContent  = `â†‘ ${Math.floor(data.uptime/60)}m`;
    const titleEl = document.querySelector('.sidebar-logo-text .sub');
    if (titleEl) titleEl.textContent = `ERP v${data.version}`;
  } catch {}
}

async function loadWarehouseFilters() {
  try {
    const res = await apiFetch('/api/warehouses');
    if (!res) return;
    const data = await res.json();
    const whs = Array.isArray(data) ? data : (data.data || []);
    const opts = whs.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
    document.getElementById('stockWarehouseFilter').innerHTML += opts;
    // adj modal
    const adjSel = document.getElementById('adjWarehouse');
    if (adjSel) adjSel.innerHTML = `<option value="">Select warehouseâ€¦</option>` + opts;
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
  loadKPIs();
  loadDashStockPreview();
  loadDashReorderPreview();
}

async function loadKPIs() {
  try {
    const res = await apiFetch('/api/dashboard/stats');
    if (!res) return;
    const { data } = await res.json();
    document.getElementById('kpiGrid').innerHTML = `
      <div class="kpi-card">
        <div class="kpi-label"><span class="ki">ğŸ“¦</span> Total SKUs</div>
        <div class="kpi-value blue">${data.total_items}</div>
        <div class="kpi-sub">${data.low_stock_count} low, ${data.out_of_stock_count} out of stock</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label"><span class="ki">ğŸ’µ</span> Inventory Value</div>
        <div class="kpi-value green">${fmtMoney(data.total_inventory_value)}</div>
        <div class="kpi-sub">Based on standard cost</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label"><span class="ki">âš ï¸</span> Reorder Alerts</div>
        <div class="kpi-value ${data.reorder_alert_count > 0 ? 'yellow' : 'green'}">${data.reorder_alert_count}</div>
        <div class="kpi-sub">${data.reorder_alert_count > 0 ? 'Items need replenishment' : 'All stock levels OK'}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label"><span class="ki">ğŸ­</span> Active Warehouses</div>
        <div class="kpi-value">${data.warehouse_count}</div>
        <div class="kpi-sub">Storage locations</div>
      </div>
    `;
    // Update nav badge
    const cnt = data.reorder_alert_count || 0;
    const badge = document.getElementById('reorderNavBadge');
    const dot   = document.getElementById('notifDot');
    if (cnt > 0) {
      badge.textContent = cnt; badge.style.display = '';
      dot.style.display = '';
    } else {
      badge.style.display = 'none';
      dot.style.display   = 'none';
    }
  } catch(e) {
    console.error('KPI error:', e);
  }
}

async function loadDashStockPreview() {
  const el = document.getElementById('dashStockPreview');
  try {
    const res = await apiFetch('/api/stock');
    if (!res) return;
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.data || []);
    if (!rows.length) {
      el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><div class="empty-title">No stock data</div></div>`;
      return;
    }
    const top = rows.slice(0, 6);
    el.innerHTML = `
      <table style="width:100%">
        <thead><tr>
          <th style="padding:10px 14px;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;background:var(--bg);border-bottom:1px solid var(--border)">Item</th>
          <th style="padding:10px 14px;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;background:var(--bg);border-bottom:1px solid var(--border);text-align:right">Available</th>
          <th style="padding:10px 14px;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;background:var(--bg);border-bottom:1px solid var(--border)">Status</th>
        </tr></thead>
        <tbody>
          ${top.map(r => `<tr style="border-bottom:1px solid var(--border)">
            <td style="padding:10px 14px">
              <div style="font-weight:600;color:var(--text0)">${r.item_name||r.name||''}</div>
              <div style="font-size:11px;color:var(--text2)">${r.item_code||r.code||''}</div>
            </td>
            <td style="padding:10px 14px;text-align:right;font-weight:700">${fmtNum(r.qty_available??r.available??r.qty_on_hand??0)}</td>
            <td style="padding:10px 14px">${stockBadge(r.qty_available??r.available??r.qty_on_hand??1, r.reorder_point??0)}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    `;
  } catch(e) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">Failed to load</div></div>`;
  }
}

async function loadDashReorderPreview() {
  const el = document.getElementById('dashReorderPreview');
  try {
    const res = await apiFetch('/api/stock/reorder-alerts');
    if (!res) return;
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.data || []);
    if (!rows.length) {
      el.innerHTML = `<div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-title">All stocked up</div><div class="empty-sub">No items below reorder point</div></div>`;
      return;
    }
    el.innerHTML = rows.slice(0,8).map(r => `
      <div style="padding:11px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
        <span style="font-size:16px">âš ï¸</span>
        <div style="flex:1">
          <div style="font-weight:600;font-size:12px;color:var(--text0)">${r.item_name||r.name||''}</div>
          <div style="font-size:11px;color:var(--text2)">${r.item_code||r.code||''} Â· ${r.warehouse_name||''}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700;color:var(--red)">${fmtNum(r.qty_available??r.available??r.qty_on_hand??0)}</div>
          <div style="font-size:10px;color:var(--text2)">/ ${fmtNum(r.reorder_point)} min</div>
        </div>
      </div>
    `).join('');
  } catch(e) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">Failed to load</div></div>`;
  }
}

async function loadReorderBadge() {
  try {
    const res = await apiFetch('/api/stock/reorder-alerts');
    if (!res) return;
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.data || []);
    const cnt = rows.length;
    const badge = document.getElementById('reorderNavBadge');
    const dot   = document.getElementById('notifDot');
    const banner = document.getElementById('reorderBanner');
    if (cnt > 0) {
      badge.textContent = cnt; badge.style.display = '';
      dot.style.display = '';
      if (banner) { banner.classList.remove('hidden'); banner.querySelector('.banner-title').textContent = `${cnt} items below reorder point`; }
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ITEM CATALOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allItems = [], filteredItems = [], catalogPage = 1;
const CATALOG_PER_PAGE = 25;
let catalogSortCol = 'name', catalogSortDir = 'asc';

async function loadCatalog() {
  const body = document.getElementById('catalogBody');
  body.innerHTML = skeletonRows(9);
  try {
    const res = await apiFetch('/api/items');
    if (!res) return;
    const data = await res.json();
    allItems = Array.isArray(data) ? data : (data.data || []);
    // Build category filter
    const cats = [...new Set(allItems.map(i => i.category).filter(Boolean))].sort();
    const catSel = document.getElementById('catalogCategoryFilter');
    catSel.innerHTML = `<option value="">All Categories</option>` + cats.map(c => `<option value="${c}">${c}</option>`).join('');
    filterCatalog();
  } catch(e) {
    body.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">Failed to load items</div></div></td></tr>`;
    toast('error', 'Load Failed', e.message);
  }
}

function filterCatalog() {
  const q      = document.getElementById('catalogSearch').value.toLowerCase();
  const cat    = document.getElementById('catalogCategoryFilter').value;
  const status = document.getElementById('catalogStatusFilter').value;
  filteredItems = allItems.filter(i => {
    if (q && !( (i.code||'').toLowerCase().includes(q) || (i.name||'').toLowerCase().includes(q) || (i.upc_code||'').toLowerCase().includes(q) )) return false;
    if (cat && i.category !== cat) return false;
    if (status === 'active'   && !i.is_active) return false;
    if (status === 'inactive' &&  i.is_active) return false;
    return true;
  });
  sortCatalogData();
  catalogPage = 1;
  renderCatalog();
}

function sortCatalog(col) {
  if (catalogSortCol === col) catalogSortDir = catalogSortDir === 'asc' ? 'desc' : 'asc';
  else { catalogSortCol = col; catalogSortDir = 'asc'; }
  document.querySelectorAll('#catalogTable thead th').forEach(th => { th.classList.remove('sort-asc','sort-desc'); });
  const th = document.querySelector(`#catalogTable thead th[data-sort="${col}"]`);
  if (th) th.classList.add(`sort-${catalogSortDir}`);
  sortCatalogData();
  renderCatalog();
}
function sortCatalogData() {
  const dir = catalogSortDir === 'asc' ? 1 : -1;
  filteredItems.sort((a,b) => {
    const av = a[catalogSortCol] ?? '', bv = b[catalogSortCol] ?? '';
    if (typeof av === 'number') return (av - bv) * dir;
    return String(av).localeCompare(String(bv)) * dir;
  });
}

function renderCatalog() {
  const body   = document.getElementById('catalogBody');
  const total  = filteredItems.length;
  const page   = catalogPage;
  const start  = (page-1) * CATALOG_PER_PAGE;
  const items  = filteredItems.slice(start, start + CATALOG_PER_PAGE);
  document.getElementById('catalogCount').textContent = `${total} items`;

  if (!items.length) {
    body.innerHTML = `<tr><td colspan="9"><div class="empty-state">
      <div class="empty-icon">ğŸ“¦</div>
      <div class="empty-title">No items found</div>
      <div class="empty-sub">Try adjusting your search or filters, or add a new item.</div>
    </div></td></tr>`;
    document.getElementById('catalogPagination').innerHTML = '';
    return;
  }

  body.innerHTML = items.map(i => `
    <tr>
      <td><div class="cell-main">${i.code}</div>${i.upc_code ? `<div class="cell-sub">UPC: ${i.upc_code}</div>` : ''}</td>
      <td><div class="cell-main">${i.name}</div>${i.description?`<div class="cell-sub" style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${i.description}</div>`:''}</td>
      <td>${i.category ? `<span class="badge badge-gray">${i.category}</span>` : 'â€”'}</td>
      <td>${i.unit_of_measure || 'EA'}</td>
      <td style="text-align:right;font-weight:600">${fmtMoney(i.standard_cost)}</td>
      <td style="text-align:right;font-weight:600">${fmtMoney(i.sale_price)}</td>
      <td style="text-align:right">${fmtNum(i.reorder_point)}</td>
      <td>${i.is_active ? '<span class="badge badge-green">Active</span>' : '<span class="badge badge-gray">Inactive</span>'}</td>
      <td>
        <div style="display:flex;gap:4px">
          <button class="btn btn-ghost btn-sm btn-icon" onclick="editItem('${i.id}')" title="Edit">âœï¸</button>
          <button class="btn btn-danger btn-sm btn-icon" onclick="deleteItem('${i.id}','${i.name.replace(/'/g,"\\'")}',this)" title="Delete">ğŸ—‘</button>
        </div>
      </td>
    </tr>
  `).join('');

  buildPagination('catalogPagination', page, total, CATALOG_PER_PAGE,
    `function(p){catalogPage=p;renderCatalog()}`);
}

// â”€â”€ Item Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openItemModal(data = null) {
  document.getElementById('itemModalTitle').textContent = data ? 'Edit Item' : 'New Item';
  document.getElementById('itemId').value           = data?.id || '';
  document.getElementById('itemCode').value         = data?.code || '';
  document.getElementById('itemName').value         = data?.name || '';
  document.getElementById('itemCategory').value     = data?.category || '';
  document.getElementById('itemUOM').value          = data?.unit_of_measure || 'EA';
  document.getElementById('itemCost').value         = data?.standard_cost || '';
  document.getElementById('itemSalePrice').value    = data?.sale_price || '';
  document.getElementById('itemReorderPoint').value = data?.reorder_point || '';
  document.getElementById('itemReorderQty').value   = data?.reorder_qty || '';
  document.getElementById('itemUPC').value          = data?.upc_code || '';
  document.getElementById('itemLeadTime').value     = data?.lead_time_days || '';
  document.getElementById('itemDescription').value  = data?.description || '';
  ['itemCode','itemName'].forEach(id => {
    document.getElementById(id).classList.remove('error');
  });
  document.getElementById('errItemCode').textContent = '';
  document.getElementById('errItemName').textContent = '';
  openModal('itemModal');
}

async function editItem(id) {
  try {
    const res = await apiFetch(`/api/items/${id}`);
    if (!res) return;
    const data = await res.json();
    openItemModal(Array.isArray(data) ? data[0] : (data.data || data));
  } catch(e) { toast('error', 'Error', e.message); }
}

async function saveItem() {
  const id = document.getElementById('itemId').value;
  const code = document.getElementById('itemCode').value.trim();
  const name = document.getElementById('itemName').value.trim();
  let valid = true;

  if (!code) { document.getElementById('itemCode').classList.add('error'); document.getElementById('errItemCode').textContent = 'SKU code is required'; valid=false; }
  else        { document.getElementById('itemCode').classList.remove('error'); document.getElementById('errItemCode').textContent=''; }
  if (!name) { document.getElementById('itemName').classList.add('error'); document.getElementById('errItemName').textContent = 'Item name is required'; valid=false; }
  else        { document.getElementById('itemName').classList.remove('error'); document.getElementById('errItemName').textContent=''; }
  if (!valid) return;

  const payload = {
    code, name,
    category:        document.getElementById('itemCategory').value.trim() || null,
    unit_of_measure: document.getElementById('itemUOM').value,
    standard_cost:   parseFloat(document.getElementById('itemCost').value) || 0,
    sale_price:      parseFloat(document.getElementById('itemSalePrice').value) || 0,
    reorder_point:   parseFloat(document.getElementById('itemReorderPoint').value) || 0,
    reorder_qty:     parseFloat(document.getElementById('itemReorderQty').value) || 0,
    lead_time_days:  parseInt(document.getElementById('itemLeadTime').value) || 0,
    upc_code:        document.getElementById('itemUPC').value.trim() || null,
    description:     document.getElementById('itemDescription').value.trim() || null,
  };

  const btn = document.getElementById('itemSaveBtn');
  btn.disabled = true; btn.textContent = 'Savingâ€¦';

  try {
    const method = id ? 'PATCH' : 'POST';
    const url    = id ? `/api/items/${id}` : '/api/items';
    const res    = await apiFetch(url, { method, body: JSON.stringify(payload) });
    const body   = await res.json();
    if (!res.ok) throw new Error(body.error || 'Failed to save');
    closeModal('itemModal');
    toast('success', id ? 'Item Updated' : 'Item Created', name);
    loadCatalog();
  } catch(e) {
    toast('error', 'Save Failed', e.message);
  } finally {
    btn.disabled = false; btn.textContent = 'Save Item';
  }
}

async function deleteItem(id, name, btnEl) {
  if (!confirm(`Delete "${name}"?\n\nThis cannot be undone if stock exists.`)) return;
  try {
    const res = await apiFetch(`/api/items/${id}`, { method: 'DELETE' });
    if (res && res.ok) {
      toast('success', 'Item Deleted', name);
      loadCatalog();
    } else {
      const body = await res?.json();
      toast('error', 'Delete Failed', body?.error || 'Could not delete item');
    }
  } catch(e) { toast('error', 'Error', e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STOCK OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allStock = [], filteredStock = [], stockPage = 1;
const STOCK_PER_PAGE = 25;

async function loadStock() {
  const body = document.getElementById('stockBody');
  body.innerHTML = skeletonRows(8);
  try {
    const res = await apiFetch('/api/stock');
    if (!res) return;
    const data = await res.json();
    allStock = Array.isArray(data) ? data : (data.data || []);
    filterStock();
  } catch(e) {
    body.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">Failed to load stock</div></div></td></tr>`;
    toast('error', 'Load Failed', e.message);
  }
}

function filterStock() {
  const q    = (document.getElementById('stockSearch')?.value || '').toLowerCase();
  const wh   = document.getElementById('stockWarehouseFilter')?.value;
  const stat = document.getElementById('stockStatusFilter')?.value;
  filteredStock = allStock.filter(r => {
    const avail = parseFloat(r.qty_available ?? r.available ?? r.qty_on_hand ?? 0);
    const rp    = parseFloat(r.reorder_point ?? 0);
    if (q && !( (r.item_name||r.name||'').toLowerCase().includes(q) || (r.item_code||r.code||'').toLowerCase().includes(q) )) return false;
    if (wh && r.warehouse_id !== wh) return false;
    if (stat === 'in_stock'    && !(avail > rp)) return false;
    if (stat === 'low_stock'   && !(avail > 0 && avail <= rp)) return false;
    if (stat === 'out_of_stock'&& avail > 0) return false;
    return true;
  });
  stockPage = 1;
  renderStock();
}

function renderStock() {
  const body  = document.getElementById('stockBody');
  const total = filteredStock.length;
  const start = (stockPage-1) * STOCK_PER_PAGE;
  const rows  = filteredStock.slice(start, start + STOCK_PER_PAGE);
  document.getElementById('stockCount').textContent = `${total} records`;

  if (!rows.length) {
    body.innerHTML = `<tr><td colspan="8"><div class="empty-state">
      <div class="empty-icon">ğŸ­</div>
      <div class="empty-title">No stock records</div>
      <div class="empty-sub">Add items and record receipts to see stock here.</div>
    </div></td></tr>`;
    document.getElementById('stockPagination').innerHTML = '';
    return;
  }

  body.innerHTML = rows.map(r => {
    const avail = parseFloat(r.qty_available ?? r.available ?? r.qty_on_hand ?? 0);
    const rp    = parseFloat(r.reorder_point ?? 0);
    return `<tr>
      <td><div class="cell-main">${r.item_code||r.code||''}</div></td>
      <td><div class="cell-main">${r.item_name||r.name||''}</div></td>
      <td>${r.warehouse_name||'â€”'}</td>
      <td style="text-align:right;font-weight:600">${fmtNum(r.qty_on_hand??0)}</td>
      <td style="text-align:right;color:var(--text2)">${fmtNum(r.qty_committed??r.qty_reserved??0)}</td>
      <td style="text-align:right;font-weight:700">${fmtNum(avail)}</td>
      <td>${stockBadge(avail, rp)}</td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick="showHistory('${r.item_id||r.id}','${(r.item_name||r.name||'').replace(/'/g,"\\'")}')">ğŸ“œ History</button>
      </td>
    </tr>`;
  }).join('');

  buildPagination('stockPagination', stockPage, total, STOCK_PER_PAGE,
    `function(p){stockPage=p;renderStock()}`);
}

async function showHistory(itemId, itemName) {
  document.getElementById('historyModalTitle').textContent = `Movement History â€” ${itemName}`;
  document.getElementById('historyBody').innerHTML = `<div class="empty-state"><div class="empty-icon">â³</div><div class="empty-title">Loadingâ€¦</div></div>`;
  openModal('historyModal');
  try {
    const res = await apiFetch(`/api/stock/${itemId}/history`);
    if (!res) return;
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.data || []);
    if (!rows.length) {
      document.getElementById('historyBody').innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">No movements yet</div></div>`;
      return;
    }
    document.getElementById('historyBody').innerHTML = rows.map(r => {
      const qty = parseFloat(r.qty);
      const isPos = qty >= 0;
      const typeColors = { receipt:'#10b981', shipment:'#ef4444', adjustment:'#f59e0b', opening_balance:'#2563eb', transfer_in:'#8b5cf6', transfer_out:'#f97316' };
      const col = typeColors[r.transaction_type] || '#64748b';
      return `<div class="history-row">
        <div class="history-badge" style="background:${col}"></div>
        <div class="history-info">
          <div style="font-size:12px;font-weight:600;color:var(--text0)">${(r.transaction_type||'').replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}</div>
          <div style="font-size:11px;color:var(--text2)">${r.warehouse_name||''} Â· ${fmtDate(r.posting_date||r.created_at)} Â· ${r.notes||r.reference_type||''}</div>
        </div>
        <div class="history-qty ${isPos?'pos':'neg'}">${isPos?'+':''}${fmtNum(qty)} ${r.unit_of_measure||''}</div>
      </div>`;
    }).join('');
  } catch(e) {
    document.getElementById('historyBody').innerHTML = `<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">Failed to load</div></div>`;
  }
}

function printStockReport() {
  window.print();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REORDER ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadReorderAlerts() {
  const body = document.getElementById('reorderBody');
  body.innerHTML = skeletonRows(7);
  try {
    const res = await apiFetch('/api/stock/reorder-alerts');
    if (!res) return;
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.data || []);
    document.getElementById('reorderCount').textContent = `${rows.length} items`;

    if (!rows.length) {
      body.innerHTML = `<tr><td colspan="8"><div class="empty-state">
        <div class="empty-icon">âœ…</div>
        <div class="empty-title">All stocked up!</div>
        <div class="empty-sub">No items are below their reorder point. Great work!</div>
      </div></td></tr>`;
      return;
    }

    body.innerHTML = rows.map(r => {
      const avail    = parseFloat(r.qty_available ?? 0);
      const rp       = parseFloat(r.reorder_point ?? 0);
      const shortfall = parseFloat(r.shortfall ?? Math.max(rp - avail, 0));
      const sugg     = parseFloat(r.reorder_qty   ?? shortfall) || shortfall;
      const isOut    = avail <= 0;
      return `<tr>
        <td><div class="cell-main">${r.item_code||r.code||''}</div></td>
        <td>
          <div class="cell-main">${r.item_name||r.name||''}</div>
          <div class="cell-sub">${r.category||''}</div>
        </td>
        <td style="font-size:11px;color:var(--text2)">${r.warehouse_names||'All warehouses'}</td>
        <td style="text-align:right;color:${isOut?'var(--red)':'var(--yellow)'};font-weight:700">${fmtNum(avail)}</td>
        <td style="text-align:right">${fmtNum(rp)}</td>
        <td style="text-align:right;color:var(--red);font-weight:700">${fmtNum(shortfall)}</td>
        <td style="text-align:right;color:var(--blue);font-weight:600">${fmtNum(sugg)}</td>
        <td>
          <button class="btn btn-primary btn-sm"
            onclick="openQuickPO('${r.item_id}','${(r.item_name||'').replace(/'/g,"\\'")}','${r.item_code||''}',${shortfall},${sugg})">
            ğŸ“‹ Create PO
          </button>
        </td>
      </tr>`;
    }).join('');
  } catch(e) {
    body.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">Failed to load</div></div></td></tr>`;
    toast('error', 'Load Failed', e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADJUSTMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let adjLineCount = 0;

async function loadAdjustments() {
  const body = document.getElementById('adjBody');
  body.innerHTML = skeletonRows(7);
  const status = document.getElementById('adjStatusFilter')?.value;
  try {
    const url = status ? `/api/adjustments?status=${status}` : '/api/adjustments';
    const res = await apiFetch(url);
    if (!res) return;
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.data || []);
    document.getElementById('adjCount').textContent = `${rows.length} adjustments`;

    if (!rows.length) {
      body.innerHTML = `<tr><td colspan="7"><div class="empty-state">
        <div class="empty-icon">ğŸ“</div>
        <div class="empty-title">No adjustments</div>
        <div class="empty-sub">Create a stock adjustment for cycle counts, damaged goods, or corrections.</div>
      </div></td></tr>`;
      return;
    }

    body.innerHTML = rows.map(r => `
      <tr>
        <td><div class="cell-main">${r.number||'â€”'}</div></td>
        <td>${fmtDate(r.adj_date||r.created_at)}</td>
        <td>${r.reason||'â€”'}</td>
        <td>${r.warehouse_name||'â€”'}</td>
        <td>${r.line_count||'â€”'}</td>
        <td>${r.status === 'posted'
          ? '<span class="badge badge-green">Posted</span>'
          : '<span class="badge badge-yellow">Draft</span>'}</td>
        <td>
          <div style="display:flex;gap:4px">
            ${r.status !== 'posted' ? `
              <button class="btn btn-success btn-sm" onclick="postAdjustment('${r.id}',this)">Post</button>
              <button class="btn btn-danger btn-sm" onclick="deleteAdjustment('${r.id}',this)">Delete</button>
            ` : '<span style="color:var(--text3);font-size:11px">Completed</span>'}
          </div>
        </td>
      </tr>
    `).join('');
  } catch(e) {
    body.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">Failed to load</div></div></td></tr>`;
    toast('error', 'Load Failed', e.message);
  }
}

async function openAdjModal() {
  document.getElementById('adjReason').value    = '';
  document.getElementById('adjWarehouse').value = '';
  document.getElementById('adjNotes').value     = '';
  document.getElementById('adjLines').innerHTML = '';
  adjLineCount = 0;
  // Ensure items are loaded before opening
  if (allItems.length === 0) await prefetchItems();
  addAdjLine();
  openModal('adjModal');
}

async function addAdjLine() {
  // If still no items, fetch now
  if (allItems.length === 0) await prefetchItems();

  adjLineCount++;
  const id = `line_${adjLineCount}`;
  const div = document.createElement('div');
  div.id = id;
  div.style.cssText = 'margin-bottom:8px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm)';

  // Build searchable item list with a text input + datalist
  const opts = allItems
    .filter(i => i.is_active)
    .sort((a,b) => (a.code||'').localeCompare(b.code||''))
    .map(i => `<option value="${i.code} â€” ${i.name}" data-id="${i.id}" data-cost="${i.standard_cost}"></option>`)
    .join('');

  div.innerHTML = `
    <div style="display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;align-items:end">
      <div class="form-group" style="margin:0">
        <label>Item * <span style="font-weight:400;color:var(--text3)">(type to search)</span></label>
        <input type="text" class="adj-item-input" list="itemList_${id}"
          placeholder="Search by SKU or nameâ€¦"
          oninput="onAdjItemInput(this,'${id}')"
          autocomplete="off"/>
        <datalist id="itemList_${id}">${opts}</datalist>
        <input type="hidden" class="adj-item-id" data-lineid="${id}"/>
      </div>
      <div class="form-group" style="margin:0">
        <label>Qty Change (Â±)</label>
        <input type="number" class="adj-qty" step="0.01" placeholder="+10 or -5"/>
      </div>
      <div class="form-group" style="margin:0">
        <label>Unit Cost ($)</label>
        <input type="number" class="adj-cost" step="0.01" placeholder="0.00" min="0"/>
      </div>
      <button class="btn btn-danger btn-sm btn-icon" style="margin-bottom:0" onclick="document.getElementById('${id}').remove()" title="Remove line">âœ•</button>
    </div>
    <div style="font-size:11px;color:var(--text3);margin-top:4px" id="adjLineHint_${id}"></div>
  `;
  document.getElementById('adjLines').appendChild(div);
}

function onAdjItemInput(inputEl, lineId) {
  const val = inputEl.value;
  const list = document.getElementById(`itemList_${lineId}`);
  const row  = document.getElementById(lineId);
  if (!list || !row) return;

  // Find the matching option
  const matched = Array.from(list.options).find(o => o.value === val);
  const hiddenId = row.querySelector('.adj-item-id');
  const costEl   = row.querySelector('.adj-cost');
  const hintEl   = document.getElementById(`adjLineHint_${lineId}`);

  if (matched) {
    const itemId = matched.dataset.id;
    const cost   = parseFloat(matched.dataset.cost || 0);
    if (hiddenId) hiddenId.value = itemId;
    if (costEl && !costEl.value) costEl.value = cost.toFixed(2);
    // Show current stock hint
    if (hintEl && itemId) {
      apiFetch(`/api/stock/${itemId}/availability`).then(r => r?.json()).then(data => {
        const rows = Array.isArray(data) ? data : (data.data || []);
        const total = rows.reduce((s,r) => s + parseFloat(r.qty_available ?? r.qty_on_hand ?? 0), 0);
        hintEl.textContent = `Current total stock: ${total.toLocaleString()} units`;
        hintEl.style.color = total <= 0 ? 'var(--red)' : 'var(--text3)';
      }).catch(() => {});
    }
    inputEl.style.borderColor = '';
  } else {
    if (hiddenId) hiddenId.value = '';
    if (hintEl)   hintEl.textContent = '';
    // Only show error if user has typed enough to expect a match
    if (val.length > 2) inputEl.style.borderColor = 'var(--red)';
    else inputEl.style.borderColor = '';
  }
}

async function saveAdjustment() {
  const reason    = document.getElementById('adjReason').value;
  const warehouseId = document.getElementById('adjWarehouse').value;
  const notes     = document.getElementById('adjNotes').value.trim();
  let valid = true;

  if (!reason)      { document.getElementById('errAdjReason').textContent = 'Required'; valid=false; }
  else               { document.getElementById('errAdjReason').textContent = ''; }
  if (!warehouseId) { document.getElementById('errAdjWarehouse').textContent = 'Required'; valid=false; }
  else               { document.getElementById('errAdjWarehouse').textContent = ''; }
  if (!valid) return;

  const lineEls = document.querySelectorAll('#adjLines div[id^="line_"]');
  const lines   = [];
  for (const row of lineEls) {
    const itemId = row.querySelector('.adj-item-id')?.value
                || row.querySelector('.adj-item-sel')?.value; // fallback
    const qty    = parseFloat(row.querySelector('.adj-qty')?.value);
    const cost   = parseFloat(row.querySelector('.adj-cost')?.value) || 0;
    if (itemId && !isNaN(qty) && qty !== 0) lines.push({ item_id: itemId, qty_actual: qty, cost_per_unit: cost });
  }
  if (!lines.length) { toast('warning', 'No Lines', 'Add at least one valid line item.'); return; }

  const btn = document.getElementById('adjSaveBtn');
  btn.disabled = true; btn.textContent = 'Savingâ€¦';

  try {
    const res = await apiFetch('/api/adjustments', {
      method: 'POST',
      body: JSON.stringify({ reason, warehouse_id: warehouseId, notes, lines })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Failed to create adjustment');
    closeModal('adjModal');
    toast('success', 'Adjustment Created', `Draft ${data.number || ''} saved`);
    loadAdjustments();
  } catch(e) {
    toast('error', 'Save Failed', e.message);
  } finally {
    btn.disabled = false; btn.textContent = 'Save Draft';
  }
}

async function postAdjustment(id, btnEl) {
  if (!confirm('Post this adjustment? This will update stock levels and cannot be undone.')) return;
  const origText = btnEl.textContent;
  btnEl.disabled = true; btnEl.textContent = 'Postingâ€¦';
  try {
    const res = await apiFetch(`/api/adjustments/${id}/post`, { method: 'POST' });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Failed to post');
    toast('success', 'Adjustment Posted', 'Stock levels have been updated.');
    loadAdjustments();
    loadKPIs();
  } catch(e) {
    toast('error', 'Post Failed', e.message);
    btnEl.disabled = false; btnEl.textContent = origText;
  }
}

async function deleteAdjustment(id, btnEl) {
  if (!confirm('Delete this draft adjustment?')) return;
  try {
    const res = await apiFetch(`/api/adjustments/${id}`, { method: 'DELETE' });
    if (res && res.ok) {
      toast('success', 'Deleted', 'Draft adjustment removed.');
      loadAdjustments();
    } else {
      const data = await res?.json();
      toast('error', 'Delete Failed', data?.error || 'Could not delete');
    }
  } catch(e) { toast('error', 'Error', e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUICK CREATE PO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _vendorsCache = [];
let _quickPOItem  = null;

async function openQuickPO(itemId, itemName, itemCode, shortfall, reorderQty) {
  _quickPOItem = { itemId, itemName, itemCode, shortfall, reorderQty };

  // Item summary card
  const suggestedQty = parseFloat(reorderQty) || parseFloat(shortfall) || 1;
  document.getElementById('quickPOItemSummary').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700;color:var(--text0)">${itemName}</div>
        <div style="font-size:11px;color:var(--text2);margin-top:2px">SKU: ${itemCode}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;color:var(--text2)">Shortfall</div>
        <div style="font-weight:700;color:var(--red);font-size:16px">${fmtNum(shortfall)} units</div>
      </div>
    </div>
  `;

  document.getElementById('quickPOItemId').value = itemId;
  document.getElementById('quickPOQty').value    = Math.ceil(suggestedQty);
  // Default expected date = 14 days from now
  const d = new Date(); d.setDate(d.getDate() + 14);
  document.getElementById('quickPODate').value = d.toISOString().slice(0, 10);
  document.getElementById('quickPONotes').value = '';
  document.getElementById('errQuickPOVendor').textContent   = '';
  document.getElementById('errQuickPOWarehouse').textContent = '';

  // Load vendors and warehouses into dropdowns
  await Promise.all([loadQuickPOVendors(), loadQuickPOWarehouses()]);
  openModal('quickPOModal');
}

async function loadQuickPOVendors() {
  const sel = document.getElementById('quickPOVendor');
  if (_vendorsCache.length === 0) {
    try {
      const res = await apiFetch('/api/vendors');
      if (!res) return;
      const data = await res.json();
      _vendorsCache = Array.isArray(data) ? data : (data.data || []);
    } catch { return; }
  }
  sel.innerHTML = '<option value="">Select vendorâ€¦</option>' +
    _vendorsCache.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
}

async function loadQuickPOWarehouses() {
  const sel = document.getElementById('quickPOWarehouse');
  try {
    const res = await apiFetch('/api/warehouses');
    if (!res) return;
    const data = await res.json();
    const whs  = Array.isArray(data) ? data : (data.data || []);
    sel.innerHTML = '<option value="">Select warehouseâ€¦</option>' +
      whs.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
  } catch {}
}

async function submitQuickPO() {
  const vendorId    = document.getElementById('quickPOVendor').value;
  const warehouseId = document.getElementById('quickPOWarehouse').value;
  const qty         = parseFloat(document.getElementById('quickPOQty').value);
  const itemId      = document.getElementById('quickPOItemId').value;
  const expDate     = document.getElementById('quickPODate').value;
  const notes       = document.getElementById('quickPONotes').value.trim();
  let valid = true;

  if (!vendorId)    { document.getElementById('errQuickPOVendor').textContent   = 'Required'; valid = false; }
  else               { document.getElementById('errQuickPOVendor').textContent   = ''; }
  if (!warehouseId) { document.getElementById('errQuickPOWarehouse').textContent = 'Required'; valid = false; }
  else               { document.getElementById('errQuickPOWarehouse').textContent = ''; }
  if (!valid) return;

  const btn = document.getElementById('quickPOBtn');
  btn.disabled = true; btn.textContent = 'Creatingâ€¦';

  try {
    const res  = await apiFetch('/api/purchase-orders', {
      method: 'POST',
      body: JSON.stringify({
        vendor_id:     vendorId,
        warehouse_id:  warehouseId,
        expected_date: expDate || null,
        notes:         notes || null,
        lines: [{ item_id: itemId, qty_ordered: qty }]
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Failed to create PO');

    closeModal('quickPOModal');
    const poNumber = data.number || data.data?.number || '';

    // Show success toast with link to purchasing
    const c = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = 'toast success';
    t.innerHTML = `
      <span class="toast-icon">âœ…</span>
      <div class="toast-body">
        <div class="toast-title">PO Created â€” ${poNumber}</div>
        <div class="toast-msg">Draft purchase order ready. <a href="/purchasing" style="color:#34d399;font-weight:600">Open Purchasing â†’</a></div>
      </div>
      <button class="toast-close" onclick="this.closest('.toast').remove()">âœ•</button>
    `;
    c.appendChild(t);
    setTimeout(() => { t.style.animation='slideOut .25s ease forwards'; setTimeout(()=>t.remove(),250); }, 7000);

  } catch(e) {
    toast('error', 'PO Failed', e.message);
  } finally {
    btn.disabled = false; btn.textContent = 'Create Draft PO';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BARCODE LOOKUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scanHistory = [];

function onBarcodeKey(e) {
  if (e.key === 'Enter') { e.preventDefault(); doBarcodeLookup(); }
}

function clearBarcode() {
  document.getElementById('barcodeInput').value = '';
  document.getElementById('barcodeResult').innerHTML = `
    <div class="scan-empty">
      <div class="scan-empty-icon">ğŸ“·</div>
      <div class="scan-empty-title">Ready to Scan</div>
      <div class="scan-empty-sub">Connect a USB barcode scanner or type a UPC / SKU above and press Enter</div>
    </div>`;
  document.getElementById('barcodeInput').focus();
}

function clearScanHistory() {
  scanHistory = [];
  renderScanHistory();
}

async function doBarcodeLookup() {
  const raw = (document.getElementById('barcodeInput').value || '').trim();
  if (!raw) return;

  const el = document.getElementById('barcodeResult');
  el.innerHTML = `<div class="scan-empty"><div class="scan-empty-icon" style="font-size:32px">â³</div><div class="scan-empty-title">Looking upâ€¦</div></div>`;

  try {
    // Try UPC lookup first, then fall back to full item list search
    let item = null;
    try {
      const res = await apiFetch(`/api/items/by-upc/${encodeURIComponent(raw)}`);
      if (res) { const d = await res.json(); if (d && d.id) item = d; }
    } catch {}

    if (!item) {
      const res2 = await apiFetch('/api/items');
      if (res2) {
        const data = await res2.json();
        const rows = Array.isArray(data) ? data : (data.data || []);
        const q = raw.toLowerCase();
        item = rows.find(r =>
          (r.code||'').toLowerCase() === q ||
          (r.upc_code||'').toLowerCase() === q
        ) || rows.find(r =>
          (r.code||'').toLowerCase().includes(q) ||
          (r.name||'').toLowerCase().includes(q)
        );
      }
    }

    if (!item) {
      el.innerHTML = `
        <div class="scan-empty">
          <div class="scan-empty-icon">âŒ</div>
          <div class="scan-empty-title">Item Not Found</div>
          <div class="scan-empty-sub">No item found matching "<strong>${escHtml(raw)}</strong>"</div>
        </div>`;
      return;
    }

    // Load stock levels by warehouse
    let stockRows = [];
    try {
      const sr = await apiFetch(`/api/stock/${item.id}/availability`);
      if (sr) { const sd = await sr.json(); stockRows = Array.isArray(sd) ? sd : (sd.data || []); }
    } catch {}

    // Record in history
    scanHistory = [{ upc: raw, item, time: new Date() }, ...scanHistory.filter(s => s.upc !== raw)].slice(0, 10);
    renderScanHistory();

    const totalStock = stockRows.reduce((s, r) => s + parseFloat(r.qty_available ?? r.qty_on_hand ?? 0), 0);
    const reorderPt  = parseFloat(item.reorder_point || 0);
    const overallBadge = totalStock <= 0
      ? `<span class="badge badge-red">Out of Stock</span>`
      : totalStock <= reorderPt
        ? `<span class="badge badge-yellow">Low Stock</span>`
        : `<span class="badge badge-green">In Stock</span>`;

    el.innerHTML = `
      <div class="item-result-card">
        <div class="item-result-header">
          <div class="item-result-icon">âŒš</div>
          <div class="item-result-meta">
            <div class="item-result-name">${escHtml(item.name)}</div>
            <div class="item-result-sku">
              SKU: <strong>${escHtml(item.code)}</strong>
              ${item.upc_code ? ` &nbsp;Â·&nbsp; UPC: <strong>${escHtml(item.upc_code)}</strong>` : ''}
              &nbsp;Â·&nbsp; ${escHtml(item.category || 'Uncategorized')}
              &nbsp;Â·&nbsp; ${overallBadge}
            </div>
          </div>
          <div class="item-result-actions">
            <button class="btn btn-ghost btn-sm" onclick="openItemModal(${item.id})">âœï¸ Edit</button>
            <button class="btn btn-primary btn-sm" onclick="openAdjModal()">+ Adjustment</button>
          </div>
        </div>
        <div style="padding:20px 24px">
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:20px">
            <div class="kpi-card" style="margin:0">
              <div class="kpi-label"><span class="ki">ğŸ“¦</span> Total Available</div>
              <div class="kpi-value ${totalStock > 0 ? 'green' : 'red'}">${fmtNum(totalStock)}</div>
            </div>
            <div class="kpi-card" style="margin:0">
              <div class="kpi-label"><span class="ki">ğŸ’µ</span> Standard Cost</div>
              <div class="kpi-value">${fmtMoney(item.standard_cost || 0)}</div>
            </div>
            <div class="kpi-card" style="margin:0">
              <div class="kpi-label"><span class="ki">ğŸ·</span> Sale Price</div>
              <div class="kpi-value blue">${fmtMoney(item.sale_price || 0)}</div>
            </div>
            <div class="kpi-card" style="margin:0">
              <div class="kpi-label"><span class="ki">âš ï¸</span> Reorder Point</div>
              <div class="kpi-value">${fmtNum(reorderPt)}</div>
            </div>
          </div>

          ${stockRows.length ? `
            <div style="font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">Stock by Warehouse</div>
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr style="background:var(--bg)">
                  <th style="padding:8px 12px;font-size:11px;font-weight:700;color:var(--text2);text-align:left;border-bottom:1px solid var(--border)">Warehouse</th>
                  <th style="padding:8px 12px;font-size:11px;font-weight:700;color:var(--text2);text-align:right;border-bottom:1px solid var(--border)">On Hand</th>
                  <th style="padding:8px 12px;font-size:11px;font-weight:700;color:var(--text2);text-align:right;border-bottom:1px solid var(--border)">Reserved</th>
                  <th style="padding:8px 12px;font-size:11px;font-weight:700;color:var(--text2);text-align:right;border-bottom:1px solid var(--border)">Available</th>
                  <th style="padding:8px 12px;font-size:11px;font-weight:700;color:var(--text2);text-align:left;border-bottom:1px solid var(--border)">Status</th>
                </tr>
              </thead>
              <tbody>
                ${stockRows.map(r => {
                  const avail = parseFloat(r.qty_available ?? r.qty_on_hand ?? 0);
                  return `<tr style="border-bottom:1px solid var(--border)">
                    <td style="padding:10px 12px;font-weight:600">${escHtml(r.warehouse_name || r.warehouse_code || 'â€”')}</td>
                    <td style="padding:10px 12px;text-align:right">${fmtNum(r.qty_on_hand || 0)}</td>
                    <td style="padding:10px 12px;text-align:right;color:var(--text2)">${fmtNum(r.qty_committed || 0)}</td>
                    <td style="padding:10px 12px;text-align:right;font-weight:700">${fmtNum(avail)}</td>
                    <td style="padding:10px 12px">${stockBadge(avail, reorderPt)}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          ` : `<div style="color:var(--text3);font-size:13px;padding:8px 0">No stock records found for this item.</div>`}
        </div>
      </div>
    `;
  } catch(e) {
    el.innerHTML = `<div class="scan-empty"><div class="scan-empty-icon">âš ï¸</div><div class="scan-empty-title">Lookup Failed</div><div class="scan-empty-sub">${escHtml(e.message)}</div></div>`;
  }
}

function renderScanHistory() {
  const card = document.getElementById('barcodeHistoryCard');
  const el   = document.getElementById('barcodeHistory');
  if (!el || !card) return;
  if (!scanHistory.length) { card.style.display = 'none'; return; }
  card.style.display = '';
  el.innerHTML = scanHistory.map(s => `
    <div class="scan-history-row" onclick="document.getElementById('barcodeInput').value=${JSON.stringify(s.upc)};doBarcodeLookup()">
      <span style="font-size:18px">ğŸ“¦</span>
      <div style="flex:1;min-width:0">
        <div style="font-weight:600;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escHtml(s.item.name)}</div>
        <div style="font-size:11px;color:var(--text3)">${escHtml(s.upc)} Â· SKU: ${escHtml(s.item.code)}</div>
      </div>
      <div style="font-size:11px;color:var(--text3);flex-shrink:0">${s.time.toLocaleTimeString()}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CUSTOMERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _allCustomers = [], _custPage = 1;
const CUST_PER_PAGE = 20;

async function loadCustomers() {
  const body = document.getElementById('custBody');
  body.innerHTML = skeletonRows(8);
  try {
    const res  = await apiFetch('/api/customers?limit=200');
    if (!res) return;
    const data = await res.json();
    _allCustomers = Array.isArray(data) ? data : (data.data || []);
    _custPage = 1;
    renderCustomers();
  } catch(e) { toast('error', 'Load Failed', e.message); }
}

function filterCustomers() {
  const q = (document.getElementById('custSearch')?.value || '').toLowerCase();
  _custPage = 1;
  renderCustomers(q);
}

function renderCustomers(q = '') {
  const filtered = q ? _allCustomers.filter(c =>
    (c.code||'').toLowerCase().includes(q) ||
    (c.name||'').toLowerCase().includes(q) ||
    (c.email||'').toLowerCase().includes(q) ||
    (c.contact_name||'').toLowerCase().includes(q)
  ) : _allCustomers;

  const start   = (_custPage - 1) * CUST_PER_PAGE;
  const slice   = filtered.slice(start, start + CUST_PER_PAGE);

  document.getElementById('custCount').textContent = `${filtered.length} customers`;
  document.getElementById('custBody').innerHTML = slice.length ? slice.map(c => `
    <tr>
      <td><span class="badge badge-blue">${escHtml(c.code)}</span></td>
      <td style="font-weight:600">${escHtml(c.name)}</td>
      <td>${escHtml(c.contact_name||'â€”')}</td>
      <td>${escHtml(c.email||'â€”')}</td>
      <td>${escHtml(c.phone||'â€”')}</td>
      <td><span class="badge">${escHtml(c.payment_terms_label||c.payment_terms_days+'d')}</span></td>
      <td style="text-align:right;font-weight:600;color:${parseFloat(c.ar_balance||0)>0?'var(--red)':'var(--text1)'}">${fmtMoney(c.ar_balance||0)}</td>
      <td>${c.is_active!==false ? '<span class="badge badge-green">Active</span>' : '<span class="badge">Inactive</span>'}</td>
    </tr>`).join('') :
    `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text3)">No customers found</td></tr>`;

  buildPagination('custPagination', _custPage, filtered.length, CUST_PER_PAGE, p => { _custPage=p; renderCustomers(q); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VENDORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _allVendors = [], _vendPage = 1;
const VEND_PER_PAGE = 20;

async function loadVendors() {
  const body = document.getElementById('vendBody');
  body.innerHTML = skeletonRows(8);
  try {
    const res  = await apiFetch('/api/vendors?limit=200');
    if (!res) return;
    const data = await res.json();
    _allVendors = Array.isArray(data) ? data : (data.data || []);
    _vendPage = 1;
    renderVendors();
  } catch(e) { toast('error', 'Load Failed', e.message); }
}

function filterVendors() {
  const q = (document.getElementById('vendSearch')?.value || '').toLowerCase();
  _vendPage = 1;
  renderVendors(q);
}

function renderVendors(q = '') {
  const filtered = q ? _allVendors.filter(v =>
    (v.code||'').toLowerCase().includes(q) ||
    (v.name||'').toLowerCase().includes(q) ||
    (v.email||'').toLowerCase().includes(q) ||
    (v.contact_name||'').toLowerCase().includes(q)
  ) : _allVendors;

  const start = (_vendPage - 1) * VEND_PER_PAGE;
  const slice = filtered.slice(start, start + VEND_PER_PAGE);

  document.getElementById('vendCount').textContent = `${filtered.length} vendors`;
  document.getElementById('vendBody').innerHTML = slice.length ? slice.map(v => `
    <tr>
      <td><span class="badge badge-blue">${escHtml(v.code)}</span></td>
      <td style="font-weight:600">${escHtml(v.name)}</td>
      <td>${escHtml(v.contact_name||'â€”')}</td>
      <td>${escHtml(v.email||'â€”')}</td>
      <td style="text-align:right">${escHtml(String(v.lead_time_days||0))} days</td>
      <td><span class="badge">${escHtml(v.payment_terms_label||v.payment_terms_days+'d')}</span></td>
      <td style="text-align:right;font-weight:600;color:${parseFloat(v.ap_balance||0)>0?'var(--red)':'var(--text1)'}">${fmtMoney(v.ap_balance||0)}</td>
      <td>${v.is_active!==false ? '<span class="badge badge-green">Active</span>' : '<span class="badge">Inactive</span>'}</td>
    </tr>`).join('') :
    `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text3)">No vendors found</td></tr>`;

  buildPagination('vendPagination', _vendPage, filtered.length, VEND_PER_PAGE, p => { _vendPage=p; renderVendors(q); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKORDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _boPage = 1, _boTotal = 0;
const BO_PER_PAGE = 20;

async function loadBackorders() {
  const body = document.getElementById('backorderBody');
  body.innerHTML = skeletonRows(8);
  const status = document.getElementById('backorderStatusFilter')?.value || '';
  const qs = new URLSearchParams({ limit: BO_PER_PAGE, page: _boPage });
  if (status) qs.set('status', status);
  try {
    const res  = await apiFetch(`/api/backorders?${qs}`);
    if (!res) return;
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.data || []);
    _boTotal = data.meta?.total || rows.length;

    // Update badge
    const badge = document.getElementById('backorderNavBadge');
    if (badge && _boTotal > 0) { badge.textContent = _boTotal; badge.style.display = ''; }
    else if (badge) badge.style.display = 'none';

    document.getElementById('backorderCount').textContent = `${_boTotal} backorders`;
    document.getElementById('backorderBody').innerHTML = rows.length ? rows.map(b => `
      <tr>
        <td><a href="/sales" style="font-weight:600;color:var(--blue)">${escHtml(b.order_number)}</a></td>
        <td>${escHtml(b.customer_name)}</td>
        <td>${escHtml(b.item_name)} <span style="color:var(--text3);font-size:11px">${escHtml(b.item_code)}</span></td>
        <td>${escHtml(b.warehouse_code)}</td>
        <td style="text-align:right;font-weight:600">${fmtNum(b.qty_backordered)}</td>
        <td style="text-align:right;font-weight:600;color:var(--red)">${fmtNum(b.qty_remaining)}</td>
        <td>${statusBadge(b.status)}</td>
        <td style="color:var(--text2)">${fmtDateShort(b.created_at)}</td>
      </tr>`).join('') :
      `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text3)">No open backorders</td></tr>`;

    buildPagination('backorderPagination', _boPage, _boTotal, BO_PER_PAGE, p => { _boPage=p; loadBackorders(); });
  } catch(e) { toast('error', 'Load Failed', e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSFERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _trPage = 1, _trTotal = 0;
const TR_PER_PAGE = 20;

async function loadTransfers() {
  const body = document.getElementById('transferBody');
  body.innerHTML = skeletonRows(7);
  const status = document.getElementById('transferStatusFilter')?.value || '';
  const qs = new URLSearchParams({ limit: TR_PER_PAGE, page: _trPage });
  if (status) qs.set('status', status);
  try {
    const res  = await apiFetch(`/api/transfers?${qs}`);
    if (!res) return;
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.data || []);
    _trTotal = data.meta?.total || rows.length;

    document.getElementById('transferCount').textContent = `${_trTotal} transfers`;
    document.getElementById('transferBody').innerHTML = rows.length ? rows.map(t => `
      <tr>
        <td style="font-weight:600">${escHtml(t.number)}</td>
        <td>${fmtDateShort(t.transfer_date)}</td>
        <td><span class="badge">${escHtml(t.from_warehouse_code)}</span></td>
        <td><span class="badge badge-blue">${escHtml(t.to_warehouse_code)}</span></td>
        <td style="text-align:right">${escHtml(String(t.line_count||0))}</td>
        <td>${statusBadge(t.status)}</td>
        <td>
          ${t.status==='draft' ? `<button class="btn btn-ghost btn-sm" onclick="postTransfer('${t.id}',this)">âœ“ Post</button>` : ''}
        </td>
      </tr>`).join('') :
      `<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3)">No transfers found</td></tr>`;

    buildPagination('transferPagination', _trPage, _trTotal, TR_PER_PAGE, p => { _trPage=p; loadTransfers(); });
  } catch(e) { toast('error', 'Load Failed', e.message); }
}

async function postTransfer(id, btn) {
  if (!confirm('Post this transfer? Stock will be moved immediately.')) return;
  btn.disabled = true; btn.textContent = 'Postingâ€¦';
  try {
    const res  = await apiFetch(`/api/transfers/${id}/post`, { method: 'POST', body: JSON.stringify({}) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || data.message || 'Failed');
    toast('success', 'Transfer Posted', `Stock moved successfully.`);
    loadTransfers();
  } catch(e) {
    toast('error', 'Post Failed', e.message);
    btn.disabled = false; btn.textContent = 'âœ“ Post';
  }
}

function openTransferModal() {
  toast('info', 'Coming Soon', 'Transfer creation UI â€” use the API directly for now.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PICK LISTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _plPage = 1, _plTotal = 0;
const PL_PER_PAGE = 20;

async function loadPickLists() {
  const body = document.getElementById('plBody');
  body.innerHTML = skeletonRows(8);
  const status = document.getElementById('plStatusFilter')?.value || '';
  const qs = new URLSearchParams({ limit: PL_PER_PAGE, page: _plPage });
  if (status) qs.set('status', status);
  try {
    const res  = await apiFetch(`/api/picklists?${qs}`);
    if (!res) return;
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.data || []);
    _plTotal = data.meta?.total || rows.length;

    document.getElementById('plCount').textContent = `${_plTotal} pick lists`;
    document.getElementById('plBody').innerHTML = rows.length ? rows.map(p => `
      <tr>
        <td style="font-weight:600">${escHtml(p.number)}</td>
        <td><a href="/sales" style="color:var(--blue)">${escHtml(p.order_number)}</a></td>
        <td>${escHtml(p.customer_name)}</td>
        <td>${escHtml(p.warehouse_code)}</td>
        <td style="text-align:right">${escHtml(String(p.line_count||0))}</td>
        <td style="text-align:right">${escHtml(String(p.lines_picked||0))}</td>
        <td>${statusBadge(p.status)}</td>
        <td>
          <a href="/api/picklists/${p.id}/print?format=html" target="_blank" class="btn btn-ghost btn-sm">ğŸ–¨ Print</a>
        </td>
      </tr>`).join('') :
      `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text3)">No pick lists found</td></tr>`;

    buildPagination('plPagination', _plPage, _plTotal, PL_PER_PAGE, p => { _plPage=p; loadPickLists(); });
  } catch(e) { toast('error', 'Load Failed', e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadReports() {
  await Promise.all([loadInventoryValuation(), loadStockSummary(), loadReorderReport()]);
}

async function loadInventoryValuation() {
  const el = document.getElementById('invValBody');
  el.innerHTML = '<div class="empty-state"><div class="empty-icon" style="font-size:24px">â³</div><div class="empty-title">Loadingâ€¦</div></div>';
  try {
    const res  = await apiFetch('/api/reports/inventory-valuation');
    if (!res) return;
    const data = await res.json();
    const rows = data.data?.rows || data.rows || [];
    const total = data.data?.grand_total || 0;
    if (!rows.length) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><div class="empty-title">No inventory data</div></div>'; return; }
    el.innerHTML = `
      <div style="font-size:20px;font-weight:700;color:var(--green);margin-bottom:16px">Total: ${fmtMoney(total)}</div>
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>SKU</th><th>Item</th><th>Category</th><th style="text-align:right">On Hand</th><th style="text-align:right">Cost</th><th style="text-align:right">Value</th></tr></thead>
          <tbody>${rows.slice(0,20).map(r=>`
            <tr>
              <td><span class="badge badge-blue">${escHtml(r.item_code)}</span></td>
              <td>${escHtml(r.item_name)}</td>
              <td>${escHtml(r.category||'â€”')}</td>
              <td style="text-align:right">${fmtNum(r.total_qty_on_hand)}</td>
              <td style="text-align:right">${fmtMoney(r.standard_cost)}</td>
              <td style="text-align:right;font-weight:600">${fmtMoney(r.total_value)}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
      ${rows.length > 20 ? `<div style="text-align:center;padding:12px;color:var(--text2);font-size:12px">Showing top 20 of ${rows.length}. Download CSV for full report.</div>` : ''}`;
  } catch(e) { el.innerHTML = `<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">${escHtml(e.message)}</div></div>`; }
}

async function loadStockSummary() {
  const el = document.getElementById('stockSummaryBody');
  el.innerHTML = '<div class="empty-state"><div class="empty-icon" style="font-size:24px">â³</div><div class="empty-title">Loadingâ€¦</div></div>';
  try {
    const res  = await apiFetch('/api/reports/stock-summary');
    if (!res) return;
    const data = await res.json();
    const rows = data.data?.by_warehouse || [];
    if (!rows.length) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ­</div><div class="empty-title">No warehouse data</div></div>'; return; }
    el.innerHTML = `
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Warehouse</th><th style="text-align:right">Items</th><th style="text-align:right">Total Qty</th><th style="text-align:right">Available</th><th style="text-align:right">Value</th></tr></thead>
          <tbody>${rows.map(r=>`
            <tr>
              <td><strong>${escHtml(r.warehouse_name)}</strong> <span style="color:var(--text3)">(${escHtml(r.warehouse_code)})</span></td>
              <td style="text-align:right">${escHtml(String(r.item_count||0))}</td>
              <td style="text-align:right">${fmtNum(r.total_qty||0)}</td>
              <td style="text-align:right">${fmtNum(r.qty_available||0)}</td>
              <td style="text-align:right;font-weight:600">${fmtMoney(r.total_value||0)}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
  } catch(e) { el.innerHTML = `<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">${escHtml(e.message)}</div></div>`; }
}

async function loadStockMovement() {
  const el = document.getElementById('stockMovBody');
  const from = document.getElementById('movFromDate')?.value;
  const to   = document.getElementById('movToDate')?.value;
  el.innerHTML = '<div class="empty-state"><div class="empty-icon" style="font-size:24px">â³</div><div class="empty-title">Loadingâ€¦</div></div>';
  const qs = new URLSearchParams({ limit: 50 });
  if (from) qs.set('from_date', from);
  if (to)   qs.set('to_date', to);
  const csvHref = `/api/reports/stock-movement?format=csv${from?'&from_date='+from:''}${to?'&to_date='+to:''}`;
  const csvLink = document.getElementById('movCSV');
  if (csvLink) csvLink.href = csvHref;
  try {
    const res  = await apiFetch(`/api/reports/stock-movement?${qs}`);
    if (!res) return;
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.data || []);
    if (!rows.length) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">No movements found</div></div>'; return; }
    el.innerHTML = `
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Date</th><th>Type</th><th>Item</th><th>Warehouse</th><th style="text-align:right">Qty</th><th style="text-align:right">Value</th></tr></thead>
          <tbody>${rows.map(r=>`
            <tr>
              <td>${fmtDateShort(r.posting_date)}</td>
              <td><span class="badge ${r.qty>0?'badge-green':'badge-red'}">${escHtml(r.transaction_type)}</span></td>
              <td>${escHtml(r.item_name)} <span style="color:var(--text3);font-size:11px">${escHtml(r.item_code)}</span></td>
              <td>${escHtml(r.warehouse_code)}</td>
              <td style="text-align:right;font-weight:600;color:${parseFloat(r.qty)>=0?'var(--green)':'var(--red)'}">${parseFloat(r.qty)>0?'+':''}${fmtNum(r.qty)}</td>
              <td style="text-align:right">${fmtMoney(r.line_value||0)}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
  } catch(e) { el.innerHTML = `<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">${escHtml(e.message)}</div></div>`; }
}

async function loadReorderReport() {
  const el = document.getElementById('reorderReportBody');
  el.innerHTML = '<div class="empty-state"><div class="empty-icon" style="font-size:24px">â³</div><div class="empty-title">Loadingâ€¦</div></div>';
  try {
    const res  = await apiFetch('/api/reports/reorder-recommendations');
    if (!res) return;
    const data = await res.json();
    const rows = data.data || data || [];
    if (!rows.length) { el.innerHTML = '<div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-title">No items need reordering</div></div>'; return; }
    el.innerHTML = `
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>SKU</th><th>Item</th><th style="text-align:right">Available</th><th style="text-align:right">Reorder Pt.</th><th style="text-align:right">Reorder Qty</th><th>Vendor</th></tr></thead>
          <tbody>${rows.map(r=>`
            <tr>
              <td><span class="badge badge-yellow">${escHtml(r.item_code)}</span></td>
              <td>${escHtml(r.item_name)}</td>
              <td style="text-align:right;color:var(--red);font-weight:600">${fmtNum(r.qty_available||0)}</td>
              <td style="text-align:right">${fmtNum(r.reorder_point||0)}</td>
              <td style="text-align:right">${fmtNum(r.reorder_qty||0)}</td>
              <td>${escHtml(r.preferred_vendor_name||'â€”')}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
  } catch(e) { el.innerHTML = `<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">${escHtml(e.message)}</div></div>`; }
}

// â”€â”€ Status / date helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function statusBadge(s) {
  const map = {
    open: 'badge-blue', in_progress: 'badge-yellow', posted: 'badge-green',
    completed: 'badge-green', draft: '', cancelled: 'badge-red',
    partial: 'badge-yellow', fulfilled: 'badge-green'
  };
  return `<span class="badge ${map[s]||''}">${escHtml((s||'').replace(/_/g,' '))}</span>`;
}

function fmtDateShort(d) {
  if (!d) return 'â€”';
  const dt = new Date(d);
  return `${dt.getMonth()+1}/${dt.getDate()}/${dt.getFullYear()}`;
}

// â”€â”€ Shipping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let shpPage = 1;
async function loadShipping() {
  const carrier = document.getElementById('shpCarrierFilter').value;
  const params  = new URLSearchParams({ page: shpPage, limit: 25 });
  if (carrier) params.set('carrier', carrier);

  const res  = await apiFetch(`/api/shipments?${params}`);
  const data = await res.json();
  const rows = data.data || [];
  const meta = data.meta || {};

  document.getElementById('shpCount').textContent = meta.total ? `${meta.total} shipments` : '';

  const tbody = document.getElementById('shpBody');
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;color:var(--text2);padding:24px">No shipments found</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(s => `
    <tr>
      <td><strong>${escHtml(s.number)}</strong></td>
      <td>${escHtml(s.order_number || '')}</td>
      <td>${escHtml(s.customer_name || '')}</td>
      <td>${s.carrier ? `<span class="badge" style="background:#e7f3fe;color:#0d6efd">${escHtml(s.carrier)}</span>` : '<span style="color:var(--text2)">â€”</span>'}</td>
      <td style="font-size:12px">${escHtml(s.service_level || 'â€”')}</td>
      <td style="font-size:12px">${s.tracking_number ? `<code>${escHtml(s.tracking_number)}</code>` : '<span style="color:var(--text2)">â€”</span>'}</td>
      <td>${s.weight_lb ? parseFloat(s.weight_lb).toFixed(2) + ' lb' : 'â€”'}</td>
      <td>${s.freight_cost && s.freight_cost > 0 ? '$' + parseFloat(s.freight_cost).toFixed(2) : 'â€”'}</td>
      <td>${statusBadge(s.status)}</td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick="openTrackingModal('${s.id}','${escHtml(s.carrier||'')}','${escHtml(s.service_level||'')}','${escHtml(s.tracking_number||'')}')">
          ${s.tracking_number ? 'âœï¸ Update' : '+ Track'}
        </button>
        <a class="btn btn-ghost btn-sm" href="/api/print/packing-slip/${s.id}?format=html" target="_blank">ğŸ“„ Slip</a>
        <a class="btn btn-ghost btn-sm" href="/api/print/bol/${s.id}?format=html" target="_blank">ğŸ“‹ BOL</a>
      </td>
    </tr>`).join('');

  buildPagination('shpPagination', meta.page || 1, meta.total || 0, meta.limit || 25, p => { shpPage = p; loadShipping(); });
}

function openTrackingModal(id, carrier, service, tracking) {
  document.getElementById('trackingShipmentId').value = id;
  document.getElementById('trackingCarrier').value    = carrier || '';
  document.getElementById('trackingService').value    = service || '';
  document.getElementById('trackingNumber').value     = tracking || '';
  document.getElementById('trackingWeight').value     = '';
  document.getElementById('trackingFreight').value    = '';
  document.getElementById('trackingModal').classList.add('active');
}

async function saveTracking() {
  const id       = document.getElementById('trackingShipmentId').value;
  const carrier  = document.getElementById('trackingCarrier').value;
  const service  = document.getElementById('trackingService').value.trim();
  const tracking = document.getElementById('trackingNumber').value.trim();
  const weight   = document.getElementById('trackingWeight').value;
  const freight  = document.getElementById('trackingFreight').value;

  if (!carrier || !tracking) return showToast('Carrier and tracking number are required', 'error');

  const body = { carrier, tracking_number: tracking };
  if (service)  body.service_level = service;
  if (weight)   body.weight_lb     = parseFloat(weight);
  if (freight)  body.freight_cost  = parseFloat(freight);

  const res = await apiFetch(`/api/shipping/shipments/${id}/tracking`, { method: 'PATCH', body: JSON.stringify(body) });
  const data = await res.json();
  if (!data.success) return showToast(data.error || 'Failed to save tracking', 'error');

  showToast('Tracking info saved', 'success');
  closeModal('trackingModal');
  loadShipping();
}

function openRateQuoteModal() {
  document.getElementById('rqFromZip').value = '';
  document.getElementById('rqToZip').value   = '';
  document.getElementById('rqWeight').value  = '';
  document.getElementById('rateResults').innerHTML = '';
  document.getElementById('rateQuoteModal').classList.add('active');
}

async function getRates() {
  const fromZip = document.getElementById('rqFromZip').value.trim();
  const toZip   = document.getElementById('rqToZip').value.trim();
  const weight  = parseFloat(document.getElementById('rqWeight').value);

  if (!fromZip || !toZip || !weight) return showToast('From ZIP, To ZIP and weight are required', 'error');

  const res  = await apiFetch('/api/shipping/rate-quote', {
    method: 'POST',
    body: JSON.stringify({ from_zip: fromZip, to_zip: toZip, weight_lb: weight }),
  });
  const data = await res.json();
  if (!data.success) return showToast(data.error || 'Rate quote failed', 'error');

  const rates = data.data;
  const carrierColors = { UPS:'#8b5cf6', FEDEX:'#f97316', USPS:'#2563eb', DHL:'#d97706', CUSTOM:'#6b7280' };

  document.getElementById('rateResults').innerHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead><tr style="background:#f1f5f9">
        <th style="padding:8px;text-align:left">Carrier</th>
        <th style="padding:8px;text-align:left">Service</th>
        <th style="padding:8px;text-align:center">Est. Days</th>
        <th style="padding:8px;text-align:right">Rate</th>
      </tr></thead>
      <tbody>${rates.map(r => `
        <tr style="border-bottom:1px solid #e9ecef">
          <td style="padding:8px"><span class="badge" style="background:${carrierColors[r.carrier]||'#6b7280'}22;color:${carrierColors[r.carrier]||'#6b7280'}">${r.carrier}</span></td>
          <td style="padding:8px">${escHtml(r.service_level)}</td>
          <td style="padding:8px;text-align:center">${r.estimated_days}d</td>
          <td style="padding:8px;text-align:right;font-weight:600">$${r.rate.toFixed(2)}</td>
        </tr>`).join('')}
      </tbody>
    </table>
    <p style="font-size:11px;color:var(--text2);margin-top:8px;text-align:center">* Rates are estimates. Actual rates may vary by carrier.</p>`;
}

// â”€â”€ Demand Planning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const URGENCY_STYLE = {
  critical: { bg:'#fee2e2', color:'#dc2626', label:'ğŸ”´ Critical' },
  high:     { bg:'#fef3c7', color:'#d97706', label:'ğŸŸ¡ High' },
  normal:   { bg:'#dbeafe', color:'#2563eb', label:'ğŸ”µ Normal' },
  ok:       { bg:'#dcfce7', color:'#16a34a', label:'ğŸŸ¢ OK' },
};
function urgencyBadge(u) {
  const s = URGENCY_STYLE[u] || URGENCY_STYLE.ok;
  return `<span style="background:${s.bg};color:${s.color};padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700">${s.label}</span>`;
}

let _velPage = 1, _suggPage = 1;

async function loadDemand() {
  await Promise.all([loadDemandKpi(), loadVelocity(), loadSuggestions()]);
}

async function loadDemandKpi() {
  const res  = await apiFetch('/api/demand/summary');
  const d    = (await res.json()).data || {};
  document.getElementById('demandKpiGrid').innerHTML = `
    <div class="kpi-card"><div class="kpi-label">ğŸ”´ Critical Items</div><div class="kpi-value" style="color:#dc2626">${d.critical_count||0}</div><div class="kpi-sub">Need immediate reorder</div></div>
    <div class="kpi-card"><div class="kpi-label">ğŸŸ¡ High Priority</div><div class="kpi-value" style="color:#d97706">${d.high_count||0}</div><div class="kpi-sub">Below reorder point</div></div>
    <div class="kpi-card"><div class="kpi-label">âš ï¸ Stockouts</div><div class="kpi-value" style="color:#ef4444">${d.stockout_count||0}</div><div class="kpi-sub">Zero stock on hand</div></div>
    <div class="kpi-card"><div class="kpi-label">ğŸ“… Avg Days of Stock</div><div class="kpi-value">${d.avg_days_of_stock||'â€”'}</div><div class="kpi-sub">Across all active items</div></div>
    <div class="kpi-card"><div class="kpi-label">ğŸ’¡ Pending Suggestions</div><div class="kpi-value">${d.pending_suggestions||0}</div><div class="kpi-sub">Est. $${Number(d.pending_value||0).toLocaleString('en-US',{maximumFractionDigits:0})}</div></div>`;
}

async function loadVelocity() {
  const urgency = document.getElementById('demandUrgency').value;
  const sort    = document.getElementById('demandSort').value;
  const params  = new URLSearchParams({ page: _velPage, limit: 25, sort });
  if (urgency) params.set('urgency', urgency);

  const res  = await apiFetch(`/api/demand/velocity?${params}`);
  const data = await res.json();
  const rows = data.data || [];
  const meta = data.meta || {};

  document.getElementById('velCount').textContent = meta.total ? `${meta.total} items` : '';
  const tbody = document.getElementById('velBody');
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:var(--text2);padding:24px">No items found</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const days = r.days_of_stock !== null ? parseFloat(r.days_of_stock).toFixed(0) : 'â€”';
    const daysColor = r.days_of_stock === null ? 'var(--text2)'
      : r.days_of_stock < (r.lead_time_days || 14) ? '#dc2626'
      : r.days_of_stock < 30 ? '#d97706' : '#16a34a';
    return `<tr>
      <td><code>${escHtml(r.code)}</code></td>
      <td>${escHtml(r.item_name)}</td>
      <td style="text-align:right;font-weight:600">${parseFloat(r.qty_available).toFixed(0)} <span style="color:var(--text2);font-size:11px">${escHtml(r.unit_of_measure||'')}</span></td>
      <td style="text-align:right">${parseFloat(r.sold_30d).toFixed(0)}</td>
      <td style="text-align:right;font-weight:600">${parseFloat(r.velocity_30d).toFixed(2)}/day</td>
      <td style="text-align:right;font-weight:700;color:${daysColor}">${days}d</td>
      <td style="text-align:center;color:var(--text2)">${r.lead_time_days}d</td>
      <td>${urgencyBadge(r.urgency)}</td>
      <td style="font-size:12px;color:var(--text2)">${r.vendor_name ? escHtml(r.vendor_name) : 'â€”'}</td>
    </tr>`;
  }).join('');

  buildPagination('velPagination', meta.page||1, meta.total||0, meta.limit||25, p => { _velPage=p; loadVelocity(); });
}

async function loadSuggestions() {
  const status = document.getElementById('suggUrgency').value;
  const params = new URLSearchParams({ page: _suggPage, limit: 25, status });
  const res    = await apiFetch(`/api/demand/suggestions?${params}`);
  const data   = await res.json();
  const rows   = data.data || [];
  const meta   = data.meta || {};

  document.getElementById('suggCount').textContent = meta.total ? `${meta.total} suggestions` : '';
  const tbody = document.getElementById('suggBody');
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:var(--text2);padding:24px">No suggestions found</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => `
    <tr>
      <td><code>${escHtml(r.item_code)}</code></td>
      <td>${escHtml(r.item_name)}</td>
      <td style="font-size:12px">${r.vendor_name ? escHtml(r.vendor_name) : '<span style="color:var(--text2)">No vendor</span>'}</td>
      <td style="text-align:right;font-weight:600">${parseFloat(r.suggested_qty).toFixed(0)}</td>
      <td style="text-align:right">$${Number(r.estimated_value||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
      <td style="text-align:right;color:${r.days_of_stock&&r.days_of_stock<14?'#dc2626':'inherit'};font-weight:600">${r.days_of_stock ? parseFloat(r.days_of_stock).toFixed(0)+'d' : 'â€”'}</td>
      <td>${urgencyBadge(r.urgency)}</td>
      <td style="font-size:11px;color:var(--text2);max-width:200px">${escHtml(r.notes||'')}</td>
      <td>
        ${r.status==='pending' ? `
          <button class="btn btn-primary btn-sm" onclick="approveSuggestion('${r.id}')">âœ“ Create PO</button>
          <button class="btn btn-ghost btn-sm" onclick="dismissSuggestion('${r.id}')">âœ•</button>
        ` : r.status === 'converted' ? `<span style="color:#16a34a;font-size:12px">âœ“ PO Created</span>` : `<span style="color:var(--text2);font-size:12px">Dismissed</span>`}
      </td>
    </tr>`).join('');

  buildPagination('suggPagination', meta.page||1, meta.total||0, meta.limit||25, p => { _suggPage=p; loadSuggestions(); });
}

async function refreshSuggestions() {
  const btn = event.currentTarget;
  btn.disabled = true; btn.textContent = 'â³ Computingâ€¦';
  try {
    const res  = await apiFetch('/api/demand/refresh', { method: 'POST', body: '{}' });
    const data = await res.json();
    showToast(`Generated ${data.data?.suggestions_created || 0} suggestions`, 'success');
    await Promise.all([loadDemandKpi(), loadSuggestions()]);
  } catch(e) { showToast(e.message || 'Refresh failed', 'error'); }
  finally { btn.disabled = false; btn.textContent = 'âš¡ Refresh Suggestions'; }
}

async function approveSuggestion(id) {
  if (!confirm('Create a draft Purchase Order for this suggestion?')) return;
  try {
    const res  = await apiFetch(`/api/demand/suggestions/${id}/approve`, { method: 'PATCH', body: '{}' });
    const data = await res.json();
    showToast(`Draft PO created: ${data.data?.po_number}`, 'success');
    await Promise.all([loadDemandKpi(), loadSuggestions()]);
  } catch(e) { showToast(e.message || 'Failed to create PO', 'error'); }
}

async function dismissSuggestion(id) {
  try {
    await apiFetch(`/api/demand/suggestions/${id}/dismiss`, { method: 'PATCH', body: '{}' });
    showToast('Suggestion dismissed', 'success');
    await Promise.all([loadDemandKpi(), loadSuggestions()]);
  } catch(e) { showToast(e.message || 'Failed to dismiss', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Module 9 â€” CRM Light
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _intPage = 1, _oppPage = 1, _healthPage = 1;
let _crmCustomers = [];
let _activeCrmTab = 'interactions';

function crmTab(tab) {
  _activeCrmTab = tab;
  ['interactions','pipeline','health'].forEach(t => {
    const panelId = 'crmPanel' + t.charAt(0).toUpperCase() + t.slice(1);
    const panel = document.getElementById(panelId);
    if (panel) panel.style.display = t === tab ? '' : 'none';
    const btnId = 'crmTab' + t.charAt(0).toUpperCase() + t.slice(1);
    const btn = document.getElementById(btnId);
    if (btn) {
      btn.classList.toggle('btn-primary', t === tab);
      btn.classList.toggle('btn-ghost', t !== tab);
    }
  });
  if (tab === 'interactions') { loadInteractions(); loadFollowups(); }
  else if (tab === 'pipeline') loadOpportunities();
  else if (tab === 'health')   loadCustomerHealth();
}

async function loadCRM() {
  try {
    const res  = await apiFetch('/api/customers?limit=500');
    const data = await res.json();
    _crmCustomers = data.data || [];
  } catch(e) { _crmCustomers = []; }
  crmTab(_activeCrmTab);
}

// â”€â”€â”€ Interactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadInteractions(page) {
  if (page) _intPage = page;
  const type     = document.getElementById('crmIntType')?.value || '';
  const fromDate = document.getElementById('crmIntFrom')?.value || '';
  const toDate   = document.getElementById('crmIntTo')?.value   || '';
  const params   = new URLSearchParams({ page: _intPage, limit: 25 });
  if (type)     params.set('type',      type);
  if (fromDate) params.set('from_date', fromDate);
  if (toDate)   params.set('to_date',   toDate);

  const tbody = document.getElementById('intBody');
  if (!tbody) return;
  tbody.innerHTML = skeletonRows(8);
  try {
    const res  = await apiFetch(`/api/crm/interactions?${params}`);
    const data = await res.json();
    const rows = data.data || [];
    const meta = data.meta || {};
    document.getElementById('intCount').textContent = meta.total ? `${meta.total} interactions` : '';
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:24px">No interactions found</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td style="font-size:12px;white-space:nowrap">${new Date(r.interaction_date).toLocaleDateString()}</td>
        <td style="font-weight:500">${escHtml(r.customer_name)}</td>
        <td>${intTypeBadge(r.type)}</td>
        <td><span style="font-size:11px;color:var(--text2)">${r.direction}</span></td>
        <td style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(r.subject)}</td>
        <td style="font-size:12px;color:var(--text2);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(r.outcome||'â€”')}</td>
        <td style="font-size:12px">${escHtml(r.agent_name||'â€”')}</td>
        <td style="font-size:12px;color:${r.follow_up_date ? 'var(--blue)' : 'var(--text2)'}">${r.follow_up_date || 'â€”'}</td>
      </tr>`).join('');
    buildPagination('intPagination', meta.page||1, meta.total||0, meta.limit||25, p => loadInteractions(p));
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="8" style="color:var(--red);padding:16px">${escHtml(e.message)}</td></tr>`;
  }
}

async function loadFollowups() {
  const tbody = document.getElementById('fuBody');
  if (!tbody) return;
  tbody.innerHTML = skeletonRows(4, 3);
  try {
    const res  = await apiFetch('/api/crm/interactions/followups');
    const data = await res.json();
    const rows = data.data || [];
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:var(--text2);padding:16px">No upcoming follow-ups</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td style="font-size:12px;font-weight:600;color:var(--blue)">${r.follow_up_date}</td>
        <td>${escHtml(r.customer_name)}</td>
        <td>${intTypeBadge(r.type)}</td>
        <td>${escHtml(r.subject)}</td>
      </tr>`).join('');
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="4" style="color:var(--red);padding:12px">${escHtml(e.message)}</td></tr>`;
  }
}

function intTypeBadge(t) {
  const map = { call:'#3b82f6', email:'#8b5cf6', meeting:'#10b981', note:'#94a3b8', demo:'#f97316', follow_up:'#f59e0b' };
  const col = map[t] || '#94a3b8';
  return `<span style="display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;background:${col}20;color:${col}">${t.replace('_',' ')}</span>`;
}

async function openInteractionModal() {
  const sel = document.getElementById('intCustId');
  sel.innerHTML = _crmCustomers.length
    ? _crmCustomers.map(c => `<option value="${c.id}">${escHtml(c.name)} (${escHtml(c.code)})</option>`).join('')
    : '<option value="">No customers loaded</option>';
  const now = new Date(); now.setSeconds(0,0);
  document.getElementById('intDate').value     = now.toISOString().slice(0,16);
  document.getElementById('intSubject').value  = '';
  document.getElementById('intBody').value     = '';
  document.getElementById('intOutcome').value  = '';
  document.getElementById('intFollowUp').value = '';
  document.getElementById('interactionModal').classList.add('open');
}

async function saveInteraction() {
  const body = {
    customer_id:      document.getElementById('intCustId').value,
    type:             document.getElementById('intType').value,
    direction:        document.getElementById('intDirection').value,
    subject:          document.getElementById('intSubject').value.trim(),
    body:             document.getElementById('intBody').value.trim() || undefined,
    outcome:          document.getElementById('intOutcome').value.trim() || undefined,
    follow_up_date:   document.getElementById('intFollowUp').value || undefined,
    interaction_date: document.getElementById('intDate').value || undefined,
  };
  if (!body.customer_id) { showToast('Select a customer', 'error'); return; }
  if (!body.subject)     { showToast('Subject is required', 'error'); return; }
  try {
    const res  = await apiFetch('/api/crm/interactions', { method: 'POST', body: JSON.stringify(body) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Save failed');
    showToast('Interaction logged', 'success');
    closeModal('interactionModal');
    loadInteractions();
    loadFollowups();
  } catch(e) { showToast(e.message, 'error'); }
}

// â”€â”€â”€ Opportunities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STAGE_COLORS = {
  lead:'#94a3b8', qualified:'#3b82f6', proposal:'#8b5cf6',
  negotiation:'#f97316', won:'#10b981', lost:'#ef4444'
};
function stageBadge(s) {
  const c = STAGE_COLORS[s] || '#94a3b8';
  return `<span style="display:inline-block;padding:2px 10px;border-radius:12px;font-size:11px;font-weight:700;background:${c}20;color:${c}">${s}</span>`;
}

async function loadOpportunities(page) {
  if (page) _oppPage = page;
  const stage  = document.getElementById('crmOppStage')?.value || '';
  const params = new URLSearchParams({ page: _oppPage, limit: 25 });
  if (stage) params.set('stage', stage);

  const tbody = document.getElementById('oppBody');
  if (!tbody) return;
  tbody.innerHTML = skeletonRows(9);
  try {
    const res  = await apiFetch(`/api/crm/opportunities?${params}`);
    const data = await res.json();
    const rows = data.data || [];
    const meta = data.meta || {};
    document.getElementById('oppCount').textContent = meta.total ? `${meta.total} opportunities` : '';

    if (data.pipeline_summary) {
      const ps = data.pipeline_summary;
      document.getElementById('pipelineKpi').innerHTML = Object.entries(ps).map(([stg, info]) => `
        <div class="card" style="padding:12px;text-align:center">
          <div style="font-size:10px;font-weight:700;color:var(--text2);text-transform:uppercase;margin-bottom:4px">${stg}</div>
          <div style="font-size:20px;font-weight:800;color:var(--text0)">${info.count}</div>
          <div style="font-size:11px;color:var(--blue)">$${Number(info.value||0).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0})}</div>
        </div>`).join('');
    }

    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:var(--text2);padding:24px">No opportunities found</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td><code style="font-size:11px">${escHtml(r.number)}</code></td>
        <td style="font-size:12px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(r.customer_name)}</td>
        <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500">${escHtml(r.title)}</td>
        <td style="text-align:right;font-weight:700">$${Number(r.estimated_value||0).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0})}</td>
        <td>${stageBadge(r.stage)}</td>
        <td style="text-align:right;font-size:12px">${r.probability}%</td>
        <td style="font-size:12px">${r.expected_close_date || 'â€”'}</td>
        <td style="font-size:12px;color:var(--text2)">${escHtml(r.assigned_to_name||'â€”')}</td>
        <td style="white-space:nowrap">
          <button class="btn btn-ghost btn-sm" onclick='openOpportunityModal(${JSON.stringify(r)})'>âœ</button>
          ${r.stage === 'won' && !r.sales_order_id ? `<button class="btn btn-primary btn-sm" onclick="convertOppToSO('${r.id}')">â†’ SO</button>` : ''}
        </td>
      </tr>`).join('');
    buildPagination('oppPagination', meta.page||1, meta.total||0, meta.limit||25, p => loadOpportunities(p));
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="9" style="color:var(--red);padding:16px">${escHtml(e.message)}</td></tr>`;
  }
}

function oppStageChanged() {
  const stageProb = { lead:10, qualified:25, proposal:50, negotiation:75, won:100, lost:0 };
  const s = document.getElementById('oppStage').value;
  document.getElementById('oppProb').value = stageProb[s] ?? 10;
  document.getElementById('oppLostReasonRow').style.display = s === 'lost' ? '' : 'none';
}

async function openOpportunityModal(opp) {
  const sel = document.getElementById('oppCustId');
  sel.innerHTML = _crmCustomers.length
    ? _crmCustomers.map(c => `<option value="${c.id}">${escHtml(c.name)} (${escHtml(c.code)})</option>`).join('')
    : '<option value="">No customers loaded</option>';

  if (opp && typeof opp === 'object') {
    document.getElementById('oppModalTitle').textContent = 'âœ Edit Opportunity';
    document.getElementById('oppEditId').value      = opp.id;
    document.getElementById('oppCustId').value      = opp.customer_id;
    document.getElementById('oppTitle').value       = opp.title;
    document.getElementById('oppStage').value       = opp.stage;
    document.getElementById('oppProb').value        = opp.probability;
    document.getElementById('oppValue').value       = opp.estimated_value;
    document.getElementById('oppCloseDate').value   = opp.expected_close_date || '';
    document.getElementById('oppNotes').value       = opp.notes || '';
    document.getElementById('oppLostReasonRow').style.display = opp.stage === 'lost' ? '' : 'none';
    document.getElementById('oppLostReason').value  = opp.lost_reason || '';
  } else {
    document.getElementById('oppModalTitle').textContent = 'ğŸ† New Opportunity';
    document.getElementById('oppEditId').value    = '';
    document.getElementById('oppTitle').value     = '';
    document.getElementById('oppStage').value     = 'lead';
    document.getElementById('oppProb').value      = 10;
    document.getElementById('oppValue').value     = 0;
    document.getElementById('oppCloseDate').value = '';
    document.getElementById('oppNotes').value     = '';
    document.getElementById('oppLostReasonRow').style.display = 'none';
    document.getElementById('oppLostReason').value = '';
  }
  document.getElementById('opportunityModal').classList.add('open');
}

async function saveOpportunity() {
  const id    = document.getElementById('oppEditId').value;
  const stage = document.getElementById('oppStage').value;
  const body  = {
    customer_id:         document.getElementById('oppCustId').value,
    title:               document.getElementById('oppTitle').value.trim(),
    stage,
    probability:         parseInt(document.getElementById('oppProb').value, 10),
    estimated_value:     parseFloat(document.getElementById('oppValue').value) || 0,
    expected_close_date: document.getElementById('oppCloseDate').value || undefined,
    notes:               document.getElementById('oppNotes').value.trim() || undefined,
    lost_reason:         stage === 'lost' ? (document.getElementById('oppLostReason').value.trim() || undefined) : undefined,
  };
  if (!body.title) { showToast('Title is required', 'error'); return; }
  try {
    let res;
    if (id) {
      res = await apiFetch(`/api/crm/opportunities/${id}`, { method: 'PATCH', body: JSON.stringify(body) });
    } else {
      res = await apiFetch('/api/crm/opportunities', { method: 'POST', body: JSON.stringify(body) });
    }
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Save failed');
    showToast(id ? 'Opportunity updated' : 'Opportunity created', 'success');
    closeModal('opportunityModal');
    loadOpportunities();
  } catch(e) { showToast(e.message, 'error'); }
}

async function convertOppToSO(id) {
  if (!confirm('Convert this won opportunity to a draft Sales Order?')) return;
  try {
    const res  = await apiFetch(`/api/crm/opportunities/${id}/convert`, { method: 'POST', body: '{}' });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Conversion failed');
    showToast(`Draft SO created: ${data.data?.so_number}`, 'success');
    loadOpportunities();
  } catch(e) { showToast(e.message, 'error'); }
}

// â”€â”€â”€ Customer Health â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function healthBadge(label) {
  const map = { 'Excellent':'#10b981', 'Good':'#3b82f6', 'Fair':'#f59e0b', 'Poor':'#ef4444', 'At Risk':'#dc2626' };
  const col = map[label] || '#94a3b8';
  return `<span style="display:inline-block;padding:2px 10px;border-radius:12px;font-size:11px;font-weight:700;background:${col}20;color:${col}">${label}</span>`;
}

async function loadCustomerHealth(page) {
  if (page) _healthPage = page;
  const label  = document.getElementById('crmHealthLabel')?.value || '';
  const params = new URLSearchParams({ page: _healthPage, limit: 25 });
  if (label) params.set('label', label);

  const tbody = document.getElementById('healthBody');
  if (!tbody) return;
  tbody.innerHTML = skeletonRows(10);
  try {
    const res  = await apiFetch(`/api/crm/health?${params}`);
    const data = await res.json();
    const rows = data.data || [];
    const meta = data.meta || {};
    document.getElementById('healthCount').textContent = meta.total ? `${meta.total} customers` : '';
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;color:var(--text2);padding:24px">No customers found</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(r => {
      const score      = parseInt(r.health_score, 10);
      const scoreColor = score >= 65 ? '#10b981' : score >= 45 ? '#3b82f6' : score >= 25 ? '#f59e0b' : '#ef4444';
      return `<tr>
        <td><code style="font-size:11px">${escHtml(r.customer_code)}</code></td>
        <td style="font-weight:500">${escHtml(r.customer_name)}</td>
        <td style="text-align:right">
          <span style="display:inline-flex;align-items:center;gap:6px">
            <span style="font-weight:800;font-size:15px;color:${scoreColor}">${score}</span>
            <span style="width:48px;height:5px;border-radius:3px;background:#e2e8f0;display:inline-block;overflow:hidden">
              <span style="display:block;height:100%;width:${score}%;background:${scoreColor}"></span>
            </span>
          </span>
        </td>
        <td>${healthBadge(r.health_label)}</td>
        <td style="text-align:right">$${Number(r.revenue_12m||0).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0})}</td>
        <td style="text-align:right">${r.order_count_90d}</td>
        <td style="text-align:right;color:${Number(r.overdue_balance)>0?'#dc2626':'inherit'}">$${Number(r.overdue_balance||0).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0})}</td>
        <td style="text-align:right;font-size:12px">${r.avg_days_to_pay ? parseFloat(r.avg_days_to_pay).toFixed(1)+'d' : 'â€”'}</td>
        <td style="font-size:12px">${r.last_order_date || 'â€”'}</td>
        <td style="text-align:right">${r.interactions_30d}</td>
      </tr>`;
    }).join('');
    buildPagination('healthPagination', meta.page||1, meta.total||0, meta.limit||25, p => loadCustomerHealth(p));
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="10" style="color:var(--red);padding:16px">${escHtml(e.message)}</td></tr>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Module 10 â€” Admin & Settings
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _usersPage = 1, _whPage = 1, _auditPage = 1;
let _activeAdminTab = 'users';

function adminTab(tab) {
  _activeAdminTab = tab;
  ['users','warehouses','settings','audit'].forEach(t => {
    const panelId = 'adminPanel' + t.charAt(0).toUpperCase() + t.slice(1);
    const panel = document.getElementById(panelId);
    if (panel) panel.style.display = t === tab ? '' : 'none';
    const btnId = 'adminTab' + t.charAt(0).toUpperCase() + t.slice(1);
    const btn = document.getElementById(btnId);
    if (btn) {
      btn.classList.toggle('btn-primary', t === tab);
      btn.classList.toggle('btn-ghost', t !== tab);
    }
  });
  if (tab === 'users')       loadAdminUsers();
  else if (tab === 'warehouses') loadAdminWarehouses();
  else if (tab === 'settings')   loadSettings();
  else if (tab === 'audit')      loadAuditLog();
}

function loadAdmin() {
  adminTab(_activeAdminTab);
}

// â”€â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function roleBadge(role) {
  const map = { admin:'#ef4444', warehouse:'#f97316', sales:'#3b82f6' };
  const c = map[role] || '#94a3b8';
  return `<span style="display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700;background:${c}20;color:${c}">${role}</span>`;
}

async function loadAdminUsers(page) {
  if (page) _usersPage = page;
  const tbody = document.getElementById('usersBody');
  if (!tbody) return;
  tbody.innerHTML = skeletonRows(6);
  try {
    const res  = await apiFetch(`/api/admin/users?page=${_usersPage}&limit=25`);
    const data = await res.json();
    const rows = data.data || [];
    const meta = data.meta || {};
    document.getElementById('usersCount').textContent = meta.total ? `${meta.total} users` : '';
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text2);padding:24px">No users found</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(u => `
      <tr style="opacity:${u.is_active ? 1 : 0.5}">
        <td style="font-weight:600">${escHtml(u.name)}</td>
        <td style="font-size:12px;color:var(--text2)">${escHtml(u.email)}</td>
        <td>${roleBadge(u.role)}</td>
        <td><span style="font-size:12px;color:${u.is_active ? '#10b981' : '#ef4444'};font-weight:600">${u.is_active ? 'â— Active' : 'â—‹ Inactive'}</span></td>
        <td style="font-size:12px;color:var(--text2)">${new Date(u.created_at).toLocaleDateString()}</td>
        <td style="white-space:nowrap">
          <button class="btn btn-ghost btn-sm" onclick='openUserModal(${JSON.stringify(u)})'>âœ Edit</button>
          <button class="btn btn-ghost btn-sm" onclick="openResetPasswordModal('${u.id}','${escHtml(u.name)}')">ğŸ”‘</button>
        </td>
      </tr>`).join('');
    buildPagination('usersPagination', meta.page||1, meta.total||0, meta.limit||25, p => loadAdminUsers(p));
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="6" style="color:var(--red);padding:16px">${escHtml(e.message)}</td></tr>`;
  }
}

function openUserModal(user) {
  const editing = user && typeof user === 'object';
  document.getElementById('userModalTitle').textContent = editing ? 'âœ Edit User' : 'ğŸ‘¤ New User';
  document.getElementById('userSaveBtn').textContent    = editing ? 'Save Changes' : 'Create User';
  document.getElementById('userEditId').value   = editing ? user.id    : '';
  document.getElementById('userName').value     = editing ? user.name  : '';
  document.getElementById('userEmail').value    = editing ? user.email : '';
  document.getElementById('userEmail').readOnly = editing;
  document.getElementById('userRole').value     = editing ? user.role  : 'sales';
  document.getElementById('userPassword').value = '';
  document.getElementById('userPasswordLabel').textContent = editing ? 'New Password (leave blank to keep)' : 'Password *';
  document.getElementById('userStatusRow').style.display  = editing ? '' : 'none';
  if (editing) document.getElementById('userIsActive').value = String(user.is_active);
  document.getElementById('userModal').classList.add('open');
}

async function saveUser() {
  const id = document.getElementById('userEditId').value;
  const pw = document.getElementById('userPassword').value;
  if (id) {
    // Edit
    const body = {
      name:      document.getElementById('userName').value.trim(),
      role:      document.getElementById('userRole').value,
      is_active: document.getElementById('userIsActive').value === 'true',
    };
    if (!body.name) { showToast('Name is required', 'error'); return; }
    try {
      const res  = await apiFetch(`/api/admin/users/${id}`, { method: 'PATCH', body: JSON.stringify(body) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Update failed');
      // Reset password if provided
      if (pw) {
        const rr = await apiFetch(`/api/admin/users/${id}/reset-password`, { method: 'POST', body: JSON.stringify({ password: pw }) });
        if (!rr.ok) { const rd = await rr.json(); throw new Error(rd.error || 'Password reset failed'); }
      }
      showToast('User updated', 'success');
      closeModal('userModal');
      loadAdminUsers();
    } catch(e) { showToast(e.message, 'error'); }
  } else {
    // Create
    const body = {
      name:     document.getElementById('userName').value.trim(),
      email:    document.getElementById('userEmail').value.trim(),
      role:     document.getElementById('userRole').value,
      password: pw,
    };
    if (!body.name || !body.email || !body.password) { showToast('Name, email and password are required', 'error'); return; }
    try {
      const res  = await apiFetch('/api/admin/users', { method: 'POST', body: JSON.stringify(body) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Create failed');
      showToast('User created', 'success');
      closeModal('userModal');
      loadAdminUsers();
    } catch(e) { showToast(e.message, 'error'); }
  }
}

async function openResetPasswordModal(id, name) {
  const pw = prompt(`Reset password for ${name}:\nEnter new password (min 6 chars):`);
  if (!pw) return;
  if (pw.length < 6) { showToast('Password must be at least 6 characters', 'error'); return; }
  try {
    const res  = await apiFetch(`/api/admin/users/${id}/reset-password`, { method: 'POST', body: JSON.stringify({ password: pw }) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Reset failed');
    showToast(`Password reset for ${name}`, 'success');
  } catch(e) { showToast(e.message, 'error'); }
}

// â”€â”€â”€ Warehouses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAdminWarehouses(page) {
  if (page) _whPage = page;
  const tbody = document.getElementById('whBody');
  if (!tbody) return;
  tbody.innerHTML = skeletonRows(6);
  try {
    const res  = await apiFetch(`/api/admin/warehouses?page=${_whPage}&limit=25`);
    const data = await res.json();
    const rows = data.data || [];
    const meta = data.meta || {};
    document.getElementById('whCount').textContent = meta.total ? `${meta.total} warehouses` : '';
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text2);padding:24px">No warehouses</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(w => `
      <tr style="opacity:${w.is_active ? 1 : 0.5}">
        <td><code style="font-size:12px;font-weight:700">${escHtml(w.code)}</code></td>
        <td style="font-weight:500">${escHtml(w.name)}</td>
        <td style="font-size:12px;color:var(--text2);max-width:220px">${escHtml(w.address||'â€”')}</td>
        <td style="text-align:right;font-size:12px">${(w.ledger_entries||0).toLocaleString()}</td>
        <td><span style="font-size:12px;color:${w.is_active ? '#10b981' : '#ef4444'};font-weight:600">${w.is_active ? 'â— Active' : 'â—‹ Inactive'}</span></td>
        <td><button class="btn btn-ghost btn-sm" onclick='openWarehouseModal(${JSON.stringify(w)})'>âœ Edit</button></td>
      </tr>`).join('');
    buildPagination('whPagination', meta.page||1, meta.total||0, meta.limit||25, p => loadAdminWarehouses(p));
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="6" style="color:var(--red);padding:16px">${escHtml(e.message)}</td></tr>`;
  }
}

function openWarehouseModal(wh) {
  const editing = wh && typeof wh === 'object';
  document.getElementById('whModalTitle').textContent = editing ? 'âœ Edit Warehouse' : 'ğŸ­ New Warehouse';
  document.getElementById('whSaveBtn').textContent    = editing ? 'Save Changes' : 'Create Warehouse';
  document.getElementById('whEditId').value  = editing ? wh.id      : '';
  document.getElementById('whCode').value    = editing ? wh.code    : '';
  document.getElementById('whCode').readOnly = editing;
  document.getElementById('whName').value    = editing ? wh.name    : '';
  document.getElementById('whAddress').value = editing ? (wh.address||'') : '';
  document.getElementById('whStatusRow').style.display = editing ? '' : 'none';
  if (editing) document.getElementById('whIsActive').value = String(wh.is_active);
  document.getElementById('warehouseModal').classList.add('open');
}

async function saveWarehouse() {
  const id = document.getElementById('whEditId').value;
  const body = {
    name:    document.getElementById('whName').value.trim(),
    address: document.getElementById('whAddress').value.trim() || undefined,
  };
  if (!body.name) { showToast('Name is required', 'error'); return; }
  if (id) {
    body.is_active = document.getElementById('whIsActive').value === 'true';
    try {
      const res  = await apiFetch(`/api/admin/warehouses/${id}`, { method: 'PATCH', body: JSON.stringify(body) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Update failed');
      showToast('Warehouse updated', 'success');
      closeModal('warehouseModal');
      loadAdminWarehouses();
    } catch(e) { showToast(e.message, 'error'); }
  } else {
    body.code = document.getElementById('whCode').value.trim().toUpperCase();
    if (!body.code) { showToast('Code is required', 'error'); return; }
    try {
      const res  = await apiFetch('/api/admin/warehouses', { method: 'POST', body: JSON.stringify(body) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Create failed');
      showToast('Warehouse created', 'success');
      closeModal('warehouseModal');
      loadAdminWarehouses();
    } catch(e) { showToast(e.message, 'error'); }
  }
}

// â”€â”€â”€ Company Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _settings = {};

async function loadSettings() {
  const body = document.getElementById('settingsBody');
  if (!body) return;
  body.innerHTML = '<div class="empty-state"><div class="empty-icon">â³</div><div class="empty-title">Loadingâ€¦</div></div>';
  try {
    const res  = await apiFetch('/api/admin/settings');
    const data = await res.json();
    _settings   = data.data || {};
    body.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      ${Object.entries(_settings).map(([key, s]) => `
        <div class="form-group">
          <label class="form-label" style="font-weight:600">${key.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}</label>
          <input class="form-control" id="setting_${key}" value="${escHtml(s.value||'')}" placeholder="${escHtml(s.description||'')}">
          <div style="font-size:11px;color:var(--text2);margin-top:2px">${escHtml(s.description||'')}</div>
        </div>`).join('')}
    </div>`;
  } catch(e) {
    body.innerHTML = `<div style="color:var(--red);padding:16px">${escHtml(e.message)}</div>`;
  }
}

async function saveSettings() {
  const updates = {};
  for (const key of Object.keys(_settings)) {
    const el = document.getElementById(`setting_${key}`);
    if (el) updates[key] = el.value;
  }
  try {
    const res  = await apiFetch('/api/admin/settings', { method: 'PATCH', body: JSON.stringify(updates) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Save failed');
    showToast('Settings saved', 'success');
  } catch(e) { showToast(e.message, 'error'); }
}

// â”€â”€â”€ Audit Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAuditLog(page) {
  if (page) _auditPage = page;
  const tableName = document.getElementById('auditTableFilter')?.value || '';
  const action    = document.getElementById('auditActionFilter')?.value || '';
  const params    = new URLSearchParams({ page: _auditPage, limit: 25 });
  if (tableName) params.set('table_name', tableName);
  if (action)    params.set('action',     action);

  const tbody = document.getElementById('auditBody');
  if (!tbody) return;
  tbody.innerHTML = skeletonRows(6);
  try {
    const res  = await apiFetch(`/api/admin/audit-log?${params}`);
    const data = await res.json();
    const rows = data.data || [];
    const meta = data.meta || {};
    document.getElementById('auditCount').textContent = meta.total ? `${meta.total} entries` : '';
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text2);padding:24px">No audit entries found</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(r => {
      const when = new Date(r.created_at);
      const detail = r.new_values ? JSON.stringify(r.new_values).slice(0,80) : (r.old_values ? '(deleted)' : '');
      return `<tr>
        <td style="font-size:11px;white-space:nowrap;color:var(--text2)">${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</td>
        <td style="font-size:12px">${escHtml(r.user_name||'System')}</td>
        <td><code style="font-size:11px;background:var(--bg2);padding:2px 5px;border-radius:4px">${escHtml(r.action)}</code></td>
        <td style="font-size:12px;color:var(--text2)">${escHtml(r.table_name||'')}</td>
        <td style="font-size:12px;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(r.entity_label||r.record_id||'')}</td>
        <td style="font-size:11px;color:var(--text2);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(detail)}">${escHtml(detail)}</td>
      </tr>`;
    }).join('');
    buildPagination('auditPagination', meta.page||1, meta.total||0, meta.limit||25, p => loadAuditLog(p));
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="6" style="color:var(--red);padding:16px">${escHtml(e.message)}</td></tr>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Module 11 â€” Advanced Analytics
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Destroy a Chart.js instance if one exists on a canvas
const _charts = {};
function destroyChart(id) {
  if (_charts[id]) { _charts[id].destroy(); delete _charts[id]; }
}

// Palette
const PALETTE = ['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#f97316','#06b6d4','#ec4899','#84cc16','#6366f1'];
const URGENCY_COLORS = { critical:'#ef4444', high:'#f59e0b', normal:'#3b82f6', ok:'#10b981' };

async function loadAnalytics() {
  await Promise.allSettled([
    loadAnalyticsKpi(),
    loadRevenueTrend(),
    loadCategoryMix(),
    loadTopCustomers(),
    loadTopItems(),
    loadCashFlow(),
    loadInventoryHealth(),
    loadPipelineChart(),
  ]);
}

async function loadAnalyticsKpi() {
  try {
    const res  = await apiFetch('/api/analytics/overview');
    const data = await res.json();
    const d    = data.data || {};
    const fmt  = n => '$' + Number(n||0).toLocaleString('en-US', {minimumFractionDigits:0, maximumFractionDigits:0});
    document.getElementById('analyticsKpi').innerHTML = `
      <div class="kpi-card"><div class="kpi-label">Revenue (30d)</div><div class="kpi-value">${fmt(d.revenue_30d)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Orders (30d)</div><div class="kpi-value">${d.orders_30d||0}</div></div>
      <div class="kpi-card"><div class="kpi-label">Active Customers (30d)</div><div class="kpi-value">${d.customers_30d||0}</div></div>
      <div class="kpi-card"><div class="kpi-label">AR Balance</div><div class="kpi-value" style="color:var(--blue)">${fmt(d.ar_balance)}</div></div>
      <div class="kpi-card"><div class="kpi-label">AP Balance</div><div class="kpi-value" style="color:var(--orange)">${fmt(d.ap_balance)}</div></div>
      <div class="kpi-card"><div class="kpi-label">Active SKUs</div><div class="kpi-value">${d.item_count||0}</div></div>
    `;
  } catch(e) { console.error('analytics kpi', e); }
}

async function loadRevenueTrend() {
  destroyChart('revenue');
  try {
    const res  = await apiFetch('/api/analytics/revenue-trend');
    const data = await res.json();
    const rows = data.data || [];
    if (!rows.length) return;
    const ctx = document.getElementById('chartRevenue').getContext('2d');
    _charts['revenue'] = new Chart(ctx, {
      type: 'line',
      data: {
        labels:   rows.map(r => r.month),
        datasets: [{
          label:           'Revenue',
          data:            rows.map(r => parseFloat(r.revenue)),
          borderColor:     '#2563eb',
          backgroundColor: 'rgba(37,99,235,.10)',
          fill:            true,
          tension:         0.4,
          pointRadius:     4,
          pointHoverRadius: 6,
        }, {
          label:       'Orders',
          data:        rows.map(r => r.order_count),
          borderColor: '#10b981',
          backgroundColor: 'transparent',
          yAxisID:     'y2',
          tension:     0.4,
          pointRadius: 3,
          borderDash:  [4, 4],
        }],
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { position: 'top', labels: { font: { size: 11 } } } },
        scales: {
          y:  { ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k', font: { size: 10 } }, grid: { color: '#e2e8f0' } },
          y2: { position: 'right', ticks: { font: { size: 10 } }, grid: { display: false } },
          x:  { ticks: { font: { size: 10 } } },
        },
      },
    });
  } catch(e) { console.error('revenue trend', e); }
}

async function loadCategoryMix() {
  destroyChart('category');
  try {
    const res  = await apiFetch('/api/analytics/category-mix');
    const data = await res.json();
    const rows = data.data || [];
    if (!rows.length) return;
    const ctx = document.getElementById('chartCategory').getContext('2d');
    _charts['category'] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels:   rows.map(r => r.category),
        datasets: [{ data: rows.map(r => parseFloat(r.revenue)), backgroundColor: PALETTE }],
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { font: { size: 10 }, boxWidth: 10 } },
          tooltip: { callbacks: { label: ctx => ` ${ctx.label}: $${Number(ctx.raw).toLocaleString('en-US', {maximumFractionDigits:0})}` } },
        },
        cutout: '60%',
      },
    });
  } catch(e) { console.error('category mix', e); }
}

async function loadTopCustomers() {
  destroyChart('customers');
  try {
    const res  = await apiFetch('/api/analytics/top-customers');
    const data = await res.json();
    const rows = data.data || [];
    if (!rows.length) return;
    const ctx = document.getElementById('chartCustomers').getContext('2d');
    _charts['customers'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels:   rows.map(r => r.customer_name.length > 16 ? r.customer_name.slice(0,14)+'â€¦' : r.customer_name),
        datasets: [{
          label:           'Revenue (12m)',
          data:            rows.map(r => parseFloat(r.revenue_12m)),
          backgroundColor: rows.map((_, i) => PALETTE[i % PALETTE.length] + 'cc'),
          borderRadius:    4,
        }],
      },
      options: {
        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k', font: { size: 10 } }, grid: { color: '#e2e8f0' } },
          y: { ticks: { font: { size: 10 } } },
        },
      },
    });
  } catch(e) { console.error('top customers', e); }
}

async function loadTopItems() {
  destroyChart('items');
  try {
    const res  = await apiFetch('/api/analytics/top-items');
    const data = await res.json();
    const rows = data.data || [];
    if (!rows.length) return;
    const ctx = document.getElementById('chartItems').getContext('2d');
    _charts['items'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels:   rows.map(r => r.item_name.length > 18 ? r.item_name.slice(0,16)+'â€¦' : r.item_name),
        datasets: [{
          label:           'Revenue (12m)',
          data:            rows.map(r => parseFloat(r.revenue_12m)),
          backgroundColor: '#8b5cf6cc',
          borderRadius:    4,
        }],
      },
      options: {
        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k', font: { size: 10 } }, grid: { color: '#e2e8f0' } },
          y: { ticks: { font: { size: 10 } } },
        },
      },
    });
  } catch(e) { console.error('top items', e); }
}

async function loadCashFlow() {
  destroyChart('cashflow');
  try {
    const res  = await apiFetch('/api/analytics/cash-flow');
    const data = await res.json();
    const rows = data.data || [];
    if (!rows.length) return;
    const ctx = document.getElementById('chartCashFlow').getContext('2d');
    _charts['cashflow'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels:   rows.map(r => r.month),
        datasets: [{
          label:           'Collected (AR)',
          data:            rows.map(r => r.collected),
          backgroundColor: '#10b981cc',
          borderRadius:    3,
        }, {
          label:           'Paid Out (AP)',
          data:            rows.map(r => r.paid_out),
          backgroundColor: '#f97316cc',
          borderRadius:    3,
        }],
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { position: 'top', labels: { font: { size: 10 }, boxWidth: 10 } } },
        scales: {
          y: { ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k', font: { size: 10 } }, grid: { color: '#e2e8f0' } },
          x: { ticks: { font: { size: 10 } } },
        },
      },
    });
  } catch(e) { console.error('cash flow', e); }
}

async function loadInventoryHealth() {
  destroyChart('health-chart');
  try {
    const res  = await apiFetch('/api/analytics/inventory-health');
    const data = await res.json();
    const rows = data.data || [];
    if (!rows.length) return;
    const ctx = document.getElementById('chartHealth').getContext('2d');
    _charts['health-chart'] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels:   rows.map(r => r.urgency.charAt(0).toUpperCase() + r.urgency.slice(1)),
        datasets: [{
          data:            rows.map(r => r.item_count),
          backgroundColor: rows.map(r => URGENCY_COLORS[r.urgency] || '#94a3b8'),
        }],
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth: 10 } },
          tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw} items` } },
        },
        cutout: '55%',
      },
    });
  } catch(e) { console.error('inventory health', e); }
}

async function loadPipelineChart() {
  const el = document.getElementById('pipelineChartBody');
  if (!el) return;
  try {
    const res  = await apiFetch('/api/analytics/pipeline');
    const data = await res.json();
    const rows = data.data || [];
    if (!rows.length) {
      el.innerHTML = '<div style="color:var(--text2);font-size:12px;padding:16px">No active opportunities</div>';
      return;
    }
    const maxVal = Math.max(...rows.map(r => parseFloat(r.total_value)));
    const stageColors = { lead:'#94a3b8', qualified:'#3b82f6', proposal:'#8b5cf6', negotiation:'#f97316' };
    el.innerHTML = rows.map(r => {
      const pct = maxVal > 0 ? (parseFloat(r.total_value) / maxVal * 100) : 0;
      const c   = stageColors[r.stage] || '#94a3b8';
      return `<div style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px;font-size:11px">
          <span style="font-weight:600;color:${c}">${r.stage}</span>
          <span style="color:var(--text2)">${r.count} Â· $${Number(r.total_value).toLocaleString('en-US',{maximumFractionDigits:0})}</span>
        </div>
        <div style="height:8px;border-radius:4px;background:#e2e8f0;overflow:hidden">
          <div style="height:100%;width:${pct.toFixed(1)}%;background:${c};border-radius:4px;transition:width .4s"></div>
        </div>
        <div style="font-size:10px;color:var(--text2);margin-top:2px">Weighted: $${Number(r.weighted_value).toLocaleString('en-US',{maximumFractionDigits:0})}</div>
      </div>`;
    }).join('');
  } catch(e) { console.error('pipeline chart', e); }
}
</script>
</body>
</html>
