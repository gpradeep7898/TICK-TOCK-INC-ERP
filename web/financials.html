<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tick Tock Inc. â€” Financial Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f2f5;color:#1a1a2e;min-height:100vh}

  /* â”€â”€ NAV â”€â”€ */
  nav{background:#1a1a2e;color:#fff;display:flex;align-items:center;gap:0;height:52px;padding:0 20px}
  .nav-brand{font-weight:700;font-size:1rem;letter-spacing:.5px;margin-right:28px;white-space:nowrap}
  .nav-brand span{color:#f5a623}
  nav a{color:#ccc;text-decoration:none;font-size:.82rem;padding:0 14px;height:52px;display:flex;align-items:center;transition:background .15s}
  nav a:hover{background:#2d2d4e;color:#fff}
  nav a.active{background:#2d2d4e;color:#f5a623;border-bottom:2px solid #f5a623}

  /* â”€â”€ HEADER â”€â”€ */
  .page-header{background:#fff;border-bottom:1px solid #e2e8f0;padding:18px 28px;display:flex;align-items:center;justify-content:space-between}
  .page-header h1{font-size:1.3rem;font-weight:700;color:#1a1a2e}
  .page-header small{color:#64748b;font-size:.8rem}
  .refresh-btn{background:#1a1a2e;color:#fff;border:none;padding:8px 18px;border-radius:6px;cursor:pointer;font-size:.82rem;font-weight:600}
  .refresh-btn:hover{background:#2d2d4e}

  /* â”€â”€ LAYOUT â”€â”€ */
  .main{padding:24px 28px;max-width:1500px;margin:0 auto}

  /* â”€â”€ KPI CARDS â”€â”€ */
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:28px}
  .kpi-card{background:#fff;border-radius:10px;padding:18px 20px;box-shadow:0 1px 4px rgba(0,0,0,.06);border-left:4px solid #e2e8f0}
  .kpi-card.green {border-left-color:#22c55e}
  .kpi-card.blue  {border-left-color:#3b82f6}
  .kpi-card.amber {border-left-color:#f59e0b}
  .kpi-card.red   {border-left-color:#ef4444}
  .kpi-card.purple{border-left-color:#8b5cf6}
  .kpi-card.teal  {border-left-color:#14b8a6}
  .kpi-label{font-size:.73rem;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
  .kpi-value{font-size:1.55rem;font-weight:700;color:#1a1a2e;line-height:1}
  .kpi-sub  {font-size:.75rem;color:#94a3b8;margin-top:5px}

  /* â”€â”€ SECTION TITLE â”€â”€ */
  .section-title{font-size:.85rem;font-weight:700;color:#475569;text-transform:uppercase;letter-spacing:.6px;margin-bottom:14px;display:flex;align-items:center;gap:8px}
  .section-title::after{content:'';flex:1;height:1px;background:#e2e8f0}

  /* â”€â”€ CHARTS ROW â”€â”€ */
  .charts-row{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:28px}
  .chart-card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
  .chart-card h3{font-size:.85rem;font-weight:700;color:#475569;margin-bottom:16px}
  .chart-wrap{position:relative;height:260px}

  /* â”€â”€ TABLES ROW â”€â”€ */
  .tables-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
  .table-card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.06);overflow:auto}
  .table-card h3{font-size:.85rem;font-weight:700;color:#475569;margin-bottom:14px}
  table{width:100%;border-collapse:collapse;font-size:.82rem}
  th{text-align:left;padding:8px 10px;font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.4px;border-bottom:2px solid #f1f5f9;white-space:nowrap}
  td{padding:8px 10px;border-bottom:1px solid #f1f5f9;color:#334155}
  tr:last-child td{border-bottom:none}
  tr:hover td{background:#f8fafc}
  td.num{text-align:right;font-variant-numeric:tabular-nums;font-weight:600}
  td.pct{text-align:right;font-weight:700}
  .badge-green{color:#16a34a;background:#dcfce7;padding:2px 7px;border-radius:12px;font-size:.72rem;font-weight:700}
  .badge-red  {color:#dc2626;background:#fee2e2;padding:2px 7px;border-radius:12px;font-size:.72rem;font-weight:700}

  /* â”€â”€ AGING â”€â”€ */
  .aging-wrap{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
  .aging-card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
  .aging-card h3{font-size:.85rem;font-weight:700;color:#475569;margin-bottom:14px}
  .aging-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-size:.8rem}
  .aging-label{width:80px;color:#64748b;font-size:.75rem}
  .aging-bar-bg{flex:1;height:14px;background:#f1f5f9;border-radius:7px;overflow:hidden}
  .aging-bar{height:100%;border-radius:7px;transition:width .4s}
  .aging-val{width:80px;text-align:right;font-weight:700;font-size:.8rem}

  /* â”€â”€ P&L TABLE â”€â”€ */
  .pl-card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.06);margin-bottom:28px;overflow:auto}
  .pl-card h3{font-size:.85rem;font-weight:700;color:#475569;margin-bottom:14px}
  .pl-card table th,.pl-card table td{font-size:.78rem}
  .pl-card table th{min-width:90px}
  .pl-highlight{font-weight:700;background:#f8fafc}
  .pl-highlight td{border-top:2px solid #e2e8f0}

  /* â”€â”€ SPINNER â”€â”€ */
  .spinner{display:inline-block;width:28px;height:28px;border:3px solid #e2e8f0;border-top-color:#1a1a2e;border-radius:50%;animation:spin .7s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-state{text-align:center;padding:40px;color:#94a3b8}

  /* â”€â”€ RESPONSIVE â”€â”€ */
  @media(max-width:900px){
    .charts-row,.tables-row,.aging-wrap{grid-template-columns:1fr}
  }

  /* â”€â”€ GL TABS â”€â”€ */
  .gl-section{margin-top:32px}
  .tab-bar{display:flex;gap:4px;border-bottom:2px solid #e2e8f0;margin-bottom:20px}
  .tab-btn{background:none;border:none;padding:10px 18px;font-size:.82rem;font-weight:600;color:#64748b;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;border-radius:4px 4px 0 0;transition:all .15s;font-family:inherit}
  .tab-btn:hover{background:#f1f5f9;color:#1a1a2e}
  .tab-btn.active{color:#1a1a2e;border-bottom-color:#1a1a2e;background:#fff}
  .tab-panel{display:none}.tab-panel.active{display:block}
  .gl-toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
  .gl-toolbar input,.gl-toolbar select{padding:7px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:.82rem;background:#fff;font-family:inherit}
  .gl-btn{padding:7px 16px;border:none;border-radius:6px;cursor:pointer;font-size:.82rem;font-weight:600;font-family:inherit;transition:all .15s}
  .gl-btn-primary{background:#1a1a2e;color:#fff}.gl-btn-primary:hover{background:#2d2d4e}
  .gl-btn-ghost{background:#fff;color:#475569;border:1px solid #e2e8f0}.gl-btn-ghost:hover{background:#f1f5f9}
  .gl-btn-green{background:#16a34a;color:#fff}.gl-btn-green:hover{background:#15803d}
  .gl-btn-red{background:#dc2626;color:#fff}.gl-btn-red:hover{background:#b91c1c}
  .gl-card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.06);margin-bottom:20px;overflow:auto}
  .gl-card h3{font-size:.85rem;font-weight:700;color:#475569;margin-bottom:14px}
  .bs-section{font-size:.78rem;font-weight:700;color:#1a1a2e;background:#f8fafc;padding:6px 10px;border-left:3px solid #1a1a2e}
  .bs-header{font-weight:700;color:#64748b;font-size:.75rem;background:#f1f5f9;padding:4px 10px}
  .bs-total{font-weight:700;border-top:2px solid #e2e8f0}
  /* GL modal */
  .gl-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;align-items:center;justify-content:center}
  .gl-overlay.active{display:flex}
  .gl-modal{background:#fff;border-radius:12px;width:min(700px,95vw);max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
  .gl-modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px 0}
  .gl-modal-title{font-size:1rem;font-weight:700;color:#1a1a2e}
  .gl-modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:#94a3b8;line-height:1}
  .gl-modal-body{padding:20px 24px}
  .gl-modal-footer{padding:0 24px 20px;display:flex;gap:10px;justify-content:flex-end}
  .gl-form-group{margin-bottom:14px}
  .gl-label{display:block;font-size:.78rem;font-weight:600;color:#475569;margin-bottom:5px}
  .gl-input{width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:.82rem;font-family:inherit}
  .gl-grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .je-line-row{display:grid;grid-template-columns:1fr 2fr 90px 90px 30px;gap:8px;align-items:center;margin-bottom:8px;font-size:.8rem}
  .je-totals-row{display:flex;gap:24px;justify-content:flex-end;padding:8px 0;font-size:.82rem;font-weight:700;border-top:2px solid #e2e8f0;margin-top:8px}
  .badge-posted{color:#16a34a;background:#dcfce7;padding:2px 7px;border-radius:12px;font-size:.72rem;font-weight:700}
  .badge-draft{color:#f59e0b;background:#fef3c7;padding:2px 7px;border-radius:12px;font-size:.72rem;font-weight:700}
  .badge-void{color:#94a3b8;background:#f1f5f9;padding:2px 7px;border-radius:12px;font-size:.72rem;font-weight:700}

  /* â”€â”€ NAV USER CHIP â”€â”€ */
  .nav-spacer{flex:1}
  .nav-user{display:flex;align-items:center;gap:10px}
  .nav-user-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0;background:#475569}
  .nav-user-name{font-size:.82rem;color:#ccc;white-space:nowrap}
  .nav-signout{background:none;border:1px solid rgba(255,255,255,.25);color:#ccc;padding:5px 12px;border-radius:4px;cursor:pointer;font-size:.76rem;font-weight:600;transition:all .15s;font-family:inherit}
  .nav-signout:hover{background:rgba(239,68,68,.2);border-color:#ef4444;color:#fca5a5}
</style>
</head>
<body>

<nav>
  <div class="nav-brand"><span>Tick Tock</span> Inc.</div>
  <a href="/inventory">Inventory</a>
  <a href="/sales">Sales / AR</a>
  <a href="/purchasing">Purchasing / AP</a>
  <a href="/financials" class="active">Financials</a>
  <div class="nav-spacer"></div>
  <div class="nav-user">
    <div class="nav-user-avatar" id="finUserAvatar">?</div>
    <span class="nav-user-name" id="finUserName">Loadingâ€¦</span>
    <button class="nav-signout" onclick="signOut()">Sign Out</button>
  </div>
</nav>

<div class="page-header">
  <div>
    <h1>Financial Dashboard</h1>
    <small id="last-updated">Loadingâ€¦</small>
  </div>
  <button class="refresh-btn" onclick="loadAll()">â†» Refresh</button>
</div>

<div class="main">

  <!-- KPI CARDS -->
  <div class="section-title">Key Performance Indicators</div>
  <div class="kpi-grid" id="kpi-grid">
    <div class="loading-state"><div class="spinner"></div></div>
  </div>

  <!-- REVENUE / GROSS PROFIT CHART + DONUT -->
  <div class="section-title">Revenue &amp; Profitability</div>
  <div class="charts-row">
    <div class="chart-card">
      <h3>Revenue vs Gross Profit â€” Last 12 Months</h3>
      <div class="chart-wrap"><canvas id="revChart"></canvas></div>
    </div>
    <div class="chart-card">
      <h3>YTD Revenue Split</h3>
      <div class="chart-wrap"><canvas id="splitChart"></canvas></div>
    </div>
  </div>

  <!-- TOP CUSTOMERS + TOP ITEMS -->
  <div class="section-title">Top Performers â€” Year to Date</div>
  <div class="tables-row">
    <div class="table-card">
      <h3>Top 10 Customers by Revenue</h3>
      <div id="tbl-customers"><div class="loading-state"><div class="spinner"></div></div></div>
    </div>
    <div class="table-card">
      <h3>Top 15 Items by Revenue</h3>
      <div id="tbl-items"><div class="loading-state"><div class="spinner"></div></div></div>
    </div>
  </div>

  <!-- AR / AP AGING -->
  <div class="section-title">AR / AP Aging</div>
  <div class="aging-wrap">
    <div class="aging-card">
      <h3>Accounts Receivable Aging</h3>
      <div id="ar-aging"><div class="loading-state"><div class="spinner"></div></div></div>
    </div>
    <div class="aging-card">
      <h3>Accounts Payable Aging</h3>
      <div id="ap-aging"><div class="loading-state"><div class="spinner"></div></div></div>
    </div>
  </div>

  <!-- P&L DETAIL TABLE -->
  <div class="section-title">Monthly P&amp;L â€” Last 12 Months</div>
  <div class="pl-card">
    <h3>Revenue Â· Cash Collected Â· COGS Â· Gross Profit Â· Cash Paid Â· Net Cash</h3>
    <div id="tbl-pl"><div class="loading-state"><div class="spinner"></div></div></div>
  </div>

</div><!-- /main -->

<!-- â•â• GENERAL LEDGER SECTION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main gl-section">
  <div class="section-title">General Ledger</div>

  <!-- Tab Bar -->
  <div class="tab-bar">
    <button class="tab-btn active" onclick="glTab('coa')">ğŸ“‹ Chart of Accounts</button>
    <button class="tab-btn" onclick="glTab('je')">ğŸ“ Journal Entries</button>
    <button class="tab-btn" onclick="glTab('tb')">âš–ï¸ Trial Balance</button>
    <button class="tab-btn" onclick="glTab('pl')">ğŸ“ˆ P&amp;L Statement</button>
    <button class="tab-btn" onclick="glTab('bs')">ğŸ› Balance Sheet</button>
  </div>

  <!-- â”€â”€ Chart of Accounts â”€â”€ -->
  <div id="gl-coa" class="tab-panel active">
    <div class="gl-toolbar">
      <input id="coaSearch" placeholder="Search accountsâ€¦" oninput="filterCOA()" style="width:220px">
      <select id="coaTypeFilter" onchange="filterCOA()">
        <option value="">All Types</option>
        <option value="asset">Asset</option>
        <option value="liability">Liability</option>
        <option value="equity">Equity</option>
        <option value="revenue">Revenue</option>
        <option value="cogs">COGS</option>
        <option value="expense">Expense</option>
      </select>
      <button class="gl-btn gl-btn-ghost" onclick="loadCOA()">âŸ³ Refresh</button>
      <button class="gl-btn gl-btn-primary" onclick="openNewAccountModal()">+ Add Account</button>
    </div>
    <div class="gl-card">
      <div id="coaBody"><div class="loading-state"><div class="spinner"></div></div></div>
    </div>
  </div>

  <!-- â”€â”€ Journal Entries â”€â”€ -->
  <div id="gl-je" class="tab-panel">
    <div class="gl-toolbar">
      <select id="jeStatusFilter" onchange="loadJE()">
        <option value="">All Statuses</option>
        <option value="draft">Draft</option>
        <option value="posted">Posted</option>
        <option value="void">Void</option>
      </select>
      <input type="date" id="jeFromDate">
      <input type="date" id="jeToDate">
      <button class="gl-btn gl-btn-ghost" onclick="loadJE()">âŸ³ Refresh</button>
      <button class="gl-btn gl-btn-primary" onclick="openNewJEModal()">+ New Entry</button>
    </div>
    <div class="gl-card">
      <div id="jeBody"><div class="loading-state"><div class="spinner"></div></div></div>
    </div>
  </div>

  <!-- â”€â”€ Trial Balance â”€â”€ -->
  <div id="gl-tb" class="tab-panel">
    <div class="gl-toolbar">
      <label style="font-size:.82rem;font-weight:600;color:#475569">As of:</label>
      <input type="date" id="tbAsOf">
      <button class="gl-btn gl-btn-primary" onclick="loadTrialBalance()">Run Trial Balance</button>
    </div>
    <div class="gl-card" id="tbCard">
      <div class="loading-state" style="color:#94a3b8">Select a date and click Run Trial Balance</div>
    </div>
  </div>

  <!-- â”€â”€ P&L Statement â”€â”€ -->
  <div id="gl-pl" class="tab-panel">
    <div class="gl-toolbar">
      <label style="font-size:.82rem;font-weight:600;color:#475569">From:</label>
      <input type="date" id="plFrom">
      <label style="font-size:.82rem;font-weight:600;color:#475569">To:</label>
      <input type="date" id="plTo">
      <button class="gl-btn gl-btn-primary" onclick="loadGLPL()">Run P&amp;L</button>
    </div>
    <div class="gl-card" id="plCard">
      <div class="loading-state" style="color:#94a3b8">Select a date range and click Run P&L</div>
    </div>
  </div>

  <!-- â”€â”€ Balance Sheet â”€â”€ -->
  <div id="gl-bs" class="tab-panel">
    <div class="gl-toolbar">
      <label style="font-size:.82rem;font-weight:600;color:#475569">As of:</label>
      <input type="date" id="bsAsOf">
      <button class="gl-btn gl-btn-primary" onclick="loadBalanceSheet()">Run Balance Sheet</button>
    </div>
    <div class="gl-card" id="bsCard">
      <div class="loading-state" style="color:#94a3b8">Select a date and click Run Balance Sheet</div>
    </div>
  </div>
</div>

<!-- â”€â”€ New Account Modal â”€â”€ -->
<div class="gl-overlay" id="newAcctModal">
  <div class="gl-modal">
    <div class="gl-modal-header">
      <div class="gl-modal-title">Add GL Account</div>
      <button class="gl-modal-close" onclick="closeGLModal('newAcctModal')">âœ•</button>
    </div>
    <div class="gl-modal-body">
      <div class="gl-grid2">
        <div class="gl-form-group">
          <label class="gl-label">Account Number *</label>
          <input class="gl-input" id="acctNum" placeholder="e.g. 6200">
        </div>
        <div class="gl-form-group">
          <label class="gl-label">Type *</label>
          <select class="gl-input" id="acctType">
            <option value="asset">Asset</option>
            <option value="liability">Liability</option>
            <option value="equity">Equity</option>
            <option value="revenue">Revenue</option>
            <option value="cogs">COGS</option>
            <option value="expense">Expense</option>
          </select>
        </div>
      </div>
      <div class="gl-form-group">
        <label class="gl-label">Account Name *</label>
        <input class="gl-input" id="acctName" placeholder="e.g. Warehouse Supplies">
      </div>
      <div class="gl-form-group">
        <label class="gl-label">Description</label>
        <input class="gl-input" id="acctDesc" placeholder="Optional description">
      </div>
    </div>
    <div class="gl-modal-footer">
      <button class="gl-btn gl-btn-ghost" onclick="closeGLModal('newAcctModal')">Cancel</button>
      <button class="gl-btn gl-btn-primary" onclick="saveNewAccount()">Create Account</button>
    </div>
  </div>
</div>

<!-- â”€â”€ New Journal Entry Modal â”€â”€ -->
<div class="gl-overlay" id="newJEModal">
  <div class="gl-modal">
    <div class="gl-modal-header">
      <div class="gl-modal-title">New Journal Entry</div>
      <button class="gl-modal-close" onclick="closeGLModal('newJEModal')">âœ•</button>
    </div>
    <div class="gl-modal-body">
      <div class="gl-grid2">
        <div class="gl-form-group">
          <label class="gl-label">Entry Date *</label>
          <input type="date" class="gl-input" id="jeDate">
        </div>
        <div class="gl-form-group">
          <label class="gl-label">Reference</label>
          <input class="gl-input" id="jeRef" placeholder="Invoice #, SO #, etc.">
        </div>
      </div>
      <div class="gl-form-group">
        <label class="gl-label">Description *</label>
        <input class="gl-input" id="jeDesc" placeholder="Brief description of this entry">
      </div>
      <div style="margin:16px 0 8px;font-size:.78rem;font-weight:700;color:#475569;text-transform:uppercase;letter-spacing:.4px">
        Lines <button class="gl-btn gl-btn-ghost" style="padding:3px 10px;font-size:.75rem;margin-left:8px" onclick="addJELine()">+ Add Line</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 2fr 90px 90px 30px;gap:8px;margin-bottom:6px;font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase">
        <span>Account</span><span>Description</span><span style="text-align:right">Debit</span><span style="text-align:right">Credit</span><span></span>
      </div>
      <div id="jeLinesContainer"></div>
      <div class="je-totals-row" id="jeTotalsRow">
        <span>Debits: <span id="jeTotalDebit">$0.00</span></span>
        <span>Credits: <span id="jeTotalCredit">$0.00</span></span>
        <span id="jeBalanceMsg" style="color:#94a3b8">â€”</span>
      </div>
    </div>
    <div class="gl-modal-footer">
      <button class="gl-btn gl-btn-ghost" onclick="closeGLModal('newJEModal')">Cancel</button>
      <button class="gl-btn gl-btn-primary" onclick="saveJE(false)">Save Draft</button>
      <button class="gl-btn gl-btn-green" onclick="saveJE(true)">Save &amp; Post</button>
    </div>
  </div>
</div>

<script>
const API = '';
let revChartInst = null, splitChartInst = null;

/* â”€â”€ Auth â”€â”€ */
async function apiFetch(path, opts = {}) {
  const token = localStorage.getItem('tt_token');
  const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(path, { ...opts, headers });
  if (res.status === 401) {
    localStorage.removeItem('tt_token');
    window.location.href = '/login.html';
    throw new Error('Unauthorized');
  }
  if (!res.ok) { const b = await res.json().catch(()=>({})); throw new Error(b.error || `HTTP ${res.status}`); }
  return res.json();
}
function signOut() { localStorage.removeItem('tt_token'); window.location.href = '/login.html'; }
(function authGuard(){
  const token = localStorage.getItem('tt_token');
  if (!token) { window.location.href = '/login.html'; return; }
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    if (payload.exp * 1000 < Date.now()) { localStorage.removeItem('tt_token'); window.location.href = '/login.html'; return; }
    const name = payload.name || payload.email || 'User';
    const role = payload.role || 'user';
    const initials = name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    const colors = { admin:'#b45309', warehouse:'#047857', sales:'#1d4ed8' };
    document.getElementById('finUserAvatar').textContent = initials;
    document.getElementById('finUserAvatar').style.background = colors[role] || '#475569';
    document.getElementById('finUserName').textContent = name;
  } catch { window.location.href = '/login.html'; }
})();

function fmt(n){ return '$' + Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtN(n){ return Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }

async function loadAll(){
  document.getElementById('last-updated').textContent = 'Refreshingâ€¦';
  await Promise.all([loadSummary(), loadRevByMonth(), loadTopCustomers(), loadTopItems(), loadCashPosition(), loadPL()]);
  document.getElementById('last-updated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
}

/* â”€â”€ KPI CARDS â”€â”€ */
async function loadSummary(){
  const grid = document.getElementById('kpi-grid');
  try {
    const r = await apiFetch('/api/financials/summary');
    grid.innerHTML = `
      <div class="kpi-card green">
        <div class="kpi-label">Revenue MTD</div>
        <div class="kpi-value">${fmt(r.revenue_mtd)}</div>
        <div class="kpi-sub">This month</div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-label">Revenue YTD</div>
        <div class="kpi-value">${fmt(r.revenue_ytd)}</div>
        <div class="kpi-sub">Year to date</div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-label">AR Open</div>
        <div class="kpi-value">${fmt(r.ar_open)}</div>
        <div class="kpi-sub">Overdue: ${fmt(r.ar_overdue)}</div>
      </div>
      <div class="kpi-card red">
        <div class="kpi-label">AR Overdue</div>
        <div class="kpi-value">${fmt(r.ar_overdue)}</div>
        <div class="kpi-sub">Past due date</div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label">AP Open</div>
        <div class="kpi-value">${fmt(r.ap_open)}</div>
        <div class="kpi-sub">Overdue: ${fmt(r.ap_overdue)}</div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-label">COGS YTD</div>
        <div class="kpi-value">${fmt(r.cogs_ytd)}</div>
        <div class="kpi-sub">Cost of goods sold</div>
      </div>
      <div class="kpi-card teal">
        <div class="kpi-label">Inventory Value</div>
        <div class="kpi-value">${fmt(r.inventory_value)}</div>
        <div class="kpi-sub">On-hand cost</div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-label">Open Sales Orders</div>
        <div class="kpi-value">${r.open_so_count||0}</div>
        <div class="kpi-sub">Active SOs</div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label">Open POs</div>
        <div class="kpi-value">${r.open_po_count||0}</div>
        <div class="kpi-sub">Active purchase orders</div>
      </div>
    `;
  } catch(e){
    grid.innerHTML = `<div class="loading-state" style="color:#ef4444">Failed to load KPIs: ${e.message}</div>`;
  }
}

/* â”€â”€ REVENUE CHART â”€â”€ */
async function loadRevByMonth(){
  try {
    const rows = await apiFetch('/api/financials/revenue-by-month');
    const labels = rows.map(r=>r.label);
    const rev    = rows.map(r=>+r.revenue);
    const gp     = rows.map(r=>+r.gross_profit);

    if(revChartInst) revChartInst.destroy();
    revChartInst = new Chart(document.getElementById('revChart'),{
      type:'bar',
      data:{
        labels,
        datasets:[
          {label:'Revenue',data:rev,backgroundColor:'rgba(59,130,246,0.7)',borderColor:'#3b82f6',borderWidth:1,borderRadius:4},
          {label:'Gross Profit',data:gp,backgroundColor:'rgba(34,197,94,0.7)',borderColor:'#22c55e',borderWidth:1,borderRadius:4,type:'bar'}
        ]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'top',labels:{font:{size:11}}},tooltip:{callbacks:{label:ctx=>' '+fmt(ctx.raw)}}},
        scales:{y:{ticks:{callback:v=>'$'+v.toLocaleString()},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}
      }
    });

    // Donut for revenue split (COGS vs GP)
    const totalRev  = rev.reduce((a,b)=>a+b,0);
    const totalCogs = rows.map(r=>+r.cogs).reduce((a,b)=>a+b,0);
    const totalGP   = totalRev - totalCogs;
    if(splitChartInst) splitChartInst.destroy();
    splitChartInst = new Chart(document.getElementById('splitChart'),{
      type:'doughnut',
      data:{
        labels:['Gross Profit','COGS'],
        datasets:[{data:[Math.max(0,totalGP),totalCogs],backgroundColor:['#22c55e','#f59e0b'],borderWidth:2,hoverOffset:6}]
      },
      options:{
        responsive:true,maintainAspectRatio:false,cutout:'62%',
        plugins:{
          legend:{position:'bottom',labels:{font:{size:11}}},
          tooltip:{callbacks:{label:ctx=>` ${ctx.label}: ${fmt(ctx.raw)}`}}
        }
      }
    });
  } catch(e){ console.error('revByMonth',e); }
}

/* â”€â”€ TOP CUSTOMERS TABLE â”€â”€ */
async function loadTopCustomers(){
  const el = document.getElementById('tbl-customers');
  try {
    const rows = await apiFetch('/api/financials/top-customers');
    if(!rows.length){ el.innerHTML='<p style="color:#94a3b8;font-size:.82rem;padding:12px">No data yet.</p>'; return; }
    el.innerHTML = `<table>
      <thead><tr><th>#</th><th>Customer</th><th>Inv</th><th class="num">Revenue YTD</th><th class="num">Open Balance</th></tr></thead>
      <tbody>${rows.map((r,i)=>`<tr>
        <td style="color:#94a3b8">${i+1}</td>
        <td>${r.customer}</td>
        <td style="text-align:center">${r.invoice_count}</td>
        <td class="num">${fmt(r.revenue_ytd)}</td>
        <td class="num">${+r.open_balance>0?`<span class="badge-red">${fmt(r.open_balance)}</span>`:'<span class="badge-green">$0.00</span>'}</td>
      </tr>`).join('')}</tbody>
    </table>`;
  } catch(e){ el.innerHTML=`<div class="loading-state" style="color:#ef4444">${e.message}</div>`; }
}

/* â”€â”€ TOP ITEMS TABLE â”€â”€ */
async function loadTopItems(){
  const el = document.getElementById('tbl-items');
  try {
    const rows = await apiFetch('/api/financials/top-items');
    if(!rows.length){ el.innerHTML='<p style="color:#94a3b8;font-size:.82rem;padding:12px">No data yet.</p>'; return; }
    el.innerHTML = `<table>
      <thead><tr><th>#</th><th>Item</th><th class="num">Qty</th><th class="num">Revenue</th><th class="num">COGS</th><th class="pct">Margin</th></tr></thead>
      <tbody>${rows.map((r,i)=>{
        const m = +r.margin_pct;
        const badge = m>=40?'badge-green':'badge-red';
        return `<tr>
          <td style="color:#94a3b8">${i+1}</td>
          <td><strong>${r.code}</strong><br><span style="color:#94a3b8;font-size:.73rem">${r.name}</span></td>
          <td class="num">${Number(r.qty_sold).toLocaleString()}</td>
          <td class="num">${fmt(r.revenue)}</td>
          <td class="num">${fmt(r.cogs)}</td>
          <td class="pct"><span class="${badge}">${m}%</span></td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  } catch(e){ el.innerHTML=`<div class="loading-state" style="color:#ef4444">${e.message}</div>`; }
}

/* â”€â”€ AGING BARS â”€â”€ */
async function loadCashPosition(){
  try {
    const d = await apiFetch('/api/financials/cash-position');
    renderAging('ar-aging', d.ar, '#3b82f6');
    renderAging('ap-aging', d.ap, '#f59e0b');
  } catch(e){
    document.getElementById('ar-aging').innerHTML=`<div style="color:#ef4444">${e.message}</div>`;
    document.getElementById('ap-aging').innerHTML=`<div style="color:#ef4444">${e.message}</div>`;
  }
}

function renderAging(elId, d, color){
  const el = document.getElementById(elId);
  const buckets = [
    {label:'Current',  val:+d.current_amt,  color:'#22c55e'},
    {label:'1â€“30 days',val:+d.overdue_1_30, color:'#f59e0b'},
    {label:'31â€“60',    val:+d.overdue_31_60,color:'#f97316'},
    {label:'61â€“90',    val:+d.overdue_61_90,color:'#ef4444'},
    {label:'90+ days', val:+d.overdue_90_plus,color:'#7f1d1d'},
  ];
  const total = buckets.reduce((a,b)=>a+b.val,0)||1;
  const totalFmt = fmt(total===1?0:total);
  el.innerHTML = `
    <div style="margin-bottom:12px;font-size:.82rem;color:#64748b">Total: <strong style="color:#1a1a2e">${totalFmt}</strong></div>
    ${buckets.map(b=>`
      <div class="aging-bar-row">
        <div class="aging-label">${b.label}</div>
        <div class="aging-bar-bg"><div class="aging-bar" style="width:${(b.val/total*100).toFixed(1)}%;background:${b.color}"></div></div>
        <div class="aging-val">${fmt(b.val)}</div>
      </div>
    `).join('')}
  `;
}

/* â”€â”€ P&L TABLE â”€â”€ */
async function loadPL(){
  const el = document.getElementById('tbl-pl');
  try {
    const rows = await apiFetch('/api/financials/pl-detail');
    if(!rows.length){ el.innerHTML='<p style="color:#94a3b8;font-size:.82rem;padding:12px">No data yet.</p>'; return; }
    el.innerHTML = `<table>
      <thead><tr>
        <th>Month</th>
        <th class="num">Revenue</th>
        <th class="num">Cash In</th>
        <th class="num">COGS</th>
        <th class="num">Gross Profit</th>
        <th class="num">Cash Out</th>
        <th class="num">Net Cash</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>{
          const gp   = +r.gross_profit;
          const nc   = +r.net_cash;
          return `<tr>
            <td><strong>${r.month}</strong></td>
            <td class="num">${fmt(r.revenue)}</td>
            <td class="num">${fmt(r.cash_collected)}</td>
            <td class="num">${fmt(r.cogs)}</td>
            <td class="num" style="color:${gp>=0?'#16a34a':'#dc2626'};font-weight:700">${fmt(gp)}</td>
            <td class="num">${fmt(r.cash_paid)}</td>
            <td class="num" style="color:${nc>=0?'#16a34a':'#dc2626'};font-weight:700">${fmt(nc)}</td>
          </tr>`;
        }).join('')}
        ${(()=>{
          const tot = rows.reduce((a,r)=>({
            revenue:a.revenue+(+r.revenue),
            cash_collected:a.cash_collected+(+r.cash_collected),
            cogs:a.cogs+(+r.cogs),
            gross_profit:a.gross_profit+(+r.gross_profit),
            cash_paid:a.cash_paid+(+r.cash_paid),
            net_cash:a.net_cash+(+r.net_cash)
          }),{revenue:0,cash_collected:0,cogs:0,gross_profit:0,cash_paid:0,net_cash:0});
          return `<tr class="pl-highlight">
            <td><strong>TOTAL</strong></td>
            <td class="num">${fmt(tot.revenue)}</td>
            <td class="num">${fmt(tot.cash_collected)}</td>
            <td class="num">${fmt(tot.cogs)}</td>
            <td class="num" style="color:${tot.gross_profit>=0?'#16a34a':'#dc2626'}">${fmt(tot.gross_profit)}</td>
            <td class="num">${fmt(tot.cash_paid)}</td>
            <td class="num" style="color:${tot.net_cash>=0?'#16a34a':'#dc2626'}">${fmt(tot.net_cash)}</td>
          </tr>`;
        })()}
      </tbody>
    </table>`;
  } catch(e){ el.innerHTML=`<div class="loading-state" style="color:#ef4444">${e.message}</div>`; }
}

// Boot
loadAll();

// â•â• General Ledger â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtM(v) { return v == null ? 'â€”' : '$' + Number(v).toLocaleString('en-US', {minimumFractionDigits:2,maximumFractionDigits:2}); }
function escGL(s) { return s==null?'':String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

const typeColors = { asset:'#3b82f6', liability:'#ef4444', equity:'#8b5cf6', revenue:'#22c55e', cogs:'#f97316', expense:'#f59e0b' };

function glTab(id) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('gl-' + id).classList.add('active');
  event.currentTarget.classList.add('active');
  if (id === 'coa') loadCOA();
  if (id === 'je')  loadJE();
}
function closeGLModal(id) { document.getElementById(id).classList.remove('active'); }

// â”€â”€ Chart of Accounts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _coaRows = [];
async function loadCOA() {
  document.getElementById('coaBody').innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  try {
    const d = await apiFetch('/api/gl/accounts');
    _coaRows = d.data || [];
    filterCOA();
  } catch(e) { document.getElementById('coaBody').innerHTML = `<div class="loading-state" style="color:#ef4444">${e.message}</div>`; }
}
function filterCOA() {
  const q    = (document.getElementById('coaSearch').value || '').toLowerCase();
  const type = document.getElementById('coaTypeFilter').value;
  const rows = _coaRows.filter(r =>
    (!q    || r.account_number.toLowerCase().includes(q) || r.name.toLowerCase().includes(q)) &&
    (!type || r.type === type)
  );
  const color = r => typeColors[r.type] || '#94a3b8';
  document.getElementById('coaBody').innerHTML = `
    <table>
      <thead><tr><th>Number</th><th>Name</th><th>Type</th><th>Sub-Type</th><th>Normal Bal.</th><th style="text-align:right">Balance</th><th>Status</th></tr></thead>
      <tbody>${rows.map(r => `
        <tr>
          <td><code>${escGL(r.account_number)}</code></td>
          <td>${escGL(r.name)}</td>
          <td><span style="background:${color(r)}22;color:${color(r)};padding:2px 8px;border-radius:10px;font-size:.72rem;font-weight:700">${r.type.toUpperCase()}</span></td>
          <td style="color:#64748b;font-size:.78rem">${r.sub_type ? r.sub_type.replace(/_/g,' ') : 'â€”'}</td>
          <td style="text-align:center">${r.normal_balance}</td>
          <td style="text-align:right;font-weight:600;color:${parseFloat(r.balance||0)<0?'#dc2626':'#16a34a'}">${fmtM(r.balance)}</td>
          <td>${r.is_active ? '<span class="badge-green">Active</span>' : '<span class="badge-void">Inactive</span>'}</td>
        </tr>`).join('')}
      </tbody>
    </table>
    <div style="font-size:.78rem;color:#94a3b8;margin-top:10px">${rows.length} accounts</div>`;
}
function openNewAccountModal() {
  ['acctNum','acctName','acctDesc'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('acctType').value = 'expense';
  document.getElementById('newAcctModal').classList.add('active');
}
async function saveNewAccount() {
  const body = {
    account_number: document.getElementById('acctNum').value.trim(),
    name:           document.getElementById('acctName').value.trim(),
    type:           document.getElementById('acctType').value,
    description:    document.getElementById('acctDesc').value.trim() || undefined,
  };
  if (!body.account_number || !body.name) return alert('Account number and name are required.');
  try {
    await apiFetch('/api/gl/accounts', { method:'POST', body: JSON.stringify(body) });
    closeGLModal('newAcctModal');
    loadCOA();
  } catch(e) { alert(e.message); }
}

// â”€â”€ Journal Entries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadJE() {
  document.getElementById('jeBody').innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  const status = document.getElementById('jeStatusFilter').value;
  const from   = document.getElementById('jeFromDate').value;
  const to     = document.getElementById('jeToDate').value;
  const params = new URLSearchParams({ limit: 50 });
  if (status) params.set('status', status);
  if (from)   params.set('from_date', from);
  if (to)     params.set('to_date', to);
  try {
    const d = await apiFetch(`/api/gl/journal-entries?${params}`);
    const rows = d.data || [];
    if (!rows.length) {
      document.getElementById('jeBody').innerHTML = '<div class="loading-state" style="color:#94a3b8">No journal entries found</div>';
      return;
    }
    document.getElementById('jeBody').innerHTML = `
      <table>
        <thead><tr><th>Number</th><th>Date</th><th>Description</th><th>Reference</th><th>Lines</th><th style="text-align:right">Total</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody>${rows.map(r => `
          <tr>
            <td><strong>${escGL(r.number)}</strong></td>
            <td>${r.entry_date ? r.entry_date.slice(0,10) : 'â€”'}</td>
            <td>${escGL(r.description)}</td>
            <td style="color:#64748b;font-size:.78rem">${escGL(r.reference||'â€”')}</td>
            <td style="text-align:center">${r.line_count}</td>
            <td style="text-align:right;font-weight:600">${fmtM(r.total_debit)}</td>
            <td><span class="badge-${r.status}">${r.status}</span></td>
            <td>
              ${r.status==='draft' ? `<button class="gl-btn gl-btn-green" style="padding:3px 10px;font-size:.75rem" onclick="postJE('${r.id}')">Post</button>
              <button class="gl-btn gl-btn-ghost" style="padding:3px 10px;font-size:.75rem" onclick="voidJE('${r.id}')">Void</button>` : ''}
            </td>
          </tr>`).join('')}
        </tbody>
      </table>`;
  } catch(e) { document.getElementById('jeBody').innerHTML = `<div class="loading-state" style="color:#ef4444">${e.message}</div>`; }
}

async function postJE(id) {
  if (!confirm('Post this journal entry? This action cannot be undone.')) return;
  try {
    await apiFetch(`/api/gl/journal-entries/${id}/post`, { method:'POST', body:'{}' });
    loadJE();
  } catch(e) { alert(e.message); }
}
async function voidJE(id) {
  if (!confirm('Void this draft entry?')) return;
  try {
    await apiFetch(`/api/gl/journal-entries/${id}/void`, { method:'POST', body:'{}' });
    loadJE();
  } catch(e) { alert(e.message); }
}

// New JE modal
let _jeAccounts = [];
function openNewJEModal() {
  document.getElementById('jeDate').value = new Date().toISOString().slice(0,10);
  document.getElementById('jeRef').value  = '';
  document.getElementById('jeDesc').value = '';
  document.getElementById('jeLinesContainer').innerHTML = '';
  updateJETotals();
  document.getElementById('newJEModal').classList.add('active');
  if (!_jeAccounts.length) apiFetch('/api/gl/accounts').then(d => { _jeAccounts = d.data || []; });
  addJELine(); addJELine();
}
function addJELine() {
  const idx = document.querySelectorAll('.je-line-row').length;
  const opts = _jeAccounts.map(a => `<option value="${a.id}">${a.account_number} â€” ${escGL(a.name)}</option>`).join('');
  const row = document.createElement('div');
  row.className = 'je-line-row';
  row.innerHTML = `
    <select class="gl-input je-acct" style="padding:5px 8px;font-size:.78rem" onchange="updateJETotals()">${opts}</select>
    <input class="gl-input je-ldesc" style="padding:5px 8px;font-size:.78rem" placeholder="Line description">
    <input type="number" class="gl-input je-debit" style="padding:5px 8px;font-size:.78rem;text-align:right" placeholder="0.00" min="0" step="0.01" oninput="updateJETotals()">
    <input type="number" class="gl-input je-credit" style="padding:5px 8px;font-size:.78rem;text-align:right" placeholder="0.00" min="0" step="0.01" oninput="updateJETotals()">
    <button onclick="this.closest('.je-line-row').remove();updateJETotals()" style="background:none;border:none;cursor:pointer;color:#94a3b8;font-size:16px" title="Remove">âœ•</button>`;
  document.getElementById('jeLinesContainer').appendChild(row);
}
function updateJETotals() {
  const debits  = [...document.querySelectorAll('.je-debit')].reduce((s,i)=>s+parseFloat(i.value||0),0);
  const credits = [...document.querySelectorAll('.je-credit')].reduce((s,i)=>s+parseFloat(i.value||0),0);
  document.getElementById('jeTotalDebit').textContent  = fmtM(debits);
  document.getElementById('jeTotalCredit').textContent = fmtM(credits);
  const diff = Math.abs(debits - credits);
  const msg  = document.getElementById('jeBalanceMsg');
  if (debits === 0 && credits === 0) { msg.textContent = 'â€”'; msg.style.color = '#94a3b8'; }
  else if (diff < 0.01) { msg.textContent = 'âœ“ Balanced'; msg.style.color = '#16a34a'; }
  else { msg.textContent = `Out of balance by ${fmtM(diff)}`; msg.style.color = '#dc2626'; }
}
async function saveJE(postNow) {
  const entry_date  = document.getElementById('jeDate').value;
  const description = document.getElementById('jeDesc').value.trim();
  const reference   = document.getElementById('jeRef').value.trim();
  if (!description) return alert('Description is required.');
  const rows = document.querySelectorAll('.je-line-row');
  const lines = [...rows].map(row => ({
    account_id:  row.querySelector('.je-acct').value,
    description: row.querySelector('.je-ldesc').value.trim() || undefined,
    debit:       parseFloat(row.querySelector('.je-debit').value  || 0),
    credit:      parseFloat(row.querySelector('.je-credit').value || 0),
  })).filter(l => l.debit > 0 || l.credit > 0);
  if (lines.length < 2) return alert('At least 2 lines required.');
  const body = { entry_date, description, lines };
  if (reference) body.reference = reference;
  try {
    const created = await apiFetch('/api/gl/journal-entries', { method:'POST', body: JSON.stringify(body) });
    if (postNow) await apiFetch(`/api/gl/journal-entries/${created.data.id}/post`, { method:'POST', body:'{}' });
    closeGLModal('newJEModal');
    loadJE();
  } catch(e) { alert(e.message); }
}

// â”€â”€ Trial Balance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTrialBalance() {
  const asOf = document.getElementById('tbAsOf').value || new Date().toISOString().slice(0,10);
  const card = document.getElementById('tbCard');
  card.innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  try {
    const d = await apiFetch(`/api/gl/trial-balance?as_of=${asOf}`);
    const { rows, total_debit, total_credit, is_balanced } = d.data;
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <h3 style="margin:0">Trial Balance â€” As of ${asOf}</h3>
        <span class="${is_balanced ? 'badge-green' : 'badge-red'}">${is_balanced ? 'âœ“ Balanced' : 'âœ— Out of Balance'}</span>
      </div>
      <table>
        <thead><tr><th>Account #</th><th>Name</th><th>Type</th><th style="text-align:right">Debits</th><th style="text-align:right">Credits</th></tr></thead>
        <tbody>${rows.map(r => `<tr>
          <td><code>${escGL(r.account_number)}</code></td>
          <td>${escGL(r.name)}</td>
          <td><span style="background:${typeColors[r.type]||'#aaa'}22;color:${typeColors[r.type]||'#aaa'};padding:2px 7px;border-radius:10px;font-size:.72rem;font-weight:700">${r.type}</span></td>
          <td style="text-align:right">${parseFloat(r.total_debit) > 0 ? fmtM(r.total_debit) : ''}</td>
          <td style="text-align:right">${parseFloat(r.total_credit) > 0 ? fmtM(r.total_credit) : ''}</td>
        </tr>`).join('')}
        </tbody>
        <tfoot><tr style="font-weight:700;border-top:2px solid #e2e8f0">
          <td colspan="3">Totals</td>
          <td style="text-align:right">${fmtM(total_debit)}</td>
          <td style="text-align:right">${fmtM(total_credit)}</td>
        </tr></tfoot>
      </table>`;
  } catch(e) { card.innerHTML = `<div class="loading-state" style="color:#ef4444">${e.message}</div>`; }
}

// â”€â”€ P&L Statement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadGLPL() {
  const from = document.getElementById('plFrom').value;
  const to   = document.getElementById('plTo').value;
  const card = document.getElementById('plCard');
  if (!from || !to) { alert('Please select a date range.'); return; }
  card.innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  try {
    const d = await apiFetch(`/api/gl/pl?from=${from}&to=${to}`);
    const { accounts, summary } = d.data;
    const rev  = accounts.filter(a => a.type === 'revenue');
    const cogs = accounts.filter(a => a.type === 'cogs');
    const exp  = accounts.filter(a => a.type === 'expense');
    const sec = (title, rows, color) => `
      <tr><td colspan="2" class="bs-section" style="border-left-color:${color}">${title}</td></tr>
      ${rows.map(r => `<tr><td style="padding-left:24px">${escGL(r.name)}</td><td class="num">${fmtM(r.amount)}</td></tr>`).join('')}`;
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <h3 style="margin:0">Income Statement â€” ${from} to ${to}</h3>
      </div>
      <table>
        <thead><tr><th>Account</th><th style="text-align:right;min-width:120px">Amount</th></tr></thead>
        <tbody>
          ${sec('Revenue', rev, '#22c55e')}
          <tr class="bs-total"><td>Total Revenue</td><td class="num">${fmtM(summary.revenue)}</td></tr>
          ${sec('Cost of Goods Sold', cogs, '#f97316')}
          <tr class="bs-total"><td>Total COGS</td><td class="num">${fmtM(summary.cogs)}</td></tr>
          <tr style="font-weight:700;font-size:1rem;background:#f0fdf4"><td>Gross Profit</td><td class="num" style="color:${summary.gross_profit>=0?'#16a34a':'#dc2626'}">${fmtM(summary.gross_profit)}</td></tr>
          ${sec('Operating Expenses', exp, '#f59e0b')}
          <tr class="bs-total"><td>Total Expenses</td><td class="num">${fmtM(summary.expenses)}</td></tr>
          <tr style="font-weight:700;font-size:1.05rem;background:${summary.net_income>=0?'#f0fdf4':'#fef2f2'}">
            <td>Net Income</td>
            <td class="num" style="color:${summary.net_income>=0?'#16a34a':'#dc2626'}">${fmtM(summary.net_income)}</td>
          </tr>
        </tbody>
      </table>`;
  } catch(e) { card.innerHTML = `<div class="loading-state" style="color:#ef4444">${e.message}</div>`; }
}

// â”€â”€ Balance Sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBalanceSheet() {
  const asOf = document.getElementById('bsAsOf').value || new Date().toISOString().slice(0,10);
  const card = document.getElementById('bsCard');
  card.innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  try {
    const d = await apiFetch(`/api/gl/balance-sheet?as_of=${asOf}`);
    const { assets, liabilities, equity, net_income, summary } = d.data;
    const groupRows = rows => rows.map(r => `
      <tr><td style="padding-left:20px">${escGL(r.name)}</td><td class="num">${fmtM(r.balance)}</td></tr>`).join('');
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <h3 style="margin:0">Balance Sheet â€” As of ${asOf}</h3>
        <span class="${summary.balanced ? 'badge-green' : 'badge-red'}">${summary.balanced ? 'âœ“ Balanced' : 'âœ— Does Not Balance'}</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
        <div>
          <table>
            <tbody>
              <tr><td colspan="2" class="bs-section" style="border-left-color:#3b82f6">ASSETS</td></tr>
              ${groupRows(assets)}
              <tr class="bs-total"><td><strong>Total Assets</strong></td><td class="num"><strong>${fmtM(summary.total_assets)}</strong></td></tr>
            </tbody>
          </table>
        </div>
        <div>
          <table>
            <tbody>
              <tr><td colspan="2" class="bs-section" style="border-left-color:#ef4444">LIABILITIES</td></tr>
              ${groupRows(liabilities)}
              <tr class="bs-total"><td>Total Liabilities</td><td class="num">${fmtM(summary.total_liabilities)}</td></tr>
              <tr><td colspan="2" class="bs-section" style="border-left-color:#8b5cf6;margin-top:16px">EQUITY</td></tr>
              ${groupRows(equity)}
              <tr><td style="padding-left:20px;color:#22c55e">Net Income (Current Period)</td><td class="num" style="color:${net_income>=0?'#16a34a':'#dc2626'}">${fmtM(net_income)}</td></tr>
              <tr class="bs-total"><td>Total Equity</td><td class="num">${fmtM(summary.total_equity)}</td></tr>
              <tr style="font-weight:700;background:#f8fafc"><td>Total Liabilities + Equity</td><td class="num">${fmtM(summary.total_liabilities + summary.total_equity)}</td></tr>
            </tbody>
          </table>
        </div>
      </div>`;
  } catch(e) { card.innerHTML = `<div class="loading-state" style="color:#ef4444">${e.message}</div>`; }
}

// Init GL defaults
(function initGLDates() {
  const today = new Date().toISOString().slice(0,10);
  const yearStart = new Date(new Date().getFullYear(), 0, 1).toISOString().slice(0,10);
  document.getElementById('tbAsOf').value = today;
  document.getElementById('bsAsOf').value = today;
  document.getElementById('plFrom').value = yearStart;
  document.getElementById('plTo').value   = today;
  loadCOA();
})();
</script>
</body>
</html>
