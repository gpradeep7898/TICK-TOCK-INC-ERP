<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tick Tock Inc. â€” Purchasing</title>
<style>
:root {
  --bg:       #0f1117;
  --surface:  #1a1d27;
  --border:   #2a2d3e;
  --accent:   #6c63ff;
  --accent2:  #00d4aa;
  --warn:     #f5a623;
  --danger:   #e74c3c;
  --success:  #27ae60;
  --text:     #e8eaf0;
  --muted:    #8a8ea8;
  --sidebar:  180px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif;
       display: flex; height: 100vh; overflow: hidden; font-size: 14px; }

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
nav { width: var(--sidebar); background: var(--surface); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; flex-shrink: 0; }
.brand { padding: 18px 16px 14px; border-bottom: 1px solid var(--border); }
.brand h1 { font-size: 15px; font-weight: 700; color: var(--accent2); }
.brand p  { font-size: 11px; color: var(--muted); margin-top: 2px; }
nav a { display: flex; align-items: center; gap: 8px; padding: 10px 16px;
        color: var(--muted); text-decoration: none; font-size: 13px; transition: all .15s; }
nav a:hover, nav a.active { color: var(--text); background: rgba(108,99,255,.12); }
nav a.active { border-left: 3px solid var(--accent); }
nav a span.ico { font-size: 15px; }
.nav-module { padding: 10px 16px 6px; font-size: 10px; text-transform: uppercase;
              letter-spacing: .08em; color: var(--muted); border-top: 1px solid var(--border); margin-top: auto; }
nav .module-links a { font-size: 12px; padding: 7px 16px; }

/* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.topbar { display: flex; align-items: center; padding: 0 24px; height: 56px;
          border-bottom: 1px solid var(--border); background: var(--surface); gap: 16px; }
.topbar h2 { font-size: 16px; font-weight: 600; flex: 1; }
.btn { padding: 7px 16px; border-radius: 6px; border: none; cursor: pointer;
       font-size: 13px; font-weight: 500; transition: all .15s; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #7a72ff; }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover { background: #2ecc71; }
.btn-warn   { background: var(--warn); color: #fff; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-ghost  { background: transparent; color: var(--muted); border: 1px solid var(--border); }
.btn-ghost:hover { color: var(--text); border-color: var(--accent); }
.btn-sm { padding: 4px 10px; font-size: 12px; }

/* â”€â”€ Stats bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-bar { display: flex; gap: 1px; background: var(--border); border-bottom: 1px solid var(--border); }
.stat { flex: 1; background: var(--surface); padding: 14px 20px; }
.stat label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }
.stat .val   { font-size: 22px; font-weight: 700; margin-top: 2px; color: var(--accent2); }
.stat .val.warn { color: var(--warn); }
.stat .val.danger { color: var(--danger); }

/* â”€â”€ Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content { flex: 1; overflow-y: auto; padding: 24px; }
.view { display: none; }
.view.active { display: block; }

/* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
table { width: 100%; border-collapse: collapse; }
th { background: #1e2130; padding: 10px 14px; text-align: left;
     font-size: 11px; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); }
td { padding: 10px 14px; border-top: 1px solid var(--border); vertical-align: middle; }
tr:hover td { background: rgba(255,255,255,.02); }
.mono { font-family: 'Courier New', monospace; font-size: 12px; }

/* â”€â”€ Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge { display: inline-block; padding: 2px 8px; border-radius: 4px;
         font-size: 11px; font-weight: 600; }
.badge-draft     { background: rgba(138,142,168,.15); color: var(--muted); }
.badge-sent      { background: rgba(245,166,35,.12); color: var(--warn); }
.badge-partial   { background: rgba(108,99,255,.15); color: var(--accent); }
.badge-received  { background: rgba(0,212,170,.12); color: var(--accent2); }
.badge-posted    { background: rgba(0,212,170,.12); color: var(--accent2); }
.badge-approved  { background: rgba(39,174,96,.15); color: var(--success); }
.badge-disputed  { background: rgba(231,76,60,.15); color: var(--danger); }
.badge-paid      { background: rgba(39,174,96,.15); color: var(--success); }
.badge-pending   { background: rgba(245,166,35,.12); color: var(--warn); }
.badge-cancelled { background: rgba(231,76,60,.1); color: var(--danger); }
.badge-matched   { background: rgba(0,212,170,.12); color: var(--accent2); }

/* â”€â”€ Card grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px; }
.card  { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
.card h3 { font-size: 13px; color: var(--muted); margin-bottom: 8px; }
.card .big { font-size: 28px; font-weight: 700; color: var(--accent2); }

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.6);
           z-index: 100; align-items: center; justify-content: center; }
.overlay.open { display: flex; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
         width: 720px; max-width: 95vw; max-height: 90vh; display: flex; flex-direction: column; }
.modal-lg { width: 900px; }
.modal-hd { padding: 18px 20px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 12px; }
.modal-hd h3 { flex: 1; font-size: 16px; }
.modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.modal-ft  { padding: 14px 20px; border-top: 1px solid var(--border);
             display: flex; gap: 8px; justify-content: flex-end; }

/* â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-full { grid-column: 1 / -1; }
.field label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
.field input, .field select, .field textarea {
  width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
  color: var(--text); padding: 8px 10px; font-size: 13px; outline: none; }
.field input:focus, .field select:focus, .field textarea:focus { border-color: var(--accent); }
.field textarea { resize: vertical; min-height: 60px; }

/* â”€â”€ Lines editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lines-tbl { width: 100%; border-collapse: collapse; margin-top: 12px; }
.lines-tbl th { background: #1e2130; padding: 8px 10px; font-size: 11px;
                text-transform: uppercase; color: var(--muted); text-align: left; }
.lines-tbl td { padding: 6px 6px; border-top: 1px solid var(--border); }
.lines-tbl input, .lines-tbl select {
  background: var(--bg); border: 1px solid var(--border); border-radius: 4px;
  color: var(--text); padding: 6px 8px; font-size: 12px; width: 100%; }

/* â”€â”€ Detail panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.detail-row { display: flex; gap: 8px; margin-bottom: 6px; font-size: 13px; }
.detail-row .lbl { color: var(--muted); min-width: 120px; }
.section-title { font-size: 12px; text-transform: uppercase; letter-spacing: .06em;
                 color: var(--muted); border-bottom: 1px solid var(--border);
                 padding-bottom: 6px; margin: 16px 0 10px; }

/* â”€â”€ AP Aging buckets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.aging-buckets { display: grid; grid-template-columns: repeat(5,1fr); gap: 1px;
                 background: var(--border); border-radius: 8px; overflow: hidden;
                 margin-bottom: 20px; }
.ab { background: var(--surface); padding: 14px; text-align: center; }
.ab label { font-size: 11px; color: var(--muted); display: block; margin-bottom: 4px; }
.ab .val { font-size: 20px; font-weight: 700; }
.ab.current .val { color: var(--accent2); }
.ab.d30 .val { color: var(--warn); }
.ab.d60 .val { color: #e67e22; }
.ab.d90 .val { color: var(--danger); }
.ab.d90p .val { color: #c0392b; }

/* â”€â”€ Reorder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.reorder-banner { background: rgba(231,76,60,.08); border: 1px solid rgba(231,76,60,.3);
                  border-radius: 8px; padding: 14px 18px; margin-bottom: 20px;
                  display: flex; align-items: center; gap: 12px; }
.reorder-banner p { flex: 1; font-size: 13px; }

/* â”€â”€ Loading / empty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading, .empty { text-align: center; padding: 40px; color: var(--muted); font-size: 13px; }
.empty { font-style: italic; }

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast { position: fixed; bottom: 24px; right: 24px; z-index: 999;
         background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
         padding: 12px 18px; font-size: 13px; max-width: 340px;
         transition: opacity .3s; opacity: 0; pointer-events: none; }
#toast.show { opacity: 1; }
#toast.ok   { border-color: var(--success); color: var(--success); }
#toast.err  { border-color: var(--danger);  color: var(--danger); }
</style>
</head>
<body>

<!-- â”€â”€ Sidebar â”€â”€â”€ -->
<nav>
  <div class="brand">
    <h1>Tick Tock Inc.</h1>
    <p>Purchasing</p>
  </div>
  <a href="#" class="active" data-view="dashboard"  onclick="show('dashboard',this)">
    <span class="ico">ğŸ“¦</span> Dashboard
  </a>
  <a href="#" data-view="pos"       onclick="show('pos',this)">
    <span class="ico">ğŸ“‹</span> Purchase Orders
  </a>
  <a href="#" data-view="receiving" onclick="show('receiving',this)">
    <span class="ico">ğŸšš</span> Receiving
  </a>
  <a href="#" data-view="vinvoices" onclick="show('vinvoices',this)">
    <span class="ico">ğŸ“„</span> Vendor Invoices
  </a>
  <a href="#" data-view="apaging"   onclick="show('apaging',this)">
    <span class="ico">â±</span> AP Aging
  </a>
  <a href="#" data-view="vendors"   onclick="show('vendors',this)">
    <span class="ico">ğŸ­</span> Vendors
  </a>
  <a href="#" data-view="reorder"   onclick="show('reorder',this)">
    <span class="ico">ğŸ””</span> Reorder
  </a>
  <a href="#" data-view="price-change" onclick="show('price-change',this)">
    <span class="ico">ğŸ’²</span> Price Change
  </a>
  <a href="#" data-view="import-tool" onclick="show('import-tool',this)">
    <span class="ico">ğŸ“‚</span> Import Tool
  </a>
  <div class="nav-module">Other Modules</div>
  <div class="module-links">
    <a href="/"><span class="ico">ğŸ“¦</span> Inventory</a>
    <a href="/sales"><span class="ico">ğŸ’°</span> Sales</a>
    <a href="/financials"><span class="ico">ğŸ“ˆ</span> Financials</a>
  </div>
</nav>

<!-- â”€â”€ Main â”€â”€â”€ -->
<main>
  <div class="topbar">
    <h2 id="pageTitle">Purchasing Dashboard</h2>
    <button class="btn btn-primary" id="topActionBtn" onclick="topAction()">+ New PO</button>
  </div>

  <div class="stats-bar">
    <div class="stat"><label>Open POs</label><div class="val" id="statOpenPOs">â€”</div></div>
    <div class="stat"><label>Received POs</label><div class="val" id="statRecPOs">â€”</div></div>
    <div class="stat"><label>AP Balance</label><div class="val warn" id="statAP">â€”</div></div>
    <div class="stat"><label>Pending Invoices</label><div class="val warn" id="statPendInv">â€”</div></div>
  </div>

  <div class="content">

    <!-- â”€â”€ Dashboard â”€â”€ -->
    <div class="view active" id="view-dashboard">
      <div class="cards">
        <div class="card">
          <h3>Recent Purchase Orders</h3>
          <div id="dashRecentPOs"><div class="loading">Loadingâ€¦</div></div>
        </div>
        <div class="card">
          <h3>AP Summary</h3>
          <div id="dashAPSummary"><div class="loading">Loadingâ€¦</div></div>
        </div>
        <div class="card">
          <h3>Reorder Alerts</h3>
          <div id="dashReorder"><div class="loading">Loadingâ€¦</div></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Purchase Orders â”€â”€ -->
    <div class="view" id="view-pos">
      <div style="margin-bottom:14px;display:flex;gap:8px;align-items:center;">
        <select id="poFilterStatus" onchange="loadPOs()" style="background:var(--surface);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:13px;">
          <option value="">All Statuses</option>
          <option value="draft">Draft</option>
          <option value="sent">Sent</option>
          <option value="partially_received">Partially Received</option>
          <option value="fully_received">Fully Received</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>PO #</th><th>Vendor</th><th>Status</th>
            <th>Order Date</th><th>Expected</th><th>Lines</th>
            <th>PO Total</th><th>Actions</th>
          </tr></thead>
          <tbody id="poBody"><tr><td colspan="8" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Receiving â”€â”€ -->
    <div class="view" id="view-receiving">
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Receipt #</th><th>PO #</th><th>Vendor</th><th>Date</th>
            <th>Status</th><th>Vendor Ref</th><th>Actions</th>
          </tr></thead>
          <tbody id="rcvBody"><tr><td colspan="7" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Vendor Invoices â”€â”€ -->
    <div class="view" id="view-vinvoices">
      <div style="margin-bottom:14px;display:flex;gap:8px;align-items:center;">
        <select id="viFilterStatus" onchange="loadVendorInvoices()" style="background:var(--surface);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:13px;">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="disputed">Disputed</option>
          <option value="paid">Paid</option>
        </select>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Invoice #</th><th>Vendor</th><th>PO #</th><th>Date</th>
            <th>Due</th><th>Total</th><th>Balance</th><th>Status</th><th>Match</th><th>Actions</th>
          </tr></thead>
          <tbody id="viBody"><tr><td colspan="10" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ AP Aging â”€â”€ -->
    <div class="view" id="view-apaging">
      <div class="aging-buckets">
        <div class="ab current"><label>Current</label><div class="val" id="apCur">â€”</div></div>
        <div class="ab d30">   <label>1â€“30 Days</label><div class="val" id="ap30">â€”</div></div>
        <div class="ab d60">   <label>31â€“60 Days</label><div class="val" id="ap60">â€”</div></div>
        <div class="ab d90">   <label>61â€“90 Days</label><div class="val" id="ap90">â€”</div></div>
        <div class="ab d90p">  <label>90+ Days</label><div class="val" id="ap90p">â€”</div></div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Vendor</th><th>Current</th><th>1â€“30</th><th>31â€“60</th><th>61â€“90</th><th>90+</th><th>Total Due</th>
          </tr></thead>
          <tbody id="apBody"><tr><td colspan="7" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Vendors â”€â”€ -->
    <div class="view" id="view-vendors">
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Code</th><th>Name</th><th>Email</th><th>Phone</th>
            <th>Terms</th><th>AP Balance</th>
          </tr></thead>
          <tbody id="vendorBody"><tr><td colspan="6" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Reorder Suggestions â”€â”€ -->
    <div class="view" id="view-reorder">
      <div class="reorder-banner" id="reorderBanner" style="display:none;">
        <p id="reorderMsg"></p>
        <button class="btn btn-danger btn-sm" onclick="generatePOs()">Auto-Generate POs</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Item Code</th><th>Name</th><th>On Hand</th><th>On Order</th>
            <th>Effective</th><th>Reorder Pt.</th><th>Suggest Qty</th><th>Preferred Vendor</th>
          </tr></thead>
          <tbody id="reorderBody"><tr><td colspan="8" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Price Change Tool â”€â”€ -->
    <div class="view" id="view-price-change">
      <div class="cards">
        <div class="card" style="max-width:560px">
          <h3>Cost Update Tool</h3>
          <p style="font-size:12px;color:var(--muted);margin-bottom:14px">
            Update an item's cost when a vendor charges a new price. The system maintains margin % and updates all customer price lists (VIP locked prices are protected).
          </p>
          <div class="form-grid">
            <div class="field form-full">
              <label>Item *</label>
              <select id="pcItemSel" onchange="pcClearPreview()">
                <option value="">Select itemâ€¦</option>
              </select>
            </div>
            <div class="field">
              <label>New Cost ($) *</label>
              <input type="number" id="pcNewCost" step="0.01" min="0" placeholder="0.00" oninput="pcClearPreview()">
            </div>
            <div class="field">
              <label>Notes</label>
              <input type="text" id="pcNotes" placeholder="Reason for cost change">
            </div>
          </div>
          <div style="margin-top:10px">
            <button class="btn btn-warn" onclick="pcPreview()">Preview Change</button>
          </div>

          <div id="pcPreviewBox" style="display:none;margin-top:16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px">
            <div style="font-size:12px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:10px">Preview</div>
            <table style="width:100%;font-size:13px;border-collapse:collapse" id="pcPreviewTable"></table>
            <div style="margin-top:14px;display:flex;gap:8px">
              <button class="btn btn-success" onclick="pcConfirm()">âœ“ Apply Change</button>
              <button class="btn btn-ghost" onclick="pcClearPreview()">Cancel</button>
            </div>
          </div>

          <div id="pcHistoryBox" style="margin-top:20px">
            <div style="font-size:12px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:8px">
              Recent Changes <button class="btn btn-ghost btn-sm" onclick="pcLoadHistory()" style="margin-left:8px">Refresh</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Item</th><th>Old Cost</th><th>New Cost</th><th>Old Price</th><th>New Price</th><th>Updated</th><th>Locked</th><th>Date</th></tr></thead>
                <tbody id="pcHistoryBody"><tr><td colspan="8" class="loading">Click Refresh to load</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Import Tool â”€â”€ -->
    <div class="view" id="view-import-tool">
      <div class="cards">
        <div class="card" style="max-width:760px">
          <h3>CSV / Excel Import</h3>
          <p style="font-size:12px;color:var(--muted);margin-bottom:14px">
            Import items, customers, or vendors from a CSV or Excel file. Existing records are updated by code; new records are inserted.
          </p>

          <div class="form-grid">
            <div class="field">
              <label>Import Type</label>
              <select id="importTable">
                <option value="items">Items (inventory)</option>
                <option value="customers">Customers</option>
                <option value="vendors">Vendors</option>
              </select>
            </div>
            <div class="field">
              <label>File (.csv, .xls, .xlsx)</label>
              <input type="file" id="importFile" accept=".csv,.xls,.xlsx" onchange="importFileSelected()">
            </div>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn btn-warn" onclick="importPreview()">Preview</button>
            <button class="btn btn-success" onclick="importConfirm()" id="importConfirmBtn" disabled>Import</button>
          </div>

          <!-- Migration Status -->
          <div style="margin-top:16px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:6px;display:flex;gap:24px;font-size:13px" id="importStatusBar">
            <span>Items: <strong id="isItems">â€”</strong></span>
            <span>Customers: <strong id="isCustomers">â€”</strong></span>
            <span>Vendors: <strong id="isVendors">â€”</strong></span>
            <button class="btn btn-ghost btn-sm" onclick="loadImportStatus()">Refresh Counts</button>
          </div>

          <!-- Preview box -->
          <div id="importPreviewBox" style="display:none;margin-top:14px">
            <div style="font-size:12px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:8px">Preview</div>
            <div id="importPreviewStats" style="font-size:13px;margin-bottom:8px"></div>
            <div class="table-wrap" style="max-height:260px;overflow-y:auto">
              <table><thead id="importPreviewHead"></thead><tbody id="importPreviewBody"></tbody></table>
            </div>
            <div id="importPreviewErrors" style="margin-top:8px;font-size:12px;color:var(--danger)"></div>
          </div>

          <!-- Result box -->
          <div id="importResultBox" style="display:none;margin-top:14px;padding:12px 16px;border-radius:6px"></div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</main>

<!-- â”€â”€ New PO Modal â”€â”€ -->
<div class="overlay" id="newPOModal">
  <div class="modal modal-lg">
    <div class="modal-hd">
      <h3>New Purchase Order</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('newPOModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field">
          <label>Vendor *</label>
          <select id="poVendor"><option value="">Select vendorâ€¦</option></select>
        </div>
        <div class="field">
          <label>Warehouse *</label>
          <select id="poWarehouse"><option value="">Select warehouseâ€¦</option></select>
        </div>
        <div class="field">
          <label>Order Date</label>
          <input type="date" id="poOrderDate">
        </div>
        <div class="field">
          <label>Expected Date</label>
          <input type="date" id="poExpectedDate">
        </div>
        <div class="field form-full">
          <label>Notes</label>
          <textarea id="poNotes" rows="2"></textarea>
        </div>
      </div>

      <div class="section-title">Lines</div>
      <table class="lines-tbl">
        <thead><tr>
          <th>Item</th><th style="width:90px">Qty</th>
          <th style="width:110px">Unit Cost</th><th style="width:110px">Line Total</th>
          <th style="width:40px"></th>
        </tr></thead>
        <tbody id="poLinesBody"></tbody>
      </table>
      <button class="btn btn-ghost btn-sm" style="margin-top:10px" onclick="addPOLine()">+ Add Line</button>
      <div style="margin-top:12px;text-align:right;">
        <strong>PO Total: <span id="poTotal">$0.00</span></strong>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-ghost" onclick="closeModal('newPOModal')">Cancel</button>
      <button class="btn btn-primary" onclick="createPO()">Create PO</button>
    </div>
  </div>
</div>

<!-- â”€â”€ PO Detail Modal â”€â”€ -->
<div class="overlay" id="poDetailModal">
  <div class="modal modal-lg">
    <div class="modal-hd">
      <h3 id="poDetailTitle">PO Detail</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('poDetailModal')">âœ•</button>
    </div>
    <div class="modal-body" id="poDetailBody"><div class="loading">Loadingâ€¦</div></div>
    <div class="modal-ft" id="poDetailFt">
      <button class="btn btn-ghost" onclick="closeModal('poDetailModal')">Close</button>
    </div>
  </div>
</div>

<!-- â”€â”€ New Receipt Modal â”€â”€ -->
<div class="overlay" id="newRcvModal">
  <div class="modal modal-lg">
    <div class="modal-hd">
      <h3>Receive Against PO</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('newRcvModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field">
          <label>Purchase Order *</label>
          <select id="rcvPO" onchange="loadPOForReceiving()">
            <option value="">Select POâ€¦</option>
          </select>
        </div>
        <div class="field">
          <label>Receipt Date</label>
          <input type="date" id="rcvDate">
        </div>
        <div class="field">
          <label>Vendor Reference</label>
          <input type="text" id="rcvVendorRef" placeholder="Vendor packing slip #">
        </div>
        <div class="field">
          <label>Notes</label>
          <input type="text" id="rcvNotes">
        </div>
      </div>
      <div class="section-title">Lines to Receive</div>
      <div id="rcvLinesArea"><div class="empty">Select a PO to load open lines</div></div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-ghost" onclick="closeModal('newRcvModal')">Cancel</button>
      <button class="btn btn-success" onclick="createReceipt()">Create Receipt</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Vendor Invoice Modal â”€â”€ -->
<div class="overlay" id="newVIModal">
  <div class="modal">
    <div class="modal-hd">
      <h3>Enter Vendor Invoice</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('newVIModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field">
          <label>Vendor *</label>
          <select id="viVendor"><option value="">Select vendorâ€¦</option></select>
        </div>
        <div class="field">
          <label>Link to PO (optional)</label>
          <select id="viPO"><option value="">No PO</option></select>
        </div>
        <div class="field">
          <label>Link to Receipt (optional)</label>
          <select id="viReceipt"><option value="">No Receipt</option></select>
        </div>
        <div class="field">
          <label>Vendor Invoice Number</label>
          <input type="text" id="viVendorNum" placeholder="Vendor's invoice #">
        </div>
        <div class="field">
          <label>Invoice Date</label>
          <input type="date" id="viInvDate">
        </div>
        <div class="field">
          <label>Subtotal *</label>
          <input type="number" id="viSubtotal" step="0.01" min="0">
        </div>
        <div class="field">
          <label>Tax Amount</label>
          <input type="number" id="viTax" step="0.01" min="0" value="0">
        </div>
        <div class="field">
          <label>Notes</label>
          <input type="text" id="viNotes">
        </div>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-ghost" onclick="closeModal('newVIModal')">Cancel</button>
      <button class="btn btn-primary" onclick="createVendorInvoice()">Save Invoice</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Payment Modal â”€â”€ -->
<div class="overlay" id="paymentModal">
  <div class="modal">
    <div class="modal-hd">
      <h3>Record AP Payment</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('paymentModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field">
          <label>Vendor</label>
          <input type="text" id="pmtVendorName" readonly style="color:var(--muted)">
          <input type="hidden" id="pmtVendorId">
        </div>
        <div class="field">
          <label>Payment Date</label>
          <input type="date" id="pmtDate">
        </div>
        <div class="field">
          <label>Amount *</label>
          <input type="number" id="pmtAmount" step="0.01" min="0">
        </div>
        <div class="field">
          <label>Method</label>
          <select id="pmtMethod">
            <option value="check">Check</option>
            <option value="wire">Wire</option>
            <option value="ach">ACH</option>
            <option value="cash">Cash</option>
          </select>
        </div>
        <div class="field">
          <label>Reference #</label>
          <input type="text" id="pmtRef">
        </div>
        <div class="field">
          <label>Notes</label>
          <input type="text" id="pmtNotes">
        </div>
      </div>
      <div class="section-title">Apply to Invoice</div>
      <div id="pmtInvoiceArea"><div class="empty">Select vendor first</div></div>
      <input type="hidden" id="pmtInvoiceId">
    </div>
    <div class="modal-ft">
      <button class="btn btn-ghost" onclick="closeModal('paymentModal')">Cancel</button>
      <button class="btn btn-success" onclick="submitPayment()">Record Payment</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const API = '';
let vendors = [], warehouses = [], items = [], openPOs = [];
let currentView = 'dashboard';

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const [v, w, i] = await Promise.all([
    fetch(`${API}/api/vendors`).then(r=>r.json()).catch(()=>[]),
    fetch(`${API}/api/warehouses`).then(r=>r.json()).catch(()=>[]),
    fetch(`${API}/api/items`).then(r=>r.json()).catch(()=>[])
  ]);
  vendors    = Array.isArray(v) ? v : [];
  warehouses = Array.isArray(w) ? w : [];
  items      = Array.isArray(i) ? i : [];

  // Populate selects
  ['poVendor','viVendor'].forEach(id => {
    const s = document.getElementById(id);
    if (!s) return;
    vendors.forEach(v => s.insertAdjacentHTML('beforeend',
      `<option value="${v.id}">${v.code} â€” ${v.name}</option>`));
  });
  const pw = document.getElementById('poWarehouse');
  warehouses.forEach(w => pw.insertAdjacentHTML('beforeend',
    `<option value="${w.id}">${w.code} â€” ${w.name}</option>`));

  const today = new Date().toISOString().slice(0,10);
  document.getElementById('poOrderDate').value   = today;
  document.getElementById('rcvDate').value        = today;
  document.getElementById('viInvDate').value      = today;
  document.getElementById('pmtDate').value        = today;

  loadDashboard();
  loadStats();
}

// â”€â”€ Stats bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  try {
    const [posR, apR, viR] = await Promise.all([
      fetch(`${API}/api/purchase-orders?status=sent`).then(r=>r.json()),
      fetch(`${API}/api/ap-aging`).then(r=>r.json()),
      fetch(`${API}/api/vendor-invoices?status=pending`).then(r=>r.json())
    ]);
    const pos = Array.isArray(posR) ? posR : [];
    document.getElementById('statOpenPOs').textContent = pos.length;
    const received = await fetch(`${API}/api/purchase-orders?status=fully_received`).then(r=>r.json()).catch(()=>[]);
    document.getElementById('statRecPOs').textContent = Array.isArray(received) ? received.length : 0;
    if (apR && apR.totals) {
      document.getElementById('statAP').textContent = '$'+fmt(apR.totals.total_due);
    }
    const vi = Array.isArray(viR) ? viR : [];
    document.getElementById('statPendInv').textContent = vi.length;
  } catch(e){}
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  try {
    const [posR, apR, reorderR] = await Promise.all([
      fetch(`${API}/api/purchase-orders`).then(r=>r.json()),
      fetch(`${API}/api/ap-aging`).then(r=>r.json()),
      fetch(`${API}/api/reorder-suggestions`).then(r=>r.json())
    ]);

    // Recent POs
    const pos = Array.isArray(posR) ? posR.slice(0,5) : [];
    document.getElementById('dashRecentPOs').innerHTML = pos.length === 0
      ? '<div class="empty">No purchase orders yet</div>'
      : pos.map(po=>`
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <div>
            <span class="mono">${po.number}</span>
            <div style="font-size:11px;color:var(--muted)">${po.vendor_name}</div>
          </div>
          <div style="text-align:right">
            <span class="badge badge-${po.status}">${po.status}</span>
            <div style="font-size:11px;color:var(--muted)">$${fmt(po.po_total)}</div>
          </div>
        </div>`).join('');

    // AP Summary
    if (apR && apR.totals) {
      const t = apR.totals;
      document.getElementById('dashAPSummary').innerHTML = `
        <div class="big">$${fmt(t.total_due)}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">Total AP Outstanding</div>
        <div style="margin-top:12px;font-size:12px;">
          <div style="display:flex;justify-content:space-between;margin:4px 0;">
            <span style="color:var(--muted)">Current</span><span>$${fmt(t.current_due)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin:4px 0;">
            <span style="color:var(--warn)">1â€“30 days</span><span>$${fmt(t.days_1_30)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin:4px 0;">
            <span style="color:#e67e22">31â€“60 days</span><span>$${fmt(t.days_31_60)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin:4px 0;">
            <span style="color:var(--danger)">61â€“90 days</span><span>$${fmt(t.days_61_90)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin:4px 0;">
            <span style="color:#c0392b">90+ days</span><span>$${fmt(t.days_90plus)}</span>
          </div>
        </div>`;
    }

    // Reorder
    const reorder = Array.isArray(reorderR) ? reorderR : [];
    document.getElementById('dashReorder').innerHTML = reorder.length === 0
      ? '<div class="empty" style="padding:16px;">All items sufficiently stocked</div>'
      : `<div class="big" style="color:var(--danger)">${reorder.length}</div>
         <div style="font-size:12px;color:var(--muted);margin-top:6px">Items below reorder point</div>
         <div style="margin-top:12px">` +
         reorder.slice(0,4).map(r=>`
           <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px;">
             <span class="mono">${r.item_code}</span>
             <span style="color:var(--danger)">On hand: ${r.qty_on_hand}</span>
           </div>`).join('') + `</div>`;
  } catch(e) {
    console.error(e);
  }
}

// â”€â”€ Purchase Orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPOs() {
  const status = document.getElementById('poFilterStatus').value;
  const url    = status ? `${API}/api/purchase-orders?status=${status}` : `${API}/api/purchase-orders`;
  const rows   = await fetch(url).then(r=>r.json()).catch(()=>[]);
  const pos    = Array.isArray(rows) ? rows : [];
  openPOs      = pos.filter(p=>['sent','partially_received'].includes(p.status));

  document.getElementById('poBody').innerHTML = pos.length === 0
    ? `<tr><td colspan="8" class="empty">No purchase orders found</td></tr>`
    : pos.map(po=>`
      <tr>
        <td class="mono">${po.number}</td>
        <td>${po.vendor_name}</td>
        <td><span class="badge badge-${po.status}">${po.status.replace(/_/g,' ')}</span></td>
        <td>${po.order_date}</td>
        <td>${po.expected_date||'â€”'}</td>
        <td>${po.line_count}</td>
        <td>$${fmt(po.po_total)}</td>
        <td>
          <button class="btn btn-ghost btn-sm" onclick="viewPO('${po.id}')">View</button>
          ${po.status==='draft'?`<button class="btn btn-warn btn-sm" onclick="sendPO('${po.id}')">Send</button>`:''}
          ${['sent','partially_received'].includes(po.status)?`<button class="btn btn-success btn-sm" onclick="openReceiveModal('${po.id}')">Receive</button>`:''}
        </td>
      </tr>`).join('');
}

async function viewPO(id) {
  document.getElementById('poDetailBody').innerHTML = '<div class="loading">Loadingâ€¦</div>';
  document.getElementById('poDetailFt').innerHTML   = '<button class="btn btn-ghost" onclick="closeModal(\'poDetailModal\')">Close</button>';
  openModal('poDetailModal');

  const po = await fetch(`${API}/api/purchase-orders/${id}`).then(r=>r.json());
  document.getElementById('poDetailTitle').textContent = `PO: ${po.number}`;

  const lines = (po.lines||[]).map(l=>`
    <tr>
      <td>${l.line_number}</td>
      <td class="mono">${l.item_code}</td>
      <td>${l.item_name}</td>
      <td>${l.qty_ordered}</td>
      <td>${l.qty_received}</td>
      <td>${l.qty_remaining}</td>
      <td>$${fmt(l.unit_cost)}</td>
      <td>$${fmt(l.line_total)}</td>
      <td><span class="badge badge-${l.status}">${l.status}</span></td>
    </tr>`).join('');

  const receipts = (po.receipts||[]).map(r=>`
    <tr>
      <td class="mono">${r.number}</td>
      <td>${r.receipt_date}</td>
      <td><span class="badge badge-${r.status}">${r.status}</span></td>
      <td>${r.vendor_ref||'â€”'}</td>
      <td><button class="btn btn-ghost btn-sm" onclick="postReceipt('${r.id}')">Post</button></td>
    </tr>`).join('');

  document.getElementById('poDetailBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;">
      <div><div class="detail-row"><span class="lbl">Vendor</span>${po.vendor_name} (${po.vendor_code})</div>
           <div class="detail-row"><span class="lbl">Warehouse</span>${po.warehouse_code}</div>
           <div class="detail-row"><span class="lbl">Order Date</span>${po.order_date}</div></div>
      <div><div class="detail-row"><span class="lbl">Expected</span>${po.expected_date||'â€”'}</div>
           <div class="detail-row"><span class="lbl">Status</span><span class="badge badge-${po.status}">${po.status}</span></div>
           <div class="detail-row"><span class="lbl">PO Total</span>$${fmt(po.po_total)}</div></div>
    </div>

    <div class="section-title">Order Lines</div>
    <div class="table-wrap">
      <table><thead><tr><th>#</th><th>Code</th><th>Item</th><th>Ordered</th>
        <th>Received</th><th>Remaining</th><th>Unit Cost</th><th>Total</th><th>Status</th>
      </tr></thead><tbody>${lines||'<tr><td colspan="9" class="empty">No lines</td></tr>'}</tbody></table>
    </div>

    ${po.receipts&&po.receipts.length?`
    <div class="section-title">Receipts</div>
    <div class="table-wrap">
      <table><thead><tr><th>Receipt #</th><th>Date</th><th>Status</th><th>Vendor Ref</th><th></th></tr></thead>
      <tbody>${receipts}</tbody></table>
    </div>`:''}

    ${po.notes?`<div class="section-title">Notes</div><p style="font-size:13px;color:var(--muted)">${po.notes}</p>`:''}
  `;

  const ftBtns = [`<button class="btn btn-ghost" onclick="closeModal('poDetailModal')">Close</button>`];
  ftBtns.push(`<button class="btn btn-ghost" onclick="window.open('/print/purchase-order.html?poId=${po.id}','_blank')" title="Print Purchase Order">ğŸ–¨ï¸ Print PO</button>`);
  if (po.status==='draft') ftBtns.push(`<button class="btn btn-warn" onclick="sendPO('${po.id}');closeModal('poDetailModal')">Send to Vendor</button>`);
  if (['sent','partially_received'].includes(po.status)) ftBtns.push(`<button class="btn btn-success" onclick="openReceiveModal('${po.id}');closeModal('poDetailModal')">Receive</button>`);
  if (!['fully_received','closed','cancelled'].includes(po.status)) ftBtns.push(`<button class="btn btn-danger" onclick="cancelPO('${po.id}')">Cancel</button>`);
  document.getElementById('poDetailFt').innerHTML = ftBtns.join('');
}

async function sendPO(id) {
  if (!confirm('Send this PO to the vendor?')) return;
  const r = await fetch(`${API}/api/purchase-orders/${id}/send`, { method:'POST' });
  const d = await r.json();
  if (!r.ok) return toast(d.error, 'err');
  toast(`${d.number} sent to vendor`);
  loadPOs();
}

async function cancelPO(id) {
  if (!confirm('Cancel this PO?')) return;
  const r = await fetch(`${API}/api/purchase-orders/${id}/cancel`, { method:'POST' });
  const d = await r.json();
  if (!r.ok) return toast(d.error, 'err');
  toast('PO cancelled');
  closeModal('poDetailModal');
  loadPOs();
}

function addPOLine() {
  const tbody = document.getElementById('poLinesBody');
  const idx   = tbody.rows.length;
  const opts  = items.map(i=>`<option value="${i.id}" data-cost="${i.standard_cost}">${i.code} â€” ${i.name}</option>`).join('');
  tbody.insertAdjacentHTML('beforeend',`
    <tr>
      <td><select onchange="autoFillCost(this)" style="width:100%"><option value="">Select itemâ€¦</option>${opts}</select></td>
      <td><input type="number" class="qty-input" min="1" value="1" oninput="recalcPOTotal()"></td>
      <td><input type="number" class="cost-input" step="0.01" min="0" value="0" oninput="recalcPOTotal()"></td>
      <td class="line-total mono">$0.00</td>
      <td><button class="btn btn-ghost btn-sm" onclick="this.closest('tr').remove();recalcPOTotal()">âœ•</button></td>
    </tr>`);
}

function autoFillCost(sel) {
  const opt  = sel.options[sel.selectedIndex];
  const cost = opt.dataset.cost || 0;
  sel.closest('tr').querySelector('.cost-input').value = parseFloat(cost).toFixed(2);
  recalcPOTotal();
}

function recalcPOTotal() {
  let total = 0;
  document.querySelectorAll('#poLinesBody tr').forEach(tr=>{
    const qty  = parseFloat(tr.querySelector('.qty-input')?.value  || 0);
    const cost = parseFloat(tr.querySelector('.cost-input')?.value || 0);
    const lt   = qty * cost;
    tr.querySelector('.line-total').textContent = '$'+fmt(lt);
    total += lt;
  });
  document.getElementById('poTotal').textContent = '$'+fmt(total);
}

async function createPO() {
  const vendor_id    = document.getElementById('poVendor').value;
  const warehouse_id = document.getElementById('poWarehouse').value;
  if (!vendor_id || !warehouse_id) return toast('Vendor and warehouse required','err');

  const lines = [];
  let valid = true;
  document.querySelectorAll('#poLinesBody tr').forEach(tr=>{
    const item_id  = tr.querySelector('select').value;
    const qty      = parseFloat(tr.querySelector('.qty-input').value);
    const cost     = parseFloat(tr.querySelector('.cost-input').value);
    if (!item_id || !qty) { valid=false; return; }
    lines.push({ item_id, qty_ordered: qty, unit_cost: cost });
  });
  if (!valid || !lines.length) return toast('Add at least one valid line','err');

  const r = await fetch(`${API}/api/purchase-orders`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      vendor_id, warehouse_id,
      order_date:    document.getElementById('poOrderDate').value,
      expected_date: document.getElementById('poExpectedDate').value||undefined,
      notes:         document.getElementById('poNotes').value||undefined,
      lines
    })
  });
  const d = await r.json();
  if (!r.ok) return toast(d.error,'err');
  toast(`${d.number} created`);
  closeModal('newPOModal');
  show('pos', document.querySelector('[data-view="pos"]'));
  loadPOs();
}

// â”€â”€ Receiving â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadReceipts() {
  const rows = await fetch(`${API}/api/receipts`).then(r=>r.json()).catch(()=>[]);
  const rcvs = Array.isArray(rows) ? rows : [];
  document.getElementById('rcvBody').innerHTML = rcvs.length===0
    ? `<tr><td colspan="7" class="empty">No receipts yet</td></tr>`
    : rcvs.map(r=>`
      <tr>
        <td class="mono">${r.number}</td>
        <td class="mono">${r.po_number}</td>
        <td>${r.vendor_name}</td>
        <td>${r.receipt_date}</td>
        <td><span class="badge badge-${r.status}">${r.status}</span></td>
        <td>${r.vendor_ref||'â€”'}</td>
        <td>
          ${r.status==='draft'?`<button class="btn btn-success btn-sm" onclick="postReceipt('${r.id}')">Post</button>`:''}
        </td>
      </tr>`).join('');
}

function openReceiveModal(poId) {
  // Reset
  document.getElementById('rcvPO').innerHTML = '<option value="">Select POâ€¦</option>';
  const sentPOs = openPOs.length ? openPOs : [];

  sentPOs.forEach(po=>{
    document.getElementById('rcvPO').insertAdjacentHTML('beforeend',
      `<option value="${po.id}">${po.number} â€” ${po.vendor_name}</option>`);
  });

  if (poId) {
    document.getElementById('rcvPO').value = poId;
    loadPOForReceiving();
  }

  openModal('newRcvModal');
}

async function loadPOForReceiving() {
  const poId = document.getElementById('rcvPO').value;
  if (!poId) { document.getElementById('rcvLinesArea').innerHTML='<div class="empty">Select a PO to load open lines</div>'; return; }

  const po = await fetch(`${API}/api/purchase-orders/${poId}`).then(r=>r.json());
  const openLines = (po.lines||[]).filter(l=>['open','partial'].includes(l.status));

  if (!openLines.length) {
    document.getElementById('rcvLinesArea').innerHTML='<div class="empty">No open lines on this PO</div>';
    return;
  }

  document.getElementById('rcvLinesArea').innerHTML = `
    <table class="lines-tbl">
      <thead><tr>
        <th>Item</th><th>Ordered</th><th>Remaining</th>
        <th style="width:120px">Qty to Receive</th><th style="width:110px">Actual Cost</th>
        <th><input type="checkbox" title="Include" checked onchange="toggleAllRcvLines(this)"></th>
      </tr></thead>
      <tbody>
        ${openLines.map(l=>`
          <tr>
            <td class="mono" data-pol-id="${l.id}" data-item-id="${l.item_id}">${l.item_code} â€” ${l.item_name}</td>
            <td>${l.qty_ordered}</td>
            <td>${l.qty_remaining}</td>
            <td><input type="number" class="rcv-qty" step="0.01" min="0" max="${l.qty_remaining}" value="${l.qty_remaining}"></td>
            <td><input type="number" class="rcv-cost" step="0.01" min="0" value="${parseFloat(l.unit_cost).toFixed(2)}"></td>
            <td><input type="checkbox" class="rcv-include" checked></td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

function toggleAllRcvLines(cb) {
  document.querySelectorAll('.rcv-include').forEach(c=>c.checked=cb.checked);
}

async function createReceipt() {
  const purchase_order_id = document.getElementById('rcvPO').value;
  if (!purchase_order_id) return toast('Select a PO','err');

  const lines = [];
  document.querySelectorAll('#rcvLinesArea tbody tr').forEach(tr=>{
    if (!tr.querySelector('.rcv-include')?.checked) return;
    const polId   = tr.querySelector('td[data-pol-id]').dataset.polId;
    const itemId  = tr.querySelector('td[data-pol-id]').dataset.itemId;
    const qty     = parseFloat(tr.querySelector('.rcv-qty').value);
    const cost    = parseFloat(tr.querySelector('.rcv-cost').value);
    if (qty > 0) lines.push({ purchase_order_line_id: polId, item_id: itemId,
                              qty_received: qty, actual_cost: cost });
  });
  if (!lines.length) return toast('No lines selected','err');

  // Create receipt (draft)
  const r1 = await fetch(`${API}/api/receipts`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      purchase_order_id,
      receipt_date: document.getElementById('rcvDate').value,
      vendor_ref:   document.getElementById('rcvVendorRef').value||undefined,
      notes:        document.getElementById('rcvNotes').value||undefined,
      lines
    })
  });
  const d1 = await r1.json();
  if (!r1.ok) return toast(d1.error,'err');

  // Auto-post
  const r2 = await fetch(`${API}/api/receipts/${d1.id}/post`, { method:'POST' });
  const d2 = await r2.json();
  if (!r2.ok) return toast(d2.error,'err');

  toast(`${d1.number} posted â€” PO updated to ${d2.po_status.replace(/_/g,' ')}`);
  closeModal('newRcvModal');
  loadReceipts();
  loadPOs();
  loadStats();
}

async function postReceipt(id) {
  if (!confirm('Post this receipt? This will update stock and PO.')) return;
  const r = await fetch(`${API}/api/receipts/${id}/post`, { method:'POST' });
  const d = await r.json();
  if (!r.ok) return toast(d.error,'err');
  toast('Receipt posted');
  loadReceipts();
  loadPOs();
}

// â”€â”€ Vendor Invoices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVendorInvoices() {
  const status = document.getElementById('viFilterStatus').value;
  const url    = status ? `${API}/api/vendor-invoices?status=${status}` : `${API}/api/vendor-invoices`;
  const rows   = await fetch(url).then(r=>r.json()).catch(()=>[]);
  const vis    = Array.isArray(rows) ? rows : [];

  document.getElementById('viBody').innerHTML = vis.length===0
    ? `<tr><td colspan="10" class="empty">No vendor invoices found</td></tr>`
    : vis.map(vi=>`
      <tr>
        <td class="mono">${vi.number}</td>
        <td>${vi.vendor_name}</td>
        <td class="mono">${vi.po_number||'â€”'}</td>
        <td>${vi.invoice_date}</td>
        <td>${vi.due_date}</td>
        <td>$${fmt(vi.total)}</td>
        <td>$${fmt(vi.balance_due)}</td>
        <td><span class="badge badge-${vi.status}">${vi.status}</span></td>
        <td><span class="badge badge-${vi.match_status}">${vi.match_status}</span></td>
        <td>
          ${vi.status==='pending'?`<button class="btn btn-ghost btn-sm" onclick="matchInvoice('${vi.id}')">Match</button>`:''}
          ${['pending','disputed'].includes(vi.status)?`<button class="btn btn-success btn-sm" onclick="approveInvoice('${vi.id}')">Approve</button>`:''}
          ${vi.status==='approved'?`<button class="btn btn-primary btn-sm" onclick="payInvoice('${vi.id}','${vi.vendor_id}','${vi.vendor_name}',${vi.balance_due})">Pay</button>`:''}
        </td>
      </tr>`).join('');
}

async function matchInvoice(id) {
  const r = await fetch(`${API}/api/vendor-invoices/${id}/match`, { method:'POST' });
  const d = await r.json();
  if (!r.ok) return toast(d.error,'err');
  toast(`Match result: ${d.match_status} â€” ${d.three_way_match_notes||''}`);
  loadVendorInvoices();
}

async function approveInvoice(id) {
  const r = await fetch(`${API}/api/vendor-invoices/${id}/approve`, { method:'POST' });
  const d = await r.json();
  if (!r.ok) return toast(d.error,'err');
  toast(`${d.number} approved`);
  loadVendorInvoices();
}

function payInvoice(invId, vendorId, vendorName, balance) {
  document.getElementById('pmtVendorId').value   = vendorId;
  document.getElementById('pmtVendorName').value = vendorName;
  document.getElementById('pmtInvoiceId').value  = invId;
  document.getElementById('pmtAmount').value     = parseFloat(balance).toFixed(2);
  document.getElementById('pmtInvoiceArea').innerHTML = `
    <div style="font-size:13px;padding:8px 0;">
      Applying to invoice <strong>${invId.slice(0,8)}â€¦</strong>
      â€” Balance: <strong>$${fmt(balance)}</strong>
    </div>`;
  openModal('paymentModal');
}

async function createVendorInvoice() {
  const vendor_id  = document.getElementById('viVendor').value;
  const subtotal   = document.getElementById('viSubtotal').value;
  if (!vendor_id || !subtotal) return toast('Vendor and subtotal required','err');

  const body = {
    vendor_id,
    purchase_order_id: document.getElementById('viPO').value||undefined,
    receipt_id:        document.getElementById('viReceipt').value||undefined,
    invoice_date:      document.getElementById('viInvDate').value,
    subtotal:          parseFloat(subtotal),
    tax_amount:        parseFloat(document.getElementById('viTax').value)||0,
    vendor_invoice_number: document.getElementById('viVendorNum').value||undefined,
    notes:             document.getElementById('viNotes').value||undefined
  };
  const r = await fetch(`${API}/api/vendor-invoices`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
  });
  const d = await r.json();
  if (!r.ok) return toast(d.error,'err');
  toast(`${d.number} created`);
  closeModal('newVIModal');
  loadVendorInvoices();
  loadStats();
}

// â”€â”€ AP Aging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAPAging() {
  const d = await fetch(`${API}/api/ap-aging`).then(r=>r.json()).catch(()=>({vendors:[],totals:{}}));
  const t = d.totals || {};
  document.getElementById('apCur').textContent  = '$'+fmt(t.current_due);
  document.getElementById('ap30').textContent   = '$'+fmt(t.days_1_30);
  document.getElementById('ap60').textContent   = '$'+fmt(t.days_31_60);
  document.getElementById('ap90').textContent   = '$'+fmt(t.days_61_90);
  document.getElementById('ap90p').textContent  = '$'+fmt(t.days_90plus);

  const rows = Array.isArray(d.vendors) ? d.vendors : [];
  document.getElementById('apBody').innerHTML = rows.length===0
    ? `<tr><td colspan="7" class="empty">No outstanding AP</td></tr>`
    : rows.map(v=>`
      <tr>
        <td><strong>${v.vendor_code}</strong><br><span style="font-size:11px;color:var(--muted)">${v.vendor_name}</span></td>
        <td style="color:var(--accent2)">$${fmt(v.current_due)}</td>
        <td style="color:var(--warn)">$${fmt(v.days_1_30)}</td>
        <td style="color:#e67e22">$${fmt(v.days_31_60)}</td>
        <td style="color:var(--danger)">$${fmt(v.days_61_90)}</td>
        <td style="color:#c0392b">$${fmt(v.days_90plus)}</td>
        <td><strong>$${fmt(v.total_due)}</strong></td>
      </tr>`).join('');
}

// â”€â”€ Vendors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVendors() {
  const rows = await fetch(`${API}/api/vendors`).then(r=>r.json()).catch(()=>[]);
  const vs   = Array.isArray(rows) ? rows : [];
  document.getElementById('vendorBody').innerHTML = vs.length===0
    ? `<tr><td colspan="6" class="empty">No vendors found</td></tr>`
    : vs.map(v=>`
      <tr>
        <td class="mono">${v.code}</td>
        <td>${v.name}</td>
        <td>${v.email||'â€”'}</td>
        <td>${v.phone||'â€”'}</td>
        <td>${v.payment_terms_days} days</td>
        <td>$${fmt(v.ap_balance)}</td>
      </tr>`).join('');
}

// â”€â”€ Reorder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadReorderSuggestions() {
  const rows = await fetch(`${API}/api/reorder-suggestions`).then(r=>r.json()).catch(()=>[]);
  const rs   = Array.isArray(rows) ? rows : [];

  const banner = document.getElementById('reorderBanner');
  const msg    = document.getElementById('reorderMsg');
  if (rs.length > 0) {
    banner.style.display = 'flex';
    msg.textContent = `${rs.length} item(s) below reorder point. Auto-generate POs to restock.`;
  } else {
    banner.style.display = 'none';
  }

  document.getElementById('reorderBody').innerHTML = rs.length===0
    ? `<tr><td colspan="8" class="empty">All items sufficiently stocked âœ“</td></tr>`
    : rs.map(r=>`
      <tr>
        <td class="mono">${r.item_code}</td>
        <td>${r.item_name}</td>
        <td style="color:${parseFloat(r.qty_on_hand)<=0?'var(--danger)':'var(--warn)'}">
          ${r.qty_on_hand}
        </td>
        <td style="color:var(--accent2)">${r.qty_on_order}</td>
        <td>${r.effective_qty}</td>
        <td>${r.reorder_point}</td>
        <td><strong style="color:var(--accent)">${r.suggested_order_qty}</strong></td>
        <td>${r.preferred_vendor_name||'<span style="color:var(--muted)">Not set</span>'}</td>
      </tr>`).join('');
}

async function generatePOs() {
  if (!warehouses.length) return toast('No warehouses found','err');
  if (!confirm(`Auto-generate POs for all items below reorder point?`)) return;
  const r = await fetch(`${API}/api/reorder-suggestions/generate-pos`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ warehouse_id: warehouses[0].id })
  });
  const d = await r.json();
  if (!r.ok) return toast(d.error,'err');
  if (d.pos_created===0) return toast(d.message);
  toast(`${d.pos_created} PO(s) created: ${d.purchase_orders.map(p=>p.po_number).join(', ')}`);
  loadReorderSuggestions();
  loadPOs();
}

// â”€â”€ Payments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitPayment() {
  const vendor_id  = document.getElementById('pmtVendorId').value;
  const amount     = parseFloat(document.getElementById('pmtAmount').value);
  const invoiceId  = document.getElementById('pmtInvoiceId').value;
  if (!vendor_id || !amount) return toast('Vendor and amount required','err');

  const body = {
    vendor_id,
    payment_date:    document.getElementById('pmtDate').value,
    amount,
    method:          document.getElementById('pmtMethod').value,
    reference_number:document.getElementById('pmtRef').value||undefined,
    notes:           document.getElementById('pmtNotes').value||undefined,
    applications: invoiceId ? [{ vendor_invoice_id: invoiceId, amount_applied: amount }] : []
  };

  const r = await fetch(`${API}/api/vendor-payments`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
  });
  const d = await r.json();
  if (!r.ok) return toast(d.error,'err');
  toast('Payment recorded');
  closeModal('paymentModal');
  loadVendorInvoices();
  loadAPAging();
  loadStats();
}

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const viewLoaders = {
  dashboard:    loadDashboard,
  pos:          loadPOs,
  receiving:    loadReceipts,
  vinvoices:    loadVendorInvoices,
  apaging:      loadAPAging,
  vendors:      loadVendors,
  reorder:      loadReorderSuggestions,
  'price-change': () => { pcPopulateItems(); pcLoadHistory(); loadImportStatus(); },
  'import-tool':  () => loadImportStatus()
};
const viewTitles = {
  dashboard:    'Purchasing Dashboard',
  pos:          'Purchase Orders',
  receiving:    'Receiving',
  vinvoices:    'Vendor Invoices',
  apaging:      'AP Aging',
  vendors:      'Vendors',
  reorder:      'Reorder Suggestions',
  'price-change': 'Price Change Tool',
  'import-tool':  'Import Tool'
};
const viewActions = {
  dashboard:    { label:'+ New PO',          action:()=>openPOModal() },
  pos:          { label:'+ New PO',          action:()=>openPOModal() },
  receiving:    { label:'+ Receive',         action:()=>openReceiveModal(null) },
  vinvoices:    { label:'+ Vendor Invoice',  action:()=>openVIModal() },
  apaging:      { label:'AP Aging',          action:null },
  vendors:      { label:'+ New Vendor',      action:null },
  reorder:      { label:'Auto-Generate POs', action:()=>generatePOs() },
  'price-change': { label:'Price Change',    action:null },
  'import-tool':  { label:'Import',          action:null }
};

function show(view, el) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
  document.getElementById('view-'+view).classList.add('active');
  if (el) el.classList.add('active');
  currentView = view;
  document.getElementById('pageTitle').textContent = viewTitles[view]||view;
  const act = viewActions[view];
  const btn = document.getElementById('topActionBtn');
  btn.textContent = act?.label || '';
  btn.style.display = act?.action ? '' : 'none';
  viewLoaders[view]?.();
}

function topAction() { viewActions[currentView]?.action?.(); }

function openPOModal() {
  document.getElementById('poLinesBody').innerHTML='';
  document.getElementById('poNotes').value='';
  document.getElementById('poExpectedDate').value='';
  recalcPOTotal();
  openModal('newPOModal');
}

function openVIModal() {
  // Populate PO and receipt dropdowns
  const viPO = document.getElementById('viPO');
  viPO.innerHTML = '<option value="">No PO</option>';
  openPOs.forEach(po=>viPO.insertAdjacentHTML('beforeend',
    `<option value="${po.id}">${po.number} â€” ${po.vendor_name}</option>`));

  fetch(`${API}/api/receipts`).then(r=>r.json()).then(rcvs=>{
    const viR = document.getElementById('viReceipt');
    viR.innerHTML='<option value="">No Receipt</option>';
    (Array.isArray(rcvs)?rcvs:[]).filter(r=>r.status==='posted').forEach(r=>
      viR.insertAdjacentHTML('beforeend',`<option value="${r.id}">${r.number}</option>`));
  });
  openModal('newVIModal');
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = n => {
  const num = parseFloat(n)||0;
  return num.toLocaleString('en-US', { minimumFractionDigits:2, maximumFractionDigits:2 });
};

function toast(msg, type='ok') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = `show ${type}`;
  clearTimeout(t._t);
  t._t = setTimeout(()=>t.className='', 3500);
}

// Close overlays on backdrop click
document.querySelectorAll('.overlay').forEach(el=>
  el.addEventListener('click', e=>{ if(e.target===el) el.classList.remove('open'); }));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRICE CHANGE TOOL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pcPreviewData = null;

function pcPopulateItems() {
  const sel = document.getElementById('pcItemSel');
  if (sel.options.length > 1) return; // already populated
  (allItems || []).forEach(i => {
    const opt = document.createElement('option');
    opt.value = i.id;
    opt.textContent = `${i.code} â€” ${i.name} (cost: $${fmt(i.standard_cost)})`;
    sel.appendChild(opt);
  });
}

function pcClearPreview() {
  pcPreviewData = null;
  document.getElementById('pcPreviewBox').style.display = 'none';
  document.getElementById('pcPreviewTable').innerHTML = '';
}

async function pcPreview() {
  const itemId  = document.getElementById('pcItemSel').value;
  const newCost = document.getElementById('pcNewCost').value;
  if (!itemId || !newCost) { toast('Select an item and enter new cost', 'err'); return; }
  try {
    const r = await fetch(`${API}/api/pricing/update-cost`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ itemId, newCost: parseFloat(newCost), notes: document.getElementById('pcNotes').value })
    });
    const d = await r.json();
    if (d.error) { toast(d.error, 'err'); return; }
    pcPreviewData = d;

    const rows = [
      ['Item', `${d.item_code} â€” ${d.item_name}`],
      ['Old Cost', `$${fmt(d.old_cost)}`],
      ['New Cost', `$${fmt(d.new_cost)}`],
      ['Old Sale Price', `$${fmt(d.old_sale_price)}`],
      ['Suggested Sale Price', `$${fmt(d.suggested_sale_price)}`],
      ['Margin Maintained', `${d.old_margin_pct || 'â€”'}%`],
      ['Customers to Update', `${d.customers_affected} (price lists will update)`],
      ['VIP Locked (Protected)', `${d.customers_locked} (will NOT change)`],
    ];

    document.getElementById('pcPreviewTable').innerHTML = rows.map(([k,v])=>
      `<tr><td style="padding:5px 8px;color:var(--muted);width:200px">${k}</td>
           <td style="padding:5px 8px;font-weight:600">${v}</td></tr>`
    ).join('');
    document.getElementById('pcPreviewBox').style.display = 'block';
  } catch (e) { toast(e.message, 'err'); }
}

async function pcConfirm() {
  if (!pcPreviewData) return;
  if (!confirm(`Apply cost change for ${pcPreviewData.item_code}? This will update ${pcPreviewData.customers_affected} customer price lists.`)) return;
  try {
    const r = await fetch(`${API}/api/pricing/update-cost/${pcPreviewData.item_id}/confirm`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        newCost: pcPreviewData.new_cost,
        newSalePrice: pcPreviewData.suggested_sale_price,
        notes: document.getElementById('pcNotes').value
      })
    });
    const d = await r.json();
    if (d.error) { toast(d.error, 'err'); return; }
    toast(`Cost updated! ${d.customers_updated} prices updated, ${d.customers_locked} VIP locks protected.`, 'ok');
    pcClearPreview();
    document.getElementById('pcItemSel').value = '';
    document.getElementById('pcNewCost').value = '';
    document.getElementById('pcNotes').value = '';
    // refresh items cache
    fetch(`${API}/api/items`).then(r=>r.json()).then(d=>{ allItems=d; pcPopulateItems(); });
    pcLoadHistory();
  } catch (e) { toast(e.message, 'err'); }
}

async function pcLoadHistory() {
  const tbody = document.getElementById('pcHistoryBody');
  tbody.innerHTML = '<tr><td colspan="8" class="loading">Loadingâ€¦</td></tr>';
  try {
    const rows = await fetch(`${API}/api/pricing/change-log`).then(r=>r.json());
    if (!rows.length) { tbody.innerHTML = '<tr><td colspan="8" class="empty">No changes yet</td></tr>'; return; }
    tbody.innerHTML = rows.map(r=>`
      <tr>
        <td class="mono">${r.item_code}</td>
        <td>$${fmt(r.old_cost)}</td>
        <td>$${fmt(r.new_cost)}</td>
        <td>$${fmt(r.old_sale_price)}</td>
        <td>$${fmt(r.new_sale_price)}</td>
        <td>${r.customers_updated}</td>
        <td>${r.customers_locked}</td>
        <td style="font-size:11px;color:var(--muted)">${r.changed_at ? new Date(r.changed_at).toLocaleDateString() : 'â€”'}</td>
      </tr>`).join('');
  } catch { tbody.innerHTML = '<tr><td colspan="8" class="empty">Error loading history</td></tr>'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORT TOOL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let importPreviewResult = null;

async function loadImportStatus() {
  try {
    const d = await fetch(`${API}/api/migration/status`).then(r=>r.json());
    document.getElementById('isItems').textContent     = d.items?.toLocaleString() || 'â€”';
    document.getElementById('isCustomers').textContent = d.customers?.toLocaleString() || 'â€”';
    document.getElementById('isVendors').textContent   = d.vendors?.toLocaleString() || 'â€”';
  } catch { /* silent */ }
}

function importFileSelected() {
  importPreviewResult = null;
  document.getElementById('importPreviewBox').style.display = 'none';
  document.getElementById('importResultBox').style.display = 'none';
  document.getElementById('importConfirmBtn').disabled = true;
}

async function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function importPreview() {
  const fileInput = document.getElementById('importFile');
  const table     = document.getElementById('importTable').value;
  if (!fileInput.files.length) { toast('Select a file first', 'err'); return; }
  const file = fileInput.files[0];
  try {
    const fileContent = await readFileAsBase64(file);
    const r = await fetch(`${API}/api/migration/preview-csv`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ table, fileContent, fileName: file.name })
    });
    const d = await r.json();
    if (d.error) { toast(d.error, 'err'); return; }
    importPreviewResult = { table, fileContent, fileName: file.name };

    document.getElementById('importPreviewStats').innerHTML =
      `Found <strong>${d.rows_found}</strong> rows &nbsp;Â·&nbsp; ` +
      `<span style="color:var(--success)"><strong>${d.rows_valid}</strong> valid</span> &nbsp;Â·&nbsp; ` +
      `<span style="color:var(--danger)"><strong>${d.rows_with_errors}</strong> with errors</span>`;

    // Build preview table from sample_data
    const samples = d.sample_data || [];
    if (samples.length) {
      const cols = Object.keys(samples[0]);
      document.getElementById('importPreviewHead').innerHTML =
        `<tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr>`;
      document.getElementById('importPreviewBody').innerHTML = samples.map(row=>
        `<tr>${cols.map(c=>`<td style="font-size:11px">${row[c]||''}</td>`).join('')}</tr>`
      ).join('');
    }

    const errHtml = d.errors && d.errors.length
      ? `<strong>Errors:</strong><br>` + d.errors.map(e=>`Row ${e.row}: ${e.error || 'Missing: '+e.missing?.join(', ')}`).join('<br>')
      : '';
    document.getElementById('importPreviewErrors').innerHTML = errHtml;
    document.getElementById('importPreviewBox').style.display = 'block';
    document.getElementById('importConfirmBtn').disabled = d.rows_valid === 0;
  } catch (e) { toast(e.message, 'err'); }
}

async function importConfirm() {
  if (!importPreviewResult) return;
  const { table, fileContent, fileName } = importPreviewResult;
  if (!confirm(`Import ${table} from ${fileName}? Existing records will be updated.`)) return;
  document.getElementById('importConfirmBtn').disabled = true;
  try {
    const r = await fetch(`${API}/api/migration/import-csv`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ table, fileContent, fileName, skipErrors: true })
    });
    const d = await r.json();
    if (d.error) { toast(d.error, 'err'); return; }

    const box = document.getElementById('importResultBox');
    box.style.display = 'block';
    box.style.background = d.skipped > 0 ? 'var(--surface)' : '#dcfce7';
    box.style.borderLeft = `4px solid ${d.skipped > 0 ? 'orange' : '#16a34a'}`;
    box.innerHTML = `
      <strong>Import Complete</strong><br>
      âœ… Imported: ${d.imported} &nbsp; âš ï¸ Skipped: ${d.skipped}
      ${d.errors && d.errors.length ? `<details style="margin-top:8px"><summary>View errors</summary>
        <div style="font-size:11px;margin-top:6px">${d.errors.map(e=>`Row ${e.row}: ${e.error}`).join('<br>')}</div>
      </details>` : ''}
    `;
    toast(`Imported ${d.imported} records.`, 'ok');
    loadImportStatus();
    // refresh caches
    if (table === 'items') fetch(`${API}/api/items`).then(r=>r.json()).then(d=>{ allItems=d; });
  } catch (e) {
    toast(e.message, 'err');
    document.getElementById('importConfirmBtn').disabled = false;
  }
}

init();
</script>
</body>
</html>
