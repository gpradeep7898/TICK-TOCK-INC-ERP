<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TICK TOCK INC. | Purchasing</title>
<style>
/* â”€â”€ Reset & Root â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --navy:    #1e2a3a;
  --navy2:   #243347;
  --navy3:   #162130;
  --sidebar-w: 240px;
  --header-h:  60px;
  --blue:    #2563eb;
  --blue-h:  #1d4ed8;
  --blue-l:  #3b82f6;
  --blue-bg: rgba(37,99,235,.08);
  --green:   #10b981;
  --yellow:  #f59e0b;
  --red:     #ef4444;
  --orange:  #f97316;
  --bg:      #f0f4f8;
  --bg2:     #e8eef5;
  --card:    #ffffff;
  --border:  #dde5ef;
  --border2: #c8d5e5;
  --text0:   #0f1923;
  --text1:   #374151;
  --text2:   #64748b;
  --text3:   #94a3b8;
  --radius:  10px;
  --radius-sm: 6px;
  --shadow:  0 1px 3px rgba(15,25,40,.08),0 4px 16px rgba(15,25,40,.06);
  --shadow-lg: 0 4px 24px rgba(15,25,40,.12),0 1px 4px rgba(15,25,40,.08);
}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text0);font-size:13px;line-height:1.5}
button{cursor:pointer;font-family:inherit;font-size:13px}
input,select,textarea{font-family:inherit;font-size:13px}

/* â”€â”€ Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:flex;height:100vh;overflow:hidden}

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar{
  width:var(--sidebar-w);min-width:var(--sidebar-w);
  background:var(--navy);display:flex;flex-direction:column;
  overflow:hidden;z-index:100;
}
.sidebar-logo{
  padding:18px 20px 16px;border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;align-items:center;gap:12px;flex-shrink:0;
}
.sidebar-logo-icon{
  width:36px;height:36px;border-radius:9px;
  background:linear-gradient(135deg,var(--blue),var(--blue-l));
  display:flex;align-items:center;justify-content:center;
  font-size:18px;flex-shrink:0;box-shadow:0 4px 12px rgba(37,99,235,.4);
}
.sidebar-logo-text .co{font-size:13px;font-weight:800;color:#fff;letter-spacing:.03em}
.sidebar-logo-text .sub{font-size:9.5px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.1em}

.sidebar-nav{padding:12px 10px;flex:1;overflow-y:auto}
.nav-section{margin-bottom:4px}
.nav-label{
  font-size:9.5px;font-weight:700;color:rgba(255,255,255,.3);
  text-transform:uppercase;letter-spacing:.12em;
  padding:10px 10px 4px;
}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:8px 10px;border-radius:var(--radius-sm);
  color:rgba(255,255,255,.55);font-size:13px;font-weight:500;
  cursor:pointer;transition:all .12s;margin-bottom:1px;
  border:none;background:none;width:100%;text-align:left;
  text-decoration:none;
}
.nav-item:hover{background:rgba(255,255,255,.07);color:rgba(255,255,255,.85)}
.nav-item.active{background:rgba(37,99,235,.25);color:#fff}
.nav-item .ni{font-size:15px;width:18px;text-align:center;flex-shrink:0}

.sidebar-footer{
  padding:12px 16px;border-top:1px solid rgba(255,255,255,.08);
  font-size:11px;color:rgba(255,255,255,.3);
}

/* â”€â”€ Main Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#header{
  height:var(--header-h);min-height:var(--header-h);
  background:var(--card);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 24px;gap:16px;
  z-index:50;flex-shrink:0;
}
.header-page-title{font-size:16px;font-weight:700;color:var(--text0);flex:1}
.header-actions{display:flex;align-items:center;gap:10px}

.user-chip{
  display:flex;align-items:center;gap:9px;padding:5px 12px 5px 5px;
  background:var(--bg);border:1.5px solid var(--border);border-radius:30px;
  cursor:default;
}
.user-avatar{
  width:28px;height:28px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;color:#fff;flex-shrink:0;
}
.user-info{line-height:1.3}
.user-name{font-size:12px;font-weight:600;color:var(--text0)}
.user-role{font-size:10px;color:var(--text2)}
.role-badge{
  font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;
  padding:2px 7px;border-radius:4px;
}
.role-admin    {background:rgba(245,158,11,.12);color:#b45309}
.role-warehouse{background:rgba(16,185,129,.12);color:#047857}
.role-sales    {background:rgba(37,99,235,.12);color:#1d4ed8}

.signout-btn{
  padding:7px 14px;border-radius:var(--radius-sm);
  background:none;color:var(--text2);font-size:12px;font-weight:500;
  border:1.5px solid var(--border);transition:all .12s;
}
.signout-btn:hover{background:var(--red);color:#fff;border-color:var(--red)}

/* â”€â”€ Content Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#content{flex:1;overflow-y:auto;padding:24px}

/* â”€â”€ Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page{display:none}
.page.active{display:block}

/* â”€â”€ KPI Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.kpi-card{
  background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  padding:20px;box-shadow:var(--shadow);
}
.kpi-label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px}
.kpi-value{font-size:26px;font-weight:800;color:var(--text0);line-height:1}
.kpi-value.blue{color:var(--blue)}
.kpi-value.green{color:var(--green)}
.kpi-value.yellow{color:var(--yellow)}
.kpi-value.red{color:var(--red)}
.kpi-sub{font-size:11px;color:var(--text3);margin-top:4px}

/* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:16px}
.card-header{padding:16px 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
.card-title{font-size:14px;font-weight:700;color:var(--text0);flex:1}

/* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.filter-select{
  padding:8px 12px;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--card);color:var(--text1);outline:none;
}
.filter-select:focus{border-color:var(--blue)}

/* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border);background:var(--card)}
table{width:100%;border-collapse:collapse}
th{
  background:var(--bg);padding:10px 14px;text-align:left;
  font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:var(--text2);
  font-weight:700;border-bottom:1px solid var(--border);white-space:nowrap;
}
td{padding:11px 14px;border-bottom:1px solid var(--border);color:var(--text1);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(37,99,235,.02)}
.mono{font-family:'Courier New',monospace;font-size:12px;color:var(--text0)}

/* â”€â”€ Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;letter-spacing:.02em}
.badge-draft     {background:rgba(100,116,139,.12);color:#475569}
.badge-sent      {background:rgba(245,158,11,.12);color:#b45309}
.badge-partial,
.badge-partially_received{background:rgba(37,99,235,.1);color:#1d4ed8}
.badge-received,
.badge-fully_received,
.badge-posted    {background:rgba(16,185,129,.1);color:#047857}
.badge-approved  {background:rgba(16,185,129,.1);color:#047857}
.badge-disputed  {background:rgba(239,68,68,.1);color:#dc2626}
.badge-paid      {background:rgba(16,185,129,.1);color:#047857}
.badge-pending   {background:rgba(245,158,11,.12);color:#b45309}
.badge-cancelled {background:rgba(239,68,68,.08);color:#dc2626}
.badge-matched   {background:rgba(16,185,129,.1);color:#047857}
.badge-open      {background:rgba(37,99,235,.1);color:#1d4ed8}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{padding:8px 16px;border-radius:var(--radius-sm);border:none;font-weight:600;font-size:13px;transition:all .12s;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--blue);color:#fff;box-shadow:0 2px 8px rgba(37,99,235,.25)}
.btn-primary:hover{background:var(--blue-h)}
.btn-success{background:var(--green);color:#fff}
.btn-success:hover{background:#059669}
.btn-warn{background:var(--yellow);color:#fff}
.btn-warn:hover{background:#d97706}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{background:#dc2626}
.btn-ghost{background:none;color:var(--text2);border:1.5px solid var(--border)}
.btn-ghost:hover{border-color:var(--border2);color:var(--text0);background:var(--bg)}
.btn-sm{padding:4px 10px;font-size:12px}

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{display:none;position:fixed;inset:0;background:rgba(15,25,40,.55);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.overlay.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);width:720px;max-width:96vw;max-height:90vh;display:flex;flex-direction:column;box-shadow:var(--shadow-lg)}
.modal-lg{width:900px}
.modal-hd{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.modal-hd h3{flex:1;font-size:15px;font-weight:700;color:var(--text0)}
.modal-body{padding:20px;overflow-y:auto;flex:1}
.modal-ft{padding:14px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;background:var(--bg)}

/* â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.form-full{grid-column:1 / -1}
.field{display:flex;flex-direction:column;gap:5px}
.field label{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.06em}
.field input,.field select,.field textarea{
  padding:9px 12px;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--card);color:var(--text0);outline:none;transition:border-color .12s,box-shadow .12s;
}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.field textarea{resize:vertical;min-height:60px}

/* â”€â”€ Section Title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-title{
  font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;
  color:var(--text2);border-bottom:1px solid var(--border);padding-bottom:8px;margin:16px 0 12px;
}

/* â”€â”€ Lines Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lines-tbl{width:100%;border-collapse:collapse}
.lines-tbl th{background:var(--bg);padding:8px 10px;font-size:11px;text-transform:uppercase;color:var(--text2);text-align:left;border-bottom:1px solid var(--border)}
.lines-tbl td{padding:6px 6px;border-bottom:1px solid var(--border)}
.lines-tbl tr:last-child td{border-bottom:none}
.lines-tbl input,.lines-tbl select{
  background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius-sm);
  color:var(--text0);padding:6px 8px;font-size:12px;width:100%;outline:none;
}
.lines-tbl input:focus,.lines-tbl select:focus{border-color:var(--blue)}

/* â”€â”€ Detail panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.detail-row{display:flex;gap:8px;margin-bottom:6px;font-size:13px}
.detail-row .lbl{color:var(--text2);min-width:120px;font-weight:500}

/* â”€â”€ AP Aging Buckets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.aging-buckets{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:24px}
.ab{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center;box-shadow:var(--shadow)}
.ab label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;display:block;margin-bottom:6px}
.ab .val{font-size:20px;font-weight:800}
.ab.current .val{color:var(--green)}
.ab.d30 .val{color:var(--yellow)}
.ab.d60 .val{color:var(--orange)}
.ab.d90 .val{color:var(--red)}
.ab.d90p .val{color:#b91c1c}

/* â”€â”€ Alert Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert-banner{
  background:rgba(239,68,68,.05);border:1px solid rgba(239,68,68,.2);
  border-radius:var(--radius);padding:12px 16px;margin-bottom:16px;
  display:flex;align-items:center;gap:12px;
}
.alert-banner p{flex:1;font-size:13px;color:var(--text1)}

/* â”€â”€ Loading / empty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading{text-align:center;padding:32px;color:var(--text3);font-size:13px}
.empty{text-align:center;padding:32px;color:var(--text3);font-size:13px;font-style:italic}

/* â”€â”€ Stock hint chip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stock-chip{
  display:inline-flex;align-items:center;gap:4px;
  padding:2px 7px;border-radius:4px;font-size:11px;font-weight:600;
}
.stock-ok  {background:rgba(16,185,129,.1);color:#047857}
.stock-low {background:rgba(245,158,11,.12);color:#b45309}
.stock-zero{background:rgba(239,68,68,.1);color:#dc2626}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toastContainer{
  position:fixed;bottom:24px;right:24px;z-index:9999;
  display:flex;flex-direction:column;gap:8px;pointer-events:none;
}
.toast-item{
  background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:12px 16px;font-size:13px;max-width:360px;
  box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px;
  animation:slideIn .2s ease;pointer-events:auto;
}
@keyframes slideIn{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}
.toast-item.success{border-left:3px solid var(--green)}
.toast-item.error  {border-left:3px solid var(--red)}
.toast-item.warning{border-left:3px solid var(--yellow)}
.toast-item.info   {border-left:3px solid var(--blue)}
.toast-icon{font-size:15px;flex-shrink:0}

/* â”€â”€ Dashboard mini cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mini-list{padding:4px 0}
.mini-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);font-size:13px}
.mini-row:last-child{border-bottom:none}
.mini-row .primary{font-weight:600;color:var(--text0)}
.mini-row .secondary{font-size:11px;color:var(--text2);margin-top:2px}
.mini-big{font-size:28px;font-weight:800;margin-bottom:4px}

/* â”€â”€ Price change preview table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pc-preview-tbl td{padding:7px 10px;border-bottom:1px solid var(--border);font-size:13px}
.pc-preview-tbl td:first-child{color:var(--text2);width:200px;font-weight:500}
.pc-preview-tbl td:last-child{font-weight:700}

/* â”€â”€ Import result box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.import-result{padding:14px 16px;border-radius:var(--radius-sm);border:1px solid var(--border)}
</style>
</head>
<body>

<div id="app">

<!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav id="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon">â±</div>
    <div class="sidebar-logo-text">
      <div class="co">TICK TOCK INC.</div>
      <div class="sub">Purchasing</div>
    </div>
  </div>

  <div class="sidebar-nav">
    <div class="nav-section">
      <div class="nav-label">Purchasing</div>
      <button class="nav-item active" data-view="dashboard" onclick="show('dashboard',this)">
        <span class="ni">ğŸ“Š</span> Dashboard
      </button>
      <button class="nav-item" data-view="pos" onclick="show('pos',this)">
        <span class="ni">ğŸ“‹</span> Purchase Orders
      </button>
      <button class="nav-item" data-view="receiving" onclick="show('receiving',this)">
        <span class="ni">ğŸšš</span> Receiving
      </button>
      <button class="nav-item" data-view="vinvoices" onclick="show('vinvoices',this)">
        <span class="ni">ğŸ“„</span> Vendor Invoices
      </button>
      <button class="nav-item" data-view="apaging" onclick="show('apaging',this)">
        <span class="ni">â³</span> AP Aging
      </button>
      <button class="nav-item" data-view="vendors" onclick="show('vendors',this)">
        <span class="ni">ğŸ­</span> Vendors
      </button>
      <button class="nav-item" data-view="reorder" onclick="show('reorder',this)">
        <span class="ni">ğŸ””</span> Reorder
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-label">Tools</div>
      <button class="nav-item" data-view="price-change" onclick="show('price-change',this)">
        <span class="ni">ğŸ’²</span> Price Change
      </button>
      <button class="nav-item" data-view="import-tool" onclick="show('import-tool',this)">
        <span class="ni">ğŸ“‚</span> Import Tool
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-label">Other Modules</div>
      <a class="nav-item" href="/">
        <span class="ni">ğŸ“¦</span> Inventory
      </a>
      <a class="nav-item" href="/sales">
        <span class="ni">ğŸ’°</span> Sales
      </a>
      <a class="nav-item" href="/financials">
        <span class="ni">ğŸ“ˆ</span> Financials
      </a>
    </div>
  </div>

  <div class="sidebar-footer">TICK TOCK INC. ERP &nbsp;Â·&nbsp; v1.0.0</div>
</nav>

<!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main id="main">

  <!-- Header -->
  <div id="header">
    <span class="header-page-title" id="pageTitle">Purchasing Dashboard</span>
    <div class="header-actions">
      <button class="btn btn-primary" id="topActionBtn" onclick="topAction()">+ New PO</button>
      <div class="user-chip">
        <div class="user-avatar" id="userAvatar" style="background:var(--blue)">?</div>
        <div class="user-info">
          <div class="user-name" id="userName">â€”</div>
          <div class="user-role" id="userRoleLine">â€”</div>
        </div>
        <span class="role-badge" id="userRoleBadge"></span>
      </div>
      <button class="signout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- Content -->
  <div id="content">

    <!-- â”€â”€ Dashboard â”€â”€ -->
    <div class="page active" id="page-dashboard">
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">Open POs</div>
          <div class="kpi-value blue" id="statOpenPOs">â€”</div>
          <div class="kpi-sub">Sent / awaiting delivery</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Received This Month</div>
          <div class="kpi-value green" id="statRecPOs">â€”</div>
          <div class="kpi-sub">Fully received POs</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">AP Balance</div>
          <div class="kpi-value yellow" id="statAP">â€”</div>
          <div class="kpi-sub">Total outstanding payable</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Pending Invoices</div>
          <div class="kpi-value red" id="statPendInv">â€”</div>
          <div class="kpi-sub">Awaiting approval</div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
        <div class="card">
          <div class="card-header"><span class="card-title">Recent Purchase Orders</span></div>
          <div style="padding:0 20px" id="dashRecentPOs"><div class="loading">Loadingâ€¦</div></div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">AP Summary</span></div>
          <div style="padding:16px 20px" id="dashAPSummary"><div class="loading">Loadingâ€¦</div></div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Reorder Alerts</span></div>
          <div style="padding:16px 20px" id="dashReorder"><div class="loading">Loadingâ€¦</div></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Purchase Orders â”€â”€ -->
    <div class="page" id="page-pos">
      <div class="toolbar">
        <select class="filter-select" id="poFilterStatus" onchange="loadPOs()">
          <option value="">All Statuses</option>
          <option value="draft">Draft</option>
          <option value="sent">Sent</option>
          <option value="partially_received">Partially Received</option>
          <option value="fully_received">Fully Received</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>PO #</th><th>Vendor</th><th>Status</th>
            <th>Order Date</th><th>Expected</th><th>Lines</th>
            <th>PO Total</th><th>Actions</th>
          </tr></thead>
          <tbody id="poBody"><tr><td colspan="8" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Receiving â”€â”€ -->
    <div class="page" id="page-receiving">
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Receipt #</th><th>PO #</th><th>Vendor</th><th>Date</th>
            <th>Status</th><th>Vendor Ref</th><th>Actions</th>
          </tr></thead>
          <tbody id="rcvBody"><tr><td colspan="7" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Vendor Invoices â”€â”€ -->
    <div class="page" id="page-vinvoices">
      <div class="toolbar">
        <select class="filter-select" id="viFilterStatus" onchange="loadVendorInvoices()">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="disputed">Disputed</option>
          <option value="paid">Paid</option>
        </select>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Invoice #</th><th>Vendor</th><th>PO #</th><th>Date</th>
            <th>Due</th><th>Total</th><th>Balance</th><th>Status</th><th>Match</th><th>Actions</th>
          </tr></thead>
          <tbody id="viBody"><tr><td colspan="10" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ AP Aging â”€â”€ -->
    <div class="page" id="page-apaging">
      <div class="aging-buckets">
        <div class="ab current"><label>Current</label><div class="val" id="apCur">â€”</div></div>
        <div class="ab d30">   <label>1â€“30 Days</label><div class="val" id="ap30">â€”</div></div>
        <div class="ab d60">   <label>31â€“60 Days</label><div class="val" id="ap60">â€”</div></div>
        <div class="ab d90">   <label>61â€“90 Days</label><div class="val" id="ap90">â€”</div></div>
        <div class="ab d90p">  <label>90+ Days</label><div class="val" id="ap90p">â€”</div></div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Vendor</th><th>Current</th><th>1â€“30</th><th>31â€“60</th><th>61â€“90</th><th>90+</th><th>Total Due</th>
          </tr></thead>
          <tbody id="apBody"><tr><td colspan="7" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Vendors â”€â”€ -->
    <div class="page" id="page-vendors">
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Code</th><th>Name</th><th>Email</th><th>Phone</th>
            <th>Terms</th><th>AP Balance</th>
          </tr></thead>
          <tbody id="vendorBody"><tr><td colspan="6" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Reorder â”€â”€ -->
    <div class="page" id="page-reorder">
      <div class="alert-banner" id="reorderBanner" style="display:none">
        <p id="reorderMsg"></p>
        <button class="btn btn-danger btn-sm" onclick="generatePOs()">Auto-Generate POs</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Item Code</th><th>Name</th><th>On Hand</th><th>On Order</th>
            <th>Effective</th><th>Reorder Pt.</th><th>Suggest Qty</th><th>Preferred Vendor</th>
          </tr></thead>
          <tbody id="reorderBody"><tr><td colspan="8" class="loading">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ Price Change â”€â”€ -->
    <div class="page" id="page-price-change">
      <div style="max-width:600px">
        <div class="card">
          <div class="card-header"><span class="card-title">Cost Update Tool</span></div>
          <div style="padding:20px">
            <p style="font-size:12px;color:var(--text2);margin-bottom:16px">
              Update an item's cost when a vendor charges a new price. The system maintains margin % and updates all customer price lists (VIP locked prices are protected).
            </p>
            <div class="form-grid">
              <div class="field form-full">
                <label>Item *</label>
                <select id="pcItemSel" onchange="pcClearPreview()">
                  <option value="">Select itemâ€¦</option>
                </select>
              </div>
              <div class="field">
                <label>New Cost ($) *</label>
                <input type="number" id="pcNewCost" step="0.01" min="0" placeholder="0.00" oninput="pcClearPreview()">
              </div>
              <div class="field">
                <label>Notes</label>
                <input type="text" id="pcNotes" placeholder="Reason for cost change">
              </div>
            </div>
            <div style="margin-top:12px">
              <button class="btn btn-warn" onclick="pcPreview()">Preview Change</button>
            </div>

            <div id="pcPreviewBox" style="display:none;margin-top:16px;border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden">
              <div style="padding:10px 14px;background:var(--bg);border-bottom:1px solid var(--border);font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text2)">Preview</div>
              <table class="pc-preview-tbl" style="width:100%;border-collapse:collapse" id="pcPreviewTable"></table>
              <div style="padding:12px 14px;display:flex;gap:8px;background:var(--bg);border-top:1px solid var(--border)">
                <button class="btn btn-success" onclick="pcConfirm()">âœ“ Apply Change</button>
                <button class="btn btn-ghost" onclick="pcClearPreview()">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Recent Changes</span>
            <button class="btn btn-ghost btn-sm" onclick="pcLoadHistory()">Refresh</button>
          </div>
          <div class="table-wrap" style="border:none;border-radius:0">
            <table>
              <thead><tr><th>Item</th><th>Old Cost</th><th>New Cost</th><th>Old Price</th><th>New Price</th><th>Updated</th><th>Locked</th><th>Date</th></tr></thead>
              <tbody id="pcHistoryBody"><tr><td colspan="8" class="loading">Click Refresh to load</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Import Tool â”€â”€ -->
    <div class="page" id="page-import-tool">
      <div style="max-width:760px">
        <div class="card">
          <div class="card-header"><span class="card-title">CSV / Excel Import</span></div>
          <div style="padding:20px">
            <p style="font-size:12px;color:var(--text2);margin-bottom:16px">
              Import items, customers, or vendors from a CSV or Excel file. Existing records are updated by code; new records are inserted.
            </p>
            <div class="form-grid">
              <div class="field">
                <label>Import Type</label>
                <select id="importTable">
                  <option value="items">Items (inventory)</option>
                  <option value="customers">Customers</option>
                  <option value="vendors">Vendors</option>
                </select>
              </div>
              <div class="field">
                <label>File (.csv, .xls, .xlsx)</label>
                <input type="file" id="importFile" accept=".csv,.xls,.xlsx" onchange="importFileSelected()">
              </div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn btn-warn" onclick="importPreview()">Preview</button>
              <button class="btn btn-success" onclick="importConfirm()" id="importConfirmBtn" disabled>Import</button>
            </div>

            <div style="margin-top:14px;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);display:flex;gap:24px;font-size:13px" id="importStatusBar">
              <span>Items: <strong id="isItems">â€”</strong></span>
              <span>Customers: <strong id="isCustomers">â€”</strong></span>
              <span>Vendors: <strong id="isVendors">â€”</strong></span>
              <button class="btn btn-ghost btn-sm" onclick="loadImportStatus()">Refresh Counts</button>
            </div>

            <div id="importPreviewBox" style="display:none;margin-top:14px">
              <div style="font-size:12px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text2);margin-bottom:8px">Preview</div>
              <div id="importPreviewStats" style="font-size:13px;margin-bottom:8px"></div>
              <div class="table-wrap" style="max-height:260px;overflow-y:auto">
                <table><thead id="importPreviewHead"></thead><tbody id="importPreviewBody"></tbody></table>
              </div>
              <div id="importPreviewErrors" style="margin-top:8px;font-size:12px;color:var(--red)"></div>
            </div>

            <div id="importResultBox" style="display:none;margin-top:14px" class="import-result"></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</main>
</div><!-- /app -->

<!-- â”€â”€ New PO Modal â”€â”€ -->
<div class="overlay" id="newPOModal">
  <div class="modal modal-lg">
    <div class="modal-hd">
      <h3>New Purchase Order</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('newPOModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field">
          <label>Vendor *</label>
          <select id="poVendor"><option value="">Select vendorâ€¦</option></select>
        </div>
        <div class="field">
          <label>Warehouse *</label>
          <select id="poWarehouse"><option value="">Select warehouseâ€¦</option></select>
        </div>
        <div class="field">
          <label>Order Date</label>
          <input type="date" id="poOrderDate">
        </div>
        <div class="field">
          <label>Expected Date</label>
          <input type="date" id="poExpectedDate">
        </div>
        <div class="field form-full">
          <label>Notes</label>
          <textarea id="poNotes" rows="2"></textarea>
        </div>
      </div>

      <div class="section-title">Lines</div>
      <table class="lines-tbl">
        <thead><tr>
          <th>Item</th><th style="width:90px">Qty</th>
          <th style="width:110px">Unit Cost</th><th style="width:110px">Line Total</th>
          <th style="width:40px"></th>
        </tr></thead>
        <tbody id="poLinesBody"></tbody>
      </table>
      <button class="btn btn-ghost btn-sm" style="margin-top:10px" onclick="addPOLine()">+ Add Line</button>
      <div style="margin-top:12px;text-align:right">
        <strong style="color:var(--text0)">PO Total: <span id="poTotal" style="color:var(--blue)">$0.00</span></strong>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-ghost" onclick="closeModal('newPOModal')">Cancel</button>
      <button class="btn btn-primary" onclick="createPO()">Create PO</button>
    </div>
  </div>
</div>

<!-- â”€â”€ PO Detail Modal â”€â”€ -->
<div class="overlay" id="poDetailModal">
  <div class="modal modal-lg">
    <div class="modal-hd">
      <h3 id="poDetailTitle">PO Detail</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('poDetailModal')">âœ•</button>
    </div>
    <div class="modal-body" id="poDetailBody"><div class="loading">Loadingâ€¦</div></div>
    <div class="modal-ft" id="poDetailFt">
      <button class="btn btn-ghost" onclick="closeModal('poDetailModal')">Close</button>
    </div>
  </div>
</div>

<!-- â”€â”€ New Receipt Modal â”€â”€ -->
<div class="overlay" id="newRcvModal">
  <div class="modal modal-lg">
    <div class="modal-hd">
      <h3>Receive Against PO</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('newRcvModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field">
          <label>Purchase Order *</label>
          <select id="rcvPO" onchange="loadPOForReceiving()">
            <option value="">Select POâ€¦</option>
          </select>
        </div>
        <div class="field">
          <label>Receipt Date</label>
          <input type="date" id="rcvDate">
        </div>
        <div class="field">
          <label>Vendor Reference</label>
          <input type="text" id="rcvVendorRef" placeholder="Vendor packing slip #">
        </div>
        <div class="field">
          <label>Notes</label>
          <input type="text" id="rcvNotes">
        </div>
      </div>
      <div class="section-title">Lines to Receive</div>
      <div id="rcvLinesArea"><div class="empty">Select a PO to load open lines</div></div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-ghost" onclick="closeModal('newRcvModal')">Cancel</button>
      <button class="btn btn-success" onclick="createReceipt()">Create Receipt</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Vendor Invoice Modal â”€â”€ -->
<div class="overlay" id="newVIModal">
  <div class="modal">
    <div class="modal-hd">
      <h3>Enter Vendor Invoice</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('newVIModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field">
          <label>Vendor *</label>
          <select id="viVendor"><option value="">Select vendorâ€¦</option></select>
        </div>
        <div class="field">
          <label>Link to PO (optional)</label>
          <select id="viPO"><option value="">No PO</option></select>
        </div>
        <div class="field">
          <label>Link to Receipt (optional)</label>
          <select id="viReceipt"><option value="">No Receipt</option></select>
        </div>
        <div class="field">
          <label>Vendor Invoice Number</label>
          <input type="text" id="viVendorNum" placeholder="Vendor's invoice #">
        </div>
        <div class="field">
          <label>Invoice Date</label>
          <input type="date" id="viInvDate">
        </div>
        <div class="field">
          <label>Subtotal *</label>
          <input type="number" id="viSubtotal" step="0.01" min="0">
        </div>
        <div class="field">
          <label>Tax Amount</label>
          <input type="number" id="viTax" step="0.01" min="0" value="0">
        </div>
        <div class="field">
          <label>Notes</label>
          <input type="text" id="viNotes">
        </div>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn btn-ghost" onclick="closeModal('newVIModal')">Cancel</button>
      <button class="btn btn-primary" onclick="createVendorInvoice()">Save Invoice</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Payment Modal â”€â”€ -->
<div class="overlay" id="paymentModal">
  <div class="modal">
    <div class="modal-hd">
      <h3>Record AP Payment</h3>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('paymentModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="field">
          <label>Vendor</label>
          <input type="text" id="pmtVendorName" readonly style="color:var(--text2)">
          <input type="hidden" id="pmtVendorId">
        </div>
        <div class="field">
          <label>Payment Date</label>
          <input type="date" id="pmtDate">
        </div>
        <div class="field">
          <label>Amount *</label>
          <input type="number" id="pmtAmount" step="0.01" min="0">
        </div>
        <div class="field">
          <label>Method</label>
          <select id="pmtMethod">
            <option value="check">Check</option>
            <option value="wire">Wire</option>
            <option value="ach">ACH</option>
            <option value="cash">Cash</option>
          </select>
        </div>
        <div class="field">
          <label>Reference #</label>
          <input type="text" id="pmtRef">
        </div>
        <div class="field">
          <label>Notes</label>
          <input type="text" id="pmtNotes">
        </div>
      </div>
      <div class="section-title">Apply to Invoice</div>
      <div id="pmtInvoiceArea"><div class="empty">Select vendor first</div></div>
      <input type="hidden" id="pmtInvoiceId">
    </div>
    <div class="modal-ft">
      <button class="btn btn-ghost" onclick="closeModal('paymentModal')">Cancel</button>
      <button class="btn btn-success" onclick="submitPayment()">Record Payment</button>
    </div>
  </div>
</div>

<div id="toastContainer"></div>

<script>
const API = '';
let vendors = [], warehouses = [], items = [], openPOs = [];
let currentView = 'dashboard';
let pcPreviewData = null;
let importPreviewResult = null;

// â”€â”€ Auth Guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function authGuard() {
  const token = localStorage.getItem('tt_token');
  if (!token) { window.location.href = '/login.html'; return; }
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    if (payload.exp * 1000 < Date.now()) {
      localStorage.removeItem('tt_token');
      localStorage.removeItem('tt_user');
      window.location.href = '/login.html';
      return;
    }
    // Render user chip
    const name   = payload.name || payload.email;
    const role   = payload.role || 'user';
    const initials = name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    const colors = { admin:'#b45309', warehouse:'#047857', sales:'#1d4ed8' };
    document.getElementById('userAvatar').textContent      = initials;
    document.getElementById('userAvatar').style.background = colors[role] || '#2563eb';
    document.getElementById('userName').textContent        = name;
    document.getElementById('userRoleLine').textContent    = role.charAt(0).toUpperCase()+role.slice(1);
    const badge = document.getElementById('userRoleBadge');
    badge.textContent = role;
    badge.className   = `role-badge role-${role}`;
  } catch {
    window.location.href = '/login.html';
  }
})();

function signOut() {
  localStorage.removeItem('tt_token');
  localStorage.removeItem('tt_user');
  window.location.href = '/login.html';
}

// â”€â”€ apiFetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(url, opts = {}) {
  const token = localStorage.getItem('tt_token');
  const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(url, { ...opts, headers });
  if (res.status === 401) {
    localStorage.removeItem('tt_token');
    window.location.href = '/login.html';
    return res;
  }
  return res;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const [v, w, i] = await Promise.all([
    apiFetch(`${API}/api/vendors`).then(r=>r.json()).catch(()=>[]),
    apiFetch(`${API}/api/warehouses`).then(r=>r.json()).catch(()=>[]),
    apiFetch(`${API}/api/items`).then(r=>r.json()).catch(()=>[])
  ]);
  vendors    = Array.isArray(v) ? v : (v?.data || []);
  warehouses = Array.isArray(w) ? w : (w?.data || []);
  items      = Array.isArray(i) ? i : (i?.data || []);

  ['poVendor','viVendor'].forEach(id => {
    const s = document.getElementById(id);
    if (!s) return;
    vendors.forEach(v => s.insertAdjacentHTML('beforeend',
      `<option value="${v.id}">${v.code} â€” ${v.name}</option>`));
  });
  const pw = document.getElementById('poWarehouse');
  warehouses.forEach(w => pw.insertAdjacentHTML('beforeend',
    `<option value="${w.id}">${w.code} â€” ${w.name}</option>`));

  const today = new Date().toISOString().slice(0,10);
  document.getElementById('poOrderDate').value = today;
  document.getElementById('rcvDate').value     = today;
  document.getElementById('viInvDate').value   = today;
  document.getElementById('pmtDate').value     = today;

  loadDashboard();
  loadStats();
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  try {
    const [posR, apR, viR, recR] = await Promise.all([
      apiFetch(`${API}/api/purchase-orders?status=sent`).then(r=>r.json()),
      apiFetch(`${API}/api/ap-aging`).then(r=>r.json()),
      apiFetch(`${API}/api/vendor-invoices?status=pending`).then(r=>r.json()),
      apiFetch(`${API}/api/purchase-orders?status=fully_received`).then(r=>r.json())
    ]);
    const pos = Array.isArray(posR) ? posR : (posR?.data || []);
    document.getElementById('statOpenPOs').textContent = pos.length;
    const rec = Array.isArray(recR) ? recR : (recR?.data || []);
    document.getElementById('statRecPOs').textContent = rec.length;
    if (apR && apR.totals) {
      document.getElementById('statAP').textContent = '$'+fmt(apR.totals.total_due);
    }
    const vi = Array.isArray(viR) ? viR : (viR?.data || []);
    document.getElementById('statPendInv').textContent = vi.length;
  } catch(e){}
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  try {
    const [posR, apR, reorderR] = await Promise.all([
      apiFetch(`${API}/api/purchase-orders`).then(r=>r.json()),
      apiFetch(`${API}/api/ap-aging`).then(r=>r.json()),
      apiFetch(`${API}/api/reorder-suggestions`).then(r=>r.json())
    ]);

    const pos = (Array.isArray(posR) ? posR : (posR?.data || [])).slice(0,5);
    document.getElementById('dashRecentPOs').innerHTML = pos.length === 0
      ? '<div class="empty">No purchase orders yet</div>'
      : '<div class="mini-list">'+pos.map(po=>`
        <div class="mini-row">
          <div>
            <div class="primary mono">${po.number}</div>
            <div class="secondary">${po.vendor_name}</div>
          </div>
          <div style="text-align:right">
            <span class="badge badge-${po.status}">${po.status.replace(/_/g,' ')}</span>
            <div class="secondary" style="margin-top:3px">$${fmt(po.po_total)}</div>
          </div>
        </div>`).join('')+'</div>';

    if (apR && apR.totals) {
      const t = apR.totals;
      document.getElementById('dashAPSummary').innerHTML = `
        <div class="mini-big" style="color:var(--yellow)">$${fmt(t.total_due)}</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:12px">Total AP Outstanding</div>
        <div style="font-size:13px">
          ${[['Current',t.current_due,'var(--green)'],['1â€“30 days',t.days_1_30,'var(--yellow)'],
             ['31â€“60 days',t.days_31_60,'var(--orange)'],['61â€“90 days',t.days_61_90,'var(--red)'],
             ['90+ days',t.days_90plus,'#b91c1c)']].map(([lbl,val,col])=>`
          <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border)">
            <span style="color:${col}">${lbl}</span><span>$${fmt(val)}</span>
          </div>`).join('')}
        </div>`;
    }

    const reorder = Array.isArray(reorderR) ? reorderR : (reorderR?.data || []);
    document.getElementById('dashReorder').innerHTML = reorder.length === 0
      ? '<div style="text-align:center;padding:16px;color:var(--text3)">All items sufficiently stocked âœ“</div>'
      : `<div class="mini-big" style="color:var(--red)">${reorder.length}</div>
         <div style="font-size:12px;color:var(--text2);margin-bottom:10px">Items below reorder point</div>
         <div class="mini-list">`+
         reorder.slice(0,4).map(r=>`
           <div class="mini-row">
             <span class="mono">${r.item_code}</span>
             <span style="color:var(--red);font-weight:600">On hand: ${r.qty_on_hand ?? r.qty_available ?? 0}</span>
           </div>`).join('')+`</div>`;
  } catch(e){ console.error(e); }
}

// â”€â”€ Purchase Orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPOs() {
  const status = document.getElementById('poFilterStatus').value;
  const url    = status ? `${API}/api/purchase-orders?status=${status}` : `${API}/api/purchase-orders`;
  const rows   = await apiFetch(url).then(r=>r.json()).catch(()=>[]);
  const pos    = Array.isArray(rows) ? rows : (rows?.data || []);
  openPOs      = pos.filter(p=>['sent','partially_received'].includes(p.status));

  document.getElementById('poBody').innerHTML = pos.length === 0
    ? `<tr><td colspan="8" class="empty">No purchase orders found</td></tr>`
    : pos.map(po=>`
      <tr>
        <td class="mono">${po.number}</td>
        <td>${po.vendor_name}</td>
        <td><span class="badge badge-${po.status}">${po.status.replace(/_/g,' ')}</span></td>
        <td>${po.order_date}</td>
        <td>${po.expected_date||'â€”'}</td>
        <td>${po.line_count}</td>
        <td style="font-weight:600">$${fmt(po.po_total)}</td>
        <td>
          <button class="btn btn-ghost btn-sm" onclick="viewPO('${po.id}')">View</button>
          ${po.status==='draft'?`<button class="btn btn-warn btn-sm" onclick="sendPO('${po.id}')">Send</button>`:''}
          ${['sent','partially_received'].includes(po.status)?`<button class="btn btn-success btn-sm" onclick="openReceiveModal('${po.id}')">Receive</button>`:''}
        </td>
      </tr>`).join('');
}

async function viewPO(id) {
  document.getElementById('poDetailBody').innerHTML = '<div class="loading">Loadingâ€¦</div>';
  document.getElementById('poDetailFt').innerHTML   = '<button class="btn btn-ghost" onclick="closeModal(\'poDetailModal\')">Close</button>';
  openModal('poDetailModal');

  const po = await apiFetch(`${API}/api/purchase-orders/${id}`).then(r=>r.json());
  document.getElementById('poDetailTitle').textContent = `PO: ${po.number}`;

  const lines = (po.lines||[]).map(l=>`
    <tr>
      <td>${l.line_number}</td>
      <td class="mono">${l.item_code}</td>
      <td>${l.item_name}</td>
      <td>${l.qty_ordered}</td>
      <td>${l.qty_received}</td>
      <td>${l.qty_remaining}</td>
      <td>$${fmt(l.unit_cost)}</td>
      <td style="font-weight:600">$${fmt(l.line_total)}</td>
      <td><span class="badge badge-${l.status}">${l.status}</span></td>
    </tr>`).join('');

  const receipts = (po.receipts||[]).map(r=>`
    <tr>
      <td class="mono">${r.number}</td>
      <td>${r.receipt_date}</td>
      <td><span class="badge badge-${r.status}">${r.status}</span></td>
      <td>${r.vendor_ref||'â€”'}</td>
      <td>${r.status==='draft'?`<button class="btn btn-success btn-sm" onclick="postReceipt('${r.id}')">Post</button>`:'â€”'}</td>
    </tr>`).join('');

  document.getElementById('poDetailBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">
      <div>
        <div class="detail-row"><span class="lbl">Vendor</span>${po.vendor_name} (${po.vendor_code})</div>
        <div class="detail-row"><span class="lbl">Warehouse</span>${po.warehouse_code}</div>
        <div class="detail-row"><span class="lbl">Order Date</span>${po.order_date}</div>
      </div>
      <div>
        <div class="detail-row"><span class="lbl">Expected</span>${po.expected_date||'â€”'}</div>
        <div class="detail-row"><span class="lbl">Status</span><span class="badge badge-${po.status}">${po.status}</span></div>
        <div class="detail-row"><span class="lbl">PO Total</span><strong>$${fmt(po.po_total)}</strong></div>
      </div>
    </div>

    <div class="section-title">Order Lines</div>
    <div class="table-wrap">
      <table><thead><tr><th>#</th><th>Code</th><th>Item</th><th>Ordered</th>
        <th>Received</th><th>Remaining</th><th>Unit Cost</th><th>Total</th><th>Status</th>
      </tr></thead><tbody>${lines||'<tr><td colspan="9" class="empty">No lines</td></tr>'}</tbody></table>
    </div>

    ${po.receipts&&po.receipts.length?`
    <div class="section-title">Receipts</div>
    <div class="table-wrap">
      <table><thead><tr><th>Receipt #</th><th>Date</th><th>Status</th><th>Vendor Ref</th><th></th></tr></thead>
      <tbody>${receipts}</tbody></table>
    </div>`:''}

    ${po.notes?`<div class="section-title">Notes</div><p style="font-size:13px;color:var(--text2)">${po.notes}</p>`:''}
  `;

  const ftBtns = [`<button class="btn btn-ghost" onclick="closeModal('poDetailModal')">Close</button>`];
  ftBtns.push(`<button class="btn btn-ghost" onclick="window.open('/print/purchase-order.html?poId=${po.id}','_blank')">ğŸ–¨ï¸ Print PO</button>`);
  if (po.status==='draft') ftBtns.push(`<button class="btn btn-warn" onclick="sendPO('${po.id}');closeModal('poDetailModal')">Send to Vendor</button>`);
  if (['sent','partially_received'].includes(po.status)) ftBtns.push(`<button class="btn btn-success" onclick="openReceiveModal('${po.id}');closeModal('poDetailModal')">Receive</button>`);
  if (!['fully_received','closed','cancelled'].includes(po.status)) ftBtns.push(`<button class="btn btn-danger" onclick="cancelPO('${po.id}')">Cancel</button>`);
  document.getElementById('poDetailFt').innerHTML = ftBtns.join('');
}

async function sendPO(id) {
  if (!confirm('Send this PO to the vendor?')) return;
  const r = await apiFetch(`${API}/api/purchase-orders/${id}/send`, { method:'POST' });
  const d = await r.json();
  if (!r.ok) return toast('error','Error',d.error);
  toast('success','Sent',`${d.number} sent to vendor`);
  loadPOs();
}

async function cancelPO(id) {
  if (!confirm('Cancel this PO?')) return;
  const r = await apiFetch(`${API}/api/purchase-orders/${id}/cancel`, { method:'POST' });
  const d = await r.json();
  if (!r.ok) return toast('error','Error',d.error);
  toast('warning','Cancelled','PO cancelled');
  closeModal('poDetailModal');
  loadPOs();
}

function addPOLine() {
  const tbody = document.getElementById('poLinesBody');
  const opts  = items.map(i=>`<option value="${i.id}" data-cost="${i.standard_cost}">${i.code} â€” ${i.name}</option>`).join('');
  tbody.insertAdjacentHTML('beforeend',`
    <tr>
      <td><select onchange="autoFillCost(this)" style="width:100%"><option value="">Select itemâ€¦</option>${opts}</select></td>
      <td><input type="number" class="qty-input" min="1" value="1" oninput="recalcPOTotal()"></td>
      <td><input type="number" class="cost-input" step="0.01" min="0" value="0" oninput="recalcPOTotal()"></td>
      <td class="line-total mono">$0.00</td>
      <td><button class="btn btn-ghost btn-sm" onclick="this.closest('tr').remove();recalcPOTotal()">âœ•</button></td>
    </tr>`);
}

function autoFillCost(sel) {
  const opt  = sel.options[sel.selectedIndex];
  const cost = opt.dataset.cost || 0;
  sel.closest('tr').querySelector('.cost-input').value = parseFloat(cost).toFixed(2);
  recalcPOTotal();
}

function recalcPOTotal() {
  let total = 0;
  document.querySelectorAll('#poLinesBody tr').forEach(tr=>{
    const qty  = parseFloat(tr.querySelector('.qty-input')?.value  || 0);
    const cost = parseFloat(tr.querySelector('.cost-input')?.value || 0);
    const lt   = qty * cost;
    tr.querySelector('.line-total').textContent = '$'+fmt(lt);
    total += lt;
  });
  document.getElementById('poTotal').textContent = '$'+fmt(total);
}

async function createPO() {
  const vendor_id    = document.getElementById('poVendor').value;
  const warehouse_id = document.getElementById('poWarehouse').value;
  if (!vendor_id || !warehouse_id) return toast('error','Required','Vendor and warehouse required');

  const lines = [];
  let valid = true;
  document.querySelectorAll('#poLinesBody tr').forEach(tr=>{
    const item_id  = tr.querySelector('select').value;
    const qty      = parseFloat(tr.querySelector('.qty-input').value);
    const cost     = parseFloat(tr.querySelector('.cost-input').value);
    if (!item_id || !qty) { valid=false; return; }
    lines.push({ item_id, qty_ordered: qty, unit_cost: cost });
  });
  if (!valid || !lines.length) return toast('error','Required','Add at least one valid line');

  const r = await apiFetch(`${API}/api/purchase-orders`, {
    method:'POST',
    body: JSON.stringify({
      vendor_id, warehouse_id,
      order_date:    document.getElementById('poOrderDate').value,
      expected_date: document.getElementById('poExpectedDate').value||undefined,
      notes:         document.getElementById('poNotes').value||undefined,
      lines
    })
  });
  const d = await r.json();
  if (!r.ok) return toast('error','Error',d.error);
  toast('success','Created',`${d.number} created`);
  closeModal('newPOModal');
  show('pos', document.querySelector('[data-view="pos"]'));
  loadPOs();
}

// â”€â”€ Receiving â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadReceipts() {
  const rows = await apiFetch(`${API}/api/receipts`).then(r=>r.json()).catch(()=>[]);
  const rcvs = Array.isArray(rows) ? rows : (rows?.data || []);
  document.getElementById('rcvBody').innerHTML = rcvs.length===0
    ? `<tr><td colspan="7" class="empty">No receipts yet</td></tr>`
    : rcvs.map(r=>`
      <tr>
        <td class="mono">${r.number}</td>
        <td class="mono">${r.po_number}</td>
        <td>${r.vendor_name}</td>
        <td>${r.receipt_date}</td>
        <td><span class="badge badge-${r.status}">${r.status}</span></td>
        <td>${r.vendor_ref||'â€”'}</td>
        <td>${r.status==='draft'?`<button class="btn btn-success btn-sm" onclick="postReceipt('${r.id}')">Post</button>`:'â€”'}</td>
      </tr>`).join('');
}

function openReceiveModal(poId) {
  document.getElementById('rcvPO').innerHTML = '<option value="">Select POâ€¦</option>';
  openPOs.forEach(po=>{
    document.getElementById('rcvPO').insertAdjacentHTML('beforeend',
      `<option value="${po.id}">${po.number} â€” ${po.vendor_name}</option>`);
  });
  if (poId) {
    document.getElementById('rcvPO').value = poId;
    loadPOForReceiving();
  }
  openModal('newRcvModal');
}

async function loadPOForReceiving() {
  const poId = document.getElementById('rcvPO').value;
  if (!poId) {
    document.getElementById('rcvLinesArea').innerHTML = '<div class="empty">Select a PO to load open lines</div>';
    return;
  }

  document.getElementById('rcvLinesArea').innerHTML = '<div class="loading">Loading linesâ€¦</div>';

  const [po, stockAll] = await Promise.all([
    apiFetch(`${API}/api/purchase-orders/${poId}`).then(r=>r.json()),
    apiFetch(`${API}/api/stock`).then(r=>r.json()).catch(()=>[])
  ]);

  const openLines = (po.lines||[]).filter(l=>['open','partial'].includes(l.status));
  if (!openLines.length) {
    document.getElementById('rcvLinesArea').innerHTML = '<div class="empty">No open lines on this PO</div>';
    return;
  }

  // Build stock map for the PO's warehouse
  const stockArr = Array.isArray(stockAll) ? stockAll : [];
  const stockMap = {};
  stockArr.forEach(s => {
    if (s.warehouse_id === po.warehouse_id) {
      stockMap[s.item_id] = s.qty_available || 0;
    }
  });

  document.getElementById('rcvLinesArea').innerHTML = `
    <table class="lines-tbl">
      <thead><tr>
        <th>Item</th><th>Ordered</th><th>Remaining</th><th>In Stock</th>
        <th style="width:120px">Qty to Receive</th><th style="width:110px">Actual Cost</th>
        <th><input type="checkbox" title="Include all" checked onchange="toggleAllRcvLines(this)"></th>
      </tr></thead>
      <tbody>
        ${openLines.map(l=>{
          const stock = stockMap[l.item_id] ?? null;
          let stockHtml = '<span style="color:var(--text3)">â€”</span>';
          if (stock !== null) {
            const cls = stock <= 0 ? 'stock-zero' : stock < 10 ? 'stock-low' : 'stock-ok';
            stockHtml = `<span class="stock-chip ${cls}">${stock}</span>`;
          }
          return `<tr>
            <td class="mono" data-pol-id="${l.id}" data-item-id="${l.item_id}">${l.item_code} â€” ${l.item_name}</td>
            <td>${l.qty_ordered}</td>
            <td>${l.qty_remaining}</td>
            <td>${stockHtml}</td>
            <td><input type="number" class="rcv-qty" step="0.01" min="0" max="${l.qty_remaining}" value="${l.qty_remaining}"></td>
            <td><input type="number" class="rcv-cost" step="0.01" min="0" value="${parseFloat(l.unit_cost).toFixed(2)}"></td>
            <td><input type="checkbox" class="rcv-include" checked></td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`;
}

function toggleAllRcvLines(cb) {
  document.querySelectorAll('.rcv-include').forEach(c=>c.checked=cb.checked);
}

async function createReceipt() {
  const purchase_order_id = document.getElementById('rcvPO').value;
  if (!purchase_order_id) return toast('error','Required','Select a PO');

  const lines = [];
  document.querySelectorAll('#rcvLinesArea tbody tr').forEach(tr=>{
    if (!tr.querySelector('.rcv-include')?.checked) return;
    const polId  = tr.querySelector('td[data-pol-id]').dataset.polId;
    const itemId = tr.querySelector('td[data-pol-id]').dataset.itemId;
    const qty    = parseFloat(tr.querySelector('.rcv-qty').value);
    const cost   = parseFloat(tr.querySelector('.rcv-cost').value);
    if (qty > 0) lines.push({ purchase_order_line_id: polId, item_id: itemId,
                              qty_received: qty, actual_cost: cost });
  });
  if (!lines.length) return toast('error','Error','No lines selected');

  const r1 = await apiFetch(`${API}/api/receipts`, {
    method:'POST',
    body: JSON.stringify({
      purchase_order_id,
      receipt_date: document.getElementById('rcvDate').value,
      vendor_ref:   document.getElementById('rcvVendorRef').value||undefined,
      notes:        document.getElementById('rcvNotes').value||undefined,
      lines
    })
  });
  const d1 = await r1.json();
  if (!r1.ok) return toast('error','Error',d1.error);

  const r2 = await apiFetch(`${API}/api/receipts/${d1.id}/post`, { method:'POST' });
  const d2 = await r2.json();
  if (!r2.ok) return toast('error','Error',d2.error);

  toast('success','Posted',`${d1.number} posted â€” PO updated to ${d2.po_status?.replace(/_/g,' ')}`);
  closeModal('newRcvModal');
  loadReceipts();
  loadPOs();
  loadStats();
}

async function postReceipt(id) {
  if (!confirm('Post this receipt? This will update stock and PO.')) return;
  const r = await apiFetch(`${API}/api/receipts/${id}/post`, { method:'POST' });
  const d = await r.json();
  if (!r.ok) return toast('error','Error',d.error);
  toast('success','Posted','Receipt posted â€” inventory updated');
  loadReceipts();
  loadPOs();
}

// â”€â”€ Vendor Invoices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVendorInvoices() {
  const status = document.getElementById('viFilterStatus').value;
  const url    = status ? `${API}/api/vendor-invoices?status=${status}` : `${API}/api/vendor-invoices`;
  const rows   = await apiFetch(url).then(r=>r.json()).catch(()=>[]);
  const vis    = Array.isArray(rows) ? rows : (rows?.data || []);

  document.getElementById('viBody').innerHTML = vis.length===0
    ? `<tr><td colspan="10" class="empty">No vendor invoices found</td></tr>`
    : vis.map(vi=>`
      <tr>
        <td class="mono">${vi.number}</td>
        <td>${vi.vendor_name}</td>
        <td class="mono">${vi.po_number||'â€”'}</td>
        <td>${vi.invoice_date}</td>
        <td>${vi.due_date}</td>
        <td>$${fmt(vi.total)}</td>
        <td style="font-weight:600">$${fmt(vi.balance_due)}</td>
        <td><span class="badge badge-${vi.status}">${vi.status}</span></td>
        <td><span class="badge badge-${vi.match_status}">${vi.match_status}</span></td>
        <td>
          ${vi.status==='pending'?`<button class="btn btn-ghost btn-sm" onclick="matchInvoice('${vi.id}')">Match</button>`:''}
          ${['pending','disputed'].includes(vi.status)?`<button class="btn btn-success btn-sm" onclick="approveInvoice('${vi.id}')">Approve</button>`:''}
          ${vi.status==='approved'?`<button class="btn btn-primary btn-sm" onclick="payInvoice('${vi.id}','${vi.vendor_id}','${vi.vendor_name}',${vi.balance_due})">Pay</button>`:''}
        </td>
      </tr>`).join('');
}

async function matchInvoice(id) {
  const r = await apiFetch(`${API}/api/vendor-invoices/${id}/match`, { method:'POST' });
  const d = await r.json();
  if (!r.ok) return toast('error','Error',d.error);
  toast('info','Match Result',`${d.match_status} â€” ${d.three_way_match_notes||''}`);
  loadVendorInvoices();
}

async function approveInvoice(id) {
  const r = await apiFetch(`${API}/api/vendor-invoices/${id}/approve`, { method:'POST' });
  const d = await r.json();
  if (!r.ok) return toast('error','Error',d.error);
  toast('success','Approved',`${d.number} approved`);
  loadVendorInvoices();
}

function payInvoice(invId, vendorId, vendorName, balance) {
  document.getElementById('pmtVendorId').value   = vendorId;
  document.getElementById('pmtVendorName').value = vendorName;
  document.getElementById('pmtInvoiceId').value  = invId;
  document.getElementById('pmtAmount').value     = parseFloat(balance).toFixed(2);
  document.getElementById('pmtInvoiceArea').innerHTML = `
    <div style="font-size:13px;padding:8px 0;">
      Applying to invoice <strong>${invId.slice(0,8)}â€¦</strong>
      â€” Balance: <strong>$${fmt(balance)}</strong>
    </div>`;
  openModal('paymentModal');
}

async function createVendorInvoice() {
  const vendor_id = document.getElementById('viVendor').value;
  const subtotal  = document.getElementById('viSubtotal').value;
  if (!vendor_id || !subtotal) return toast('error','Required','Vendor and subtotal required');

  const body = {
    vendor_id,
    purchase_order_id:     document.getElementById('viPO').value||undefined,
    receipt_id:            document.getElementById('viReceipt').value||undefined,
    invoice_date:          document.getElementById('viInvDate').value,
    subtotal:              parseFloat(subtotal),
    tax_amount:            parseFloat(document.getElementById('viTax').value)||0,
    vendor_invoice_number: document.getElementById('viVendorNum').value||undefined,
    notes:                 document.getElementById('viNotes').value||undefined
  };
  const r = await apiFetch(`${API}/api/vendor-invoices`, { method:'POST', body: JSON.stringify(body) });
  const d = await r.json();
  if (!r.ok) return toast('error','Error',d.error);
  toast('success','Created',`${d.number} created`);
  closeModal('newVIModal');
  loadVendorInvoices();
  loadStats();
}

// â”€â”€ AP Aging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAPAging() {
  const d = await apiFetch(`${API}/api/ap-aging`).then(r=>r.json()).catch(()=>({vendors:[],totals:{}}));
  const t = d.totals || {};
  document.getElementById('apCur').textContent  = '$'+fmt(t.current_due);
  document.getElementById('ap30').textContent   = '$'+fmt(t.days_1_30);
  document.getElementById('ap60').textContent   = '$'+fmt(t.days_31_60);
  document.getElementById('ap90').textContent   = '$'+fmt(t.days_61_90);
  document.getElementById('ap90p').textContent  = '$'+fmt(t.days_90plus);

  const rows = Array.isArray(d.vendors) ? d.vendors : [];
  document.getElementById('apBody').innerHTML = rows.length===0
    ? `<tr><td colspan="7" class="empty">No outstanding AP</td></tr>`
    : rows.map(v=>`
      <tr>
        <td><strong>${v.vendor_code}</strong><br><span style="font-size:11px;color:var(--text2)">${v.vendor_name}</span></td>
        <td style="color:var(--green)">$${fmt(v.current_due)}</td>
        <td style="color:var(--yellow)">$${fmt(v.days_1_30)}</td>
        <td style="color:var(--orange)">$${fmt(v.days_31_60)}</td>
        <td style="color:var(--red)">$${fmt(v.days_61_90)}</td>
        <td style="color:#b91c1c">$${fmt(v.days_90plus)}</td>
        <td><strong>$${fmt(v.total_due)}</strong></td>
      </tr>`).join('');
}

// â”€â”€ Vendors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVendors() {
  const rows = await apiFetch(`${API}/api/vendors`).then(r=>r.json()).catch(()=>[]);
  const vs   = Array.isArray(rows) ? rows : (rows?.data || []);
  document.getElementById('vendorBody').innerHTML = vs.length===0
    ? `<tr><td colspan="6" class="empty">No vendors found</td></tr>`
    : vs.map(v=>`
      <tr>
        <td class="mono">${v.code}</td>
        <td><strong>${v.name}</strong></td>
        <td>${v.email||'â€”'}</td>
        <td>${v.phone||'â€”'}</td>
        <td>${v.payment_terms_days} days</td>
        <td style="font-weight:600;color:var(--yellow)">$${fmt(v.ap_balance)}</td>
      </tr>`).join('');
}

// â”€â”€ Reorder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadReorderSuggestions() {
  const rows = await apiFetch(`${API}/api/reorder-suggestions`).then(r=>r.json()).catch(()=>[]);
  const rs   = Array.isArray(rows) ? rows : (rows?.data || []);

  const banner = document.getElementById('reorderBanner');
  if (rs.length > 0) {
    banner.style.display = 'flex';
    document.getElementById('reorderMsg').textContent = `${rs.length} item(s) below reorder point. Auto-generate POs to restock.`;
  } else {
    banner.style.display = 'none';
  }

  document.getElementById('reorderBody').innerHTML = rs.length===0
    ? `<tr><td colspan="8" class="empty">All items sufficiently stocked âœ“</td></tr>`
    : rs.map(r=>`
      <tr>
        <td class="mono">${r.item_code}</td>
        <td>${r.item_name}</td>
        <td style="color:${parseFloat(r.qty_on_hand)<=0?'var(--red)':'var(--yellow)'}">
          <strong>${r.qty_on_hand}</strong>
        </td>
        <td style="color:var(--blue)">${r.qty_on_order}</td>
        <td>${r.effective_qty}</td>
        <td>${r.reorder_point}</td>
        <td><strong style="color:var(--blue)">${r.suggested_order_qty}</strong></td>
        <td>${r.preferred_vendor_name||'<span style="color:var(--text3)">Not set</span>'}</td>
      </tr>`).join('');
}

async function generatePOs() {
  if (!warehouses.length) return toast('error','Error','No warehouses found');
  if (!confirm(`Auto-generate POs for all items below reorder point?`)) return;
  const r = await apiFetch(`${API}/api/reorder-suggestions/generate-pos`, {
    method:'POST',
    body: JSON.stringify({ warehouse_id: warehouses[0].id })
  });
  const d = await r.json();
  if (!r.ok) return toast('error','Error',d.error);
  if (d.pos_created===0) return toast('info','Info',d.message);
  toast('success','Generated',`${d.pos_created} PO(s) created: ${d.purchase_orders.map(p=>p.po_number).join(', ')}`);
  loadReorderSuggestions();
  loadPOs();
}

// â”€â”€ Payments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitPayment() {
  const vendor_id = document.getElementById('pmtVendorId').value;
  const amount    = parseFloat(document.getElementById('pmtAmount').value);
  const invoiceId = document.getElementById('pmtInvoiceId').value;
  if (!vendor_id || !amount) return toast('error','Required','Vendor and amount required');

  const body = {
    vendor_id,
    payment_date:     document.getElementById('pmtDate').value,
    amount,
    method:           document.getElementById('pmtMethod').value,
    reference_number: document.getElementById('pmtRef').value||undefined,
    notes:            document.getElementById('pmtNotes').value||undefined,
    applications: invoiceId ? [{ vendor_invoice_id: invoiceId, amount_applied: amount }] : []
  };

  const r = await apiFetch(`${API}/api/vendor-payments`, { method:'POST', body: JSON.stringify(body) });
  const d = await r.json();
  if (!r.ok) return toast('error','Error',d.error);
  toast('success','Recorded','Payment recorded');
  closeModal('paymentModal');
  loadVendorInvoices();
  loadAPAging();
  loadStats();
}

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const viewLoaders = {
  dashboard:      loadDashboard,
  pos:            loadPOs,
  receiving:      loadReceipts,
  vinvoices:      loadVendorInvoices,
  apaging:        loadAPAging,
  vendors:        loadVendors,
  reorder:        loadReorderSuggestions,
  'price-change': () => { pcPopulateItems(); pcLoadHistory(); },
  'import-tool':  () => loadImportStatus()
};
const viewTitles = {
  dashboard:      'Purchasing Dashboard',
  pos:            'Purchase Orders',
  receiving:      'Receiving',
  vinvoices:      'Vendor Invoices',
  apaging:        'AP Aging',
  vendors:        'Vendors',
  reorder:        'Reorder Suggestions',
  'price-change': 'Price Change Tool',
  'import-tool':  'Import Tool'
};
const viewActions = {
  dashboard:      { label:'+ New PO',         action:()=>openPOModal() },
  pos:            { label:'+ New PO',         action:()=>openPOModal() },
  receiving:      { label:'+ Receive',        action:()=>openReceiveModal(null) },
  vinvoices:      { label:'+ Vendor Invoice', action:()=>openVIModal() },
  apaging:        null,
  vendors:        null,
  reorder:        { label:'Auto-Generate POs',action:()=>generatePOs() },
  'price-change': null,
  'import-tool':  null
};

function show(view, el) {
  document.querySelectorAll('.page').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(a=>a.classList.remove('active'));
  document.getElementById('page-'+view).classList.add('active');
  if (el) el.classList.add('active');
  currentView = view;
  document.getElementById('pageTitle').textContent = viewTitles[view]||view;
  const act = viewActions[view];
  const btn = document.getElementById('topActionBtn');
  if (act && act.action) {
    btn.textContent  = act.label;
    btn.style.display = '';
  } else {
    btn.style.display = 'none';
  }
  viewLoaders[view]?.();
}

function topAction() { viewActions[currentView]?.action?.(); }

function openPOModal() {
  document.getElementById('poLinesBody').innerHTML = '';
  document.getElementById('poNotes').value        = '';
  document.getElementById('poExpectedDate').value = '';
  recalcPOTotal();
  openModal('newPOModal');
}

function openVIModal() {
  const viPO = document.getElementById('viPO');
  viPO.innerHTML = '<option value="">No PO</option>';
  openPOs.forEach(po=>viPO.insertAdjacentHTML('beforeend',
    `<option value="${po.id}">${po.number} â€” ${po.vendor_name}</option>`));

  apiFetch(`${API}/api/receipts`).then(r=>r.json()).then(rcvs=>{
    const viR = document.getElementById('viReceipt');
    viR.innerHTML = '<option value="">No Receipt</option>';
    (Array.isArray(rcvs)?rcvs:[]).filter(r=>r.status==='posted').forEach(r=>
      viR.insertAdjacentHTML('beforeend',`<option value="${r.id}">${r.number}</option>`));
  });
  openModal('newVIModal');
}

function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// Close overlays on backdrop click
document.querySelectorAll('.overlay').forEach(el=>
  el.addEventListener('click', e=>{ if(e.target===el) el.classList.remove('open'); }));

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = n => {
  const num = parseFloat(n)||0;
  return num.toLocaleString('en-US', { minimumFractionDigits:2, maximumFractionDigits:2 });
};

function toast(type, title, message) {
  const icons = { success:'âœ“', error:'âœ•', warning:'âš ', info:'â„¹' };
  const container = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = `toast-item ${type}`;
  el.innerHTML = `<span class="toast-icon">${icons[type]||'â€¢'}</span>
    <div><div style="font-weight:700;font-size:12px">${title}</div>
    ${message?`<div style="color:var(--text2);font-size:12px;margin-top:2px">${message}</div>`:''}</div>`;
  container.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .3s'; setTimeout(()=>el.remove(),320); }, 3500);
}

// â”€â”€ Price Change Tool â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pcPopulateItems() {
  const sel = document.getElementById('pcItemSel');
  if (sel.options.length > 1) return;
  items.forEach(i => {
    const opt = document.createElement('option');
    opt.value = i.id;
    opt.textContent = `${i.code} â€” ${i.name} (cost: $${fmt(i.standard_cost)})`;
    sel.appendChild(opt);
  });
}

function pcClearPreview() {
  pcPreviewData = null;
  document.getElementById('pcPreviewBox').style.display = 'none';
  document.getElementById('pcPreviewTable').innerHTML = '';
}

async function pcPreview() {
  const itemId  = document.getElementById('pcItemSel').value;
  const newCost = document.getElementById('pcNewCost').value;
  if (!itemId || !newCost) { toast('error','Required','Select an item and enter new cost'); return; }
  try {
    const r = await apiFetch(`${API}/api/pricing/update-cost`, {
      method: 'POST',
      body: JSON.stringify({ itemId, newCost: parseFloat(newCost), notes: document.getElementById('pcNotes').value })
    });
    const d = await r.json();
    if (d.error) { toast('error','Error',d.error); return; }
    pcPreviewData = d;

    const rows = [
      ['Item', `${d.item_code} â€” ${d.item_name}`],
      ['Old Cost', `$${fmt(d.old_cost)}`],
      ['New Cost', `$${fmt(d.new_cost)}`],
      ['Old Sale Price', `$${fmt(d.old_sale_price)}`],
      ['Suggested Sale Price', `$${fmt(d.suggested_sale_price)}`],
      ['Margin Maintained', `${d.old_margin_pct || 'â€”'}%`],
      ['Customers to Update', `${d.customers_affected}`],
      ['VIP Locked (Protected)', `${d.customers_locked}`],
    ];

    document.getElementById('pcPreviewTable').innerHTML = rows.map(([k,v])=>
      `<tr><td style="padding:7px 14px;color:var(--text2);width:200px">${k}</td>
           <td style="padding:7px 14px;font-weight:600">${v}</td></tr>`
    ).join('');
    document.getElementById('pcPreviewBox').style.display = 'block';
  } catch (e) { toast('error','Error',e.message); }
}

async function pcConfirm() {
  if (!pcPreviewData) return;
  if (!confirm(`Apply cost change for ${pcPreviewData.item_code}? This will update ${pcPreviewData.customers_affected} customer price lists.`)) return;
  try {
    const r = await apiFetch(`${API}/api/pricing/update-cost/${pcPreviewData.item_id}/confirm`, {
      method: 'POST',
      body: JSON.stringify({
        newCost: pcPreviewData.new_cost,
        newSalePrice: pcPreviewData.suggested_sale_price,
        notes: document.getElementById('pcNotes').value
      })
    });
    const d = await r.json();
    if (d.error) { toast('error','Error',d.error); return; }
    toast('success','Updated',`Cost updated! ${d.customers_updated} prices updated, ${d.customers_locked} VIP locks protected.`);
    pcClearPreview();
    document.getElementById('pcItemSel').value = '';
    document.getElementById('pcNewCost').value = '';
    document.getElementById('pcNotes').value   = '';
    apiFetch(`${API}/api/items`).then(r=>r.json()).then(d=>{ items = Array.isArray(d)?d:(d?.data||[]); });
    pcLoadHistory();
  } catch (e) { toast('error','Error',e.message); }
}

async function pcLoadHistory() {
  const tbody = document.getElementById('pcHistoryBody');
  tbody.innerHTML = '<tr><td colspan="8" class="loading">Loadingâ€¦</td></tr>';
  try {
    const rows = await apiFetch(`${API}/api/pricing/change-log`).then(r=>r.json());
    const data = Array.isArray(rows) ? rows : (rows?.data || []);
    if (!data.length) { tbody.innerHTML = '<tr><td colspan="8" class="empty">No changes yet</td></tr>'; return; }
    tbody.innerHTML = data.map(r=>`
      <tr>
        <td class="mono">${r.item_code}</td>
        <td>$${fmt(r.old_cost)}</td>
        <td>$${fmt(r.new_cost)}</td>
        <td>$${fmt(r.old_sale_price)}</td>
        <td>$${fmt(r.new_sale_price)}</td>
        <td>${r.customers_updated}</td>
        <td>${r.customers_locked}</td>
        <td style="font-size:11px;color:var(--text2)">${r.changed_at ? new Date(r.changed_at).toLocaleDateString() : 'â€”'}</td>
      </tr>`).join('');
  } catch { tbody.innerHTML = '<tr><td colspan="8" class="empty">Error loading history</td></tr>'; }
}

// â”€â”€ Import Tool â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadImportStatus() {
  try {
    const d = await apiFetch(`${API}/api/migration/status`).then(r=>r.json());
    document.getElementById('isItems').textContent     = d.items?.toLocaleString() || 'â€”';
    document.getElementById('isCustomers').textContent = d.customers?.toLocaleString() || 'â€”';
    document.getElementById('isVendors').textContent   = d.vendors?.toLocaleString() || 'â€”';
  } catch { /* silent */ }
}

function importFileSelected() {
  importPreviewResult = null;
  document.getElementById('importPreviewBox').style.display = 'none';
  document.getElementById('importResultBox').style.display  = 'none';
  document.getElementById('importConfirmBtn').disabled = true;
}

async function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function importPreview() {
  const fileInput = document.getElementById('importFile');
  const table     = document.getElementById('importTable').value;
  if (!fileInput.files.length) { toast('error','Required','Select a file first'); return; }
  const file = fileInput.files[0];
  try {
    const fileContent = await readFileAsBase64(file);
    const r = await apiFetch(`${API}/api/migration/preview-csv`, {
      method: 'POST',
      body: JSON.stringify({ table, fileContent, fileName: file.name })
    });
    const d = await r.json();
    if (d.error) { toast('error','Error',d.error); return; }
    importPreviewResult = { table, fileContent, fileName: file.name };

    document.getElementById('importPreviewStats').innerHTML =
      `Found <strong>${d.rows_found}</strong> rows &nbsp;Â·&nbsp; ` +
      `<span style="color:var(--green)"><strong>${d.rows_valid}</strong> valid</span> &nbsp;Â·&nbsp; ` +
      `<span style="color:var(--red)"><strong>${d.rows_with_errors}</strong> with errors</span>`;

    const samples = d.sample_data || [];
    if (samples.length) {
      const cols = Object.keys(samples[0]);
      document.getElementById('importPreviewHead').innerHTML =
        `<tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr>`;
      document.getElementById('importPreviewBody').innerHTML = samples.map(row=>
        `<tr>${cols.map(c=>`<td style="font-size:11px">${row[c]||''}</td>`).join('')}</tr>`
      ).join('');
    }

    const errHtml = d.errors && d.errors.length
      ? `<strong>Errors:</strong><br>`+d.errors.map(e=>`Row ${e.row}: ${e.error||'Missing: '+e.missing?.join(', ')}`).join('<br>')
      : '';
    document.getElementById('importPreviewErrors').innerHTML = errHtml;
    document.getElementById('importPreviewBox').style.display = 'block';
    document.getElementById('importConfirmBtn').disabled = d.rows_valid === 0;
  } catch (e) { toast('error','Error',e.message); }
}

async function importConfirm() {
  if (!importPreviewResult) return;
  const { table, fileContent, fileName } = importPreviewResult;
  if (!confirm(`Import ${table} from ${fileName}? Existing records will be updated.`)) return;
  document.getElementById('importConfirmBtn').disabled = true;
  try {
    const r = await apiFetch(`${API}/api/migration/import-csv`, {
      method: 'POST',
      body: JSON.stringify({ table, fileContent, fileName, skipErrors: true })
    });
    const d = await r.json();
    if (d.error) { toast('error','Error',d.error); return; }

    const box = document.getElementById('importResultBox');
    box.style.display = 'block';
    box.style.borderLeftColor = d.skipped > 0 ? 'var(--yellow)' : 'var(--green)';
    box.innerHTML = `
      <strong>Import Complete</strong><br>
      âœ… Imported: ${d.imported} &nbsp; âš ï¸ Skipped: ${d.skipped}
      ${d.errors && d.errors.length ? `<details style="margin-top:8px"><summary>View errors</summary>
        <div style="font-size:11px;margin-top:6px">${d.errors.map(e=>`Row ${e.row}: ${e.error}`).join('<br>')}</div>
      </details>` : ''}
    `;
    toast('success','Done',`Imported ${d.imported} records`);
    loadImportStatus();
    if (table==='items') apiFetch(`${API}/api/items`).then(r=>r.json()).then(d=>{ items=Array.isArray(d)?d:(d?.data||[]); });
  } catch (e) {
    toast('error','Error',e.message);
    document.getElementById('importConfirmBtn').disabled = false;
  }
}

init();
</script>
</body>
</html>
