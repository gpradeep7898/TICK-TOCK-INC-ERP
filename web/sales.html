<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TICK TOCK INC. | Sales</title>
<style>
/* â”€â”€ Reset & Root â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --navy:    #1e2a3a;
  --navy2:   #243347;
  --navy3:   #162130;
  --sidebar-w: 240px;
  --header-h:  60px;
  --blue:    #2563eb;
  --blue-h:  #1d4ed8;
  --blue-l:  #3b82f6;
  --green:   #10b981;
  --yellow:  #f59e0b;
  --red:     #ef4444;
  --orange:  #f97316;
  --bg:      #f0f4f8;
  --bg2:     #e8eef5;
  --card:    #ffffff;
  --border:  #dde5ef;
  --border2: #c8d5e5;
  --text0:   #0f1923;
  --text1:   #374151;
  --text2:   #64748b;
  --text3:   #94a3b8;
  --radius:  10px;
  --radius-sm: 6px;
  --shadow:  0 1px 3px rgba(15,25,40,.08),0 4px 16px rgba(15,25,40,.06);
  --shadow-lg: 0 4px 24px rgba(15,25,40,.12),0 1px 4px rgba(15,25,40,.08);
}
html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text0);font-size:13px;line-height:1.5}
button{cursor:pointer;font-family:inherit;font-size:13px}
input,select,textarea{font-family:inherit;font-size:13px}

/* â”€â”€ Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:flex;height:100vh;overflow:hidden}

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar{
  width:var(--sidebar-w);min-width:var(--sidebar-w);
  background:var(--navy);display:flex;flex-direction:column;
  overflow:hidden;z-index:100;
}
.sidebar-logo{
  padding:18px 20px 16px;border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;align-items:center;gap:12px;flex-shrink:0;
}
.sidebar-logo-icon{
  width:36px;height:36px;border-radius:9px;
  background:linear-gradient(135deg,var(--blue),var(--blue-l));
  display:flex;align-items:center;justify-content:center;
  font-size:18px;flex-shrink:0;box-shadow:0 4px 12px rgba(37,99,235,.4);
}
.sidebar-logo-text .co{font-size:13px;font-weight:800;color:#fff;letter-spacing:.03em}
.sidebar-logo-text .sub{font-size:9.5px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.1em}

.sidebar-nav{padding:12px 10px;flex:1;overflow-y:auto}
.nav-section{margin-bottom:4px}
.nav-label{
  font-size:9.5px;font-weight:700;color:rgba(255,255,255,.3);
  text-transform:uppercase;letter-spacing:.12em;padding:10px 10px 4px;
}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:8px 10px;border-radius:var(--radius-sm);
  color:rgba(255,255,255,.55);font-size:13px;font-weight:500;
  cursor:pointer;transition:all .12s;margin-bottom:1px;
  border:none;background:none;width:100%;text-align:left;text-decoration:none;
}
.nav-item:hover{background:rgba(255,255,255,.07);color:rgba(255,255,255,.85)}
.nav-item.active{background:rgba(37,99,235,.25);color:#fff}
.nav-item .ni{font-size:15px;width:18px;text-align:center;flex-shrink:0}
.nav-badge{
  margin-left:auto;background:var(--red);color:#fff;
  font-size:10px;font-weight:700;border-radius:10px;
  padding:1px 6px;min-width:18px;text-align:center;
}
.nav-badge-orange{background:var(--orange)}

.sidebar-footer{
  padding:12px 16px;border-top:1px solid rgba(255,255,255,.08);
  font-size:11px;color:rgba(255,255,255,.3);
}

/* â”€â”€ Main Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#header{
  height:var(--header-h);min-height:var(--header-h);
  background:var(--card);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 24px;gap:16px;
  z-index:50;flex-shrink:0;
}
.header-page-title{font-size:16px;font-weight:700;color:var(--text0);flex:1}
.header-actions{display:flex;align-items:center;gap:10px}

.user-chip{
  display:flex;align-items:center;gap:9px;padding:5px 12px 5px 5px;
  background:var(--bg);border:1.5px solid var(--border);border-radius:30px;
}
.user-avatar{
  width:28px;height:28px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;color:#fff;flex-shrink:0;
}
.user-info{line-height:1.3}
.user-name{font-size:12px;font-weight:600;color:var(--text0)}
.user-role-line{font-size:10px;color:var(--text2)}
.role-badge{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;padding:2px 7px;border-radius:4px}
.role-admin    {background:rgba(245,158,11,.12);color:#b45309}
.role-warehouse{background:rgba(16,185,129,.12);color:#047857}
.role-sales    {background:rgba(37,99,235,.12);color:#1d4ed8}

.signout-btn{
  padding:7px 14px;border-radius:var(--radius-sm);background:none;
  color:var(--text2);font-size:12px;font-weight:500;border:1.5px solid var(--border);transition:all .12s;
}
.signout-btn:hover{background:var(--red);color:#fff;border-color:var(--red)}

/* â”€â”€ Content Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#content{flex:1;overflow-y:auto;padding:24px}

/* â”€â”€ KPI Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.kpi-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
.kpi-label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px}
.kpi-value{font-size:26px;font-weight:800;color:var(--text0);line-height:1}
.kpi-value.blue{color:var(--blue)} .kpi-value.green{color:var(--green)}
.kpi-value.yellow{color:var(--yellow)} .kpi-value.red{color:var(--red)}
.kpi-sub{font-size:11px;color:var(--text3);margin-top:4px}

/* â”€â”€ Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section{display:none}.section.active{display:block}

/* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.search-wrap{position:relative;flex:1;min-width:180px;max-width:320px}
.search-wrap input{
  width:100%;padding:8px 12px 8px 34px;border:1.5px solid var(--border);
  border-radius:var(--radius-sm);background:var(--card);color:var(--text0);outline:none;
  transition:border-color .12s,box-shadow .12s;
}
.search-wrap input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:13px;pointer-events:none}
.filter-select{
  padding:8px 12px;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--card);color:var(--text1);outline:none;
}
.filter-select:focus{border-color:var(--blue)}

/* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border);background:var(--card)}
.data-table{width:100%;border-collapse:collapse}
.data-table th{
  background:var(--bg);padding:10px 14px;text-align:left;
  font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;
  color:var(--text2);border-bottom:1px solid var(--border);white-space:nowrap;
}
.data-table td{padding:11px 14px;border-bottom:1px solid var(--border);color:var(--text1)}
.data-table tr:last-child td{border-bottom:none}
.data-table tbody tr:hover td{background:rgba(37,99,235,.02);cursor:pointer}
.code-tag{font-family:'Courier New',monospace;font-size:11px;color:var(--text0);background:var(--bg2);padding:2px 6px;border-radius:4px;font-weight:600}
.empty-state{text-align:center;padding:40px;color:var(--text3);font-size:13px}

/* â”€â”€ AR Aging Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.aging-table{width:100%;border-collapse:collapse}
.aging-table th{background:var(--bg);padding:10px 14px;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.06em;text-align:right;border-bottom:1px solid var(--border)}
.aging-table th:first-child{text-align:left}
.aging-table td{padding:11px 14px;border-bottom:1px solid var(--border);font-size:12px;text-align:right;font-variant-numeric:tabular-nums;color:var(--text1)}
.aging-table td:first-child{text-align:left;font-weight:500}
.aging-table tfoot td{background:var(--bg);font-weight:700;border-top:2px solid var(--border);border-bottom:none}
.aging-table tr:last-child td{border-bottom:none}
.aging-table tbody tr:hover td{background:rgba(37,99,235,.02);cursor:pointer}
.overdue-30{color:var(--yellow)!important} .overdue-60{color:var(--orange)!important} .overdue-90{color:var(--red)!important}

/* â”€â”€ Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status-badge{
  display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;
  padding:3px 8px;border-radius:10px;text-transform:uppercase;letter-spacing:.05em;
}
.badge-draft          {background:rgba(100,116,139,.1);color:#475569}
.badge-confirmed      {background:rgba(37,99,235,.1);color:#1d4ed8}
.badge-partial        {background:rgba(249,115,22,.1);color:#c2410c}
.badge-partially_shipped{background:rgba(249,115,22,.1);color:#c2410c}
.badge-shipped,
.badge-fully_shipped  {background:rgba(16,185,129,.1);color:#047857}
.badge-invoiced       {background:rgba(139,92,246,.1);color:#6d28d9}
.badge-closed,
.badge-paid           {background:rgba(16,185,129,.1);color:#047857}
.badge-cancelled,
.badge-void           {background:rgba(239,68,68,.08);color:#dc2626}
.badge-sent           {background:rgba(37,99,235,.1);color:#1d4ed8}
.badge-partial_paid   {background:rgba(249,115,22,.1);color:#c2410c}
.badge-overdue        {background:rgba(239,68,68,.1);color:#dc2626}
.badge-active         {background:rgba(16,185,129,.1);color:#047857}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:none;border-radius:var(--radius-sm);font-size:13px;font-weight:600;transition:all .12s;cursor:pointer}
.btn-primary{background:var(--blue);color:#fff;box-shadow:0 2px 8px rgba(37,99,235,.25)}
.btn-primary:hover{background:var(--blue-h)}
.btn-secondary{background:var(--bg);color:var(--text1);border:1.5px solid var(--border)}
.btn-secondary:hover{background:var(--bg2);color:var(--text0);border-color:var(--border2)}
.btn-success{background:var(--green);color:#fff}
.btn-success:hover{background:#059669}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{background:#dc2626}
.btn-warning{background:var(--yellow);color:#fff}
.btn-warning:hover{background:#d97706}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-xs{padding:3px 8px;font-size:11px}

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(15,25,40,.55);z-index:200;align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;backdrop-filter:blur(2px)}
.modal-overlay.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);width:90%;max-width:820px;display:flex;flex-direction:column;box-shadow:var(--shadow-lg);margin:0 auto 40px}
.modal-sm{max-width:480px}
.modal-header{display:flex;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);gap:10px}
.modal-title{font-size:15px;font-weight:700;flex:1;color:var(--text0)}
.modal-close{width:28px;height:28px;border:1.5px solid var(--border);background:none;border-radius:6px;color:var(--text2);font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .12s}
.modal-close:hover{background:var(--red);color:#fff;border-color:var(--red)}
.modal-body{padding:20px;overflow-y:auto;max-height:70vh}
.modal-footer{padding:14px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap;background:var(--bg)}

/* â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-group.full{grid-column:1/-1}
.form-label{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.06em}
.form-input{
  padding:9px 12px;background:var(--card);border:1.5px solid var(--border);
  border-radius:var(--radius-sm);color:var(--text0);outline:none;
  transition:border-color .12s,box-shadow .12s;width:100%;
}
.form-input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
textarea.form-input{resize:vertical;min-height:60px}

/* â”€â”€ SO Lines table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lines-table{width:100%;border-collapse:collapse}
.lines-table th{background:var(--bg);padding:8px 10px;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;text-align:left;border-bottom:1px solid var(--border)}
.lines-table td{padding:7px 8px;border-bottom:1px solid var(--border);vertical-align:middle}
.lines-table tr:last-child td{border-bottom:none}
.lines-table input,.lines-table select{
  background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius-sm);
  color:var(--text0);padding:5px 7px;outline:none;font-size:12px;
}
.lines-table input:focus,.lines-table select:focus{border-color:var(--blue)}

/* â”€â”€ SO Detail sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px}
.detail-block{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
.detail-block-title{font-size:10px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px}
.detail-row{display:flex;justify-content:space-between;padding:4px 0;font-size:13px}
.detail-label{color:var(--text2)}
.detail-value{font-weight:500;color:var(--text0)}
.totals-block{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-top:12px;max-width:300px;margin-left:auto}
.total-row{display:flex;justify-content:space-between;padding:4px 0;font-size:13px}
.total-row.grand{font-size:15px;font-weight:700;border-top:2px solid var(--border);margin-top:8px;padding-top:10px}

/* â”€â”€ Section title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-heading{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.07em;margin-bottom:10px}

/* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast-container{position:fixed;bottom:24px;right:24px;display:flex;flex-direction:column;gap:8px;z-index:9999;pointer-events:none}
.toast{
  background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:12px 16px;font-size:13px;max-width:360px;
  box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px;
  animation:slideIn .2s ease;pointer-events:auto;
}
.toast.success{border-left:3px solid var(--green)}
.toast.error  {border-left:3px solid var(--red)}
.toast.info   {border-left:3px solid var(--blue)}
@keyframes slideIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
</style>
</head>
<body>
<div id="app">

<!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<aside id="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon">â±</div>
    <div class="sidebar-logo-text">
      <div class="co">TICK TOCK INC.</div>
      <div class="sub">Sales</div>
    </div>
  </div>

  <div class="sidebar-nav">
    <div class="nav-section">
      <div class="nav-label">Sales</div>
      <button class="nav-item active" data-section="orders" onclick="navigate('orders')">
        <span class="ni">ğŸ§¾</span> Sales Orders
        <span class="nav-badge" id="badge-orders">0</span>
      </button>
      <button class="nav-item" data-section="shipments" onclick="navigate('shipments')">
        <span class="ni">ğŸšš</span> Shipments
      </button>
      <button class="nav-item" data-section="invoices" onclick="navigate('invoices')">
        <span class="ni">ğŸ’°</span> Invoices
        <span class="nav-badge nav-badge-orange" id="badge-invoices">0</span>
      </button>
      <button class="nav-item" data-section="aging" onclick="navigate('aging')">
        <span class="ni">ğŸ“…</span> AR Aging
      </button>
      <button class="nav-item" data-section="customers" onclick="navigate('customers')">
        <span class="ni">ğŸ¢</span> Customers
      </button>
    </div>
    <div class="nav-section">
      <div class="nav-label">Other Modules</div>
      <a class="nav-item" href="/"><span class="ni">ğŸ“¦</span> Inventory</a>
      <a class="nav-item" href="/purchasing"><span class="ni">ğŸ›’</span> Purchasing</a>
      <a class="nav-item" href="/financials"><span class="ni">ğŸ“ˆ</span> Financials</a>
    </div>
  </div>

  <div class="sidebar-footer">TICK TOCK INC. ERP &nbsp;Â·&nbsp; v1.0.0</div>
</aside>

<!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="main">
  <div id="header">
    <span class="header-page-title" id="page-title">Sales Orders</span>
    <div class="header-actions">
      <button class="btn btn-secondary btn-sm" onclick="refreshAll()">â†» Refresh</button>
      <button class="btn btn-primary btn-sm" id="top-action-btn" onclick="openNewSOModal()">+ New Order</button>
      <div class="user-chip">
        <div class="user-avatar" id="userAvatar" style="background:var(--blue)">?</div>
        <div class="user-info">
          <div class="user-name" id="userName">â€”</div>
          <div class="user-role-line" id="userRoleLine">â€”</div>
        </div>
        <span class="role-badge" id="userRoleBadge"></span>
      </div>
      <button class="signout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- KPI Stats -->
  <div style="padding:16px 24px 0;background:var(--card);border-bottom:1px solid var(--border)">
    <div class="kpi-grid" style="margin-bottom:16px">
      <div class="kpi-card" style="box-shadow:none;border-radius:var(--radius-sm)">
        <div class="kpi-label">Open Orders</div>
        <div class="kpi-value blue" id="stat-open">â€”</div>
        <div class="kpi-sub">confirmed + partial</div>
      </div>
      <div class="kpi-card" style="box-shadow:none;border-radius:var(--radius-sm)">
        <div class="kpi-label">Revenue MTD</div>
        <div class="kpi-value green" id="stat-mtd">â€”</div>
        <div class="kpi-sub">this month</div>
      </div>
      <div class="kpi-card" style="box-shadow:none;border-radius:var(--radius-sm)">
        <div class="kpi-label">Overdue Invoices</div>
        <div class="kpi-value red" id="stat-overdue">â€”</div>
        <div class="kpi-sub">past due date</div>
      </div>
      <div class="kpi-card" style="box-shadow:none;border-radius:var(--radius-sm)">
        <div class="kpi-label">Total AR</div>
        <div class="kpi-value yellow" id="stat-ar">â€”</div>
        <div class="kpi-sub">outstanding balance</div>
      </div>
    </div>
  </div>

  <div id="content">

    <!-- Sales Orders -->
    <div class="section active" id="section-orders">
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="so-search" placeholder="Search order # or customerâ€¦" oninput="renderOrders()">
        </div>
        <select class="filter-select" id="so-status-filter" onchange="renderOrders()">
          <option value="">All Statuses</option>
          <option value="draft">Draft</option>
          <option value="confirmed">Confirmed</option>
          <option value="partially_shipped">Partially Shipped</option>
          <option value="fully_shipped">Fully Shipped</option>
          <option value="invoiced">Invoiced</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr>
            <th>Order #</th><th>Customer</th><th>Date</th><th>Ship By</th>
            <th>Lines</th><th>Total</th><th>Status</th><th>Actions</th>
          </tr></thead>
          <tbody id="orders-tbody">
            <tr><td colspan="8" class="empty-state"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Shipments -->
    <div class="section" id="section-shipments">
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr>
            <th>Shipment #</th><th>Order #</th><th>Customer</th><th>Ship Date</th><th>Carrier</th><th>Tracking</th><th>Status</th>
          </tr></thead>
          <tbody id="shipments-tbody">
            <tr><td colspan="7" class="empty-state"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Invoices -->
    <div class="section" id="section-invoices">
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="inv-search" placeholder="Search invoice # or customerâ€¦" oninput="renderInvoices()">
        </div>
        <select class="filter-select" id="inv-status-filter" onchange="renderInvoices()">
          <option value="">All Statuses</option>
          <option value="draft">Draft</option>
          <option value="sent">Sent</option>
          <option value="partial_paid">Partial Paid</option>
          <option value="paid">Paid</option>
          <option value="void">Void</option>
        </select>
      </div>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr>
            <th>Invoice #</th><th>Customer</th><th>Date</th><th>Due Date</th><th>Total</th><th>Paid</th><th>Balance</th><th>Status</th><th></th>
          </tr></thead>
          <tbody id="invoices-tbody">
            <tr><td colspan="9" class="empty-state"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- AR Aging -->
    <div class="section" id="section-aging">
      <p style="margin-bottom:16px;color:var(--text2);font-size:12px">
        Outstanding balances by customer, bucketed by days past due.
      </p>
      <div class="table-wrap">
        <table class="aging-table">
          <thead><tr>
            <th style="text-align:left">Customer</th>
            <th>Current</th><th>1â€“30 Days</th><th>31â€“60 Days</th>
            <th>61â€“90 Days</th><th>90+ Days</th><th>Total Due</th>
          </tr></thead>
          <tbody id="aging-tbody">
            <tr><td colspan="7" class="empty-state"><div class="spinner"></div></td></tr>
          </tbody>
          <tfoot>
            <tr>
              <td style="text-align:left;font-weight:700">Totals</td>
              <td id="aging-tot-current">â€”</td><td id="aging-tot-30">â€”</td>
              <td id="aging-tot-60">â€”</td><td id="aging-tot-90">â€”</td>
              <td id="aging-tot-90p">â€”</td><td id="aging-tot-total">â€”</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Customers -->
    <div class="section" id="section-customers">
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="cust-search" placeholder="Search customerâ€¦" oninput="renderCustomers()">
        </div>
        <button class="btn btn-primary btn-sm" onclick="openNewCustomerModal()">+ New Customer</button>
      </div>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr>
            <th>Code</th><th>Name</th><th>Email</th><th>Phone</th><th>Terms</th><th>Credit Limit</th><th>AR Balance</th><th>Status</th>
          </tr></thead>
          <tbody id="customers-tbody">
            <tr><td colspan="8" class="empty-state"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /app -->

<!-- â•â•â• NEW SALES ORDER MODAL â•â•â• -->
<div class="modal-overlay" id="new-so-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">New Sales Order</div>
      <button class="modal-close" onclick="closeModal('new-so-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid" style="margin-bottom:16px">
        <div class="form-group">
          <label class="form-label">Customer *</label>
          <select class="form-input" id="so-customer" onchange="onSOCustomerChange()">
            <option value="">Select customerâ€¦</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Warehouse *</label>
          <select class="form-input" id="so-warehouse">
            <option value="">Select warehouseâ€¦</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Order Date</label>
          <input class="form-input" type="date" id="so-order-date">
        </div>
        <div class="form-group">
          <label class="form-label">Requested Ship Date</label>
          <input class="form-input" type="date" id="so-ship-date">
        </div>
        <div class="form-group">
          <label class="form-label">Tax Rate (%)</label>
          <input class="form-input" type="number" id="so-tax-rate" value="8" step="0.01" min="0" max="100">
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <input class="form-input" id="so-notes" placeholder="Optional notes">
        </div>
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div class="section-heading" style="margin-bottom:0">Order Lines</div>
        <button class="btn btn-secondary btn-sm" onclick="addSOLine()">+ Add Line</button>
      </div>
      <div class="table-wrap">
        <table class="lines-table">
          <thead><tr><th style="min-width:220px">Item</th><th>Available</th><th>Qty</th><th>Unit Price</th><th>Disc %</th><th>Line Total</th><th></th></tr></thead>
          <tbody id="so-lines-body">
            <tr id="so-lines-empty"><td colspan="7" style="padding:16px;text-align:center;color:var(--text3)">Click "+ Add Line" to add items</td></tr>
          </tbody>
        </table>
      </div>

      <div style="margin-top:14px;display:flex;justify-content:flex-end">
        <div style="min-width:260px">
          <div class="total-row"><span style="color:var(--text2)">Subtotal</span><span id="so-subtotal-display">$0.00</span></div>
          <div class="total-row"><span style="color:var(--text2)">Tax</span><span id="so-tax-display">$0.00</span></div>
          <div class="total-row grand"><span>Total</span><span id="so-total-display">$0.00</span></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('new-so-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitNewSO()">Create Order</button>
    </div>
  </div>
</div>

<!-- â•â•â• SO DETAIL MODAL â•â•â• -->
<div class="modal-overlay" id="so-detail-modal">
  <div class="modal" style="max-width:900px">
    <div class="modal-header">
      <div class="modal-title" id="so-detail-title">Order Detail</div>
      <button class="modal-close" onclick="closeModal('so-detail-modal')">âœ•</button>
    </div>
    <div class="modal-body" id="so-detail-body">
      <div class="empty-state"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<!-- â•â•â• SHIP MODAL â•â•â• -->
<div class="modal-overlay" id="ship-modal">
  <div class="modal" style="max-width:680px">
    <div class="modal-header">
      <div class="modal-title">Create Shipment</div>
      <button class="modal-close" onclick="closeModal('ship-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="ship-order-id">
      <div class="form-grid" style="margin-bottom:16px">
        <div class="form-group">
          <label class="form-label">Ship Date</label>
          <input class="form-input" type="date" id="ship-date">
        </div>
        <div class="form-group">
          <label class="form-label">Carrier</label>
          <input class="form-input" id="ship-carrier" placeholder="UPS, FedEx, USPSâ€¦">
        </div>
        <div class="form-group">
          <label class="form-label">Tracking Number</label>
          <input class="form-input" id="ship-tracking" placeholder="Optional">
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <input class="form-input" id="ship-notes" placeholder="Optional">
        </div>
      </div>
      <div class="section-heading">Lines to Ship</div>
      <div class="table-wrap">
        <table class="lines-table">
          <thead><tr><th>Item</th><th>Ordered</th><th>Shipped</th><th>Remaining</th><th>Ship Qty</th></tr></thead>
          <tbody id="ship-lines-body"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('ship-modal')">Cancel</button>
      <button class="btn btn-success" onclick="submitShipment()">Post Shipment</button>
    </div>
  </div>
</div>

<!-- â•â•â• NEW CUSTOMER MODAL â•â•â• -->
<div class="modal-overlay" id="new-customer-modal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <div class="modal-title">New Customer</div>
      <button class="modal-close" onclick="closeModal('new-customer-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">Code *</label><input class="form-input" id="nc-code" placeholder="CUST-006"></div>
        <div class="form-group"><label class="form-label">Name *</label><input class="form-input" id="nc-name" placeholder="Company Name"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="nc-email" type="email" placeholder="orders@company.com"></div>
        <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="nc-phone" placeholder="212-555-0100"></div>
        <div class="form-group"><label class="form-label">Payment Terms (days)</label><input class="form-input" id="nc-terms" type="number" value="30" min="0"></div>
        <div class="form-group"><label class="form-label">Credit Limit ($)</label><input class="form-input" id="nc-credit" type="number" value="10000" min="0"></div>
        <div class="form-group full"><label class="form-label">Billing Address</label><input class="form-input" id="nc-addr" placeholder="Street address"></div>
        <div class="form-group"><label class="form-label">City</label><input class="form-input" id="nc-city" placeholder="New York"></div>
        <div class="form-group">
          <label class="form-label">State / Zip</label>
          <div style="display:flex;gap:8px">
            <input class="form-input" id="nc-state" placeholder="NY" style="width:70px">
            <input class="form-input" id="nc-zip" placeholder="10001">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('new-customer-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitNewCustomer()">Create Customer</button>
    </div>
  </div>
</div>

<!-- â•â•â• PAYMENT MODAL â•â•â• -->
<div class="modal-overlay" id="payment-modal">
  <div class="modal modal-sm">
    <div class="modal-header">
      <div class="modal-title">Record Payment</div>
      <button class="modal-close" onclick="closeModal('payment-modal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="pay-invoice-id">
      <input type="hidden" id="pay-customer-id">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">Payment Date</label><input class="form-input" type="date" id="pay-date"></div>
        <div class="form-group"><label class="form-label">Amount ($)</label><input class="form-input" type="number" id="pay-amount" step="0.01" min="0"></div>
        <div class="form-group">
          <label class="form-label">Method</label>
          <select class="form-input" id="pay-method">
            <option value="check">Check</option>
            <option value="wire">Wire</option>
            <option value="ach">ACH</option>
            <option value="credit_card">Credit Card</option>
            <option value="cash">Cash</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Reference #</label><input class="form-input" id="pay-ref" placeholder="Check or wire ref"></div>
      </div>
      <div style="margin-top:10px;font-size:12px;color:var(--text2)" id="pay-invoice-info"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('payment-modal')">Cancel</button>
      <button class="btn btn-secondary" onclick="printCurrentInvoice()" title="Print Invoice">ğŸ–¨ï¸ Print</button>
      <button class="btn btn-success" onclick="submitPayment()">Record Payment</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
const API = '';
let allOrders = [], allShipments = [], allInvoices = [], allCustomers = [], allItems = [], allWarehouses = [];

// â”€â”€ Auth Guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function authGuard() {
  const token = localStorage.getItem('tt_token');
  if (!token) { window.location.href = '/login.html'; return; }
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    if (payload.exp * 1000 < Date.now()) {
      localStorage.removeItem('tt_token');
      localStorage.removeItem('tt_user');
      window.location.href = '/login.html';
      return;
    }
    const name    = payload.name || payload.email;
    const role    = payload.role || 'user';
    const initials = name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    const colors  = { admin:'#b45309', warehouse:'#047857', sales:'#1d4ed8' };
    document.getElementById('userAvatar').textContent      = initials;
    document.getElementById('userAvatar').style.background = colors[role] || '#2563eb';
    document.getElementById('userName').textContent        = name;
    document.getElementById('userRoleLine').textContent    = role.charAt(0).toUpperCase()+role.slice(1);
    const badge = document.getElementById('userRoleBadge');
    badge.textContent = role;
    badge.className   = `role-badge role-${role}`;
  } catch { window.location.href = '/login.html'; }
})();

function signOut() {
  localStorage.removeItem('tt_token');
  localStorage.removeItem('tt_user');
  window.location.href = '/login.html';
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(path, opts = {}) {
  const token = localStorage.getItem('tt_token');
  const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(`${API}${path}`, { ...opts, headers });
  if (res.status === 401) {
    localStorage.removeItem('tt_token');
    window.location.href = '/login.html';
    throw new Error('Unauthorized');
  }
  if (!res.ok) { const b = await res.json().catch(() => ({})); throw new Error(b.error || `HTTP ${res.status}`); }
  return res.json();
}

const $ = id => document.getElementById(id);
const fmt = n => parseFloat(n || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const fmtDate = d => d ? String(d).slice(0, 10) : 'â€”';
const today = () => new Date().toISOString().slice(0, 10);

function statusBadge(s) {
  const map = {
    draft:'badge-draft', confirmed:'badge-confirmed',
    partially_shipped:'badge-partially_shipped', fully_shipped:'badge-shipped',
    invoiced:'badge-invoiced', closed:'badge-closed', cancelled:'badge-cancelled',
    sent:'badge-sent', paid:'badge-paid', partial_paid:'badge-partial_paid', void:'badge-cancelled',
    shipped:'badge-shipped', delivered:'badge-shipped'
  };
  return `<span class="status-badge ${map[s]||'badge-draft'}">${(s||'').replace(/_/g,' ')}</span>`;
}

function invoiceStatusBadge(inv) {
  const overdue = inv.status !== 'paid' && inv.status !== 'void' && new Date(inv.due_date) < new Date();
  if (overdue) return `<span class="status-badge badge-overdue">âš  Overdue</span>`;
  return statusBadge(inv.status);
}

function toast(msg, type = 'info') {
  const icons = { success:'âœ“', error:'âœ•', info:'â„¹' };
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span style="font-size:15px">${icons[type]||'â€¢'}</span><span>${msg}</span>`;
  $('toast-container').appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .3s'; setTimeout(()=>el.remove(),320); }, 3500);
}

function openModal(id) { $(id).classList.add('open'); }
function closeModal(id) { $(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o =>
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); })
);

// â”€â”€ Data Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  try {
    const [dash, aging, invoices] = await Promise.all([
      apiFetch('/api/sales-orders/dashboard'),
      apiFetch('/api/ar-aging'),
      apiFetch('/api/invoices')
    ]);
    $('stat-open').textContent   = dash.open_orders;
    $('stat-mtd').textContent    = '$' + fmt(dash.revenue_mtd);
    const overdue = invoices.filter(i => i.status !== 'paid' && i.status !== 'void' && new Date(i.due_date) < new Date()).length;
    $('stat-overdue').textContent    = overdue;
    $('stat-ar').textContent         = '$' + fmt(aging.totals?.total_due || 0);
    $('badge-invoices').textContent  = overdue;
  } catch (e) { console.error('Dashboard error:', e.message); }
}

async function loadOrders() {
  try {
    allOrders = await apiFetch('/api/sales-orders');
    $('badge-orders').textContent = allOrders.filter(o => ['confirmed','partially_shipped'].includes(o.status)).length;
    renderOrders();
  } catch (e) { $('orders-tbody').innerHTML = `<tr><td colspan="8" class="empty-state">Failed to load orders</td></tr>`; }
}

async function loadShipments() {
  try {
    allShipments = await apiFetch('/api/shipments');
    renderShipments();
  } catch (e) { $('shipments-tbody').innerHTML = `<tr><td colspan="7" class="empty-state">Failed to load shipments</td></tr>`; }
}

async function loadInvoices() {
  try {
    allInvoices = await apiFetch('/api/invoices');
    renderInvoices();
  } catch (e) { $('invoices-tbody').innerHTML = `<tr><td colspan="9" class="empty-state">Failed to load invoices</td></tr>`; }
}

async function loadCustomers() {
  try {
    allCustomers = await apiFetch('/api/customers');
    const sel = $('so-customer');
    sel.innerHTML = '<option value="">Select customerâ€¦</option>';
    allCustomers.forEach(c => {
      const o = document.createElement('option');
      o.value = c.id; o.textContent = `${c.code} â€” ${c.name}`;
      sel.appendChild(o);
    });
    renderCustomers();
  } catch (e) { console.error('Customers error:', e.message); }
}

async function loadWarehouses() {
  try {
    allWarehouses = await apiFetch('/api/warehouses');
    const sel = $('so-warehouse');
    sel.innerHTML = '<option value="">Select warehouseâ€¦</option>';
    allWarehouses.forEach(w => {
      const o = document.createElement('option');
      o.value = w.id; o.textContent = `${w.code} â€” ${w.name}`;
      sel.appendChild(o);
    });
  } catch (e) { console.error('Warehouses error:', e.message); }
}

async function loadItems() {
  try { allItems = await apiFetch('/api/items'); }
  catch (e) { console.error('Items error:', e.message); }
}

async function loadAging() {
  try {
    const { customers, totals } = await apiFetch('/api/ar-aging');
    const tbody = $('aging-tbody');
    if (!customers.length) {
      tbody.innerHTML = `<tr><td colspan="7" class="empty-state">âœ… No outstanding AR balances</td></tr>`;
    } else {
      tbody.innerHTML = customers.map(c => `
        <tr>
          <td><div style="font-weight:600;color:var(--text0)">${c.customer_name}</div><div style="font-size:10px;color:var(--text2)">${c.customer_code}</div></td>
          <td>${c.current_due > 0 ? '$'+fmt(c.current_due) : 'â€”'}</td>
          <td class="${c.days_1_30 > 0 ? 'overdue-30' : ''}">${c.days_1_30 > 0 ? '$'+fmt(c.days_1_30) : 'â€”'}</td>
          <td class="${c.days_31_60 > 0 ? 'overdue-60' : ''}">${c.days_31_60 > 0 ? '$'+fmt(c.days_31_60) : 'â€”'}</td>
          <td class="${c.days_61_90 > 0 ? 'overdue-90' : ''}">${c.days_61_90 > 0 ? '$'+fmt(c.days_61_90) : 'â€”'}</td>
          <td class="${c.days_90plus > 0 ? 'overdue-90' : ''}">${c.days_90plus > 0 ? '$'+fmt(c.days_90plus) : 'â€”'}</td>
          <td style="font-weight:700;color:${c.total_due>0?'var(--red)':'var(--text0)'}">$${fmt(c.total_due)}</td>
        </tr>
      `).join('');
    }
    if (totals) {
      $('aging-tot-current').textContent = '$' + fmt(totals.current_due);
      $('aging-tot-30').textContent      = '$' + fmt(totals.days_1_30);
      $('aging-tot-60').textContent      = '$' + fmt(totals.days_31_60);
      $('aging-tot-90').textContent      = '$' + fmt(totals.days_61_90);
      $('aging-tot-90p').textContent     = '$' + fmt(totals.days_90plus);
      $('aging-tot-total').textContent   = '$' + fmt(totals.total_due);
    }
  } catch (e) { $('aging-tbody').innerHTML = `<tr><td colspan="7" class="empty-state">Failed to load AR aging</td></tr>`; }
}

// â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOrders() {
  const q  = ($('so-search').value || '').toLowerCase();
  const st = $('so-status-filter').value;
  const rows = allOrders.filter(o => {
    if (st && o.status !== st) return false;
    if (q && !o.number.toLowerCase().includes(q) && !(o.customer_name||'').toLowerCase().includes(q)) return false;
    return true;
  });
  const tbody = $('orders-tbody');
  if (!rows.length) { tbody.innerHTML = `<tr><td colspan="8" class="empty-state">No orders found</td></tr>`; return; }
  tbody.innerHTML = rows.map(o => `
    <tr onclick="openSODetail('${o.id}')">
      <td><span class="code-tag">${o.number}</span></td>
      <td><div style="font-weight:500;color:var(--text0)">${o.customer_name}</div><div style="font-size:10px;color:var(--text2)">${o.customer_code}</div></td>
      <td>${fmtDate(o.order_date)}</td>
      <td style="color:${o.requested_ship_date && new Date(o.requested_ship_date)<new Date()?'var(--red)':'var(--text1)'}">
        ${fmtDate(o.requested_ship_date)}</td>
      <td>${o.line_count}</td>
      <td style="font-weight:600">$${fmt(o.total)}</td>
      <td>${statusBadge(o.status)}</td>
      <td onclick="event.stopPropagation()">
        ${o.status==='draft' ? `<button class="btn btn-success btn-xs" onclick="confirmOrder('${o.id}')">Confirm</button>` : ''}
        ${['confirmed','partially_shipped'].includes(o.status) ? `<button class="btn btn-primary btn-xs" onclick="openShipModal('${o.id}')">Ship</button>` : ''}
        ${['draft','confirmed'].includes(o.status) ? `<button class="btn btn-danger btn-xs" onclick="cancelOrder('${o.id}')">Cancel</button>` : ''}
      </td>
    </tr>
  `).join('');
}

function renderShipments() {
  const tbody = $('shipments-tbody');
  if (!allShipments.length) { tbody.innerHTML = `<tr><td colspan="7" class="empty-state">No shipments yet</td></tr>`; return; }
  tbody.innerHTML = allShipments.map(s => `
    <tr>
      <td><span class="code-tag">${s.number}</span></td>
      <td><span class="code-tag">${s.order_number}</span></td>
      <td>${s.customer_name}</td>
      <td>${fmtDate(s.ship_date)}</td>
      <td>${s.carrier || 'â€”'}</td>
      <td style="font-size:11px;color:var(--text2)">${s.tracking_number || 'â€”'}</td>
      <td>${statusBadge(s.status)}</td>
    </tr>
  `).join('');
}

function renderInvoices() {
  const q  = ($('inv-search').value || '').toLowerCase();
  const st = $('inv-status-filter').value;
  const rows = allInvoices.filter(i => {
    if (st && i.status !== st) return false;
    if (q && !i.number.toLowerCase().includes(q) && !(i.customer_name||'').toLowerCase().includes(q)) return false;
    return true;
  });
  const tbody = $('invoices-tbody');
  if (!rows.length) { tbody.innerHTML = `<tr><td colspan="9" class="empty-state">No invoices found</td></tr>`; return; }
  tbody.innerHTML = rows.map(i => {
    const overdue = i.status !== 'paid' && i.status !== 'void' && new Date(i.due_date) < new Date();
    return `
    <tr onclick="openPaymentModal('${i.id}','${i.customer_id}','${i.number}',${i.balance_due})" style="cursor:pointer">
      <td><span class="code-tag">${i.number}</span></td>
      <td style="font-weight:500">${i.customer_name}</td>
      <td>${fmtDate(i.invoice_date)}</td>
      <td style="color:${overdue?'var(--red)':'var(--text1)'}">${fmtDate(i.due_date)}</td>
      <td style="font-weight:600">$${fmt(i.total)}</td>
      <td style="color:var(--green)">$${fmt(i.amount_paid)}</td>
      <td style="font-weight:700;color:${parseFloat(i.balance_due)>0?(overdue?'var(--red)':'var(--orange)'):'var(--green)'}">$${fmt(i.balance_due)}</td>
      <td>${invoiceStatusBadge(i)}</td>
      <td onclick="event.stopPropagation()"><button class="btn btn-secondary btn-xs" onclick="window.open('/print/invoice.html?invoiceId=${i.id}','_blank')">ğŸ–¨ï¸</button></td>
    </tr>`;
  }).join('');
}

function renderCustomers() {
  const q = ($('cust-search').value || '').toLowerCase();
  const rows = allCustomers.filter(c =>
    !q || c.name.toLowerCase().includes(q) || c.code.toLowerCase().includes(q) || (c.email||'').toLowerCase().includes(q)
  );
  const tbody = $('customers-tbody');
  if (!rows.length) { tbody.innerHTML = `<tr><td colspan="8" class="empty-state">No customers found</td></tr>`; return; }
  tbody.innerHTML = rows.map(c => `
    <tr>
      <td><span class="code-tag">${c.code}</span></td>
      <td style="font-weight:600;color:var(--text0)">${c.name}</td>
      <td style="color:var(--text2)">${c.email||'â€”'}</td>
      <td style="color:var(--text2)">${c.phone||'â€”'}</td>
      <td>NET${c.payment_terms_days}</td>
      <td>$${fmt(c.credit_limit)}</td>
      <td style="font-weight:600;color:${parseFloat(c.ar_balance||0)>0?'var(--orange)':'var(--text0)'}">$${fmt(c.ar_balance||0)}</td>
      <td>${c.is_active ? '<span class="status-badge badge-active">Active</span>' : '<span class="status-badge badge-cancelled">Inactive</span>'}</td>
    </tr>
  `).join('');
}

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pageTitles  = { orders:'Sales Orders', shipments:'Shipments', invoices:'Invoices', aging:'AR Aging', customers:'Customers' };
const pageActions = {
  orders:    { label:'+ New Order',    fn: 'openNewSOModal' },
  shipments: null,
  invoices:  null,
  aging:     null,
  customers: { label:'+ New Customer', fn: 'openNewCustomerModal' },
};

function navigate(section) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  $(`section-${section}`)?.classList.add('active');
  document.querySelector(`[data-section="${section}"]`)?.classList.add('active');
  $('page-title').textContent = pageTitles[section] || section;
  const act = pageActions[section];
  const btn = $('top-action-btn');
  if (act) {
    btn.textContent  = act.label;
    btn.style.display = '';
    btn.onclick = () => window[act.fn]();
  } else {
    btn.style.display = 'none';
  }
  if (section === 'shipments') loadShipments();
  if (section === 'invoices')  loadInvoices();
  if (section === 'aging')     loadAging();
  if (section === 'customers') loadCustomers();
}

// â”€â”€ SO Detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openSODetail(orderId) {
  openModal('so-detail-modal');
  $('so-detail-title').textContent = 'Loadingâ€¦';
  $('so-detail-body').innerHTML = '<div class="empty-state"><div class="spinner"></div></div>';
  try {
    const o = await apiFetch(`/api/sales-orders/${orderId}`);
    $('so-detail-title').textContent = `${o.number} â€” ${o.customer_name}`;

    const canConfirm = o.status === 'draft';
    const canShip    = ['confirmed','partially_shipped'].includes(o.status);
    const canCancel  = ['draft','confirmed'].includes(o.status);

    $('so-detail-body').innerHTML = `
      <div class="detail-grid">
        <div class="detail-block">
          <div class="detail-block-title">Order Info</div>
          <div class="detail-row"><span class="detail-label">Number</span><span class="detail-value">${o.number}</span></div>
          <div class="detail-row"><span class="detail-label">Status</span><span>${statusBadge(o.status)}</span></div>
          <div class="detail-row"><span class="detail-label">Order Date</span><span class="detail-value">${fmtDate(o.order_date)}</span></div>
          <div class="detail-row"><span class="detail-label">Ship By</span><span class="detail-value">${fmtDate(o.requested_ship_date)}</span></div>
          <div class="detail-row"><span class="detail-label">Warehouse</span><span class="detail-value">${o.warehouse_code}</span></div>
        </div>
        <div class="detail-block">
          <div class="detail-block-title">Customer</div>
          <div class="detail-row"><span class="detail-label">Code</span><span class="detail-value">${o.customer_code}</span></div>
          <div class="detail-row"><span class="detail-label">Name</span><span class="detail-value">${o.customer_name}</span></div>
          <div class="detail-row"><span class="detail-label">Email</span><span class="detail-value">${o.customer_email||'â€”'}</span></div>
          <div class="detail-row"><span class="detail-label">Terms</span><span class="detail-value">NET${o.payment_terms_days||30}</span></div>
        </div>
      </div>

      <div class="section-heading">Order Lines</div>
      <div class="table-wrap" style="margin-bottom:16px">
        <table class="data-table">
          <thead><tr><th>SKU</th><th>Item</th><th>Ordered</th><th>Shipped</th><th>Backorder</th><th>Unit Price</th><th>Disc</th><th>Line Total</th><th>Status</th></tr></thead>
          <tbody>
            ${(o.lines||[]).map(l => `
              <tr>
                <td><span class="code-tag">${l.item_code}</span></td>
                <td>${l.item_name}</td>
                <td>${l.qty_ordered}</td>
                <td>${l.qty_shipped}</td>
                <td style="color:${parseFloat(l.qty_backordered)>0?'var(--orange)':'var(--text2)'}">${l.qty_backordered}</td>
                <td>$${fmt(l.unit_price)}</td>
                <td>${l.discount_pct > 0 ? (parseFloat(l.discount_pct)*100).toFixed(1)+'%' : 'â€”'}</td>
                <td style="font-weight:600">$${fmt(l.line_total)}</td>
                <td>${statusBadge(l.status)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-bottom:16px">
        <div style="min-width:260px">
          <div class="total-row"><span style="color:var(--text2)">Subtotal</span><span>$${fmt(o.subtotal)}</span></div>
          <div class="total-row"><span style="color:var(--text2)">Tax (${(parseFloat(o.tax_rate||0)*100).toFixed(1)}%)</span><span>$${fmt(o.tax_amount)}</span></div>
          <div class="total-row grand"><span>Total</span><span>$${fmt(o.total)}</span></div>
        </div>
      </div>

      ${(o.shipments||[]).length ? `
      <div class="section-heading">Shipments</div>
      <div class="table-wrap" style="margin-bottom:16px">
        <table class="data-table">
          <thead><tr><th>Shipment #</th><th>Ship Date</th><th>Carrier</th><th>Tracking</th><th>Status</th><th></th></tr></thead>
          <tbody>
            ${o.shipments.map(s=>`<tr>
              <td><span class="code-tag">${s.number}</span></td>
              <td>${fmtDate(s.ship_date)}</td><td>${s.carrier||'â€”'}</td>
              <td style="font-size:11px;color:var(--text2)">${s.tracking_number||'â€”'}</td>
              <td>${statusBadge(s.status)}</td>
              <td><button class="btn btn-secondary btn-xs" onclick="window.open('/print/picklist.html?shipmentId=${s.id}','_blank')">ğŸ–¨ï¸ Pick List</button></td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>` : ''}

      ${(o.invoices||[]).length ? `
      <div class="section-heading">Invoices</div>
      <div class="table-wrap" style="margin-bottom:16px">
        <table class="data-table">
          <thead><tr><th>Invoice #</th><th>Date</th><th>Due</th><th>Total</th><th>Paid</th><th>Balance</th><th>Status</th><th></th></tr></thead>
          <tbody>
            ${o.invoices.map(i=>`<tr onclick="openPaymentModal('${i.id}','${o.customer_id}','${i.number}',${i.balance_due})" style="cursor:pointer">
              <td><span class="code-tag">${i.number}</span></td>
              <td>${fmtDate(i.invoice_date)}</td><td>${fmtDate(i.due_date)}</td>
              <td>$${fmt(i.total)}</td>
              <td style="color:var(--green)">$${fmt(i.amount_paid)}</td>
              <td style="font-weight:700">$${fmt(i.balance_due)}</td>
              <td>${invoiceStatusBadge(i)}</td>
              <td onclick="event.stopPropagation()"><button class="btn btn-secondary btn-xs" onclick="window.open('/print/invoice.html?invoiceId=${i.id}','_blank')">ğŸ–¨ï¸</button></td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>` : ''}

      <div style="display:flex;gap:8px;flex-wrap:wrap;padding-top:4px">
        ${canConfirm ? `<button class="btn btn-success" onclick="confirmOrder('${o.id}',true)">âœ“ Confirm Order</button>` : ''}
        ${canShip    ? `<button class="btn btn-primary" onclick="openShipModal('${o.id}')">ğŸšš Create Shipment</button>` : ''}
        ${canCancel  ? `<button class="btn btn-danger"  onclick="cancelOrder('${o.id}',true)">âœ• Cancel Order</button>` : ''}
        <button class="btn btn-secondary" onclick="closeModal('so-detail-modal')">Close</button>
      </div>
    `;
  } catch (e) {
    $('so-detail-body').innerHTML = `<div class="empty-state">âš ï¸ ${e.message}</div>`;
  }
}

// â”€â”€ Order Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function confirmOrder(orderId, fromDetail = false) {
  if (!confirm('Confirm this order? Stock will be reserved.')) return;
  try {
    await apiFetch(`/api/sales-orders/${orderId}/confirm`, { method: 'POST', body: '{}' });
    toast('Order confirmed â€” stock reserved!', 'success');
    await Promise.all([loadOrders(), loadDashboard()]);
    if (fromDetail) openSODetail(orderId);
  } catch (e) { toast(e.message, 'error'); }
}

async function cancelOrder(orderId, fromDetail = false) {
  if (!confirm('Cancel this order? Any reservations will be released.')) return;
  try {
    await apiFetch(`/api/sales-orders/${orderId}/cancel`, { method: 'POST', body: '{}' });
    toast('Order cancelled', 'info');
    await Promise.all([loadOrders(), loadDashboard()]);
    if (fromDetail) closeModal('so-detail-modal');
  } catch (e) { toast(e.message, 'error'); }
}

// â”€â”€ New Sales Order â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewSOModal() {
  $('so-order-date').value = today();
  $('so-ship-date').value  = '';
  $('so-notes').value      = '';
  $('so-tax-rate').value   = '8';
  $('so-lines-body').innerHTML = `<tr id="so-lines-empty"><td colspan="7" style="padding:16px;text-align:center;color:var(--text3)">Click "+ Add Line" to add items</td></tr>`;
  updateSOTotals();
  openModal('new-so-modal');
}

function addSOLine() {
  const empty = $('so-lines-empty');
  if (empty) empty.remove();
  const tbody = $('so-lines-body');
  const tr = document.createElement('tr');
  const opts = allItems.map(i => `<option value="${i.id}" data-price="${i.sale_price}">${i.code} â€” ${i.name}</option>`).join('');
  tr.innerHTML = `
    <td><select class="sol-item" style="width:220px;font-size:12px" onchange="onSOLineItemChange(this)">${opts.length ? '<option value="">Select itemâ€¦</option>'+opts : '<option>No items loaded</option>'}</select></td>
    <td><span class="sol-avail" style="font-size:11px;color:var(--text2)">â€”</span></td>
    <td><input class="sol-qty" type="number" value="1" min="1" step="1" style="width:60px" oninput="updateSOTotals()"></td>
    <td style="white-space:nowrap">
      <input class="sol-price" type="number" step="0.01" min="0" style="width:80px" placeholder="0.00" oninput="updateSOTotals()">
      <span class="sol-price-src" style="font-size:13px;cursor:default;margin-left:2px"></span>
    </td>
    <td><input class="sol-disc" type="number" step="0.01" min="0" max="100" value="0" style="width:55px" oninput="updateSOTotals()"></td>
    <td class="sol-total" style="font-weight:600;text-align:right">$0.00</td>
    <td><button class="btn btn-danger btn-xs" onclick="this.closest('tr').remove();updateSOTotals()">âœ•</button></td>
  `;
  tbody.appendChild(tr);
}

async function onSOLineItemChange(sel) {
  const tr         = sel.closest('tr');
  const priceInput = tr.querySelector('.sol-price');
  const availSpan  = tr.querySelector('.sol-avail');
  const itemId     = sel.value;
  const customerId = $('so-customer').value;
  if (!itemId) return;

  try {
    const qty    = tr.querySelector('.sol-qty').value || 1;
    const params = new URLSearchParams({ itemId, qty });
    if (customerId) params.set('customerId', customerId);
    const priceData = await apiFetch(`/api/pricing/resolve?${params}`);
    priceInput.value = parseFloat(priceData.price).toFixed(2);
    const srcSpan = tr.querySelector('.sol-price-src');
    if (srcSpan) {
      if (priceData.source === 'locked') {
        srcSpan.textContent = 'ğŸ”’'; srcSpan.title = `VIP Locked Price${priceData.lock_reason?': '+priceData.lock_reason:''}`;
      } else if (priceData.source === 'price_list') {
        srcSpan.textContent = 'ğŸ“‹'; srcSpan.title = 'From customer price list';
      } else { srcSpan.textContent = ''; }
    }
  } catch {
    const opt = sel.options[sel.selectedIndex];
    if (opt?.dataset?.price) priceInput.value = parseFloat(opt.dataset.price).toFixed(2);
  }

  try {
    const whId = $('so-warehouse').value;
    if (whId) {
      const avail = await apiFetch(`/api/stock/${itemId}/availability`);
      const wh = avail.find(a => a.warehouse_id === whId);
      availSpan.textContent = wh ? `${wh.qty_available} avail` : '0 avail';
      availSpan.style.color = wh && parseFloat(wh.qty_available) > 0 ? 'var(--green)' : 'var(--red)';
    }
  } catch { availSpan.textContent = 'â€”'; }

  updateSOTotals();
}

function onSOCustomerChange() {
  document.querySelectorAll('#so-lines-body .sol-item').forEach(sel => {
    if (sel.value) onSOLineItemChange(sel);
  });
}

function updateSOTotals() {
  let subtotal = 0;
  document.querySelectorAll('#so-lines-body tr:not(#so-lines-empty)').forEach(tr => {
    const qty   = parseFloat(tr.querySelector('.sol-qty')?.value || 0);
    const price = parseFloat(tr.querySelector('.sol-price')?.value || 0);
    const disc  = parseFloat(tr.querySelector('.sol-disc')?.value || 0) / 100;
    const lt    = qty * price * (1 - disc);
    const totEl = tr.querySelector('.sol-total');
    if (totEl) totEl.textContent = '$' + fmt(lt);
    subtotal += lt;
  });
  const taxRate = parseFloat($('so-tax-rate').value || 0) / 100;
  const tax     = subtotal * taxRate;
  $('so-subtotal-display').textContent = '$' + fmt(subtotal);
  $('so-tax-display').textContent      = '$' + fmt(tax);
  $('so-total-display').textContent    = '$' + fmt(subtotal + tax);
}

async function submitNewSO() {
  const customerId  = $('so-customer').value;
  const warehouseId = $('so-warehouse').value;
  if (!customerId)  { toast('Select a customer', 'error'); return; }
  if (!warehouseId) { toast('Select a warehouse', 'error'); return; }

  const lines = [];
  let valid = true;
  document.querySelectorAll('#so-lines-body tr:not(#so-lines-empty)').forEach(tr => {
    const itemId = tr.querySelector('.sol-item')?.value;
    const qty    = parseFloat(tr.querySelector('.sol-qty')?.value || 0);
    const price  = parseFloat(tr.querySelector('.sol-price')?.value || 0);
    const disc   = parseFloat(tr.querySelector('.sol-disc')?.value || 0) / 100;
    if (!itemId || qty <= 0) { valid = false; return; }
    lines.push({ item_id: itemId, qty_ordered: qty, unit_price: price, discount_pct: disc });
  });
  if (!valid) { toast('All lines need an item and quantity > 0', 'error'); return; }
  if (!lines.length) { toast('Add at least one line', 'error'); return; }

  try {
    const so = await apiFetch('/api/sales-orders', {
      method: 'POST',
      body: JSON.stringify({
        customer_id: customerId, warehouse_id: warehouseId,
        order_date: $('so-order-date').value,
        requested_ship_date: $('so-ship-date').value || null,
        tax_rate: parseFloat($('so-tax-rate').value || 0) / 100,
        notes: $('so-notes').value || null,
        lines
      })
    });
    toast(`${so.number} created!`, 'success');
    closeModal('new-so-modal');
    await Promise.all([loadOrders(), loadDashboard()]);
  } catch (e) { toast(e.message, 'error'); }
}

// â”€â”€ Ship Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openShipModal(orderId) {
  $('ship-order-id').value = orderId;
  $('ship-date').value     = today();
  $('ship-carrier').value  = '';
  $('ship-tracking').value = '';
  $('ship-notes').value    = '';
  $('ship-lines-body').innerHTML = '<tr><td colspan="5" style="padding:14px;text-align:center"><div class="spinner"></div></td></tr>';
  openModal('ship-modal');
  closeModal('so-detail-modal');

  try {
    const order = await apiFetch(`/api/sales-orders/${orderId}`);
    const openLines = (order.lines || []).filter(l => parseFloat(l.qty_backordered) > 0 && l.status !== 'cancelled');
    $('ship-lines-body').innerHTML = openLines.map(l => `
      <tr>
        <td><div style="font-weight:500">${l.item_code}</div><div style="font-size:11px;color:var(--text2)">${l.item_name}</div></td>
        <td>${l.qty_ordered}</td><td>${l.qty_shipped}</td>
        <td style="color:var(--orange)">${l.qty_backordered}</td>
        <td><input type="number" data-line-id="${l.id}" class="ship-qty-input"
              value="${l.qty_backordered}" min="0.01" max="${l.qty_backordered}" step="0.01"
              style="width:70px"></td>
      </tr>
    `).join('');
  } catch (e) { $('ship-lines-body').innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--red)">${e.message}</td></tr>`; }
}

async function submitShipment() {
  const orderId  = $('ship-order-id').value;
  const shipDate = $('ship-date').value;
  const lines    = [];
  document.querySelectorAll('.ship-qty-input').forEach(inp => {
    const qty = parseFloat(inp.value);
    if (qty > 0) lines.push({ order_line_id: inp.dataset.lineId, qty_shipped: qty });
  });
  if (!lines.length) { toast('No lines to ship', 'error'); return; }

  try {
    const shp = await apiFetch('/api/shipments', {
      method: 'POST',
      body: JSON.stringify({
        sales_order_id: orderId, ship_date: shipDate,
        carrier: $('ship-carrier').value || null,
        tracking_number: $('ship-tracking').value || null,
        notes: $('ship-notes').value || null, lines
      })
    });
    const result = await apiFetch(`/api/shipments/${shp.id}/post`, { method: 'POST', body: '{}' });
    toast(`${shp.number} shipped! Invoice ${result.invoice.number} created.`, 'success');
    closeModal('ship-modal');
    await Promise.all([loadOrders(), loadShipments(), loadInvoices(), loadDashboard()]);
  } catch (e) { toast(e.message, 'error'); }
}

// â”€â”€ New Customer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewCustomerModal() { openModal('new-customer-modal'); }

async function submitNewCustomer() {
  const code = $('nc-code').value.trim();
  const name = $('nc-name').value.trim();
  if (!code || !name) { toast('Code and Name are required', 'error'); return; }

  const city = $('nc-city').value.trim(), state = $('nc-state').value.trim();
  const zip  = $('nc-zip').value.trim(),  addr  = $('nc-addr').value.trim();

  try {
    const cust = await apiFetch('/api/customers', {
      method: 'POST',
      body: JSON.stringify({
        code, name,
        email: $('nc-email').value || null,
        phone: $('nc-phone').value || null,
        billing_address: addr ? { line1: addr, city, state, zip, country: 'US' } : null,
        payment_terms_days: parseInt($('nc-terms').value) || 30,
        credit_limit: parseFloat($('nc-credit').value) || 0
      })
    });
    toast(`Customer ${cust.code} created!`, 'success');
    closeModal('new-customer-modal');
    await loadCustomers();
  } catch (e) { toast(e.message, 'error'); }
}

// â”€â”€ Payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPaymentModal(invoiceId, customerId, invoiceNumber, balanceDue) {
  $('pay-invoice-id').value  = invoiceId;
  $('pay-customer-id').value = customerId;
  $('pay-date').value        = today();
  $('pay-amount').value      = parseFloat(balanceDue).toFixed(2);
  $('pay-ref').value         = '';
  $('pay-invoice-info').textContent = `Invoice ${invoiceNumber} â€” Balance Due: $${fmt(balanceDue)}`;
  openModal('payment-modal');
}

function printCurrentInvoice() {
  const id = $('pay-invoice-id').value;
  if (id) window.open(`/print/invoice.html?invoiceId=${id}`, '_blank');
}

async function submitPayment() {
  const invoiceId  = $('pay-invoice-id').value;
  const customerId = $('pay-customer-id').value;
  const amount     = parseFloat($('pay-amount').value);
  if (!amount || amount <= 0) { toast('Enter a valid amount', 'error'); return; }

  try {
    await apiFetch('/api/payments', {
      method: 'POST',
      body: JSON.stringify({
        customer_id: customerId,
        payment_date: $('pay-date').value,
        amount,
        method: $('pay-method').value,
        reference_number: $('pay-ref').value || null,
        applications: [{ invoice_id: invoiceId, amount_applied: amount }]
      })
    });
    toast(`Payment of $${fmt(amount)} recorded!`, 'success');
    closeModal('payment-modal');
    await Promise.all([loadInvoices(), loadDashboard(), loadCustomers()]);
  } catch (e) { toast(e.message, 'error'); }
}

// â”€â”€ Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshAll() {
  await Promise.all([loadDashboard(), loadOrders(), loadCustomers()]);
  toast('Refreshed', 'info');
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  await Promise.all([loadWarehouses(), loadItems(), loadCustomers()]);
  await Promise.all([loadDashboard(), loadOrders()]);
})();
</script>
</body>
</html>
