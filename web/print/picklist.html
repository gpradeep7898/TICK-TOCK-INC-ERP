<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pick List — Tick Tock Inc.</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 13px; color: #000; background: #fff; }
  .page { width: 8.5in; margin: 0 auto; padding: 0.4in; }

  /* Header */
  .hdr { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
  .pick-label { font-size: 36px; font-weight: 900; letter-spacing: 3px; color: #1a1a2e; }
  .pick-label small { display: block; font-size: 13px; font-weight: 400; letter-spacing: 0; color: #555; margin-top: 2px; }
  .doc-meta { text-align: right; }
  .doc-meta .meta-row { font-size: 12px; line-height: 1.9; }
  .doc-meta .meta-key { color: #888; }
  .doc-meta .meta-val { font-weight: 700; margin-left: 6px; }

  .divider { border: none; border-top: 3px solid #1a1a2e; margin: 14px 0; }

  /* Info grid */
  .info-grid { display: flex; gap: 32px; margin-bottom: 20px; }
  .info-box  { flex: 1; }
  .info-box .lbl { font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: #888; margin-bottom: 4px; }
  .info-box .val { font-size: 13px; font-weight: 700; }
  .info-box .sub { font-size: 12px; color: #444; line-height: 1.5; }

  /* Table */
  table { width: 100%; border-collapse: collapse; }
  thead tr { background: #1a1a2e; color: #fff; }
  thead th { padding: 10px 8px; text-align: left; font-size: 12px; font-weight: 700; letter-spacing: 0.5px; }
  thead th.check-col { width: 36px; text-align: center; }
  thead th.qty-col   { width: 90px; text-align: center; }
  tbody tr { border-bottom: 2px solid #ccc; }
  tbody tr:nth-child(odd) { background: #f8f8f8; }
  tbody td { padding: 12px 8px; font-size: 14px; vertical-align: middle; }
  tbody td.check-col { text-align: center; }
  tbody td.qty-col   { text-align: center; font-size: 18px; font-weight: 900; }

  /* Checkbox */
  .pick-check { width: 22px; height: 22px; border: 2px solid #333; display: inline-block; }

  /* Totals bar */
  .totals-bar { background: #1a1a2e; color: #fff; padding: 10px 16px; margin-top: 16px;
                display: flex; justify-content: space-between; align-items: center; border-radius: 3px; }
  .totals-bar .t-item { text-align: center; }
  .totals-bar .t-num  { font-size: 20px; font-weight: 900; }
  .totals-bar .t-lbl  { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; opacity: 0.7; }

  /* Signature */
  .sig-section { margin-top: 32px; display: flex; gap: 48px; }
  .sig-box { flex: 1; }
  .sig-box .sig-label { font-size: 11px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;
                         color: #888; margin-bottom: 4px; }
  .sig-box .sig-line  { border-bottom: 1.5px solid #333; height: 28px; }
  .sig-box .sig-hint  { font-size: 10px; color: #aaa; margin-top: 3px; }

  .loading { text-align: center; padding: 80px; font-size: 18px; color: #888; }
  .error   { text-align: center; padding: 80px; font-size: 16px; color: #dc2626; }

  @media print {
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .page { padding: 0.25in; }
  }
</style>
</head>
<body>
<div class="page" id="content">
  <div class="loading">Loading pick list…</div>
</div>

<script>
const API = 'http://localhost:3001';

function fmtDate(d) {
  if (!d) return '—';
  return new Date(d).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });
}
function addr(obj) {
  if (!obj) return '';
  if (typeof obj === 'string') { try { obj = JSON.parse(obj); } catch { return obj; } }
  return [obj.line1, obj.city && `${obj.city}${obj.state ? ', '+obj.state : ''} ${obj.zip||''}`.trim()]
    .filter(Boolean).join(', ');
}

async function load() {
  const params = new URLSearchParams(location.search);
  const shipmentId = params.get('shipmentId');
  if (!shipmentId) {
    document.getElementById('content').innerHTML = '<div class="error">No shipmentId in URL. Add ?shipmentId=... to the URL.</div>';
    return;
  }

  try {
    const r = await fetch(`${API}/api/print/picklist/${shipmentId}`);
    if (!r.ok) throw new Error((await r.json()).error || r.statusText);
    const { shipment: shp, lines } = await r.json();

    const totalQty  = lines.reduce((s, l) => s + Number(l.qty_shipped), 0);
    const totalLines = lines.length;
    const shipAddrStr = addr(shp.shipping_address);

    const linesHtml = lines.map((l, idx) => `
      <tr>
        <td class="check-col"><div class="pick-check"></div></td>
        <td><span style="font-weight:700;font-size:13px">${l.item_code}</span>
            ${l.upc_code ? `<br><span style="font-size:10px;color:#888;font-family:monospace">${l.upc_code}</span>` : ''}
        </td>
        <td>${l.item_name}</td>
        <td style="font-size:11px;color:#888">—</td>
        <td class="qty-col" style="color:#1a1a2e">${Number(l.qty_shipped)}</td>
        <td style="font-size:11px;color:#666">${l.unit_of_measure}</td>
      </tr>`).join('');

    document.getElementById('content').innerHTML = `
      <div class="hdr">
        <div>
          <div class="pick-label">PICK LIST
            <small>Tick Tock Inc. · Warehouse Operations</small>
          </div>
        </div>
        <div class="doc-meta">
          <div class="meta-row"><span class="meta-key">Shipment #</span><span class="meta-val">${shp.number}</span></div>
          <div class="meta-row"><span class="meta-key">Order #</span><span class="meta-val">${shp.order_number}</span></div>
          <div class="meta-row"><span class="meta-key">Date</span><span class="meta-val">${fmtDate(shp.ship_date)}</span></div>
          <div class="meta-row"><span class="meta-key">Warehouse</span><span class="meta-val">${shp.warehouse_code} — ${shp.warehouse_name}</span></div>
        </div>
      </div>

      <hr class="divider">

      <div class="info-grid">
        <div class="info-box">
          <div class="lbl">Ship To Customer</div>
          <div class="val">${shp.customer_name}</div>
          ${shipAddrStr ? `<div class="sub">${shipAddrStr}</div>` : ''}
        </div>
        ${shp.carrier ? `
        <div class="info-box">
          <div class="lbl">Carrier</div>
          <div class="val">${shp.carrier}</div>
          ${shp.tracking_number ? `<div class="sub">Tracking: ${shp.tracking_number}</div>` : ''}
        </div>` : ''}
        ${shp.order_notes ? `
        <div class="info-box">
          <div class="lbl">Order Notes</div>
          <div class="sub">${shp.order_notes}</div>
        </div>` : ''}
      </div>

      <table>
        <thead>
          <tr>
            <th class="check-col">✓</th>
            <th>SKU / Barcode</th>
            <th>Item Name</th>
            <th>Location</th>
            <th class="qty-col">Qty</th>
            <th>UOM</th>
          </tr>
        </thead>
        <tbody>${linesHtml}</tbody>
      </table>

      <div class="totals-bar">
        <div class="t-item">
          <div class="t-num">${totalLines}</div>
          <div class="t-lbl">Lines</div>
        </div>
        <div class="t-item">
          <div class="t-num">${totalQty.toLocaleString()}</div>
          <div class="t-lbl">Total Units</div>
        </div>
        <div class="t-item" style="font-size:12px;opacity:0.8">
          Verify all items before sealing package
        </div>
      </div>

      <div class="sig-section">
        <div class="sig-box">
          <div class="sig-label">Picked By (Print Name)</div>
          <div class="sig-line"></div>
          <div class="sig-hint">Name</div>
        </div>
        <div class="sig-box">
          <div class="sig-label">Signature</div>
          <div class="sig-line"></div>
          <div class="sig-hint">Signature</div>
        </div>
        <div class="sig-box">
          <div class="sig-label">Date &amp; Time</div>
          <div class="sig-line"></div>
          <div class="sig-hint">MM/DD/YYYY  HH:MM</div>
        </div>
        <div class="sig-box">
          <div class="sig-label">Checked By</div>
          <div class="sig-line"></div>
          <div class="sig-hint">QC Initials</div>
        </div>
      </div>
    `;

    window.addEventListener('load', () => setTimeout(() => window.print(), 300));

  } catch (err) {
    document.getElementById('content').innerHTML = `<div class="error">Error: ${err.message}</div>`;
  }
}

load();
</script>
</body>
</html>
